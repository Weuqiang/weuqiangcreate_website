---
sidebar_position: 2
title: 
tags: [, qiankun, Module Federation, ]
---

# 

## 



### 

- ****
- ****
- ****
- ****

## 

### 1. iframe 



```html
<!--  -->
<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body>
  <nav>
    <button onclick="loadApp('app1')">1</button>
    <button onclick="loadApp('app2')">2</button>
  </nav>
  
  <iframe id="micro-app" src="" frameborder="0"></iframe>
  
  <script>
    function loadApp(appName) {
      const iframe = document.getElementById('micro-app');
      iframe.src = `http://localhost:${appName === 'app1' ? 3001 : 3002}`;
    }
  </script>
</body>
</html>
```

****
- 
- JS

****
- 
- 
- 
- SEO

### 2. qiankun 

 single-spa 

#### 

```bash
# 
npm install qiankun
```

```javascript
// main.js - 
import { registerMicroApps, start } from 'qiankun';

// 
registerMicroApps([
  {
    name: 'react-app',
    entry: '//localhost:3001',
    container: '#subapp-container',
    activeRule: '/react',
    props: {
      // 
      data: { user: 'admin' }
    }
  },
  {
    name: 'vue-app',
    entry: '//localhost:3002',
    container: '#subapp-container',
    activeRule: '/vue',
  },
]);

//  qiankun
start({
  prefetch: true, // 
  sandbox: {
    strictStyleIsolation: true, // 
    experimentalStyleIsolation: true, // 
  },
});
```

```jsx
// App.jsx - 
import React from 'react';
import { BrowserRouter, Link } from 'react-router-dom';

function App() {
  return (
    <BrowserRouter>
      <div className="main-app">
        <nav>
          <Link to="/react">React </Link>
          <Link to="/vue">Vue </Link>
        </nav>
        
        {/*  */}
        <div id="subapp-container"></div>
      </div>
    </BrowserRouter>
  );
}

export default App;
```

#### React 

```javascript
// public-path.js
if (window.__POWERED_BY_QIANKUN__) {
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}
```

```jsx
// index.js - React 
import './public-path';
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';

let root = null;

// 
function render(props = {}) {
  const { container } = props;
  root = ReactDOM.createRoot(
    container 
      ? container.querySelector('#root') 
      : document.querySelector('#root')
  );
  root.render(<App />);
}

// 
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

// 
export async function bootstrap() {
  console.log('React ');
}

export async function mount(props) {
  console.log('React ', props);
  render(props);
}

export async function unmount(props) {
  console.log('React ');
  root.unmount();
}
```

```javascript
// config-overrides.js -  webpack
const { name } = require('./package.json');

module.exports = {
  webpack: (config) => {
    config.output.library = `${name}-[name]`;
    config.output.libraryTarget = 'umd';
    config.output.chunkLoadingGlobal = `webpackJsonp_${name}`;
    config.output.globalObject = 'window';
    
    return config;
  },
  devServer: (configFunction) => {
    return function (proxy, allowedHost) {
      const config = configFunction(proxy, allowedHost);
      config.headers = {
        'Access-Control-Allow-Origin': '*',
      };
      return config;
    };
  },
};
```

#### Vue 

```javascript
// main.js - Vue 
import './public-path';
import { createApp } from 'vue';
import { createRouter, createWebHistory } from 'vue-router';
import App from './App.vue';
import routes from './router';

let app = null;
let router = null;
let history = null;

function render(props = {}) {
  const { container } = props;
  
  history = createWebHistory(
    window.__POWERED_BY_QIANKUN__ ? '/vue' : '/'
  );
  
  router = createRouter({
    history,
    routes,
  });

  app = createApp(App);
  app.use(router);
  app.mount(
    container 
      ? container.querySelector('#app') 
      : '#app'
  );
}

// 
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

export async function bootstrap() {
  console.log('Vue ');
}

export async function mount(props) {
  console.log('Vue ', props);
  render(props);
}

export async function unmount() {
  console.log('Vue ');
  app.unmount();
  app = null;
  router = null;
  history.destroy();
}
```

```javascript
// vue.config.js
const { name } = require('./package.json');

module.exports = {
  devServer: {
    port: 3002,
    headers: {
      'Access-Control-Allow-Origin': '*',
    },
  },
  configureWebpack: {
    output: {
      library: `${name}-[name]`,
      libraryTarget: 'umd',
      chunkLoadingGlobal: `webpackJsonp_${name}`,
    },
  },
};
```

### 3. Webpack Module Federation

Webpack 5 

#### 

```javascript
// webpack.config.js - 
const HtmlWebpackPlugin = require('html-webpack-plugin');
const ModuleFederationPlugin = require('webpack/lib/container/ModuleFederationPlugin');

module.exports = {
  entry: './src/index',
  mode: 'development',
  devServer: {
    port: 3000,
  },
  output: {
    publicPath: 'http://localhost:3000/',
  },
  plugins: [
    new ModuleFederationPlugin({
      name: 'host',
      remotes: {
        // 
        app1: 'app1@http://localhost:3001/remoteEntry.js',
        app2: 'app2@http://localhost:3002/remoteEntry.js',
      },
      shared: {
        react: { singleton: true },
        'react-dom': { singleton: true },
      },
    }),
    new HtmlWebpackPlugin({
      template: './public/index.html',
    }),
  ],
};
```

```jsx
// App.jsx - 
import React, { lazy, Suspense } from 'react';
import { BrowserRouter, Routes, Route, Link } from 'react-router-dom';

// 
const RemoteApp1 = lazy(() => import('app1/App'));
const RemoteApp2 = lazy(() => import('app2/App'));

function App() {
  return (
    <BrowserRouter>
      <nav>
        <Link to="/app1">1</Link>
        <Link to="/app2">2</Link>
      </nav>
      
      <Suspense fallback={<div>...</div>}>
        <Routes>
          <Route path="/app1/*" element={<RemoteApp1 />} />
          <Route path="/app2/*" element={<RemoteApp2 />} />
        </Routes>
      </Suspense>
    </BrowserRouter>
  );
}

export default App;
```

#### 

```javascript
// webpack.config.js - 
const HtmlWebpackPlugin = require('html-webpack-plugin');
const ModuleFederationPlugin = require('webpack/lib/container/ModuleFederationPlugin');

module.exports = {
  entry: './src/index',
  mode: 'development',
  devServer: {
    port: 3001,
  },
  output: {
    publicPath: 'http://localhost:3001/',
  },
  plugins: [
    new ModuleFederationPlugin({
      name: 'app1',
      filename: 'remoteEntry.js',
      exposes: {
        // 
        './App': './src/App',
        './Button': './src/components/Button',
      },
      shared: {
        react: { singleton: true },
        'react-dom': { singleton: true },
      },
    }),
    new HtmlWebpackPlugin({
      template: './public/index.html',
    }),
  ],
};
```

## 

### 1. Props 

```javascript
// 
registerMicroApps([
  {
    name: 'app1',
    entry: '//localhost:3001',
    container: '#subapp',
    activeRule: '/app1',
    props: {
      data: { user: 'admin' },
      onGlobalStateChange: (state) => {
        console.log('', state);
      },
    },
  },
]);

// 
export async function mount(props) {
  console.log(' props:', props);
  const { data, onGlobalStateChange } = props;
}
```

### 2. 

```javascript
//  - 
import { initGlobalState } from 'qiankun';

const actions = initGlobalState({
  user: 'admin',
  token: 'xxx',
});

// 
actions.onGlobalStateChange((state, prev) => {
  console.log('', state, prev);
});

// 
actions.setGlobalState({
  user: 'new-user',
});

// 
registerMicroApps([
  {
    name: 'app1',
    entry: '//localhost:3001',
    container: '#subapp',
    activeRule: '/app1',
    props: { actions },
  },
]);
```

```javascript
//  - 
export async function mount(props) {
  const { actions } = props;
  
  // 
  actions.onGlobalStateChange((state, prev) => {
    console.log('', state, prev);
  });
  
  // 
  actions.setGlobalState({
    token: 'new-token',
  });
}
```

### 3. 

```javascript
// event-bus.js
class EventBus {
  constructor() {
    this.events = {};
  }
  
  on(event, callback) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(callback);
  }
  
  emit(event, data) {
    if (this.events[event]) {
      this.events[event].forEach(callback => callback(data));
    }
  }
  
  off(event, callback) {
    if (this.events[event]) {
      this.events[event] = this.events[event].filter(
        cb => cb !== callback
      );
    }
  }
}

export default new EventBus();
```

```javascript
// 
import eventBus from './event-bus';

// 
eventBus.on('user-login', (user) => {
  console.log('', user);
});

// 
eventBus.emit('user-login', { name: 'admin' });
```

## 

### 1. CSS Modules

```jsx
// Button.module.css
.button {
  background: blue;
  color: white;
}

// Button.jsx
import styles from './Button.module.css';

function Button() {
  return <button className={styles.button}></button>;
}
```

### 2. CSS-in-JS

```jsx
import styled from 'styled-components';

const Button = styled.button`
  background: blue;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  
  &:hover {
    background: darkblue;
  }
`;

function App() {
  return <Button></Button>;
}
```

### 3. Shadow DOM

```javascript
// qiankun 
start({
  sandbox: {
    strictStyleIsolation: true, //  Shadow DOM
  },
});
```

### 4. 

```css
/*  */
.main-app .button {
  background: blue;
}

/*  */
.sub-app .button {
  background: red;
}
```

## JS 

### 1. 

```javascript
class SnapshotSandbox {
  constructor() {
    this.proxy = window;
    this.modifyPropsMap = {};
  }
  
  active() {
    // 
    this.windowSnapshot = {};
    for (const prop in window) {
      if (window.hasOwnProperty(prop)) {
        this.windowSnapshot[prop] = window[prop];
      }
    }
    
    // 
    Object.keys(this.modifyPropsMap).forEach(prop => {
      window[prop] = this.modifyPropsMap[prop];
    });
  }
  
  inactive() {
    // 
    for (const prop in window) {
      if (window.hasOwnProperty(prop)) {
        if (window[prop] !== this.windowSnapshot[prop]) {
          this.modifyPropsMap[prop] = window[prop];
          window[prop] = this.windowSnapshot[prop];
        }
      }
    }
  }
}
```

### 2. Proxy 

```javascript
class ProxySandbox {
  constructor() {
    const fakeWindow = Object.create(null);
    
    this.proxy = new Proxy(fakeWindow, {
      get(target, prop) {
        return prop in target ? target[prop] : window[prop];
      },
      set(target, prop, value) {
        target[prop] = value;
        return true;
      },
    });
  }
  
  active() {
    this.sandboxRunning = true;
  }
  
  inactive() {
    this.sandboxRunning = false;
  }
}
```

## 

### 1. 

```javascript
import { registerMicroApps, start, prefetchApps } from 'qiankun';

registerMicroApps([
  { name: 'app1', entry: '//localhost:3001', container: '#subapp', activeRule: '/app1' },
  { name: 'app2', entry: '//localhost:3002', container: '#subapp', activeRule: '/app2' },
]);

start();

// 
prefetchApps([
  { name: 'app1', entry: '//localhost:3001' },
]);
```

### 2. 

```javascript
import { loadMicroApp } from 'qiankun';

// 
function loadApp() {
  const microApp = loadMicroApp({
    name: 'app1',
    entry: '//localhost:3001',
    container: '#subapp',
  });
  
  // 
  microApp.unmount();
}
```

### 3. 

```javascript
// Module Federation 
new ModuleFederationPlugin({
  shared: {
    react: {
      singleton: true,
      requiredVersion: '^18.0.0',
    },
    'react-dom': {
      singleton: true,
      requiredVersion: '^18.0.0',
    },
  },
});
```

## 

### 1. 

- ****
- ****
- ****

### 2. 

```javascript
// 
const routes = [
  { path: '/app1/*', app: 'app1' },
  { path: '/app2/*', app: 'app2' },
];

// 
const subRoutes = [
  { path: '/', component: Home },
  { path: '/detail', component: Detail },
];
```

### 3. 

```javascript
// 
window.sharedLibs = {
  React: require('react'),
  ReactDOM: require('react-dom'),
  axios: require('axios'),
};

// 
const React = window.sharedLibs.React;
```

### 4. 

```javascript
import { addErrorHandler } from 'qiankun';

addErrorHandler((error) => {
  console.error('', error);
  
  // 
  reportError(error);
  
  // 
  showErrorMessage('');
});
```

## 

### 

```jsx
// main-app/src/index.js
import React from 'react';
import ReactDOM from 'react-dom/client';
import { registerMicroApps, start, initGlobalState } from 'qiankun';
import App from './App';

// 
const actions = initGlobalState({
  user: null,
  token: null,
});

// 
registerMicroApps(
  [
    {
      name: 'react-app',
      entry: '//localhost:3001',
      container: '#subapp-viewport',
      activeRule: '/react',
      props: { actions },
    },
    {
      name: 'vue-app',
      entry: '//localhost:3002',
      container: '#subapp-viewport',
      activeRule: '/vue',
      props: { actions },
    },
  ],
  {
    beforeLoad: [
      app => {
        console.log('before load', app.name);
      },
    ],
    beforeMount: [
      app => {
        console.log('before mount', app.name);
      },
    ],
    afterMount: [
      app => {
        console.log('after mount', app.name);
      },
    ],
    afterUnmount: [
      app => {
        console.log('after unmount', app.name);
      },
    ],
  }
);

//  qiankun
start({
  prefetch: true,
  sandbox: {
    strictStyleIsolation: true,
  },
});

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
```

```jsx
// main-app/src/App.jsx
import React from 'react';
import { BrowserRouter, Routes, Route, Link } from 'react-router-dom';
import './App.css';

function App() {
  return (
    <BrowserRouter>
      <div className="main-app">
        <header>
          <h1></h1>
          <nav>
            <Link to="/"></Link>
            <Link to="/react">React </Link>
            <Link to="/vue">Vue </Link>
          </nav>
        </header>
        
        <main>
          <Routes>
            <Route path="/" element={<Home />} />
          </Routes>
          
          {/*  */}
          <div id="subapp-viewport"></div>
        </main>
      </div>
    </BrowserRouter>
  );
}

function Home() {
  return <h2></h2>;
}

export default App;
```

## 

### 1. 

**** 404

**** `publicPath`

```javascript
// 
if (window.__POWERED_BY_QIANKUN__) {
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}
```

### 2. 

****

****
-  CSS Modules  CSS-in-JS
-  qiankun 
- 

### 3. 

****

****
-  `activeRule` 
- 

### 4. 

****

****
-  qiankun  JS 
-  window 

## 



1. ****
2. ****
3. ****
4. ****



- ****
- ****
- ****
- ****

## 

- [qiankun ](https://qiankun.umijs.org/)
- [Webpack Module Federation](https://webpack.js.org/concepts/module-federation/)
- [single-spa ](https://single-spa.js.org/)
- [](https://micro-frontends.org/)

