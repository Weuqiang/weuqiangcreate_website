# 
## bluebird

Promise

### bluebird + fs



```javascript
const fs = require('fs')
fs.readFile('index.html', (err, data) => {
    response.end(data)
})
```

Promise

```javascript
const bluebird = require('bluebird')
const fs = bluebird.promisifyAll(require('fs'))

fs.readFileAsync('index.html')
.then(data => {
    response.end(data)
})
```

### bluebird + mysql



```javascript
const mysql = require('mysql')
// mysql
let config = require('./config')
conn.connect()

// 
conn.query(`sql code here...`, (err, data) => {

})
```

Promise

```javascript
const bluebird = require('bluebird')
const mysql = require('mysql')
// mysql
let config = require('./config')
const conn = bluebird.promisifyAll(mysql.createConnection(config))
conn.connect()

// 
let data = await conn.queryAsync(`sql code here...`)
```

## PM2

 `pm2 start index.js`

```js
//  ecosystem.config.js
module.exports = {
  apps: [{
    script: './server/app.js',
    watch: '.',
    env_development: {
      "REACT_APP_NODE_ENV": "development"
    },
    env_production: {
      "REACT_APP_NODE_ENV": "production"
    }
  }]
}
```



```shell
pm2 start ecosystem.config.js --env development
// or
pm2 start ecosystem.config.js --env production
```

### 

```js
pm2 start app.js
pm2 list
pm2 delete [app-id]
pm2 logs
pm2 logs [app-name]
pm2 monit
// ...
```

## 



### chalk



```js
import chalk from 'chalk'
console.log(chalk.blue('akara'))  // 
console.log(chalk.blue.bgRed('akara')) // 
```

### yargs

 `--help``--version`

```js
#!/usr/bin/env node
const yargs = require("yargs/yargs");
const { hideBin } = require("yargs/helpers");
const http = require("http");

yargs(hideBin(process.argv)) // hideBin(process.argv)  process.argv.slice(2)
    .command( 
        "serve [port]", // [port]
        "",
        { // 
            port: {
                alias: "p",
                default: 3000,
            },
        },
        (argv) => {
            http.createServer((req, res) => {}).listen(argv.port, () => {
                console.log(`${argv.port}`);
            });
        }
    )
    .command("curl <url>", "", {}, (argv) => { // <url>
        if (argv.verbose) console.log('verbose')
        console.log(argv.url);
    })
    .option('verbose', {
      alias: 'v',
      type: 'boolean',
      description: 'Run with verbose logging'
    })
    .argv;
```

```bash
cli --help
cli --version
cli serve 8000 # cli serve -p 8000 | cli serve --port=8000
cli curl 'google.com' -v
```

### commander

 `yargs`

```js
#!/usr/bin/env node
const { program } = require('commander')

program
    .version('1.0.0')
    .description('cli tool')
    .option('--verbose', 'use verbose') // 
    .option('-u, --url <url>', 'url') // 
    .option('-p, --port [port]', 'port', 3000) // 
    .parse(process.argv)

console.log(program.opts());
```

### inquirer



```js
#!/usr/bin/env node
const inquirer = require('inquirer')
const questions = [
    {
        type: 'confirm',
        name: 'isPeople',
        message: '?',
        default: false
    },
    {
        type: 'input',
        name: 'name',
        message: '',
    },
    {
        type: 'input',
        name: 'phone',
        message: '',
        validate(value) {
            const pass = value.match(/^1[34578]\d{9}$/g)
            if (pass) return true
            return ''
        }
    },
    {
        type: 'list',
        name: 'sex',
        message: '',
        choices: ['Male', 'Female', 'None'],
        filter(val) {
            return val.toLowerCase();
        },

    }
]
inquirer
    .prompt(questions)
    .then(answers => {
        console.log(JSON.stringify(answers, null, ' '));
    })
```

### readline

```js
// 
const readline = require('readline')

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
})

rl.question('', (answer) => {
    console.log('666');
    rl.close()
})
```

```js
// 
const fs = require('fs');
const readline = require('readline');

async function processLineByLine() {
  const fileStream = fs.createReadStream('log.txt');

  const rl = readline.createInterface({
    input: fileStream,
    crlfDelay: Infinity
  });
  //  crlfDelay  input.txt  CR LF '\r\n'

  for await (const line of rl) {
    // input.txt  `line`
    console.log(`Line from file: ${line}`);
  }
}

processLineByLine();
```

## puppeteer

 `puppeteer.connect`

1. Chrome `--remote-debugging-port=9222 `
2.  `http://127.0.0.1:9222/json/version` `webSocketDebuggerUrl`
3. ```js
   const url = 'ws://127.0.0.1:9222/devtools/browser/81daad69-fb53-49ea-9f97-3683b73afea0'
   const browser = await puppeteer.connect({
       browserWSEndpoint: url,
   });
   ```

https://medium.com/@jaredpotter1/connecting-puppeteer-to-existing-chrome-window-8a10828149e0

## Koa

### 

```javascript
const Koa = require('koa');
const app = new Koa();

app.use(async (ctx, next) => {
  const start = Date.now();
  await next();
  const ms = Date.now() - start;
  console.log(`${ctx.method} ${ctx.url} - ${ms}ms`);
});


// response
app.use(ctx => {
  ctx.status = 200
  ctx.set('Content-type', 'text/plain; charset=utf-8')
  ctx.body = 'Hello Koa'
});

app.listen(3000);

// 
ctx.redirect('/home')
// 
// res.status = 302
// res.setHeader('Location', '/home')
```

#### 

```javascript
const Emitter = require('events')
// 
const context = require('./context')
const request = require('./request')
const response = require('./response')
class Koa extends Emitter {
    constructor() {
        super()
        this.middleware = []
        this.context = Object.create(context)
        this.request = Object.create(request)
        this.response = Object.create(response)
    }

    callback() {
        const fn = compose(this.middleware)
        return (req, res) => {
            const ctx = this.createContext(req, res)
            return this.handlerRequest(ctx, fn)
        }
    }

    use(fn) {
        if (typeof fn !== 'function') throw new TypeError('middleware must be a function!')
        this.middleware.push(fn)
        return this
    }

    listen(...args) {
        const server = http.createServer(this.callback())
        return server.listen(...args)
    }

    createContext(req, res) {
        // reqrescontext
        const context = Object.create(this.context);
        const request = Object.create(this.request);
        const response = Object.create(this.response);
        context.request = request
        context.response = response
        context.app = request.app = response.app = this;
        // reqres
        context.req = request.req = response.req = req;
        context.res = request.res = response.res = res;
        // 
        request.ctx = response.ctx = context;
        request.response = response;
        response.request = request;
        return context
    }

    handlerRequest(ctx, fn) {
        const res = ctx.res
        res.statusCode = 404
        fn(ctx).catch(reason => {
            console.log(reason)
        })
    }
}
```

KoaappAPI

- use

  ```javascript
  app.use((ctx, next) => {
  
  })
  ```

  useappmiddleware
- listen

  ```javascript
  app.listen(3000)
  ```

  

  ```javascript
   const server = http.createServer(this.callback())
   server.listen(3000)
  ```
- callback

  

  1. koa-composemiddlewarefn
  2. app.createContextcontextrequestresponserequestresponsecontextreqres

     request

     ```javascript
     get header() {
     	return this.req.headers;
     },
     set header(val) {
     	this.req.headers = val;
     },
     ```

      `ctx.request.header`reqheaders
  3. handleRequestcontextfn

KoaKoa-compose 

#### koa-compose

```javascript
const compose = (middleware) => {
    if (!Array.isArray(middleware)) throw new TypeError("Middleware stack must be an array!")
    for (const fn of middleware) {
        if (typeof fn !== 'function') throw new TypeError("Middleware must be composed of functions!")
    }
    let length = middleware.length
    return function (ctx, next) {
        let index = -1
        return dispatch(0)
        function dispatch(i) {
            // nextindexi
            if ( index >= i) {
                return Promise.reject(new Error('next() called multiple times'))
            }
            let fn
            index = i
            if (i < length) {
                fn = middleware[i]
            }
            else if (i === length) {
                //  composenextcompose
                fn = next
            }
            // next
            if (!fn) return
            // Promiseasync
            return Promise.resolve(fn(ctx, dispatch.bind(null, (i + 1))))
        }
    }
}
```

### koa-router

```javascript
const Router = require('koa-router')
const router = new Router()
router
  .get('/', (ctx, next) => {
    ctx.body = 'Hello World!';
  })
  .post('/users', (ctx, next) => {
    // ...
  })
  .put('/users/:id', (ctx, next) => {
    // ...
  })
  .del('/users/:id', (ctx, next) => {
    // ...
  })
  .all('/users/:id', (ctx, next) => {
    // ...
  });
app.use(router.routes())
app.use(router.allowedMethods()) // 
```

#### 

get

```javascript
class Router {
    constructor() {
        this.stack = []
    }

    get(url, fn) {
        function middleware(ctx, next) {
            if (ctx.req.method.toLowerCase() === 'get' && ctx.req.url === url) {
                console.log('');
                fn(ctx, next)
            }
            else {
                console.log('');
                next()
            }
        }
        this.stack.push(middleware)
        return this
    }

    routes() {
        return (ctx, next) => {
            let fn = compose(this.stack)
            // next
            // koacompose next
            fn(ctx, next)
        }
    }
}
```

### koa-static

koa

```js
const static = require('koa-static')
app.use(static('public'))
```

### koa-body



```js
const body = require('koa-body')
app.use(body({multipart: true}))
app.use((ctx) => {
    console.log(ctx.request.body)
})
```

### koa-logger

```js
const logger = require('koa-logger')
app.use(logger())
```

### koa-views



 `ejs` `npm i ejs`

```js
const views = require('koa-views')
const render = views('./views', { extension: 'ejs'})

app.use(render)
app.use(async ctx => {
    await ctx.render('template', {
        content: 'hello'
    }) 
})
```

```ejs
<!-- template.ejs -->
<!DOCTYPE html>
<html>
<head></head>
<body>
    <div><%= content %></div>  
</body>
</html>
```

## NestJS

NextJSAngularTypeScriptNodeWeb

NextJS*Module**Module*ControllerServiceControllerService*Module*Service*exports**imports*Service

```js
npm i -g @nestjs/cli
nest new my-project
```

```tsx
// main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(3000);
}
bootstrap();
```

```js
// app.module.ts
import { Module } from '@nestjs/common';
import { AppController, MyController } from './app.controller';
import { AppService } from './app.service';

@Module({
  imports: [],
  controllers: [AppController, MyController],
  providers: [AppService],
 	exports: [],
})
export class AppModule {}
```



### Controller

 `controller`

```js
// app.controller.ts
import { Controller, Get, Post, Req, Res, Body, Param, Query, Headers, Header, HttpCode } from '@nestjs/common';
import { Request } from 'express'

export class DTO { // 
  value: string
}

@Controller()
export class AppController {
  @Get() // /
  getText(): string {
    return 'hello'
  }

  @Get('admin') // /admin
  getAdmin(): string {
    return 'admin'
  }
}

@Controller('/api')
export class MyController {
  @Get('fetchAllInfo') // /api/fetchAllInfo
  fetchInfo(@Req() req: Request, @Query() query): string[] { // ReqQuery
    console.log(req.url)
    console.log(query)
    return ['a', 'b', 'c']
  }

  @Get('/fetchOneInfo/:id')
  fetchOneInfo(@Param() params, @Headers() headers): string { // ParamsHeaders
    console.log(params.id)
    console.log(headers)
    return 'a'
  }

  @Post('/updateOneInfo/:id')
  updateOneInfo(@Param('id') id: number, @Body() body: DTO) { // @Param('id')ParamBody
    console.log(id)
    console.log(body)
    return { // JSONContent-Type
      code: 200,
      msg: 'success'
    }
  }

  @Get('html')
  @Header('Cache-Control', 'none') // 
  getHtml(): string { // Content-Type
    return `
      <html>
        <body>
          <h1>hello nest</hi>
        </body>
      </html>
    `
  }

  @HttpCode(404) // 
  @Get('404')
  four0four() {
    return '404 not Found'
  }

  @Get('async')
  async testAsync(): Promise<string[]> {
    return ['aa', 'bb', 'cc']
  } 

  @Get('res')
  async testRes(@Res() res) {
    res.send('hello nest')
  }
}
```

### Service

 `Controller` `Service``Service` `Provider`

 `Service` `app.module.ts` `Service` `Provider` `Controller` `Service`

```ts
// app.service.ts
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  private name: string = 'akara'

  getName(): string {
    return this.name
  }

  setName(name: string): void {
    this.name = name
  }
}
```

```ts
// app.controller.ts
import { Controller, Get} from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get('/get/service')
  async testGetService() {
    return this.appService.getName()
  }

  @Get('/set/service')
  async testSetService() {
    return this.appService.setName('bkb')
  }
}
```
