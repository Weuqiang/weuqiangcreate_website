---
sidebar_position: 5
title: RedisæŒä¹…åŒ–ä¸é›†ç¾¤æ–¹æ¡ˆ
tags: [æ•°æ®åº“, Redis, æŒä¹…åŒ–, é›†ç¾¤, é«˜å¯ç”¨]
---

# RedisæŒä¹…åŒ–ä¸é›†ç¾¤æ–¹æ¡ˆ

æœ¬æ–‡å°†æ·±å…¥è®²è§£Redisçš„æŒä¹…åŒ–æœºåˆ¶ã€ä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼å’ŒClusteré›†ç¾¤æ–¹æ¡ˆã€‚

## æŒä¹…åŒ–æœºåˆ¶

### RDBæŒä¹…åŒ–

```bash
# RDBé…ç½®
save 900 1      # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–
save 300 10     # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–
save 60 10000   # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–

# RDBæ–‡ä»¶é…ç½®
dbfilename dump.rdb
dir /var/lib/redis
rdbcompression yes
rdbchecksum yes

# æ‰‹åŠ¨è§¦å‘
SAVE            # é˜»å¡ä¿å­˜ï¼ˆç”Ÿäº§ç¯å¢ƒä¸æ¨èï¼‰
BGSAVE          # åå°ä¿å­˜ï¼ˆæ¨èï¼‰
```

#### RDBåŸç†

```javascript
// RDBä¿å­˜æµç¨‹
const rdbProcess = {
  step1: 'Redis forkå­è¿›ç¨‹',
  step2: 'å­è¿›ç¨‹å°†æ•°æ®å†™å…¥ä¸´æ—¶RDBæ–‡ä»¶',
  step3: 'å­è¿›ç¨‹å®Œæˆåï¼Œç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢æ—§RDBæ–‡ä»¶',
  step4: 'çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚',
  
  advantages: [
    'æ–‡ä»¶ç´§å‡‘ï¼Œé€‚åˆå¤‡ä»½',
    'æ¢å¤é€Ÿåº¦å¿«',
    'å¯¹æ€§èƒ½å½±å“å°ï¼ˆforkåçˆ¶è¿›ç¨‹ç»§ç»­å·¥ä½œï¼‰'
  ],
  
  disadvantages: [
    'å¯èƒ½ä¸¢å¤±æœ€åä¸€æ¬¡å¿«ç…§åçš„æ•°æ®',
    'forkå­è¿›ç¨‹è€—æ—¶ï¼ˆæ•°æ®é‡å¤§æ—¶ï¼‰',
    'ä¸é€‚åˆå®æ—¶æŒä¹…åŒ–'
  ]
};
```

### AOFæŒä¹…åŒ–

```bash
# AOFé…ç½®
appendonly yes
appendfilename "appendonly.aof"

# åŒæ­¥ç­–ç•¥
appendfsync always      # æ¯æ¬¡å†™å…¥éƒ½åŒæ­¥ï¼ˆæœ€å®‰å…¨ï¼Œæœ€æ…¢ï¼‰
appendfsync everysec    # æ¯ç§’åŒæ­¥ï¼ˆæ¨èï¼Œå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨ï¼‰
appendfsync no          # ç”±OSå†³å®šï¼ˆæœ€å¿«ï¼Œæœ€ä¸å®‰å…¨ï¼‰

# AOFé‡å†™é…ç½®
auto-aof-rewrite-percentage 100  # æ–‡ä»¶å¢é•¿100%æ—¶é‡å†™
auto-aof-rewrite-min-size 64mb   # æœ€å°64MBæ‰é‡å†™

# æ‰‹åŠ¨è§¦å‘é‡å†™
BGREWRITEAOF
```

#### AOFé‡å†™

```javascript
// AOFé‡å†™åŸç†
const aofRewrite = {
  problem: 'AOFæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§',
  solution: 'é‡å†™AOFæ–‡ä»¶ï¼Œåªä¿ç•™æ¢å¤æ•°æ®çš„æœ€å°å‘½ä»¤é›†',
  
  example: {
    before: [
      'SET key value1',
      'SET key value2',
      'SET key value3',
      'DEL key',
      'SET key value4'
    ],
    after: [
      'SET key value4'  // åªä¿ç•™æœ€ç»ˆçŠ¶æ€
    ]
  },
  
  process: [
    '1. forkå­è¿›ç¨‹',
    '2. å­è¿›ç¨‹éå†å†…å­˜æ•°æ®ï¼Œç”Ÿæˆæ–°AOFæ–‡ä»¶',
    '3. çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤ï¼Œå†™å…¥AOFç¼“å†²åŒº',
    '4. å­è¿›ç¨‹å®Œæˆåï¼Œçˆ¶è¿›ç¨‹è¿½åŠ ç¼“å†²åŒºå‘½ä»¤',
    '5. ç”¨æ–°AOFæ–‡ä»¶æ›¿æ¢æ—§æ–‡ä»¶'
  ]
};
```

### æ··åˆæŒä¹…åŒ–

```bash
# Redis 4.0+æ”¯æŒæ··åˆæŒä¹…åŒ–
aof-use-rdb-preamble yes

# AOFæ–‡ä»¶æ ¼å¼ï¼šRDBå¿«ç…§ + AOFå¢é‡å‘½ä»¤
# ä¼˜ç‚¹ï¼šç»“åˆRDBçš„å¿«é€Ÿæ¢å¤å’ŒAOFçš„æ•°æ®å®‰å…¨
```

## ä¸»ä»å¤åˆ¶

### é…ç½®ä¸»ä»

```bash
# ä¸»èŠ‚ç‚¹é…ç½®ï¼ˆmasterï¼‰
bind 0.0.0.0
port 6379
requirepass master_password

# ä»èŠ‚ç‚¹é…ç½®ï¼ˆslaveï¼‰
bind 0.0.0.0
port 6380
replicaof 127.0.0.1 6379
masterauth master_password

# ä»èŠ‚ç‚¹åªè¯»
replica-read-only yes
```

### å¤åˆ¶åŸç†

```javascript
const replicationProcess = {
  // å…¨é‡å¤åˆ¶
  fullSync: {
    step1: 'ä»èŠ‚ç‚¹å‘é€PSYNCå‘½ä»¤',
    step2: 'ä¸»èŠ‚ç‚¹æ‰§è¡ŒBGSAVEç”ŸæˆRDB',
    step3: 'ä¸»èŠ‚ç‚¹å‘é€RDBæ–‡ä»¶ç»™ä»èŠ‚ç‚¹',
    step4: 'ä¸»èŠ‚ç‚¹å‘é€å¤åˆ¶ç¼“å†²åŒºçš„å‘½ä»¤',
    step5: 'ä»èŠ‚ç‚¹æ¸…ç©ºæ•°æ®ï¼ŒåŠ è½½RDB',
    step6: 'ä»èŠ‚ç‚¹æ‰§è¡Œç¼“å†²åŒºå‘½ä»¤'
  },
  
  // å¢é‡å¤åˆ¶
  partialSync: {
    condition: 'ä»èŠ‚ç‚¹çŸ­æš‚æ–­å¼€åé‡è¿',
    step1: 'ä»èŠ‚ç‚¹å‘é€PSYNC runid offset',
    step2: 'ä¸»èŠ‚ç‚¹æ£€æŸ¥offsetæ˜¯å¦åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒº',
    step3: 'ä¸»èŠ‚ç‚¹å‘é€offsetä¹‹åçš„å‘½ä»¤',
    step4: 'ä»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤'
  },
  
  // å¤åˆ¶ç§¯å‹ç¼“å†²åŒº
  replBacklog: {
    size: '1MBï¼ˆé»˜è®¤ï¼‰',
    config: 'repl-backlog-size 1mb',
    purpose: 'ä¿å­˜æœ€è¿‘çš„å†™å‘½ä»¤ï¼Œç”¨äºå¢é‡å¤åˆ¶'
  }
};
```

### ä¸»ä»æ¶æ„

```javascript
class MasterSlaveArchitecture {
  constructor() {
    this.master = { host: '127.0.0.1', port: 6379 };
    this.slaves = [
      { host: '127.0.0.1', port: 6380 },
      { host: '127.0.0.1', port: 6381 }
    ];
  }
  
  // è¯»å†™åˆ†ç¦»
  async write(key, value) {
    // å†™æ“ä½œèµ°ä¸»èŠ‚ç‚¹
    return await this.master.set(key, value);
  }
  
  async read(key) {
    // è¯»æ“ä½œèµ°ä»èŠ‚ç‚¹ï¼ˆè½®è¯¢ï¼‰
    const slave = this.getNextSlave();
    return await slave.get(key);
  }
  
  getNextSlave() {
    const index = this.currentIndex % this.slaves.length;
    this.currentIndex++;
    return this.slaves[index];
  }
}
```

## å“¨å…µæ¨¡å¼

### å“¨å…µé…ç½®

```bash
# sentinel.conf
port 26379
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel auth-pass mymaster master_password
sentinel down-after-milliseconds mymaster 5000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000

# å¯åŠ¨å“¨å…µ
redis-sentinel /path/to/sentinel.conf
```

### å“¨å…µåŠŸèƒ½

```javascript
const sentinelFeatures = {
  // 1. ç›‘æ§
  monitoring: {
    description: 'æ£€æŸ¥ä¸»ä»èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸è¿è¡Œ',
    mechanism: 'å®šæœŸå‘é€PINGå‘½ä»¤',
    interval: '1ç§’'
  },
  
  // 2. é€šçŸ¥
  notification: {
    description: 'æ•…éšœé€šçŸ¥',
    methods: ['è„šæœ¬é€šçŸ¥', 'Pub/Subé€šçŸ¥']
  },
  
  // 3. è‡ªåŠ¨æ•…éšœè½¬ç§»
  failover: {
    trigger: 'ä¸»èŠ‚ç‚¹ä¸‹çº¿',
    process: [
      '1. ä¸»è§‚ä¸‹çº¿ï¼šå•ä¸ªå“¨å…µè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸‹çº¿',
      '2. å®¢è§‚ä¸‹çº¿ï¼šå¤šæ•°å“¨å…µè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸‹çº¿',
      '3. é€‰ä¸¾é¢†å¯¼å“¨å…µï¼šRaftç®—æ³•',
      '4. é€‰æ‹©æ–°ä¸»èŠ‚ç‚¹ï¼šä¼˜å…ˆçº§ã€å¤åˆ¶åç§»é‡ã€runid',
      '5. é€šçŸ¥ä»èŠ‚ç‚¹ï¼šå¤åˆ¶æ–°ä¸»èŠ‚ç‚¹',
      '6. é€šçŸ¥å®¢æˆ·ç«¯ï¼šæ–°ä¸»èŠ‚ç‚¹åœ°å€'
    ]
  },
  
  // 4. é…ç½®æä¾›
  configProvider: {
    description: 'å®¢æˆ·ç«¯é€šè¿‡å“¨å…µè·å–ä¸»èŠ‚ç‚¹åœ°å€',
    command: 'SENTINEL get-master-addr-by-name mymaster'
  }
};
```

### å“¨å…µé€‰ä¸»è§„åˆ™

```javascript
class SentinelElection {
  selectNewMaster(slaves) {
    // 1. è¿‡æ»¤ä¸‹çº¿å’Œæ–­çº¿çš„ä»èŠ‚ç‚¹
    let candidates = slaves.filter(s => s.isOnline && !s.isDisconnected);
    
    // 2. æŒ‰ä¼˜å…ˆçº§æ’åº
    candidates.sort((a, b) => {
      // ä¼˜å…ˆçº§é«˜çš„ä¼˜å…ˆ
      if (a.priority !== b.priority) {
        return b.priority - a.priority;
      }
      
      // å¤åˆ¶åç§»é‡å¤§çš„ä¼˜å…ˆï¼ˆæ•°æ®æ›´æ–°ï¼‰
      if (a.replOffset !== b.replOffset) {
        return b.replOffset - a.replOffset;
      }
      
      // runidå°çš„ä¼˜å…ˆ
      return a.runid.localeCompare(b.runid);
    });
    
    return candidates[0];
  }
}
```

## Clusteré›†ç¾¤

### Clusteré…ç½®

```bash
# èŠ‚ç‚¹é…ç½®
port 7000
cluster-enabled yes
cluster-config-file nodes-7000.conf
cluster-node-timeout 5000
appendonly yes

# åˆ›å»ºé›†ç¾¤
redis-cli --cluster create \
  127.0.0.1:7000 127.0.0.1:7001 \
  127.0.0.1:7002 127.0.0.1:7003 \
  127.0.0.1:7004 127.0.0.1:7005 \
  --cluster-replicas 1

# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
redis-cli -c -p 7000
CLUSTER INFO
CLUSTER NODES
```

### æ§½ä½åˆ†é…

```javascript
class ClusterSlots {
  constructor() {
    this.totalSlots = 16384;  // æ€»å…±16384ä¸ªæ§½ä½
  }
  
  // è®¡ç®—keyæ‰€å±æ§½ä½
  getSlot(key) {
    // CRC16(key) % 16384
    return this.crc16(key) % this.totalSlots;
  }
  
  // æ§½ä½åˆ†é…ç¤ºä¾‹
  allocateSlots() {
    return {
      'node1': '0-5460',      // 5461ä¸ªæ§½ä½
      'node2': '5461-10922',  // 5462ä¸ªæ§½ä½
      'node3': '10923-16383'  // 5461ä¸ªæ§½ä½
    };
  }
  
  // Hash Tagï¼šå¼ºåˆ¶keyåˆ†é…åˆ°åŒä¸€æ§½ä½
  hashTag(key) {
    // {user:1}:name å’Œ {user:1}:age ä¼šåˆ†é…åˆ°åŒä¸€æ§½ä½
    const match = key.match(/\{([^}]+)\}/);
    return match ? match[1] : key;
  }
  
  crc16(str) {
    let crc = 0;
    for (let i = 0; i < str.length; i++) {
      crc = ((crc << 8) ^ this.crc16Table[(crc >> 8) ^ str.charCodeAt(i)]) & 0xFFFF;
    }
    return crc;
  }
}
```

### é‡å®šå‘æœºåˆ¶

```javascript
class ClusterRedirection {
  async get(key) {
    const slot = this.getSlot(key);
    const node = this.getNodeBySlot(slot);
    
    try {
      return await node.get(key);
    } catch (error) {
      if (error.message.startsWith('MOVED')) {
        // æ§½ä½å·²è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹
        const [_, slot, host, port] = error.message.split(' ');
        const newNode = this.getNode(host, port);
        return await newNode.get(key);
      }
      
      if (error.message.startsWith('ASK')) {
        // æ§½ä½æ­£åœ¨è¿ç§»
        const [_, slot, host, port] = error.message.split(' ');
        const newNode = this.getNode(host, port);
        await newNode.asking();  // å‘é€ASKINGå‘½ä»¤
        return await newNode.get(key);
      }
      
      throw error;
    }
  }
}
```

### é›†ç¾¤æ‰©å®¹

```bash
# æ·»åŠ æ–°èŠ‚ç‚¹
redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000

# é‡æ–°åˆ†é…æ§½ä½
redis-cli --cluster reshard 127.0.0.1:7000
# è¾“å…¥è¦è¿ç§»çš„æ§½ä½æ•°é‡
# è¾“å…¥ç›®æ ‡èŠ‚ç‚¹ID
# è¾“å…¥æºèŠ‚ç‚¹IDï¼ˆallè¡¨ç¤ºæ‰€æœ‰èŠ‚ç‚¹ï¼‰

# æ·»åŠ ä»èŠ‚ç‚¹
redis-cli --cluster add-node 127.0.0.1:7007 127.0.0.1:7000 \
  --cluster-slave --cluster-master-id <master-node-id>
```

### é›†ç¾¤ç¼©å®¹

```bash
# è¿ç§»æ§½ä½åˆ°å…¶ä»–èŠ‚ç‚¹
redis-cli --cluster reshard 127.0.0.1:7000 \
  --cluster-from <node-id> \
  --cluster-to <target-node-id> \
  --cluster-slots <slot-count>

# åˆ é™¤èŠ‚ç‚¹
redis-cli --cluster del-node 127.0.0.1:7000 <node-id>
```

## é«˜å¯ç”¨æ–¹æ¡ˆå¯¹æ¯”

```javascript
const haComparison = {
  // ä¸»ä»å¤åˆ¶
  masterSlave: {
    pros: [
      'é…ç½®ç®€å•',
      'è¯»å†™åˆ†ç¦»',
      'æ•°æ®å¤‡ä»½'
    ],
    cons: [
      'æ— è‡ªåŠ¨æ•…éšœè½¬ç§»',
      'éœ€è¦æ‰‹åŠ¨åˆ‡æ¢',
      'å†™æ“ä½œæ— æ³•æ‰©å±•'
    ],
    useCase: 'è¯»å¤šå†™å°‘ï¼Œå¯æ¥å—æ‰‹åŠ¨åˆ‡æ¢'
  },
  
  // å“¨å…µæ¨¡å¼
  sentinel: {
    pros: [
      'è‡ªåŠ¨æ•…éšœè½¬ç§»',
      'é«˜å¯ç”¨',
      'é…ç½®ç®€å•'
    ],
    cons: [
      'å†™æ“ä½œæ— æ³•æ‰©å±•',
      'ä¸»èŠ‚ç‚¹å‹åŠ›å¤§',
      'ä¸æ”¯æŒæ•°æ®åˆ†ç‰‡'
    ],
    useCase: 'ä¸­å°è§„æ¨¡ï¼Œéœ€è¦é«˜å¯ç”¨'
  },
  
  // Clusteré›†ç¾¤
  cluster: {
    pros: [
      'æ•°æ®åˆ†ç‰‡',
      'æ°´å¹³æ‰©å±•',
      'è‡ªåŠ¨æ•…éšœè½¬ç§»',
      'é«˜å¯ç”¨'
    ],
    cons: [
      'é…ç½®å¤æ‚',
      'ä¸æ”¯æŒå¤šæ•°æ®åº“',
      'æ‰¹é‡æ“ä½œå—é™'
    ],
    useCase: 'å¤§è§„æ¨¡ï¼Œéœ€è¦æ°´å¹³æ‰©å±•'
  }
};
```

## å®¢æˆ·ç«¯å®ç°

```javascript
// Sentinelå®¢æˆ·ç«¯
class SentinelClient {
  constructor(sentinels, masterName) {
    this.sentinels = sentinels;
    this.masterName = masterName;
    this.master = null;
  }
  
  async connect() {
    // ä»å“¨å…µè·å–ä¸»èŠ‚ç‚¹åœ°å€
    for (const sentinel of this.sentinels) {
      try {
        const [host, port] = await sentinel.sentinelGetMasterAddrByName(
          this.masterName
        );
        this.master = new Redis({ host, port });
        break;
      } catch (error) {
        continue;
      }
    }
    
    // è®¢é˜…å“¨å…µé€šçŸ¥
    this.subscribeSentinel();
  }
  
  subscribeSentinel() {
    const sentinel = new Redis(this.sentinels[0]);
    sentinel.subscribe('+switch-master', (channel, message) => {
      // ä¸»èŠ‚ç‚¹åˆ‡æ¢ï¼Œæ›´æ–°è¿æ¥
      const [masterName, oldHost, oldPort, newHost, newPort] = message.split(' ');
      if (masterName === this.masterName) {
        this.master = new Redis({ host: newHost, port: newPort });
      }
    });
  }
}

// Clusterå®¢æˆ·ç«¯
class ClusterClient {
  constructor(nodes) {
    this.nodes = nodes.map(n => new Redis(n));
    this.slots = new Map();
    this.refreshSlots();
  }
  
  async refreshSlots() {
    const node = this.nodes[0];
    const slots = await node.cluster('SLOTS');
    
    for (const [start, end, master] of slots) {
      for (let i = start; i <= end; i++) {
        this.slots.set(i, master);
      }
    }
  }
  
  async get(key) {
    const slot = this.getSlot(key);
    const node = this.getNodeBySlot(slot);
    
    try {
      return await node.get(key);
    } catch (error) {
      if (error.message.startsWith('MOVED')) {
        await this.refreshSlots();
        return await this.get(key);
      }
      throw error;
    }
  }
}
```

## ç›‘æ§ä¸è¿ç»´

```bash
# æŸ¥çœ‹å¤åˆ¶ä¿¡æ¯
INFO replication

# æŸ¥çœ‹æŒä¹…åŒ–ä¿¡æ¯
INFO persistence

# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
CLUSTER INFO
CLUSTER NODES

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
SLOWLOG GET 10

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
INFO memory
MEMORY USAGE key

# æŸ¥çœ‹å®¢æˆ·ç«¯è¿æ¥
CLIENT LIST

# ç›‘æ§å‘½ä»¤æ‰§è¡Œ
MONITOR
```

## æ€»ç»“

Redisé«˜å¯ç”¨æ–¹æ¡ˆï¼š
- ğŸ’¾ **æŒä¹…åŒ–**ï¼šRDBå¿«ç…§ + AOFæ—¥å¿— + æ··åˆæŒä¹…åŒ–
- ğŸ”„ **ä¸»ä»å¤åˆ¶**ï¼šè¯»å†™åˆ†ç¦» + æ•°æ®å¤‡ä»½
- ğŸ›¡ï¸ **å“¨å…µæ¨¡å¼**ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§» + é«˜å¯ç”¨
- ğŸŒ **Clusteré›†ç¾¤**ï¼šæ•°æ®åˆ†ç‰‡ + æ°´å¹³æ‰©å±•
- ğŸ“Š **æ–¹æ¡ˆé€‰æ‹©**ï¼šæ ¹æ®è§„æ¨¡å’Œéœ€æ±‚é€‰æ‹©åˆé€‚æ–¹æ¡ˆ
- ğŸ”§ **è¿ç»´ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥ + æ€§èƒ½ä¼˜åŒ–

è®°ä½ï¼š**é€‰æ‹©åˆé€‚çš„é«˜å¯ç”¨æ–¹æ¡ˆæ˜¯ä¿è¯Redisç¨³å®šè¿è¡Œçš„å…³é”®ï¼**

