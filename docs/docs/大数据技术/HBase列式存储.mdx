---
sidebar_position: 6
title: HBase - 
---

# HBase - NoSQL

HBaseHadoopNoSQL**HBase**

## HBase

### HBase

****10IDHive

**Hive**
```sql
-- 
SELECT * FROM users WHERE user_id = 'user123';
-- 
```

**HBase**
```python
# RowKey
table.get('user123')
# 
```

### HBase vs 

|  |  | HBase |
|------|-----------|-------|
|  | GB-TB | PB |
|  | SQL | Key-Value |
|  | ACID |  |
|  |  |  |
|  |  |  |

### HBase

```
Table: users

  RowKey       Column Family: info             

 user001      name:Alice  age:25  city:Beijing 
 user002      name:Bob    age:30  city:Shanghai
 user003      name:Charlie age:35 city:Shenzhen

```

****
- **RowKey**
- **Column Family**
- **Column** `family:qualifier`
- **Timestamp**
- **Cell** `{row, column, timestamp}` 

## 

### DockerHBase

```yaml
# docker-compose.yml
version: '3'
services:
  hbase:
    image: harisekhon/hbase:1.4
    ports:
      - "16010:16010"  # HBase Master Web UI
      - "9090:9090"    # Thrift
      - "9095:9095"    # REST
      - "2181:2181"    # Zookeeper
    environment:
      - HBASE_CONF_hbase_rootdir=file:///hbase-data
```

```bash
# 
docker-compose up -d

# HBase Shell
docker exec -it hbase hbase shell

# Web UI
# http://localhost:16010
```

### HBase Shell

```bash
# 
create 'users', 'info', 'contact'

# 
list

# 
describe 'users'

# 
put 'users', 'user001', 'info:name', 'Alice'
put 'users', 'user001', 'info:age', '25'
put 'users', 'user001', 'contact:email', 'alice@example.com'

# 
get 'users', 'user001'

# 
scan 'users'

# 
delete 'users', 'user001', 'info:age'

# 
deleteall 'users', 'user001'

# 
disable 'users'
drop 'users'
```

## PythonHBase

### HappyBase

```bash
pip install happybase
```

### 

```python
import happybase

# HBase
connection = happybase.Connection('localhost', port=9090)

# 
connection.create_table(
    'users',
    {
        'info': dict(),
        'contact': dict()
    }
)

# 
table = connection.table('users')

# 
table.put('user001', {
    b'info:name': b'Alice',
    b'info:age': b'25',
    b'info:city': b'Beijing',
    b'contact:email': b'alice@example.com',
    b'contact:phone': b'13800138000'
})

# 
with table.batch() as batch:
    for i in range(1000):
        batch.put(f'user{i:06d}', {
            b'info:name': f'User{i}'.encode(),
            b'info:age': str(20 + i % 50).encode()
        })

# 
row = table.row('user001')
print(row)
# {b'info:name': b'Alice', b'info:age': b'25', ...}

# 
row = table.row('user001', columns=[b'info:name', b'info:age'])

# 
for key, data in table.scan():
    print(key, data)

# 
for key, data in table.scan(row_start='user000', row_stop='user100'):
    print(key, data)

# 
table.delete('user001', columns=[b'info:age'])

# 
table.delete('user001')

# 
connection.close()
```

## RowKey

### RowKey

**1. **RowKey

**2. **

```python
#  
rowkey = f"{timestamp}_{user_id}"
# Region

#  
import hashlib

def generate_rowkey(user_id, timestamp):
    # 1hash
    salt = hashlib.md5(user_id.encode()).hexdigest()[:4]
    return f"{salt}_{timestamp}_{user_id}"
    
    # 2
    reversed_ts = str(9999999999 - timestamp)
    return f"{user_id}_{reversed_ts}"
```

**3. **

```python
# ID
rowkey = user_id

# ID+
rowkey = f"{user_id}_{timestamp}"

# +
rowkey = f"{region}_{timestamp}_{user_id}"
```

### 

```python
import happybase
import time
import hashlib

class UserBehaviorTable:
    """"""
    
    def __init__(self, host='localhost'):
        self.connection = happybase.Connection(host, port=9090)
        self.table_name = 'user_behavior'
        self._create_table()
    
    def _create_table(self):
        """"""
        if self.table_name.encode() not in self.connection.tables():
            self.connection.create_table(
                self.table_name,
                {
                    'action': dict(),  # 
                    'item': dict(),    # 
                    'context': dict()  # 
                }
            )
    
    def generate_rowkey(self, user_id, timestamp):
        """RowKeyuser_id + """
        # 
        reversed_ts = 9999999999 - int(timestamp)
        return f"{user_id}_{reversed_ts:010d}"
    
    def put_behavior(self, user_id, action, item_id, **kwargs):
        """"""
        table = self.connection.table(self.table_name)
        
        timestamp = int(time.time())
        rowkey = self.generate_rowkey(user_id, timestamp)
        
        data = {
            b'action:type': action.encode(),
            b'action:timestamp': str(timestamp).encode(),
            b'item:id': item_id.encode(),
        }
        
        # 
        for key, value in kwargs.items():
            data[f'context:{key}'.encode()] = str(value).encode()
        
        table.put(rowkey, data)
    
    def get_user_behaviors(self, user_id, limit=100):
        """"""
        table = self.connection.table(self.table_name)
        
        # 
        row_start = f"{user_id}_"
        row_stop = f"{user_id}_~"
        
        behaviors = []
        for key, data in table.scan(row_start=row_start, row_stop=row_stop, limit=limit):
            behavior = {
                'rowkey': key.decode(),
                'action': data.get(b'action:type', b'').decode(),
                'timestamp': data.get(b'action:timestamp', b'').decode(),
                'item_id': data.get(b'item:id', b'').decode()
            }
            behaviors.append(behavior)
        
        return behaviors

# 
behavior_table = UserBehaviorTable()

# 
behavior_table.put_behavior('user001', 'view', 'item123', page='home')
behavior_table.put_behavior('user001', 'click', 'item123', page='detail')
behavior_table.put_behavior('user001', 'cart', 'item123')

# 
behaviors = behavior_table.get_user_behaviors('user001')
for b in behaviors:
    print(b)
```

## 

### 

```python
import happybase

connection = happybase.Connection('localhost', port=9090)
table = connection.table('users')

# 1. 
# 
for key, data in table.scan(row_prefix=b'user00'):
    print(key, data)

# 2. 
# 
for key, data in table.scan(columns=[b'info']):
    print(key, data)

# 3. Thrift2
# 
filter_string = "SingleColumnValueFilter('info', 'age', >=, 'binary:25')"

# 4. 
# 
import time
now = int(time.time() * 1000)
one_day_ago = now - 86400000

for key, data in table.scan(timestamp=one_day_ago):
    print(key, data)
```

## 

### 1

```python
import happybase
import json
from datetime import datetime

class UserProfileSystem:
    """"""
    
    def __init__(self, host='localhost'):
        self.connection = happybase.Connection(host, port=9090)
        self.table_name = 'user_profile'
        self._create_table()
    
    def _create_table(self):
        """"""
        if self.table_name.encode() not in self.connection.tables():
            self.connection.create_table(
                self.table_name,
                {
                    'basic': dict(),      # 
                    'behavior': dict(),   # 
                    'preference': dict(), # 
                    'stats': dict()       # 
                }
            )
    
    def update_profile(self, user_id, **kwargs):
        """"""
        table = self.connection.table(self.table_name)
        
        data = {}
        for key, value in kwargs.items():
            family, qualifier = key.split('_', 1)
            data[f'{family}:{qualifier}'.encode()] = str(value).encode()
        
        table.put(user_id, data)
    
    def get_profile(self, user_id):
        """"""
        table = self.connection.table(self.table_name)
        row = table.row(user_id)
        
        profile = {}
        for key, value in row.items():
            key_str = key.decode()
            profile[key_str] = value.decode()
        
        return profile
    
    def update_behavior_stats(self, user_id, action, item_category):
        """"""
        table = self.connection.table(self.table_name)
        
        # 
        row = table.row(user_id)
        
        # 
        view_count_key = b'behavior:view_count'
        view_count = int(row.get(view_count_key, b'0'))
        
        # 
        category_key = f'preference:{item_category}'.encode()
        category_count = int(row.get(category_key, b'0'))
        
        # 
        table.put(user_id, {
            view_count_key: str(view_count + 1).encode(),
            category_key: str(category_count + 1).encode(),
            b'stats:last_active': datetime.now().isoformat().encode()
        })
    
    def get_top_preferences(self, user_id, top_n=5):
        """Top"""
        table = self.connection.table(self.table_name)
        row = table.row(user_id, columns=[b'preference'])
        
        preferences = {}
        for key, value in row.items():
            category = key.decode().split(':')[1]
            count = int(value.decode())
            preferences[category] = count
        
        # 
        sorted_prefs = sorted(preferences.items(), key=lambda x: x[1], reverse=True)
        return sorted_prefs[:top_n]

# 
profile_system = UserProfileSystem()

# 
profile_system.update_profile(
    'user001',
    basic_name='Alice',
    basic_age='25',
    basic_city='Beijing'
)

# 
profile_system.update_behavior_stats('user001', 'view', 'electronics')
profile_system.update_behavior_stats('user001', 'view', 'electronics')
profile_system.update_behavior_stats('user001', 'view', 'books')

# 
profile = profile_system.get_profile('user001')
print(":", profile)

# 
preferences = profile_system.get_top_preferences('user001')
print("Top:", preferences)
```

### 2

```python
import happybase
import time
from datetime import datetime

class TimeSeriesDB:
    """"""
    
    def __init__(self, host='localhost'):
        self.connection = happybase.Connection(host, port=9090)
        self.table_name = 'metrics'
        self._create_table()
    
    def _create_table(self):
        """"""
        if self.table_name.encode() not in self.connection.tables():
            self.connection.create_table(
                self.table_name,
                {
                    'data': dict(max_versions=100)  # 100
                }
            )
    
    def generate_rowkey(self, metric_name, timestamp):
        """RowKeymetric_name + """
        # 
        hour_bucket = int(timestamp / 3600) * 3600
        return f"{metric_name}_{hour_bucket}"
    
    def put_metric(self, metric_name, value, timestamp=None):
        """"""
        if timestamp is None:
            timestamp = int(time.time())
        
        table = self.connection.table(self.table_name)
        rowkey = self.generate_rowkey(metric_name, timestamp)
        
        # timestamp
        table.put(rowkey, {
            f'data:{timestamp}'.encode(): str(value).encode()
        })
    
    def get_metrics(self, metric_name, start_time, end_time):
        """"""
        table = self.connection.table(self.table_name)
        
        # 
        start_bucket = int(start_time / 3600) * 3600
        end_bucket = int(end_time / 3600) * 3600
        
        metrics = []
        
        # 
        for bucket in range(start_bucket, end_bucket + 3600, 3600):
            rowkey = f"{metric_name}_{bucket}"
            
            try:
                row = table.row(rowkey)
                for key, value in row.items():
                    timestamp = int(key.decode().split(':')[1])
                    if start_time <= timestamp <= end_time:
                        metrics.append({
                            'timestamp': timestamp,
                            'value': float(value.decode())
                        })
            except:
                continue
        
        # 
        metrics.sort(key=lambda x: x['timestamp'])
        return metrics

# 
tsdb = TimeSeriesDB()

# CPU
for i in range(100):
    tsdb.put_metric('cpu_usage', 50 + i % 30, int(time.time()) - 100 + i)

# 100
start = int(time.time()) - 100
end = int(time.time())
metrics = tsdb.get_metrics('cpu_usage', start, end)

print(f" {len(metrics)} ")
for m in metrics[:5]:
    print(f": {datetime.fromtimestamp(m['timestamp'])}, : {m['value']}")
```

## 

### 1. 

```python
# 
connection.create_table(
    'users',
    {'info': dict()},
    split_keys=[b'user100', b'user200', b'user300']
)
```

### 2. 

```python
# 
with table.batch(batch_size=1000) as batch:
    for i in range(10000):
        batch.put(f'key{i}', {b'cf:col': b'value'})

# 
rows = table.rows([b'key1', b'key2', b'key3'])
```

### 3. 

```python
# 
connection.create_table(
    'users',
    {
        'info': dict(bloom_filter_type='ROW')
    }
)
```

## 

HBase

1. ****RowKey
2. ****PB
3. ****schema
4. ****

**HBaseKey**

## 

1. 
2. 
3. 
4. 



