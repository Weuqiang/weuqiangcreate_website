---
sidebar_position: 6
title: MongoDB
tags: [, MongoDB, NoSQL, ]
---

# MongoDB

MongoDBNoSQLMongoDBCRUD

## 

```javascript
const mongodbConcepts = {
  // 
  dataModel: {
    database: '',
    collection: '',
    document: '',
    field: ''
  },
  
  // 
  document: {
    _id: 'ObjectId("507f1f77bcf86cd799439011")',  // 
    name: 'John',
    age: 30,
    tags: ['tech', 'music'],  // 
    address: {                 // 
      city: 'Beijing',
      country: 'China'
    }
  },
  
  // 
  features: [
    '',
    '',
    '',
    '',
    ''
  ]
};
```

## CRUD

### 

```javascript
// 
db.users.insertOne({
  name: 'John',
  age: 30,
  email: 'john@example.com',
  tags: ['tech', 'music'],
  createdAt: new Date()
});

// 
db.users.insertMany([
  { name: 'Alice', age: 25 },
  { name: 'Bob', age: 35 },
  { name: 'Charlie', age: 28 }
]);

// Node.js
const { MongoClient } = require('mongodb');

class UserRepository {
  constructor(client) {
    this.collection = client.db('mydb').collection('users');
  }
  
  async create(user) {
    const result = await this.collection.insertOne({
      ...user,
      createdAt: new Date(),
      updatedAt: new Date()
    });
    
    return result.insertedId;
  }
  
  async createMany(users) {
    const result = await this.collection.insertMany(
      users.map(u => ({
        ...u,
        createdAt: new Date(),
        updatedAt: new Date()
      }))
    );
    
    return result.insertedIds;
  }
}
```

### 

```javascript
// 
db.users.find({});

// 
db.users.find({ age: 30 });
db.users.find({ age: { $gt: 25 } });  // age > 25
db.users.find({ age: { $gte: 25, $lte: 35 } });  // 25 <= age <= 35

// 
db.users.find({
  $or: [
    { age: { $lt: 25 } },
    { age: { $gt: 35 } }
  ]
});

db.users.find({
  $and: [
    { age: { $gte: 25 } },
    { tags: 'tech' }
  ]
});

// 
db.users.find({ tags: 'tech' });  // tech
db.users.find({ tags: { $all: ['tech', 'music'] } });  // 
db.users.find({ tags: { $size: 2 } });  // 2

// 
db.users.find({ 'address.city': 'Beijing' });

// 
db.users.find({ name: /^John/ });

// 
db.users.find({}, { name: 1, age: 1, _id: 0 });

// 
db.users.find({}).sort({ age: 1 });  // 
db.users.find({}).sort({ age: -1 }); // 

// 
db.users.find({})
  .skip(20)
  .limit(10);

// 
db.users.countDocuments({ age: { $gt: 25 } });

// Node.js
class UserRepository {
  async findById(id) {
    return await this.collection.findOne({
      _id: new ObjectId(id)
    });
  }
  
  async findByEmail(email) {
    return await this.collection.findOne({ email });
  }
  
  async findAll(options = {}) {
    const {
      filter = {},
      page = 1,
      pageSize = 20,
      sort = { createdAt: -1 }
    } = options;
    
    const skip = (page - 1) * pageSize;
    
    const [items, total] = await Promise.all([
      this.collection
        .find(filter)
        .sort(sort)
        .skip(skip)
        .limit(pageSize)
        .toArray(),
      this.collection.countDocuments(filter)
    ]);
    
    return {
      items,
      total,
      page,
      pageSize,
      totalPages: Math.ceil(total / pageSize)
    };
  }
}
```

### 

```javascript
// 
db.users.updateOne(
  { name: 'John' },
  { $set: { age: 31 } }
);

// 
db.users.updateMany(
  { age: { $lt: 25 } },
  { $set: { status: 'young' } }
);

// 
db.users.updateOne(
  { name: 'John' },
  {
    $set: { age: 31 },           // 
    $inc: { views: 1 },          // 
    $push: { tags: 'sports' },   // 
    $pull: { tags: 'music' },    // 
    $addToSet: { tags: 'tech' }, // 
    $unset: { temp: '' },        // 
    $currentDate: { updatedAt: true }  // 
  }
);

// 
db.users.replaceOne(
  { name: 'John' },
  {
    name: 'John',
    age: 31,
    email: 'john@example.com'
  }
);

// upsert
db.users.updateOne(
  { email: 'john@example.com' },
  { $set: { name: 'John', age: 30 } },
  { upsert: true }
);

// Node.js
class UserRepository {
  async update(id, updates) {
    const result = await this.collection.updateOne(
      { _id: new ObjectId(id) },
      {
        $set: {
          ...updates,
          updatedAt: new Date()
        }
      }
    );
    
    return result.modifiedCount > 0;
  }
  
  async incrementViews(id) {
    await this.collection.updateOne(
      { _id: new ObjectId(id) },
      {
        $inc: { views: 1 },
        $set: { updatedAt: new Date() }
      }
    );
  }
  
  async addTag(id, tag) {
    await this.collection.updateOne(
      { _id: new ObjectId(id) },
      {
        $addToSet: { tags: tag },
        $set: { updatedAt: new Date() }
      }
    );
  }
}
```

### 

```javascript
// 
db.users.deleteOne({ name: 'John' });

// 
db.users.deleteMany({ age: { $lt: 18 } });

// 
db.users.deleteMany({});

// Node.js
class UserRepository {
  async delete(id) {
    const result = await this.collection.deleteOne({
      _id: new ObjectId(id)
    });
    
    return result.deletedCount > 0;
  }
  
  async deleteByEmail(email) {
    const result = await this.collection.deleteOne({ email });
    return result.deletedCount > 0;
  }
}
```

## 

```javascript
// 
db.orders.aggregate([
  // 1. 
  { $match: { status: 'completed' } },
  
  // 2. 
  {
    $group: {
      _id: '$userId',
      totalAmount: { $sum: '$amount' },
      orderCount: { $sum: 1 },
      avgAmount: { $avg: '$amount' }
    }
  },
  
  // 3. 
  { $sort: { totalAmount: -1 } },
  
  // 4. 
  { $limit: 10 },
  
  // 5. 
  {
    $lookup: {
      from: 'users',
      localField: '_id',
      foreignField: '_id',
      as: 'user'
    }
  },
  
  // 6. 
  { $unwind: '$user' },
  
  // 7. 
  {
    $project: {
      userName: '$user.name',
      totalAmount: 1,
      orderCount: 1,
      avgAmount: 1
    }
  }
]);

// 
class OrderAnalytics {
  async getUserOrderStats(startDate, endDate) {
    return await db.orders.aggregate([
      // 
      {
        $match: {
          createdAt: {
            $gte: startDate,
            $lte: endDate
          },
          status: 'completed'
        }
      },
      
      // 
      {
        $group: {
          _id: '$userId',
          totalAmount: { $sum: '$amount' },
          orderCount: { $sum: 1 },
          avgAmount: { $avg: '$amount' },
          maxAmount: { $max: '$amount' },
          minAmount: { $min: '$amount' }
        }
      },
      
      // 
      {
        $lookup: {
          from: 'users',
          localField: '_id',
          foreignField: '_id',
          as: 'user'
        }
      },
      
      { $unwind: '$user' },
      
      // 
      {
        $addFields: {
          userName: '$user.name',
          userEmail: '$user.email'
        }
      },
      
      // 
      { $sort: { totalAmount: -1 } },
      
      // 
      { $skip: 0 },
      { $limit: 20 }
    ]).toArray();
  }
  
  async getDailySales(startDate, endDate) {
    return await db.orders.aggregate([
      {
        $match: {
          createdAt: { $gte: startDate, $lte: endDate },
          status: 'completed'
        }
      },
      
      // 
      {
        $group: {
          _id: {
            $dateToString: {
              format: '%Y-%m-%d',
              date: '$createdAt'
            }
          },
          totalAmount: { $sum: '$amount' },
          orderCount: { $sum: 1 }
        }
      },
      
      { $sort: { _id: 1 } }
    ]).toArray();
  }
}
```

## 

### 

```javascript
// 
db.users.createIndex({ email: 1 });  // 
db.users.createIndex({ age: -1 });   // 

// 
db.users.createIndex({ name: 1, age: -1 });

// 
db.users.createIndex({ email: 1 }, { unique: true });

// 
db.users.createIndex({ phone: 1 }, { sparse: true });

// TTL
db.sessions.createIndex(
  { createdAt: 1 },
  { expireAfterSeconds: 3600 }  // 1
);

// 
db.articles.createIndex({ title: 'text', content: 'text' });

// 
db.places.createIndex({ location: '2dsphere' });

// 
db.users.getIndexes();

// 
db.users.dropIndex('email_1');
db.users.dropIndexes();  // _id
```

### 

```javascript
class IndexStrategy {
  // 1. 
  async createQueryIndexes() {
    // 
    await db.users.createIndex({ email: 1 });
    
    // 
    await db.orders.createIndex({ createdAt: -1 });
    
    // 
    await db.products.createIndex({ price: 1 });
  }
  
  // 2. 
  async createCompoundIndexes() {
    //  + 
    await db.orders.createIndex({
      userId: 1,
      createdAt: -1
    });
    
    // 
    await db.orders.createIndex({
      status: 1,      // 
      amount: 1       // 
    });
  }
  
  // 3. 
  async createCoveringIndexes() {
    // 
    await db.users.createIndex({
      email: 1,
      name: 1,
      age: 1
    });
    
    // db.users.find({ email: 'john@example.com' }, { name: 1, age: 1, _id: 0 })
    // 
  }
  
  // 4. 
  async analyzeQuery() {
    const explain = await db.users
      .find({ email: 'john@example.com' })
      .explain('executionStats');
    
    console.log({
      executionTimeMs: explain.executionStats.executionTimeMillis,
      totalDocsExamined: explain.executionStats.totalDocsExamined,
      totalKeysExamined: explain.executionStats.totalKeysExamined,
      indexUsed: explain.executionStats.executionStages.indexName
    });
  }
}
```

## 

###  vs 

```javascript
// 1. 
const userWithEmbedded = {
  _id: ObjectId('...'),
  name: 'John',
  email: 'john@example.com',
  address: {
    street: '123 Main St',
    city: 'Beijing',
    country: 'China'
  },
  phones: [
    { type: 'home', number: '123-456-7890' },
    { type: 'work', number: '098-765-4321' }
  ]
};

// 
// 16MB

// 2. 
const userWithReference = {
  _id: ObjectId('user1'),
  name: 'John',
  email: 'john@example.com'
};

const orders = [
  {
    _id: ObjectId('order1'),
    userId: ObjectId('user1'),
    amount: 100
  },
  {
    _id: ObjectId('order2'),
    userId: ObjectId('user1'),
    amount: 200
  }
];

// 
// $lookup

// 3. 
const blogPost = {
  _id: ObjectId('...'),
  title: 'MongoDB Guide',
  content: '...',
  author: {
    _id: ObjectId('user1'),
    name: 'John'  // 
  },
  comments: [
    {
      _id: ObjectId('...'),
      userId: ObjectId('user2'),
      userName: 'Alice',  // 
      content: 'Great post!',
      createdAt: new Date()
    }
  ]
};
```

### 

```javascript
// 1. 
const product = {
  _id: ObjectId('...'),
  name: 'Laptop',
  specs: [
    { key: 'CPU', value: 'Intel i7' },
    { key: 'RAM', value: '16GB' },
    { key: 'Storage', value: '512GB SSD' }
  ]
};

// 
db.products.createIndex({ 'specs.key': 1, 'specs.value': 1 });

// 2. 
const sensorData = {
  _id: ObjectId('...'),
  sensorId: 'sensor1',
  date: '2024-01-01',
  measurements: [
    { time: '00:00:00', temperature: 20, humidity: 60 },
    { time: '00:01:00', temperature: 20.5, humidity: 61 },
    // ... 1440
  ]
};

// 3. 
const article = {
  _id: ObjectId('...'),
  title: 'MongoDB Guide',
  content: '...',
  stats: {
    views: 1000,
    likes: 50,
    comments: 10
  }
};

// 
db.articles.updateOne(
  { _id: articleId },
  { $inc: { 'stats.views': 1 } }
);
```

## 

```javascript
// MongoDB 4.0+
const session = client.startSession();

try {
  await session.withTransaction(async () => {
    // 
    await db.accounts.updateOne(
      { _id: fromAccountId },
      { $inc: { balance: -amount } },
      { session }
    );
    
    // 
    await db.accounts.updateOne(
      { _id: toAccountId },
      { $inc: { balance: amount } },
      { session }
    );
    
    // 
    await db.transactions.insertOne(
      {
        from: fromAccountId,
        to: toAccountId,
        amount,
        createdAt: new Date()
      },
      { session }
    );
  });
  
  console.log('Transaction committed');
} catch (error) {
  console.error('Transaction aborted:', error);
} finally {
  await session.endSession();
}
```

## 

```javascript
// 
rs.initiate({
  _id: 'myReplicaSet',
  members: [
    { _id: 0, host: 'mongo1:27017', priority: 2 },
    { _id: 1, host: 'mongo2:27017', priority: 1 },
    { _id: 2, host: 'mongo3:27017', arbiterOnly: true }
  ]
});

// 
rs.status();

// 
const client = new MongoClient(uri, {
  readPreference: 'secondaryPreferred'  // 
});

// 
await collection.insertOne(
  { name: 'John' },
  { writeConcern: { w: 'majority', j: true } }
);
```

## 

```javascript
// 
sh.enableSharding('mydb');

// 
sh.shardCollection('mydb.users', { userId: 'hashed' });

// 
sh.status();

// 
const shardingStrategies = {
  // 1. 
  hashed: {
    key: { userId: 'hashed' },
    pros: '',
    cons: ''
  },
  
  // 2. 
  ranged: {
    key: { createdAt: 1 },
    pros: '',
    cons: ''
  },
  
  // 3. 
  compound: {
    key: { country: 1, userId: 1 },
    pros: '',
    cons: ''
  }
};
```

## 

```javascript
const optimizationTips = {
  // 1. 
  projection: async () => {
    //  
    await db.users.find({});
    
    //  
    await db.users.find({}, { name: 1, email: 1 });
  },
  
  // 2. 
  indexing: async () => {
    // 
    await db.users.createIndex({ email: 1 });
    
    // 
    const explain = await db.users.find({ email: 'john@example.com' }).explain();
  },
  
  // 3. 
  limiting: async () => {
    await db.users.find({}).limit(100);
  },
  
  // 4. 
  bulkOps: async () => {
    const bulk = db.users.initializeUnorderedBulkOp();
    bulk.insert({ name: 'User1' });
    bulk.insert({ name: 'User2' });
    bulk.insert({ name: 'User3' });
    await bulk.execute();
  },
  
  // 5. 
  documentSize: {
    problem: '16MB',
    solution: 'GridFS'
  }
};
```

## 

MongoDB
-  ****JSON
-  ****
-  ****
-  **** vs 
-  ****
-  ****

**MongoDB**

