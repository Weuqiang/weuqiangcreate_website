---
sidebar_position: 4
title: MySQL
tags: [, MySQL, , ]
---

# MySQL

MySQL

## EXPLAIN

### 

```sql
-- 
EXPLAIN SELECT * FROM orders WHERE user_id = 1;

-- 
/*
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+--------+------+---------------+------+---------+------+------+-------------+
*/

-- 
```

#### 1. id - 

```sql
-- 
EXPLAIN SELECT * FROM users WHERE id = 1;
-- id = 1

-- 
EXPLAIN SELECT * FROM users 
WHERE id IN (SELECT user_id FROM orders);
-- id = 1 ()
-- id = 2 ()

-- 
EXPLAIN 
SELECT * FROM users WHERE id = 1
UNION
SELECT * FROM users WHERE id = 2;
-- id = 1 ()
-- id = 2 ()
```

#### 2. select_type - 

```sql
-- SIMPLE
EXPLAIN SELECT * FROM users WHERE id = 1;

-- PRIMARY
EXPLAIN SELECT * FROM users 
WHERE id IN (SELECT user_id FROM orders);

-- SUBQUERY
EXPLAIN SELECT * FROM users 
WHERE id = (SELECT MAX(user_id) FROM orders);

-- DERIVED
EXPLAIN SELECT * FROM (
    SELECT * FROM users WHERE age > 18
) AS adults;

-- UNION
EXPLAIN 
SELECT * FROM users WHERE id = 1
UNION
SELECT * FROM users WHERE id = 2;
```

#### 3. type - 

```sql
-- system
-- 

-- const
EXPLAIN SELECT * FROM users WHERE id = 1;
-- type: const

-- eq_ref
EXPLAIN SELECT * FROM orders o
JOIN users u ON o.user_id = u.id;
-- type: eq_ref

-- ref
EXPLAIN SELECT * FROM users WHERE name = 'John';
-- type: ref

-- range
EXPLAIN SELECT * FROM users WHERE age > 18;
-- type: range

-- index
EXPLAIN SELECT id FROM users;
-- type: index

-- ALL
EXPLAIN SELECT * FROM users WHERE email LIKE '%@gmail.com';
-- type: ALL

-- system > const > eq_ref > ref > range > index > ALL
```

#### 4. possible_keys  key

```sql
-- possible_keys
-- key

CREATE INDEX idx_name ON users(name);
CREATE INDEX idx_age ON users(age);

EXPLAIN SELECT * FROM users WHERE name = 'John' AND age > 18;
-- possible_keys: idx_name, idx_age
-- key: idx_name (MySQLname)
```

#### 5. rows - 

```sql
-- 
EXPLAIN SELECT * FROM users WHERE age > 18;
-- rows: 50000 (5)

-- 
CREATE INDEX idx_age ON users(age);
EXPLAIN SELECT * FROM users WHERE age > 18;
-- rows: 10000 (1)
```

#### 6. Extra - 

```sql
-- Using index
CREATE INDEX idx_name_age ON users(name, age);
EXPLAIN SELECT name, age FROM users WHERE name = 'John';
-- Extra: Using index

-- Using whereWHERE
EXPLAIN SELECT * FROM users WHERE age > 18;
-- Extra: Using where

-- Using filesort
EXPLAIN SELECT * FROM users ORDER BY age;
-- Extra: Using filesort

-- 
CREATE INDEX idx_age ON users(age);
EXPLAIN SELECT * FROM users ORDER BY age;
-- Extra: Using index

-- Using temporary
EXPLAIN SELECT DISTINCT name FROM users;
-- Extra: Using temporary

-- Using index condition
CREATE INDEX idx_name_age ON users(name, age);
EXPLAIN SELECT * FROM users WHERE name LIKE 'John%' AND age > 18;
-- Extra: Using index condition
```

## 

### 1. 

```sql
-- 
SHOW VARIABLES LIKE 'slow_query%';
SHOW VARIABLES LIKE 'long_query_time';

-- 
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
SET GLOBAL long_query_time = 1;  -- 1

-- 
SHOW GLOBAL STATUS LIKE 'Slow_queries';
```

### 2. 

```bash
# mysqldumpslow
mysqldumpslow -s t -t 10 /var/log/mysql/slow.log

# 
# -s: t:, c:, l:
# -t: N
# -g: 

# pt-query-digest
pt-query-digest /var/log/mysql/slow.log
```

### 3. 

#### 1SELECT *

```sql
--  
SELECT * FROM users WHERE id = 1;

--  
SELECT id, name, email FROM users WHERE id = 1;

-- 
-- SELECT *: 
-- SELECT : 
```

#### 2JOIN

```sql
--  
SELECT * FROM orders, users 
WHERE orders.user_id = users.id;

--  JOIN
SELECT * FROM orders 
INNER JOIN users ON orders.user_id = users.id;

--  JOIN
SELECT * FROM orders o
JOIN order_items oi ON o.id = oi.order_id;

--  JOIN
SELECT * FROM orders o
JOIN order_items oi ON o.id = oi.order_id
WHERE o.created_at > '2024-01-01';

--  
SELECT * FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.id IN (1, 2, 3);
```

#### 3

```sql
--  
SELECT * FROM users 
WHERE id IN (
    SELECT user_id FROM orders WHERE amount > 1000
);

--  JOIN
SELECT DISTINCT u.* FROM users u
INNER JOIN orders o ON u.id = o.user_id
WHERE o.amount > 1000;

--  
SELECT u.*, (
    SELECT COUNT(*) FROM orders WHERE user_id = u.id
) AS order_count
FROM users u;

--  JOIN + GROUP BY
SELECT u.*, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id;
```

#### 4

```sql
--  
SELECT * FROM users ORDER BY id LIMIT 1000000, 10;
-- 1000010

--   + 
SELECT * FROM users u
INNER JOIN (
    SELECT id FROM users ORDER BY id LIMIT 1000000, 10
) AS t ON u.id = t.id;

--  
SELECT * FROM users 
WHERE id > 1000000 
ORDER BY id 
LIMIT 10;

--  
SELECT * FROM users 
WHERE created_at > '2024-01-01 00:00:00'
ORDER BY created_at 
LIMIT 10;
```

#### 5COUNT

```sql
--  COUNT(*)
SELECT COUNT(*) FROM users;

--  
SELECT table_rows FROM information_schema.tables
WHERE table_name = 'users';

--  
-- Redis
SET user:count 1000000 EX 3600

--  
CREATE TABLE counters (
    name VARCHAR(50) PRIMARY KEY,
    count BIGINT
);

INSERT INTO counters VALUES ('users', 0);

-- 
INSERT INTO users (...) VALUES (...);
UPDATE counters SET count = count + 1 WHERE name = 'users';
```

## 

### 1. 

```sql
-- 
CREATE TABLE orders (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    status VARCHAR(20),
    amount DECIMAL(10,2),
    created_at TIMESTAMP,
    INDEX idx_user_status (user_id, status),
    INDEX idx_created (created_at)
);

--  idx_user_status
SELECT * FROM orders WHERE user_id = 1;
SELECT * FROM orders WHERE user_id = 1 AND status = 'paid';

--  idx_user_status
SELECT * FROM orders WHERE status = 'paid';

-- 
CREATE INDEX idx_status_user ON orders(status, user_id);

--  
SELECT user_id, status FROM orders WHERE user_id = 1;
-- Extra: Using index

--  
SELECT * FROM orders WHERE user_id = 1 ORDER BY status;
-- Extra: Using index
```

### 2. 

```sql
-- 
SELECT 
    COUNT(DISTINCT LEFT(email, 5)) / COUNT(*) AS sel_5,
    COUNT(DISTINCT LEFT(email, 10)) / COUNT(*) AS sel_10,
    COUNT(DISTINCT LEFT(email, 15)) / COUNT(*) AS sel_15,
    COUNT(DISTINCT email) / COUNT(*) AS sel_full
FROM users;

-- 
-- sel_5: 0.85
-- sel_10: 0.98
-- sel_15: 0.99
-- sel_full: 1.00

-- 10
CREATE INDEX idx_email_prefix ON users(email(10));
```

### 3. 

```sql
-- 
CREATE INDEX idx_name ON users(name);
CREATE INDEX idx_age ON users(age);

-- 
EXPLAIN SELECT * FROM users WHERE name = 'John' AND age > 18;
-- Extra: Using intersect(idx_name, idx_age)

-- 
CREATE INDEX idx_name_age ON users(name, age);
EXPLAIN SELECT * FROM users WHERE name = 'John' AND age > 18;
-- key: idx_name_age
```

## 

### 1. ORUNION

```sql
--  OR
SELECT * FROM users WHERE name = 'John' OR email = 'john@example.com';

--  UNION
SELECT * FROM users WHERE name = 'John'
UNION
SELECT * FROM users WHERE email = 'john@example.com';
```

### 2. INEXISTS

```sql
--  IN
SELECT * FROM users 
WHERE id IN (SELECT user_id FROM orders WHERE amount > 1000);

--  EXISTS
SELECT * FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o 
    WHERE o.user_id = u.id AND o.amount > 1000
);
```

### 3. 

```sql
--  
SELECT * FROM users WHERE YEAR(created_at) = 2024;

--  
SELECT * FROM users 
WHERE created_at >= '2024-01-01' 
  AND created_at < '2025-01-01';

--  
SELECT * FROM users WHERE phone = 12345678;

--  
SELECT * FROM users WHERE phone = '12345678';
```

### 4. LIKE

```sql
--  
SELECT * FROM users WHERE name LIKE '%John';

--  
SELECT * FROM users WHERE name LIKE 'John%';

--  
CREATE FULLTEXT INDEX idx_name_fulltext ON users(name);
SELECT * FROM users WHERE MATCH(name) AGAINST('John');
```

## 

### 1. 

```sql
--  
CREATE TABLE users (
    id BIGINT,              -- INT
    name VARCHAR(255),      -- 50VARCHAR(50)
    age TINYINT UNSIGNED,   --  0-255
    balance DECIMAL(20,2)   -- DECIMAL(10,2)
);

--  
CREATE TABLE users (
    id INT UNSIGNED,
    name VARCHAR(50),
    age TINYINT UNSIGNED,
    balance DECIMAL(10,2)
);

-- 
-- 1. 
-- 2. INTVARCHAR
-- 3. NULLNOT NULL + DEFAULT
```

### 2. 

```sql
--  
CREATE TABLE articles (
    id BIGINT PRIMARY KEY,
    title VARCHAR(200),
    author VARCHAR(50),
    content TEXT,           -- 
    views INT,
    created_at TIMESTAMP
);

--  
CREATE TABLE articles (
    id BIGINT PRIMARY KEY,
    title VARCHAR(200),
    author VARCHAR(50),
    views INT,
    created_at TIMESTAMP
);

CREATE TABLE article_content (
    article_id BIGINT PRIMARY KEY,
    content TEXT,
    FOREIGN KEY (article_id) REFERENCES articles(id)
);
```

### 3. 

```sql
-- 
CREATE TABLE orders_2024_01 (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    amount DECIMAL(10,2),
    created_at TIMESTAMP
);

CREATE TABLE orders_2024_02 (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    amount DECIMAL(10,2),
    created_at TIMESTAMP
);

-- 
CREATE TABLE users_0 (  -- id % 10 = 0
    id BIGINT PRIMARY KEY,
    name VARCHAR(50)
);

CREATE TABLE users_1 (  -- id % 10 = 1
    id BIGINT PRIMARY KEY,
    name VARCHAR(50)
);
```

## 

### 1. 

```sql
--  
INSERT INTO users (name) VALUES ('User1');
INSERT INTO users (name) VALUES ('User2');
INSERT INTO users (name) VALUES ('User3');

--  
INSERT INTO users (name) VALUES 
('User1'), ('User2'), ('User3');

--  LOAD DATA
LOAD DATA INFILE '/tmp/users.csv'
INTO TABLE users
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n';
```

### 2. 

```sql
--  
UPDATE users SET status = 'active' WHERE id = 1;
UPDATE users SET status = 'active' WHERE id = 2;
UPDATE users SET status = 'active' WHERE id = 3;

--  
UPDATE users SET status = 'active' WHERE id IN (1, 2, 3);

--  CASE WHEN
UPDATE users SET status = CASE
    WHEN id = 1 THEN 'active'
    WHEN id = 2 THEN 'inactive'
    WHEN id = 3 THEN 'pending'
END
WHERE id IN (1, 2, 3);
```

## 

```sql
-- 
SHOW PROCESSLIST;

-- 
SHOW TABLE STATUS LIKE 'users';

-- 
SHOW INDEX FROM users;

-- 
SELECT 
    TABLE_NAME,
    ROUND((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024, 2) AS size_mb
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA = 'your_database'
ORDER BY size_mb DESC;

-- 
SELECT 
    TABLE_NAME,
    DATA_FREE / (DATA_LENGTH + INDEX_LENGTH) AS fragmentation
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA = 'your_database'
    AND DATA_FREE > 0;

-- 
OPTIMIZE TABLE users;
```

## 

```javascript
// Node.js
class QueryBenchmark {
  async benchmark(query, iterations = 1000) {
    const times = [];
    
    for (let i = 0; i < iterations; i++) {
      const start = Date.now();
      await db.query(query);
      const end = Date.now();
      times.push(end - start);
    }
    
    return {
      avg: times.reduce((a, b) => a + b) / times.length,
      min: Math.min(...times),
      max: Math.max(...times),
      p95: this.percentile(times, 0.95),
      p99: this.percentile(times, 0.99)
    };
  }
  
  percentile(arr, p) {
    const sorted = arr.sort((a, b) => a - b);
    const index = Math.ceil(sorted.length * p) - 1;
    return sorted[index];
  }
}

// 
const benchmark = new QueryBenchmark();

const result1 = await benchmark.benchmark(
  'SELECT * FROM users WHERE id = 1'
);

const result2 = await benchmark.benchmark(
  'SELECT id, name FROM users WHERE id = 1'
);

console.log('Query 1:', result1);
console.log('Query 2:', result2);
```

## 

MySQL
-  **EXPLAIN**
-  ****
-  ****
-  ****SQL
-  ****
-  ****

****

