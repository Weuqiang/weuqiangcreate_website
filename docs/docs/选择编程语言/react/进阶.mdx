
# 

## Fiber

ReactV16FiberFiberFiber

JSGUIJSGUI16.6GUIJS16.6

ReactFiberGUI

ReactFiberCoroutineES6GeneratorReactFiberGUI

Fiber6

ABReactAA

FiberReact“Render/Reconciliation phase”"Commit phase"ReactDOMReact

“Render/Reconciliation phase”ABA

componentWillMountReact"Render/Reconciliation phase"componentWillMount

## Diff

[](https://zhuanlan.zhihu.com/p/20346379)

1. Web UI  DOM 
2. 
3.  id 



ReactVue

> **tree diff**
>
> React 
>
>  DOM React  updateDepth  Virtual DOM  DOM  DOM 



React



## (SSR)

[](https://github.com/Messiahhh/react-ssr-demo)

****************

********

`react-dom/server``renderToString``react-dom``hydrate`

``` jsx
// server.js 
import { renderToString } from 'react-dom/server'

const content = renderToString(<App />)
ctx.body = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>React App</title>
    </head>
    <body>
        <div id="root">${content}</div>
        <script src="/client.js"></script>
    </body>
    </html>
`
```

``` jsx
// client.js 
import { hydrate } from 'react-dom'

hydrate(<App />, document.querySelector('#root'))
```

### 



`App``hydrate``renderToString`



### 

`react-router-dom``redux` `StaticRouter``BrowserRouter`

`store``store``store``Provider``renderToString`



`hydrate``Provider``store``window.__STATE__ = XXX``store`

``` js
export const loadData = () => (dispatch) => {
    dispatch(setFetching(true))
    return axios.get('http://localhost:3000/getData')
        .then(res => {
            dispatch(setLists(res.data.lists))
        })
        .catch(err => console.log(err))
}


export const load = (store) => {
    return store.dispatch(loadData())
}

export const routes = [
    {
        path: '/',
        key: 'home',
        component: Contain,
        loadData: load, // 
        exact: true,
    },
    {
        path: '/signup',
        key: 'signup',
        component: Signup
    },
]
```

``` js
// server.js 
app.use(async (ctx) => {
    const store = configureStore(initialState) // store
    const promiseArr = []
    routes.forEach(route => {
        if (route.loadData) {
            promiseArr.push(route.loadData(store)) // 
        }
    })
    await Promise.all(promiseArr) // 
    const content = await renderToHTML(ctx.url, store) // 
    ctx.body = content
})

export default async function renderToHTML(url, store) {
    const template = await fs.readFileAsync((`./template/index.html`), 'utf8')
      
    const content = renderToString(
        <Provider store={store}> // store
            <StaticRouter location={url}>
                <App />
            </StaticRouter>
        </Provider>
    )
    
    // storewindow
    const state = `
        <script>
            window.__STATE__ = ${JSON.stringify(store.getState())} 
        </script>
    `
    return template
    .replace(`<!-- CONTENT -->`, content)
    .replace(`<!-- STATE -->`, state)
}
```


``` js
// client.js 
export default function App() {
    return (
        <Switch>
            {
                routes.map(route => {
                    return <Route  {...route}></Route> 
                })
            }
        </Switch>
    )
}

const state = window.__STATE__ // store

delete window.__STATE__

const store = configureStore(state)

hydrate(
    <Provider store={store}>
    	<Router>
        	<App />
        </Router>
    </Provider>, 
    document.querySelector('#root')
)
```

### CSS

`App``import 'index.css'``style-loader``document.createElement('style')`Node`document`

`index.css``index.css`HTML`CONTENT``STATE`



`isomorphic-style-loader``webpack`CSS`style-loader`

``` js
// webpack.config.js
{
    test: /\.module\.css$/,
    use: ["isomorphic-style-loader", {
        loader: "css-loader",
        options: {
            importLoaders: 1,
            esModule: false, // 
        }
    },
    "postcss-loader"
],
```

[](https://github.com/kriasoft/isomorphic-style-loader)`esModule: false``css-loader``css-loader@3.x``css-loader@5.x`[](https://stackoverflow.com/questions/63458657/isomorphic-style-loader-doesnt-work-as-it-supposed-to/63983963#63983963)`css-loader``es``isomorphic-style-loader``commonjs`

`StaticRouter``context`CSS`isomorphic-style-loader`



CSS

``` js
// server.js 
const css = new Set() // CSS for all rendered React components
const insertCss = (...styles) => styles.forEach(style => css.add(style._getCss()))
const body = ReactDOM.renderToString(
    <StyleContext.Provider value={{ insertCss }}>
      <App />
    </StyleContext.Provider>
)
const html = `<!doctype html>
    <html>
      <head>
        <script src="client.js" defer></script>
        <style>${[...css].join('')}</style>
      </head>
      <body>
        <div id="root">${body}</div>
      </body>
    </html>
`
```

``` js
// client.js 

import React from 'react'
import withStyles from 'isomorphic-style-loader/withStyles'
import s from './App.scss'

function App(props, context) {
  return (
    <div className={s.root}>
      <h1 className={s.title}>Hello, world!</h1>
    </div>
  )
}

export default withStyles(s)(App) // <--

const insertCss = (...styles) => {
  // 
  const removeCss = styles.map(style => style._insertCss())
  return () => removeCss.forEach(dispose => dispose())
}

ReactDOM.hydrate(
  <StyleContext.Provider value={{ insertCss }}>
    <App />
  </StyleContext.Provider>,
  document.getElementById('root')
)
```



## Next.js

`next.js`React

- 
- `CSS Module``css-in-js`
- 
- ①②

`Vercel`



## Create-React-App

### 

`CRA``process.env`

``` json
// process.env 
{
    NODE_ENV: "development" | "production" | "test"
    PUBLIC_URL: ""
    WDS_SOCKET_HOST: undefined
    WDS_SOCKET_PATH: undefined
    WDS_SOCKET_PORT: undefined
}
```

`NODE_ENV``npm start``npm build``npm test``NODE_ENV``development``production``test``PUBLIC_URL`HTML

`REACT_APP_``process.env`

``` json
{
    "dev": "cross-env REACT_APP_MY_ENV=development react-scripts start"
}
```



### rewired

`create-react-app``webpack`

`eject``react-app-rewired`