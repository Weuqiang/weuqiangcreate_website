---
sidebar_position: 4
title: å¾®å‰ç«¯æ¶æ„è®¾è®¡
tags: [å‰ç«¯, å¾®å‰ç«¯, qiankun, Module Federation]
---

# å¾®å‰ç«¯æ¶æ„è®¾è®¡

å¾®å‰ç«¯æ˜¯å°†å¾®æœåŠ¡ç†å¿µåº”ç”¨äºå‰ç«¯çš„æ¶æ„æ¨¡å¼ï¼Œæœ¬æ–‡å°†è¯¦ç»†è®²è§£å¾®å‰ç«¯çš„å®ç°æ–¹æ¡ˆå’Œæœ€ä½³å®è·µã€‚

## å¾®å‰ç«¯æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å¾®å‰ç«¯

```javascript
const microFrontendConcept = {
  definition: 'å°†å‰ç«¯åº”ç”¨æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„å­åº”ç”¨',
  
  benefits: [
    'æŠ€æœ¯æ ˆæ— å…³ï¼šå„å­åº”ç”¨å¯ä½¿ç”¨ä¸åŒæ¡†æ¶',
    'ç‹¬ç«‹å¼€å‘ï¼šå›¢é˜Ÿç‹¬ç«‹å¼€å‘éƒ¨ç½²',
    'å¢é‡å‡çº§ï¼šé€æ­¥è¿ç§»è€é¡¹ç›®',
    'ç‹¬ç«‹éƒ¨ç½²ï¼šäº’ä¸å½±å“',
    'å›¢é˜Ÿè‡ªæ²»ï¼šæé«˜å¼€å‘æ•ˆç‡'
  ],
  
  challenges: [
    'åº”ç”¨éš”ç¦»ï¼šæ ·å¼ã€JSéš”ç¦»',
    'é€šä¿¡æœºåˆ¶ï¼šä¸»åº”ç”¨ä¸å­åº”ç”¨é€šä¿¡',
    'è·¯ç”±ç®¡ç†ï¼šç»Ÿä¸€è·¯ç”±',
    'æ€§èƒ½ä¼˜åŒ–ï¼šåŠ è½½æ€§èƒ½',
    'å…¬å…±ä¾èµ–ï¼šé¿å…é‡å¤åŠ è½½'
  ]
};
```

## å®ç°æ–¹æ¡ˆå¯¹æ¯”

### 1. iframeæ–¹æ¡ˆ

```javascript
// æœ€ç®€å•çš„å¾®å‰ç«¯æ–¹æ¡ˆ
class IframeMicroFrontend {
  constructor(container) {
    this.container = container;
  }
  
  load(url) {
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    
    this.container.appendChild(iframe);
    
    return iframe;
  }
  
  // é€šä¿¡
  postMessage(data) {
    this.iframe.contentWindow.postMessage(data, '*');
  }
}

// ä¼˜ç¼ºç‚¹
const iframeApproach = {
  pros: [
    'å®Œç¾éš”ç¦»ï¼šå¤©ç„¶çš„æ²™ç®±ç¯å¢ƒ',
    'ç®€å•æ˜“ç”¨ï¼šæ— éœ€é¢å¤–é…ç½®',
    'æŠ€æœ¯æ ˆæ— å…³ï¼šä»»æ„æ¡†æ¶'
  ],
  
  cons: [
    'æ€§èƒ½é—®é¢˜ï¼šæ¯ä¸ªiframeéƒ½æ˜¯ç‹¬ç«‹çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡',
    'æ ·å¼é—®é¢˜ï¼šæ— æ³•å…±äº«æ ·å¼',
    'é€šä¿¡å¤æ‚ï¼šåªèƒ½é€šè¿‡postMessage',
    'SEOä¸å‹å¥½ï¼šæœç´¢å¼•æ“æ— æ³•ç´¢å¼•',
    'ç”¨æˆ·ä½“éªŒå·®ï¼šåˆ·æ–°ã€å‰è¿›åé€€é—®é¢˜'
  ]
};
```

### 2. single-spaæ–¹æ¡ˆ

```javascript
// single-spaæ˜¯æœ€æ—©çš„å¾®å‰ç«¯æ¡†æ¶
import { registerApplication, start } from 'single-spa';

// æ³¨å†Œå­åº”ç”¨
registerApplication({
  name: 'app1',
  app: () => System.import('app1'),
  activeWhen: '/app1',
  customProps: {
    domElement: document.getElementById('app1-container')
  }
});

registerApplication({
  name: 'app2',
  app: () => System.import('app2'),
  activeWhen: '/app2'
});

// å¯åŠ¨
start();

// å­åº”ç”¨éœ€è¦å¯¼å‡ºç”Ÿå‘½å‘¨æœŸ
export async function bootstrap(props) {
  // åˆå§‹åŒ–
}

export async function mount(props) {
  // æŒ‚è½½
  ReactDOM.render(<App />, props.domElement);
}

export async function unmount(props) {
  // å¸è½½
  ReactDOM.unmountComponentAtNode(props.domElement);
}
```

### 3. qiankunæ–¹æ¡ˆ

```javascript
// qiankunæ˜¯åŸºäºsingle-spaçš„å¾®å‰ç«¯æ¡†æ¶
import { registerMicroApps, start } from 'qiankun';

// æ³¨å†Œå­åº”ç”¨
registerMicroApps([
  {
    name: 'react-app',
    entry: '//localhost:3000',
    container: '#container',
    activeRule: '/react',
    props: {
      data: { user: 'admin' }
    }
  },
  {
    name: 'vue-app',
    entry: '//localhost:8080',
    container: '#container',
    activeRule: '/vue'
  }
]);

// å¯åŠ¨
start({
  prefetch: true,        // é¢„åŠ è½½
  sandbox: true,         // æ²™ç®±éš”ç¦»
  singular: false        // æ˜¯å¦å•å®ä¾‹
});

// å­åº”ç”¨é…ç½®ï¼ˆReactï¼‰
// src/index.js
function render(props = {}) {
  const { container } = props;
  ReactDOM.render(
    <App />,
    container ? container.querySelector('#root') : document.getElementById('root')
  );
}

// ç‹¬ç«‹è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

// å¯¼å‡ºç”Ÿå‘½å‘¨æœŸ
export async function bootstrap() {
  console.log('react app bootstraped');
}

export async function mount(props) {
  console.log('react app mount', props);
  render(props);
}

export async function unmount(props) {
  const { container } = props;
  ReactDOM.unmountComponentAtNode(
    container ? container.querySelector('#root') : document.getElementById('root')
  );
}

// webpacké…ç½®
module.exports = {
  output: {
    library: 'reactApp',
    libraryTarget: 'umd',
    publicPath: '//localhost:3000/'
  },
  devServer: {
    headers: {
      'Access-Control-Allow-Origin': '*'
    }
  }
};
```

### 4. Module Federation

```javascript
// Webpack 5çš„Module Federation
// ä¸»åº”ç”¨ webpack.config.js
const ModuleFederationPlugin = require('webpack/lib/container/ModuleFederationPlugin');

module.exports = {
  plugins: [
    new ModuleFederationPlugin({
      name: 'host',
      remotes: {
        app1: 'app1@http://localhost:3001/remoteEntry.js',
        app2: 'app2@http://localhost:3002/remoteEntry.js'
      },
      shared: {
        react: { singleton: true },
        'react-dom': { singleton: true }
      }
    })
  ]
};

// ä½¿ç”¨è¿œç¨‹æ¨¡å—
import React, { lazy, Suspense } from 'react';

const RemoteApp1 = lazy(() => import('app1/App'));
const RemoteApp2 = lazy(() => import('app2/App'));

function App() {
  return (
    <div>
      <Suspense fallback="Loading App1...">
        <RemoteApp1 />
      </Suspense>
      
      <Suspense fallback="Loading App2...">
        <RemoteApp2 />
      </Suspense>
    </div>
  );
}

// å­åº”ç”¨ webpack.config.js
module.exports = {
  plugins: [
    new ModuleFederationPlugin({
      name: 'app1',
      filename: 'remoteEntry.js',
      exposes: {
        './App': './src/App'
      },
      shared: {
        react: { singleton: true },
        'react-dom': { singleton: true }
      }
    })
  ]
};
```

## qiankunæ·±åº¦å®è·µ

### ä¸»åº”ç”¨é…ç½®

```javascript
// main/src/micro-app.js
import { registerMicroApps, start, initGlobalState } from 'qiankun';

// å…¨å±€çŠ¶æ€
const initialState = {
  user: null,
  token: null
};

const actions = initGlobalState(initialState);

// ç›‘å¬çŠ¶æ€å˜åŒ–
actions.onGlobalStateChange((state, prev) => {
  console.log('ä¸»åº”ç”¨ç›‘å¬åˆ°çŠ¶æ€å˜åŒ–', state, prev);
});

// æ³¨å†Œå­åº”ç”¨
registerMicroApps(
  [
    {
      name: 'react-app',
      entry: process.env.REACT_APP_URL,
      container: '#subapp-container',
      activeRule: '/react',
      props: {
        actions,
        data: { mainApp: 'data' }
      }
    },
    {
      name: 'vue-app',
      entry: process.env.VUE_APP_URL,
      container: '#subapp-container',
      activeRule: '/vue',
      props: { actions }
    }
  ],
  {
    // ç”Ÿå‘½å‘¨æœŸé’©å­
    beforeLoad: [
      app => {
        console.log('before load', app.name);
      }
    ],
    beforeMount: [
      app => {
        console.log('before mount', app.name);
      }
    ],
    afterMount: [
      app => {
        console.log('after mount', app.name);
      }
    ],
    beforeUnmount: [
      app => {
        console.log('before unmount', app.name);
      }
    ],
    afterUnmount: [
      app => {
        console.log('after unmount', app.name);
      }
    ]
  }
);

// å¯åŠ¨é…ç½®
start({
  prefetch: 'all',           // é¢„åŠ è½½ç­–ç•¥
  sandbox: {
    strictStyleIsolation: true,  // ä¸¥æ ¼æ ·å¼éš”ç¦»
    experimentalStyleIsolation: true
  },
  singular: false,           // æ˜¯å¦å•å®ä¾‹
  fetch: window.fetch        // è‡ªå®šä¹‰fetch
});

export { actions };
```

### å­åº”ç”¨é…ç½®

```javascript
// react-app/src/index.js
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';
import './public-path';

let root = null;

function render(props = {}) {
  const { container, actions } = props;
  
  // ç›‘å¬å…¨å±€çŠ¶æ€
  if (actions) {
    actions.onGlobalStateChange((state, prev) => {
      console.log('å­åº”ç”¨ç›‘å¬åˆ°çŠ¶æ€å˜åŒ–', state, prev);
    });
  }
  
  root = ReactDOM.createRoot(
    container ? container.querySelector('#root') : document.getElementById('root')
  );
  
  root.render(<App actions={actions} />);
}

// ç‹¬ç«‹è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

// ç”Ÿå‘½å‘¨æœŸ
export async function bootstrap() {
  console.log('[react app] bootstraped');
}

export async function mount(props) {
  console.log('[react app] mount', props);
  render(props);
}

export async function unmount(props) {
  console.log('[react app] unmount', props);
  root.unmount();
}

export async function update(props) {
  console.log('[react app] update', props);
}

// public-path.js
if (window.__POWERED_BY_QIANKUN__) {
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}

// webpack.config.js
module.exports = {
  output: {
    library: `${packageName}-[name]`,
    libraryTarget: 'umd',
    chunkLoadingGlobal: `webpackJsonp_${packageName}`,
    publicPath: '//localhost:3000/'
  },
  devServer: {
    port: 3000,
    headers: {
      'Access-Control-Allow-Origin': '*'
    }
  }
};
```

## åº”ç”¨éš”ç¦»

### JSæ²™ç®±

```javascript
// å¿«ç…§æ²™ç®±ï¼ˆå•å®ä¾‹ï¼‰
class SnapshotSandbox {
  constructor() {
    this.windowSnapshot = {};
    this.modifyPropsMap = {};
  }
  
  active() {
    // ä¿å­˜windowå¿«ç…§
    for (const prop in window) {
      this.windowSnapshot[prop] = window[prop];
    }
    
    // æ¢å¤ä¸Šæ¬¡ä¿®æ”¹
    Object.keys(this.modifyPropsMap).forEach(prop => {
      window[prop] = this.modifyPropsMap[prop];
    });
  }
  
  inactive() {
    // è®°å½•ä¿®æ”¹
    for (const prop in window) {
      if (window[prop] !== this.windowSnapshot[prop]) {
        this.modifyPropsMap[prop] = window[prop];
        window[prop] = this.windowSnapshot[prop];
      }
    }
  }
}

// Proxyæ²™ç®±ï¼ˆå¤šå®ä¾‹ï¼‰
class ProxySandbox {
  constructor() {
    this.running = false;
    
    const fakeWindow = Object.create(null);
    
    this.proxyWindow = new Proxy(fakeWindow, {
      get: (target, prop) => {
        return prop in target ? target[prop] : window[prop];
      },
      
      set: (target, prop, value) => {
        if (this.running) {
          target[prop] = value;
        }
        return true;
      },
      
      has: (target, prop) => {
        return prop in target || prop in window;
      }
    });
  }
  
  active() {
    this.running = true;
  }
  
  inactive() {
    this.running = false;
  }
}
```

### æ ·å¼éš”ç¦»

```javascript
// 1. Shadow DOMéš”ç¦»
class ShadowDOMIsolation {
  mount(container, html) {
    const shadowRoot = container.attachShadow({ mode: 'open' });
    shadowRoot.innerHTML = html;
  }
}

// 2. CSS Modules
// è‡ªåŠ¨æ·»åŠ hash
import styles from './App.module.css';

function App() {
  return <div className={styles.container}>App</div>;
}

// 3. CSS-in-JS
import styled from 'styled-components';

const Container = styled.div`
  color: red;
`;

// 4. åŠ¨æ€æ ·å¼ä½œç”¨åŸŸ
class StyleIsolation {
  addPrefix(css, prefix) {
    return css.replace(/([^\r\n,{}]+)(,(?=[^}]*{)|\s*{)/g, (match, selector) => {
      return `${prefix} ${selector}`;
    });
  }
  
  mount(appName, css) {
    const prefixedCss = this.addPrefix(css, `[data-qiankun="${appName}"]`);
    const style = document.createElement('style');
    style.innerHTML = prefixedCss;
    document.head.appendChild(style);
  }
}
```

## åº”ç”¨é€šä¿¡

### å…¨å±€çŠ¶æ€ç®¡ç†

```javascript
// ä¸»åº”ç”¨
import { initGlobalState } from 'qiankun';

const initialState = {
  user: null,
  token: null,
  theme: 'light'
};

const actions = initGlobalState(initialState);

// ç›‘å¬å˜åŒ–
actions.onGlobalStateChange((state, prev) => {
  console.log('çŠ¶æ€å˜åŒ–', state, prev);
});

// è®¾ç½®çŠ¶æ€
actions.setGlobalState({
  user: { name: 'John', id: 1 }
});

// å­åº”ç”¨
export async function mount(props) {
  const { actions } = props;
  
  // ç›‘å¬çŠ¶æ€
  actions.onGlobalStateChange((state, prev) => {
    console.log('å­åº”ç”¨æ”¶åˆ°çŠ¶æ€', state);
    // æ›´æ–°å­åº”ç”¨çŠ¶æ€
    store.dispatch({ type: 'UPDATE_USER', payload: state.user });
  });
  
  // ä¿®æ”¹çŠ¶æ€
  actions.setGlobalState({
    token: 'new-token'
  });
}
```

### è‡ªå®šä¹‰äº‹ä»¶æ€»çº¿

```javascript
class EventBus {
  constructor() {
    this.events = {};
  }
  
  on(event, callback) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(callback);
  }
  
  emit(event, data) {
    if (this.events[event]) {
      this.events[event].forEach(callback => callback(data));
    }
  }
  
  off(event, callback) {
    if (this.events[event]) {
      this.events[event] = this.events[event].filter(cb => cb !== callback);
    }
  }
}

// å…¨å±€äº‹ä»¶æ€»çº¿
window.__MICRO_APP_EVENT_BUS__ = new EventBus();

// ä¸»åº”ç”¨
window.__MICRO_APP_EVENT_BUS__.on('user-login', (user) => {
  console.log('ç”¨æˆ·ç™»å½•', user);
});

// å­åº”ç”¨
window.__MICRO_APP_EVENT_BUS__.emit('user-login', {
  name: 'John',
  id: 1
});
```

## æ€§èƒ½ä¼˜åŒ–

### é¢„åŠ è½½

```javascript
import { prefetchApps } from 'qiankun';

// é¢„åŠ è½½å­åº”ç”¨
prefetchApps([
  { name: 'app1', entry: '//localhost:3001' },
  { name: 'app2', entry: '//localhost:3002' }
]);

// è‡ªå®šä¹‰é¢„åŠ è½½ç­–ç•¥
start({
  prefetch(apps) {
    // ç©ºé—²æ—¶é¢„åŠ è½½
    if ('requestIdleCallback' in window) {
      window.requestIdleCallback(() => {
        apps.forEach(app => {
          fetch(app.entry);
        });
      });
    }
    return [];
  }
});
```

### å…¬å…±ä¾èµ–ä¼˜åŒ–

```javascript
// webpack externals
module.exports = {
  externals: {
    react: 'React',
    'react-dom': 'ReactDOM',
    'react-router-dom': 'ReactRouterDOM'
  }
};

// ä¸»åº”ç”¨åŠ è½½å…¬å…±ä¾èµ–
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

// Module Federationå…±äº«ä¾èµ–
new ModuleFederationPlugin({
  shared: {
    react: {
      singleton: true,
      requiredVersion: '^18.0.0'
    },
    'react-dom': {
      singleton: true,
      requiredVersion: '^18.0.0'
    }
  }
});
```

## æœ€ä½³å®è·µ

```javascript
const bestPractices = {
  // 1. åº”ç”¨æ‹†åˆ†åŸåˆ™
  splitting: {
    byBusiness: 'æŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†',
    byTeam: 'æŒ‰å›¢é˜Ÿæ‹†åˆ†',
    byTech: 'æŒ‰æŠ€æœ¯æ ˆæ‹†åˆ†'
  },
  
  // 2. è·¯ç”±è®¾è®¡
  routing: {
    mainApp: 'ä¸»åº”ç”¨ç®¡ç†ä¸€çº§è·¯ç”±',
    subApp: 'å­åº”ç”¨ç®¡ç†äºŒçº§è·¯ç”±',
    avoid: 'é¿å…è·¯ç”±å†²çª'
  },
  
  // 3. çŠ¶æ€ç®¡ç†
  state: {
    global: 'å…¨å±€çŠ¶æ€æ”¾ä¸»åº”ç”¨',
    local: 'å±€éƒ¨çŠ¶æ€æ”¾å­åº”ç”¨',
    communication: 'é€šè¿‡äº‹ä»¶é€šä¿¡'
  },
  
  // 4. æ ·å¼è§„èŒƒ
  style: {
    prefix: 'ä½¿ç”¨CSSå‰ç¼€',
    modules: 'ä½¿ç”¨CSS Modules',
    scoped: 'ä½¿ç”¨scopedæ ·å¼'
  },
  
  // 5. æ€§èƒ½ä¼˜åŒ–
  performance: {
    prefetch: 'é¢„åŠ è½½å­åº”ç”¨',
    cache: 'ç¼“å­˜å­åº”ç”¨èµ„æº',
    lazy: 'æŒ‰éœ€åŠ è½½',
    cdn: 'ä½¿ç”¨CDNåŠ é€Ÿ'
  }
};
```

## æ€»ç»“

å¾®å‰ç«¯æ¶æ„çš„æ ¸å¿ƒï¼š
- ğŸ—ï¸ **åº”ç”¨æ‹†åˆ†**ï¼šæŒ‰ä¸šåŠ¡ã€å›¢é˜Ÿã€æŠ€æœ¯æ ˆæ‹†åˆ†
- ğŸ”’ **åº”ç”¨éš”ç¦»**ï¼šJSæ²™ç®±ã€æ ·å¼éš”ç¦»
- ğŸ“¡ **åº”ç”¨é€šä¿¡**ï¼šå…¨å±€çŠ¶æ€ã€äº‹ä»¶æ€»çº¿
- ğŸš€ **æ€§èƒ½ä¼˜åŒ–**ï¼šé¢„åŠ è½½ã€å…¬å…±ä¾èµ–
- ğŸ› ï¸ **æŠ€æœ¯é€‰å‹**ï¼šqiankunã€Module Federation
- ğŸ“‹ **æœ€ä½³å®è·µ**ï¼šè·¯ç”±ã€çŠ¶æ€ã€æ ·å¼è§„èŒƒ

è®°ä½ï¼š**å¾®å‰ç«¯ä¸æ˜¯é“¶å¼¹ï¼Œè¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆï¼**

