---
sidebar_position: 2
title: MongoDB - 
---

# MongoDB - NoSQL

MongoDBNoSQL**MongoDB**

## MongoDB

### MongoDB

****
```sql
-- 
ALTER TABLE users ADD COLUMN hobbies TEXT;
-- 
```

**MongoDB**
```javascript
// schema
db.users.insertOne({
    name: "Alice",
    age: 25,
    hobbies: ["reading", "coding"]  // 
});

db.users.insertOne({
    name: "Bob",
    age: 30
    // hobbies
});
```

### 

**Docker**
```bash
# MongoDB
docker run -d --name mongodb \
  -p 27017:27017 \
  mongo:latest

# MongoDB Shell
docker exec -it mongodb mongosh
```

**Python**
```python
from pymongo import MongoClient

# MongoDB
client = MongoClient('mongodb://localhost:27017/')

# 
db = client['ecommerce']

# 
users = db['users']
```

### 

```
MySQL          MongoDB
         
             Collection
             Document
             Field
           
         
```

## CRUD

### 

```python
from pymongo import MongoClient
from datetime import datetime

client = MongoClient('mongodb://localhost:27017/')
db = client['ecommerce']
users = db['users']

# 
user = {
    "username": "alice",
    "email": "alice@example.com",
    "age": 25,
    "gender": "F",
    "hobbies": ["reading", "coding"],
    "address": {
        "city": "Beijing",
        "street": "Chaoyang Road"
    },
    "created_at": datetime.now()
}
result = users.insert_one(user)
print(f"ID: {result.inserted_id}")

# 
users_list = [
    {"username": "bob", "age": 30, "gender": "M"},
    {"username": "charlie", "age": 28, "gender": "M"},
    {"username": "diana", "age": 26, "gender": "F"}
]
result = users.insert_many(users_list)
print(f"IDs: {result.inserted_ids}")
```

### 

```python
# 
for user in users.find():
    print(user)

# 
# 
for user in users.find({"age": 25}):
    print(user)

# 
for user in users.find({"age": {"$gt": 25}}):
    print(user)

# 
for user in users.find({"age": {"$gte": 20, "$lte": 30}}):
    print(user)

# IN
for user in users.find({"username": {"$in": ["alice", "bob"]}}):
    print(user)

# 
for user in users.find({"username": {"$regex": "^a"}}):
    print(user)

# AND
for user in users.find({"age": {"$gt": 25}, "gender": "F"}):
    print(user)

# OR
for user in users.find({"$or": [{"age": {"$lt": 20}}, {"age": {"$gt": 30}}]}):
    print(user)

# 
for user in users.find({"address.city": "Beijing"}):
    print(user)

# 
for user in users.find({"hobbies": "coding"}):
    print(user)

# 
for user in users.find({"hobbies": {"$all": ["reading", "coding"]}}):
    print(user)

# 
for user in users.find({}, {"username": 1, "age": 1, "_id": 0}):
    print(user)

# 
for user in users.find().sort("age", -1):  # -11
    print(user)

# 
for user in users.find().limit(10):
    print(user)

# 
for user in users.find().skip(10).limit(10):
    print(user)

# 
count = users.count_documents({"age": {"$gt": 25}})
print(f"25: {count}")

# 
user = users.find_one({"username": "alice"})
print(user)
```

### 

```python
# 
users.update_one(
    {"username": "alice"},
    {"$set": {"age": 26}}
)

# 
users.update_many(
    {"gender": "M"},
    {"$set": {"updated": True}}
)

# 
users.update_one(
    {"username": "alice"},
    {"$inc": {"age": 1}}  # age1
)

# 
# 
users.update_one(
    {"username": "alice"},
    {"$push": {"hobbies": "swimming"}}
)

# 
users.update_one(
    {"username": "alice"},
    {"$push": {"hobbies": {"$each": ["gaming", "music"]}}}
)

# 
users.update_one(
    {"username": "alice"},
    {"$pull": {"hobbies": "gaming"}}
)

# upsert
users.update_one(
    {"username": "eve"},
    {"$set": {"age": 22, "gender": "F"}},
    upsert=True
)

# 
users.replace_one(
    {"username": "alice"},
    {
        "username": "alice",
        "age": 27,
        "email": "alice@example.com"
    }
)
```

### 

```python
# 
users.delete_one({"username": "alice"})

# 
users.delete_many({"age": {"$lt": 18}})

# 
users.delete_many({})

# 
users.drop()
```

## 

### 

```python
# SQLGROUP BY
pipeline = [
    # $matchWHERE
    {"$match": {"age": {"$gte": 20}}},
    
    # $groupGROUP BY
    {"$group": {
        "_id": "$gender",
        "count": {"$sum": 1},
        "avg_age": {"$avg": "$age"},
        "max_age": {"$max": "$age"},
        "min_age": {"$min": "$age"}
    }},
    
    # $sortORDER BY
    {"$sort": {"count": -1}},
    
    # $limit
    {"$limit": 10}
]

result = users.aggregate(pipeline)
for doc in result:
    print(doc)
```

### 

```python
# 
orders = db['orders']

# 
orders.insert_many([
    {
        "user_id": "user1",
        "items": [
            {"product": "laptop", "price": 1000, "quantity": 1},
            {"product": "mouse", "price": 20, "quantity": 2}
        ],
        "total": 1040,
        "status": "completed",
        "created_at": datetime(2024, 1, 1)
    },
    {
        "user_id": "user1",
        "items": [
            {"product": "keyboard", "price": 50, "quantity": 1}
        ],
        "total": 50,
        "status": "completed",
        "created_at": datetime(2024, 1, 15)
    },
    {
        "user_id": "user2",
        "items": [
            {"product": "laptop", "price": 1000, "quantity": 1}
        ],
        "total": 1000,
        "status": "pending",
        "created_at": datetime(2024, 1, 10)
    }
])

# 
pipeline = [
    {"$match": {"status": "completed"}},
    {"$group": {
        "_id": "$user_id",
        "order_count": {"$sum": 1},
        "total_amount": {"$sum": "$total"},
        "avg_amount": {"$avg": "$total"}
    }},
    {"$sort": {"total_amount": -1}}
]

for doc in orders.aggregate(pipeline):
    print(doc)

# 
pipeline = [
    {"$match": {"status": "completed"}},
    {"$unwind": "$items"},  # 
    {"$group": {
        "_id": "$items.product",
        "total_quantity": {"$sum": "$items.quantity"},
        "total_revenue": {"$sum": {"$multiply": ["$items.price", "$items.quantity"]}}
    }},
    {"$sort": {"total_revenue": -1}}
]

for doc in orders.aggregate(pipeline):
    print(doc)

# 
pipeline = [
    {"$match": {"status": "completed"}},
    {"$group": {
        "_id": {
            "year": {"$year": "$created_at"},
            "month": {"$month": "$created_at"}
        },
        "total_sales": {"$sum": "$total"},
        "order_count": {"$sum": 1}
    }},
    {"$sort": {"_id.year": 1, "_id.month": 1}}
]

for doc in orders.aggregate(pipeline):
    print(doc)

# $lookupJOIN
pipeline = [
    {"$lookup": {
        "from": "users",
        "localField": "user_id",
        "foreignField": "_id",
        "as": "user_info"
    }},
    {"$unwind": "$user_info"},
    {"$project": {
        "order_id": "$_id",
        "username": "$user_info.username",
        "total": 1,
        "status": 1
    }}
]

for doc in orders.aggregate(pipeline):
    print(doc)
```

## 

### 

```python
# 
users.create_index("username")

# 
users.create_index([("age", 1), ("gender", 1)])  # 1-1

# 
users.create_index("email", unique=True)

# 
users.create_index([("bio", "text")])

# 
locations = db['locations']
locations.create_index([("location", "2dsphere")])

# 
for index in users.list_indexes():
    print(index)

# 
users.drop_index("username_1")

# 
users.drop_indexes()
```

### 

```python
# 
explain = users.find({"age": {"$gt": 25}}).explain()
print(explain)

# 
explain = users.find({"age": {"$gt": 25}}).explain("executionStats")
print(f": {explain['executionStats']['totalDocsExamined']}")
print(f": {explain['executionStats']['nReturned']}")
print(f": {explain['executionStats']['executionTimeMillis']}ms")
```

## 

###  vs 

****
```python
# 
user = {
    "username": "alice",
    "email": "alice@example.com",
    "address": {
        "city": "Beijing",
        "street": "Chaoyang Road",
        "zipcode": "100000"
    }
}
users.insert_one(user)

# 
post = {
    "title": "MongoDB Tutorial",
    "content": "...",
    "comments": [
        {"user": "bob", "text": "Great post!", "date": datetime.now()},
        {"user": "charlie", "text": "Thanks!", "date": datetime.now()}
    ]
}
posts = db['posts']
posts.insert_one(post)
```

****
```python
# 
user = {
    "_id": "user1",
    "username": "alice"
}
users.insert_one(user)

order = {
    "user_id": "user1",  # ID
    "total": 100,
    "items": [...]
}
orders.insert_one(order)

# 
user = users.find_one({"_id": "user1"})
user_orders = list(orders.find({"user_id": user["_id"]}))
```

## 

### 

```python
from pymongo import MongoClient
from datetime import datetime
from bson import ObjectId

class CMS:
    """"""
    
    def __init__(self):
        self.client = MongoClient('mongodb://localhost:27017/')
        self.db = self.client['cms']
        self.articles = self.db['articles']
        self.users = self.db['users']
        self.comments = self.db['comments']
        
        # 
        self.articles.create_index("title")
        self.articles.create_index([("content", "text")])
        self.articles.create_index("author_id")
        self.articles.create_index("created_at")
    
    def create_article(self, title, content, author_id, tags=None):
        """"""
        article = {
            "title": title,
            "content": content,
            "author_id": author_id,
            "tags": tags or [],
            "views": 0,
            "likes": 0,
            "created_at": datetime.now(),
            "updated_at": datetime.now()
        }
        result = self.articles.insert_one(article)
        return result.inserted_id
    
    def get_article(self, article_id):
        """"""
        # 
        self.articles.update_one(
            {"_id": ObjectId(article_id)},
            {"$inc": {"views": 1}}
        )
        
        article = self.articles.find_one({"_id": ObjectId(article_id)})
        
        # 
        if article:
            author = self.users.find_one({"_id": article["author_id"]})
            article["author"] = author
            
            # 
            comments = list(self.comments.find({"article_id": article_id}))
            article["comments"] = comments
        
        return article
    
    def search_articles(self, keyword):
        """"""
        return list(self.articles.find(
            {"$text": {"$search": keyword}},
            {"score": {"$meta": "textScore"}}
        ).sort([("score", {"$meta": "textScore"})]))
    
    def get_popular_articles(self, limit=10):
        """"""
        return list(self.articles.find().sort("views", -1).limit(limit))
    
    def get_articles_by_tag(self, tag):
        """"""
        return list(self.articles.find({"tags": tag}))
    
    def add_comment(self, article_id, user_id, content):
        """"""
        comment = {
            "article_id": article_id,
            "user_id": user_id,
            "content": content,
            "created_at": datetime.now()
        }
        return self.comments.insert_one(comment).inserted_id
    
    def like_article(self, article_id):
        """"""
        self.articles.update_one(
            {"_id": ObjectId(article_id)},
            {"$inc": {"likes": 1}}
        )
    
    def get_user_articles(self, user_id):
        """"""
        return list(self.articles.find({"author_id": user_id}).sort("created_at", -1))
    
    def get_statistics(self):
        """"""
        pipeline = [
            {"$group": {
                "_id": None,
                "total_articles": {"$sum": 1},
                "total_views": {"$sum": "$views"},
                "total_likes": {"$sum": "$likes"},
                "avg_views": {"$avg": "$views"}
            }}
        ]
        return list(self.articles.aggregate(pipeline))[0]

# 
cms = CMS()

# 
user_id = cms.users.insert_one({
    "username": "alice",
    "email": "alice@example.com"
}).inserted_id

# 
article_id = cms.create_article(
    title="MongoDB",
    content="MongoDBNoSQL...",
    author_id=user_id,
    tags=["mongodb", "database", "nosql"]
)

# 
article = cms.get_article(str(article_id))
print(f": {article['title']}")
print(f": {article['views']}")

# 
results = cms.search_articles("MongoDB")
print(f": {len(results)}")

# 
cms.add_comment(str(article_id), user_id, "")

# 
cms.like_article(str(article_id))

# 
stats = cms.get_statistics()
print(f": {stats['total_articles']}")
print(f": {stats['total_views']}")
```

## 

### MongoDB 4.0+

```python
from pymongo import MongoClient

client = MongoClient('mongodb://localhost:27017/')
db = client['ecommerce']

# 
with client.start_session() as session:
    with session.start_transaction():
        try:
            # 
            db.products.update_one(
                {"_id": "product1"},
                {"$inc": {"stock": -1}},
                session=session
            )
            
            # 
            db.orders.insert_one(
                {"product_id": "product1", "quantity": 1},
                session=session
            )
            
            # 
            session.commit_transaction()
        except Exception as e:
            # 
            session.abort_transaction()
            print(f": {e}")
```

### Change Streams

```python
# 
with users.watch() as stream:
    for change in stream:
        print(f": {change['operationType']}")
        print(f": {change['fullDocument']}")
```

## 

MongoDBNoSQL

1. **Schema**
2. ****
3. ****
4. ****

**MongoDB**

## 

1. 
2. 
3. 
4. MongoDB

[Redis](./redis.mdx)

