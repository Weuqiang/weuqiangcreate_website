---
sidebar_position: 19
title: PythonC
---



## 

PythonC

1. **ctypes** - C
2. **C** - Python C API
3. **Cython** - PythonC

## ctypes

### 

```python
from ctypes import CDLL, c_int, c_double, c_char_p

# C
lib = CDLL('./mylib.so')

# 
lib.add.argtypes = [c_int, c_int]
lib.add.restype = c_int

# C
result = lib.add(5, 3)
print(f"5 + 3 = {result}")
```

### 

```c
// example.h
typedef struct {
    int x;
    int y;
    char name[50];
} Point;

extern void print_point(Point *p);
```

```python
from ctypes import Structure, c_int, c_char, CDLL

class Point(Structure):
    _fields_ = [
        ("x", c_int),
        ("y", c_int),
        ("name", c_char * 50)
    ]

lib = CDLL('./example.so')
point = Point(10, 20, b"test")
lib.print_point(point)
```

## C

### 

```c
#include <Python.h>

static PyObject* add(PyObject* self, PyObject* args) {
    int a, b;
    if (!PyArg_ParseTuple(args, "ii", &a, &b)) {
        return NULL;
    }
    return PyLong_FromLong(a + b);
}

static PyMethodDef methods[] = {
    {"add", add, METH_VARARGS, "Add two numbers"},
    {NULL, NULL, 0, NULL}
};

static struct PyModuleDef module = {
    PyModuleDef_HEAD_INIT,
    "myextension",
    NULL,
    -1,
    methods
};

PyMODINIT_FUNC PyInit_myextension(void) {
    return PyModule_Create(&module);
}
```

### setup.py

```python
from distutils.core import setup, Extension

module = Extension(
    'myextension',
    sources=['myextension.c']
)

setup(
    name='MyExtension',
    version='1.0',
    ext_modules=[module]
)
```

## Cython

### 

```cython
# mymodule.pyx
def add(int a, int b):
    cdef int result = a + b
    return result
```

### setup.py

```python
from distutils.core import setup
from Cython.Build import cythonize

setup(
    ext_modules=cythonize("mymodule.pyx")
)
```

## 

### 

```c
// 
Py_INCREF(obj);

// 
Py_DECREF(obj);

// 
PyObject* item = PyList_GetItem(list, index);
```

### 

Valgrind
```bash
valgrind --leak-check=full python script.py
```

## 

### CPython

```c
static PyObject* risky_function(PyObject* self, PyObject* args) {
    // 
    if (operation_failed) {
        PyErr_SetString(PyExc_RuntimeError, "Operation failed");
        return NULL;
    }
    
    // 
    Py_RETURN_NONE;
}
```

## 

### 

```c
// Python
for (int i = 0; i < 1000000; i++) {
    PyObject* num = PyLong_FromLong(i);
    // num
    Py_DECREF(num);
}

// C
int result = 0;
for (int i = 0; i < 1000000; i++) {
    result += i;
}
PyObject* final = PyLong_FromLong(result);
```

## GIL

### GIL

```c
Py_BEGIN_ALLOW_THREADS
// I/O
perform_time_consuming_operation();
Py_END_ALLOW_THREADS
```

## 

### GDBC

```bash
gdb --args python script.py
(gdb) break myextension.c:25
(gdb) run
```

## 

1. ****INCREF/DECREF
2. **GIL**GIL
3. ****
4. ****

## 

### 

```c
// 
static PyObject* rotate_image(PyObject* self, PyObject* args) {
    PyObject* image_obj;
    double angle;
    
    if (!PyArg_ParseTuple(args, "Od", &image_obj, &angle)) {
        return NULL;
    }
    
    // 
    Py_buffer buffer;
    if (PyObject_GetBuffer(image_obj, &buffer, PyBUF_SIMPLE) != 0) {
        return NULL;
    }
    
    // 
    rotate_image_data(buffer.buf, buffer.len, angle);
    
    PyBuffer_Release(&buffer);
    Py_RETURN_NONE;
}
```

## 

- ****: GCC/Clang + distutils/setuptools
- ****: GDB + Python
- ****: perf, gprof, cProfile
- ****: Valgrind, AddressSanitizer

## 

1. CythonPythonic
2. C
3. ctypes
4. 
5. GIL
6. 
7. 
