---
sidebar_position: 5
title: Vite
tags: [Vite, , ]
---

# Vite

ViteESVite

## Vite

### 

```mermaid
graph LR
    A[] --> B[]
    B --> C[]
    
    D[Vite] --> E[]
    E --> F[]
    
    style D fill:#42b883
    style F fill:#42b883
```

**Vite vs Webpack**:
-  ****: Vite vs Webpack
-  ****: Vite vs Webpack
-  ****: Rollup
-  ****: Vite vs Webpack

## 

### vite.config.ts

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  // 
  plugins: [
    react({
      // React Fast Refresh
      fastRefresh: true,
      // Babel
      babel: {
        plugins: [
          ['@babel/plugin-proposal-decorators', { legacy: true }]
        ]
      }
    })
  ],
  
  // 
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@components': path.resolve(__dirname, 'src/components'),
      '@utils': path.resolve(__dirname, 'src/utils'),
      '@assets': path.resolve(__dirname, 'src/assets')
    },
    // 
    extensions: ['.js', '.ts', '.jsx', '.tsx', '.json']
  },
  
  // 
  server: {
    port: 3000,
    host: true, // 
    open: true, // 
    cors: true, // 
    
    // 
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      },
      '/ws': {
        target: 'ws://localhost:8080',
        ws: true
      }
    },
    
    // HMR
    hmr: {
      overlay: true // 
    }
  },
  
  // 
  build: {
    // 
    outDir: 'dist',
    // 
    assetsDir: 'assets',
    // base64
    assetsInlineLimit: 4096,
    // CSS
    cssCodeSplit: true,
    // sourcemap
    sourcemap: false,
    
    // Rollup
    rollupOptions: {
      output: {
        // 
        manualChunks: {
          'react-vendor': ['react', 'react-dom'],
          'router': ['react-router-dom'],
          'ui': ['antd', '@ant-design/icons']
        },
        // 
        chunkFileNames: 'js/[name]-[hash].js',
        entryFileNames: 'js/[name]-[hash].js',
        assetFileNames: '[ext]/[name]-[hash].[ext]'
      }
    },
    
    // 
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true, // console
        drop_debugger: true // debugger
      }
    },
    
    // 
    chunkSizeWarningLimit: 1000
  },
  
  // CSS
  css: {
    // CSS
    preprocessorOptions: {
      scss: {
        additionalData: `@import "@/styles/variables.scss";`
      },
      less: {
        javascriptEnabled: true,
        modifyVars: {
          '@primary-color': '#1890ff'
        }
      }
    },
    // CSS
    modules: {
      localsConvention: 'camelCase',
      scopeBehaviour: 'local'
    }
  },
  
  // 
  envPrefix: 'VITE_',
  
  // 
  optimizeDeps: {
    include: ['react', 'react-dom', 'react-router-dom'],
    exclude: ['your-local-package']
  }
});
```

## 

### 

```bash
# .env - 
VITE_APP_TITLE=My App

# .env.development - 
VITE_API_URL=http://localhost:8080
VITE_DEBUG=true

# .env.production - 
VITE_API_URL=https://api.example.com
VITE_DEBUG=false

# .env.local - git
VITE_SECRET_KEY=your-secret-key
```

### 

```typescript
// 
const apiUrl = import.meta.env.VITE_API_URL;
const isDebug = import.meta.env.VITE_DEBUG === 'true';
const mode = import.meta.env.MODE; // 'development' | 'production'
const isDev = import.meta.env.DEV; // boolean
const isProd = import.meta.env.PROD; // boolean

// TypeScript
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_API_URL: string;
  readonly VITE_DEBUG: string;
  readonly VITE_APP_TITLE: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

## 

### 

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import vue from '@vitejs/plugin-vue';
import legacy from '@vitejs/plugin-legacy';
import { visualizer } from 'rollup-plugin-visualizer';
import viteCompression from 'vite-plugin-compression';
import { createHtmlPlugin } from 'vite-plugin-html';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    // React
    react(),
    
    // Vue
    vue(),
    
    // 
    legacy({
      targets: ['defaults', 'not IE 11']
    }),
    
    // 
    visualizer({
      open: true,
      gzipSize: true,
      brotliSize: true
    }),
    
    // Gzip
    viteCompression({
      algorithm: 'gzip',
      ext: '.gz'
    }),
    
    // HTML
    createHtmlPlugin({
      minify: true,
      inject: {
        data: {
          title: 'My App',
          injectScript: '<script src="./inject.js"></script>'
        }
      }
    }),
    
    // PWA
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'My App',
        short_name: 'App',
        theme_color: '#ffffff',
        icons: [
          {
            src: '/icon-192.png',
            sizes: '192x192',
            type: 'image/png'
          }
        ]
      }
    })
  ]
});
```

### 

```typescript
// 
import type { Plugin } from 'vite';

function autoImportComponents(): Plugin {
  return {
    name: 'auto-import-components',
    
    // 
    transform(code, id) {
      if (!id.endsWith('.tsx') && !id.endsWith('.jsx')) {
        return null;
      }
      
      // import
      const imports = `
        import Button from '@/components/Button';
        import Input from '@/components/Input';
      `;
      
      return {
        code: imports + code,
        map: null
      };
    }
  };
}

// 
export default defineConfig({
  plugins: [autoImportComponents()]
});
```

## 

### 1. 

```typescript
export default defineConfig({
  optimizeDeps: {
    // 
    include: [
      'react',
      'react-dom',
      'react-router-dom',
      'axios',
      'lodash-es'
    ],
    
    // 
    exclude: ['your-local-package'],
    
    // esbuild
    esbuildOptions: {
      target: 'es2020',
      supported: {
        bigint: true
      }
    }
  }
});
```

### 2. 

```typescript
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks(id) {
          // node_modules
          if (id.includes('node_modules')) {
            // React
            if (id.includes('react') || id.includes('react-dom')) {
              return 'react-vendor';
            }
            // UI
            if (id.includes('antd') || id.includes('@ant-design')) {
              return 'ui-vendor';
            }
            // 
            if (id.includes('lodash') || id.includes('dayjs')) {
              return 'utils-vendor';
            }
            // 
            return 'vendor';
          }
          
          // 
          if (id.includes('src/pages/')) {
            const match = id.match(/src\/pages\/([^/]+)/);
            if (match) {
              return `page-${match[1]}`;
            }
          }
        }
      }
    }
  }
});
```

### 3. 

```typescript
import viteImagemin from 'vite-plugin-imagemin';

export default defineConfig({
  plugins: [
    viteImagemin({
      gifsicle: {
        optimizationLevel: 7,
        interlaced: false
      },
      optipng: {
        optimizationLevel: 7
      },
      mozjpeg: {
        quality: 80
      },
      pngquant: {
        quality: [0.8, 0.9],
        speed: 4
      },
      svgo: {
        plugins: [
          {
            name: 'removeViewBox'
          },
          {
            name: 'removeEmptyAttrs',
            active: false
          }
        ]
      }
    })
  ]
});
```

### 4. CDN

```typescript
export default defineConfig({
  build: {
    rollupOptions: {
      external: ['react', 'react-dom'],
      output: {
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM'
        }
      }
    }
  },
  
  // HTMLCDN
  plugins: [
    createHtmlPlugin({
      inject: {
        data: {
          injectScript: `
            <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
          `
        }
      }
    })
  ]
});
```

## 

```typescript
import { resolve } from 'path';

export default defineConfig({
  build: {
    rollupOptions: {
      input: {
        main: resolve(__dirname, 'index.html'),
        admin: resolve(__dirname, 'admin/index.html'),
        mobile: resolve(__dirname, 'mobile/index.html')
      }
    }
  }
});
```

## SSR

```typescript
// vite.config.ts
export default defineConfig({
  ssr: {
    // SSR
    external: ['react', 'react-dom'],
    // 
    noExternal: ['@your/package']
  }
});

// server.js
import express from 'express';
import { createServer as createViteServer } from 'vite';

async function createServer() {
  const app = express();
  
  // Vite
  const vite = await createViteServer({
    server: { middlewareMode: true },
    appType: 'custom'
  });
  
  app.use(vite.middlewares);
  
  app.use('*', async (req, res) => {
    const url = req.originalUrl;
    
    try {
      // HTML
      let template = await vite.transformIndexHtml(
        url,
        fs.readFileSync('index.html', 'utf-8')
      );
      
      // 
      const { render } = await vite.ssrLoadModule('/src/entry-server.tsx');
      
      // 
      const appHtml = await render(url);
      
      // HTML
      const html = template.replace('<!--ssr-outlet-->', appHtml);
      
      res.status(200).set({ 'Content-Type': 'text/html' }).end(html);
    } catch (e) {
      vite.ssrFixStacktrace(e);
      console.error(e);
      res.status(500).end(e.message);
    }
  });
  
  app.listen(3000);
}

createServer();
```

## 

### 1. 

```bash
# 
rm -rf node_modules/.vite

# 
vite --debug
```

### 2. 

```typescript
import { visualizer } from 'rollup-plugin-visualizer';

export default defineConfig({
  plugins: [
    visualizer({
      open: true,
      filename: 'dist/stats.html',
      gzipSize: true,
      brotliSize: true
    })
  ]
});
```

### 3. 

```typescript
export default defineConfig({
  build: {
    // 
    reportCompressedSize: true,
    
    rollupOptions: {
      // 
      output: {
        // chunk
        experimentalMinChunkSize: 1000
      }
    }
  }
});
```

## 

### 1. 

```
project/
 public/              # 
    favicon.ico
    robots.txt
 src/
    assets/         # 
    components/     # 
    pages/          # 
    utils/          # 
    styles/         # 
    App.tsx
    main.tsx
 .env                # 
 .env.development
 .env.production
 index.html
 package.json
 tsconfig.json
 vite.config.ts
```

### 2. 

```typescript
//  
import _ from 'lodash';

//  
import debounce from 'lodash-es/debounce';

//  
import * as Icons from '@ant-design/icons';

//  
import { UserOutlined, SettingOutlined } from '@ant-design/icons';
```

### 3. 

```typescript
// 
const Home = lazy(() => import('./pages/Home'));
const About = lazy(() => import('./pages/About'));

// 
if (import.meta.env.DEV) {
  import('./debug-tools').then(module => {
    module.init();
  });
}
```

### 4. 

```typescript
// 
import logo from './logo.png'; // URL

// 
import styles from './style.css?inline';

// URL
import workerUrl from './worker.js?url';

// 
import raw from './data.txt?raw';
```

## 

### 1. 

```typescript
// 
export default defineConfig({
  optimizeDeps: {
    include: ['problematic-package']
  }
});
```

### 2. HMR

```typescript
// HMR
export default defineConfig({
  server: {
    hmr: {
      overlay: true,
      // Docker
      host: '0.0.0.0',
      port: 3000
    }
  }
});
```

### 3. 

```typescript
// base
export default defineConfig({
  base: '/my-app/', // 
  // 
  base: './', // 
});
```

## 

Vite
-  ****ES
-  **HMR**
-  ****Rollup
-  ****
-  ****

Vite

