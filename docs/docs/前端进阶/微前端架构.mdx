---
sidebar_position: 4
title: 
tags: [, , qiankun, Module Federation]
---

# 



## 

### 

```javascript
const microFrontendConcept = {
  definition: '',
  
  benefits: [
    '',
    '',
    '',
    '',
    ''
  ],
  
  challenges: [
    'JS',
    '',
    '',
    '',
    ''
  ]
};
```

## 

### 1. iframe

```javascript
// 
class IframeMicroFrontend {
  constructor(container) {
    this.container = container;
  }
  
  load(url) {
    const iframe = document.createElement('iframe');
    iframe.src = url;
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    
    this.container.appendChild(iframe);
    
    return iframe;
  }
  
  // 
  postMessage(data) {
    this.iframe.contentWindow.postMessage(data, '*');
  }
}

// 
const iframeApproach = {
  pros: [
    '',
    '',
    ''
  ],
  
  cons: [
    'iframe',
    '',
    'postMessage',
    'SEO',
    ''
  ]
};
```

### 2. single-spa

```javascript
// single-spa
import { registerApplication, start } from 'single-spa';

// 
registerApplication({
  name: 'app1',
  app: () => System.import('app1'),
  activeWhen: '/app1',
  customProps: {
    domElement: document.getElementById('app1-container')
  }
});

registerApplication({
  name: 'app2',
  app: () => System.import('app2'),
  activeWhen: '/app2'
});

// 
start();

// 
export async function bootstrap(props) {
  // 
}

export async function mount(props) {
  // 
  ReactDOM.render(<App />, props.domElement);
}

export async function unmount(props) {
  // 
  ReactDOM.unmountComponentAtNode(props.domElement);
}
```

### 3. qiankun

```javascript
// qiankunsingle-spa
import { registerMicroApps, start } from 'qiankun';

// 
registerMicroApps([
  {
    name: 'react-app',
    entry: '//localhost:3000',
    container: '#container',
    activeRule: '/react',
    props: {
      data: { user: 'admin' }
    }
  },
  {
    name: 'vue-app',
    entry: '//localhost:8080',
    container: '#container',
    activeRule: '/vue'
  }
]);

// 
start({
  prefetch: true,        // 
  sandbox: true,         // 
  singular: false        // 
});

// React
// src/index.js
function render(props = {}) {
  const { container } = props;
  ReactDOM.render(
    <App />,
    container ? container.querySelector('#root') : document.getElementById('root')
  );
}

// 
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

// 
export async function bootstrap() {
  console.log('react app bootstraped');
}

export async function mount(props) {
  console.log('react app mount', props);
  render(props);
}

export async function unmount(props) {
  const { container } = props;
  ReactDOM.unmountComponentAtNode(
    container ? container.querySelector('#root') : document.getElementById('root')
  );
}

// webpack
module.exports = {
  output: {
    library: 'reactApp',
    libraryTarget: 'umd',
    publicPath: '//localhost:3000/'
  },
  devServer: {
    headers: {
      'Access-Control-Allow-Origin': '*'
    }
  }
};
```

### 4. Module Federation

```javascript
// Webpack 5Module Federation
//  webpack.config.js
const ModuleFederationPlugin = require('webpack/lib/container/ModuleFederationPlugin');

module.exports = {
  plugins: [
    new ModuleFederationPlugin({
      name: 'host',
      remotes: {
        app1: 'app1@http://localhost:3001/remoteEntry.js',
        app2: 'app2@http://localhost:3002/remoteEntry.js'
      },
      shared: {
        react: { singleton: true },
        'react-dom': { singleton: true }
      }
    })
  ]
};

// 
import React, { lazy, Suspense } from 'react';

const RemoteApp1 = lazy(() => import('app1/App'));
const RemoteApp2 = lazy(() => import('app2/App'));

function App() {
  return (
    <div>
      <Suspense fallback="Loading App1...">
        <RemoteApp1 />
      </Suspense>
      
      <Suspense fallback="Loading App2...">
        <RemoteApp2 />
      </Suspense>
    </div>
  );
}

//  webpack.config.js
module.exports = {
  plugins: [
    new ModuleFederationPlugin({
      name: 'app1',
      filename: 'remoteEntry.js',
      exposes: {
        './App': './src/App'
      },
      shared: {
        react: { singleton: true },
        'react-dom': { singleton: true }
      }
    })
  ]
};
```

## qiankun

### 

```javascript
// main/src/micro-app.js
import { registerMicroApps, start, initGlobalState } from 'qiankun';

// 
const initialState = {
  user: null,
  token: null
};

const actions = initGlobalState(initialState);

// 
actions.onGlobalStateChange((state, prev) => {
  console.log('', state, prev);
});

// 
registerMicroApps(
  [
    {
      name: 'react-app',
      entry: process.env.REACT_APP_URL,
      container: '#subapp-container',
      activeRule: '/react',
      props: {
        actions,
        data: { mainApp: 'data' }
      }
    },
    {
      name: 'vue-app',
      entry: process.env.VUE_APP_URL,
      container: '#subapp-container',
      activeRule: '/vue',
      props: { actions }
    }
  ],
  {
    // 
    beforeLoad: [
      app => {
        console.log('before load', app.name);
      }
    ],
    beforeMount: [
      app => {
        console.log('before mount', app.name);
      }
    ],
    afterMount: [
      app => {
        console.log('after mount', app.name);
      }
    ],
    beforeUnmount: [
      app => {
        console.log('before unmount', app.name);
      }
    ],
    afterUnmount: [
      app => {
        console.log('after unmount', app.name);
      }
    ]
  }
);

// 
start({
  prefetch: 'all',           // 
  sandbox: {
    strictStyleIsolation: true,  // 
    experimentalStyleIsolation: true
  },
  singular: false,           // 
  fetch: window.fetch        // fetch
});

export { actions };
```

### 

```javascript
// react-app/src/index.js
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';
import './public-path';

let root = null;

function render(props = {}) {
  const { container, actions } = props;
  
  // 
  if (actions) {
    actions.onGlobalStateChange((state, prev) => {
      console.log('', state, prev);
    });
  }
  
  root = ReactDOM.createRoot(
    container ? container.querySelector('#root') : document.getElementById('root')
  );
  
  root.render(<App actions={actions} />);
}

// 
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

// 
export async function bootstrap() {
  console.log('[react app] bootstraped');
}

export async function mount(props) {
  console.log('[react app] mount', props);
  render(props);
}

export async function unmount(props) {
  console.log('[react app] unmount', props);
  root.unmount();
}

export async function update(props) {
  console.log('[react app] update', props);
}

// public-path.js
if (window.__POWERED_BY_QIANKUN__) {
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}

// webpack.config.js
module.exports = {
  output: {
    library: `${packageName}-[name]`,
    libraryTarget: 'umd',
    chunkLoadingGlobal: `webpackJsonp_${packageName}`,
    publicPath: '//localhost:3000/'
  },
  devServer: {
    port: 3000,
    headers: {
      'Access-Control-Allow-Origin': '*'
    }
  }
};
```

## 

### JS

```javascript
// 
class SnapshotSandbox {
  constructor() {
    this.windowSnapshot = {};
    this.modifyPropsMap = {};
  }
  
  active() {
    // window
    for (const prop in window) {
      this.windowSnapshot[prop] = window[prop];
    }
    
    // 
    Object.keys(this.modifyPropsMap).forEach(prop => {
      window[prop] = this.modifyPropsMap[prop];
    });
  }
  
  inactive() {
    // 
    for (const prop in window) {
      if (window[prop] !== this.windowSnapshot[prop]) {
        this.modifyPropsMap[prop] = window[prop];
        window[prop] = this.windowSnapshot[prop];
      }
    }
  }
}

// Proxy
class ProxySandbox {
  constructor() {
    this.running = false;
    
    const fakeWindow = Object.create(null);
    
    this.proxyWindow = new Proxy(fakeWindow, {
      get: (target, prop) => {
        return prop in target ? target[prop] : window[prop];
      },
      
      set: (target, prop, value) => {
        if (this.running) {
          target[prop] = value;
        }
        return true;
      },
      
      has: (target, prop) => {
        return prop in target || prop in window;
      }
    });
  }
  
  active() {
    this.running = true;
  }
  
  inactive() {
    this.running = false;
  }
}
```

### 

```javascript
// 1. Shadow DOM
class ShadowDOMIsolation {
  mount(container, html) {
    const shadowRoot = container.attachShadow({ mode: 'open' });
    shadowRoot.innerHTML = html;
  }
}

// 2. CSS Modules
// hash
import styles from './App.module.css';

function App() {
  return <div className={styles.container}>App</div>;
}

// 3. CSS-in-JS
import styled from 'styled-components';

const Container = styled.div`
  color: red;
`;

// 4. 
class StyleIsolation {
  addPrefix(css, prefix) {
    return css.replace(/([^\r\n,{}]+)(,(?=[^}]*{)|\s*{)/g, (match, selector) => {
      return `${prefix} ${selector}`;
    });
  }
  
  mount(appName, css) {
    const prefixedCss = this.addPrefix(css, `[data-qiankun="${appName}"]`);
    const style = document.createElement('style');
    style.innerHTML = prefixedCss;
    document.head.appendChild(style);
  }
}
```

## 

### 

```javascript
// 
import { initGlobalState } from 'qiankun';

const initialState = {
  user: null,
  token: null,
  theme: 'light'
};

const actions = initGlobalState(initialState);

// 
actions.onGlobalStateChange((state, prev) => {
  console.log('', state, prev);
});

// 
actions.setGlobalState({
  user: { name: 'John', id: 1 }
});

// 
export async function mount(props) {
  const { actions } = props;
  
  // 
  actions.onGlobalStateChange((state, prev) => {
    console.log('', state);
    // 
    store.dispatch({ type: 'UPDATE_USER', payload: state.user });
  });
  
  // 
  actions.setGlobalState({
    token: 'new-token'
  });
}
```

### 

```javascript
class EventBus {
  constructor() {
    this.events = {};
  }
  
  on(event, callback) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(callback);
  }
  
  emit(event, data) {
    if (this.events[event]) {
      this.events[event].forEach(callback => callback(data));
    }
  }
  
  off(event, callback) {
    if (this.events[event]) {
      this.events[event] = this.events[event].filter(cb => cb !== callback);
    }
  }
}

// 
window.__MICRO_APP_EVENT_BUS__ = new EventBus();

// 
window.__MICRO_APP_EVENT_BUS__.on('user-login', (user) => {
  console.log('', user);
});

// 
window.__MICRO_APP_EVENT_BUS__.emit('user-login', {
  name: 'John',
  id: 1
});
```

## 

### 

```javascript
import { prefetchApps } from 'qiankun';

// 
prefetchApps([
  { name: 'app1', entry: '//localhost:3001' },
  { name: 'app2', entry: '//localhost:3002' }
]);

// 
start({
  prefetch(apps) {
    // 
    if ('requestIdleCallback' in window) {
      window.requestIdleCallback(() => {
        apps.forEach(app => {
          fetch(app.entry);
        });
      });
    }
    return [];
  }
});
```

### 

```javascript
// webpack externals
module.exports = {
  externals: {
    react: 'React',
    'react-dom': 'ReactDOM',
    'react-router-dom': 'ReactRouterDOM'
  }
};

// 
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

// Module Federation
new ModuleFederationPlugin({
  shared: {
    react: {
      singleton: true,
      requiredVersion: '^18.0.0'
    },
    'react-dom': {
      singleton: true,
      requiredVersion: '^18.0.0'
    }
  }
});
```

## 

```javascript
const bestPractices = {
  // 1. 
  splitting: {
    byBusiness: '',
    byTeam: '',
    byTech: ''
  },
  
  // 2. 
  routing: {
    mainApp: '',
    subApp: '',
    avoid: ''
  },
  
  // 3. 
  state: {
    global: '',
    local: '',
    communication: ''
  },
  
  // 4. 
  style: {
    prefix: 'CSS',
    modules: 'CSS Modules',
    scoped: 'scoped'
  },
  
  // 5. 
  performance: {
    prefetch: '',
    cache: '',
    lazy: '',
    cdn: 'CDN'
  }
};
```

## 


-  ****
-  ****JS
-  ****
-  ****
-  ****qiankunModule Federation
-  ****

****

