# Webpack

## Setup

``` bash
npm install webpack webpack-cli webpack-dev-server -D
npx webpack
npx webpack serve --open
```



## Mode 

- `development``tree shaking`
- `production``ES``tree shaking`

## Entry

`webpack``js``chunk``js``chunk``chunk``initial-chunk``non-initial-chunk`

``` js
// 
entry: './src/index.js',  
entry: {
    home: './src/index.js' 
}

// 
entry: { 
    home: './src/index.js', 
    test: './src/test.js' 
},
```

## Output



``` js
entry: {
    home: './src/index.js',
    test: './src/test.js'
},
output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'js/[name].[contenthash].bundle.js', // initial-chunk
    chunkFilename: '[contenthash].js', // non-initial-chunk
    clean: true, // clean-webpack-plugin
},
```

### publicPath

TOSCDN`publicPath`TOS

``` js
module.exports = {
		output: {
				publicPath: 'https://tos.xxx.com/yyy/'
		}
}
```

HTML

``` html
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
<script defer src="https://tos.xxx.com/yyy/js/main.5883839b305c23966b80.js"></script></head>
<body>
    <div id="root">hello</div>
</body>
</html>
```



### library

``` js
// webpack.config.js
output: {
    library: {
        type: 'umd',
    }
},
```





## Module

WebpackJavaScriptJavaScript*loader*

`loader`****`['style-loader', 'css-loader']``css``css``css-loader``style-loader``css`

### loader

#### style-loader

*style*

#### css-loader

> The `css-loader` interprets `@import` and `url()` like `import/require()` and will resolve them.

CSS Modules`.module.css``options.modules: true``css`

``` json
 {
    test: /\.css$/,
    use: ['style-loader', 'css-loader'],
 }
```

``` css
/* style.module.css */
.Root {
  background: 'pink'
}
```

``` jsx
import { Root } from './style.module.css'

function App() {
  return <div className={Root}></div>
}
```



#### sass-loader

``` shell
npm i sass sass-loader -D
```

``` json
{
    test: /\.s?css$/i,
    use: ['style-loader', 'css-loader', 'sass-loader'],
}
```



#### @svgr/webpack

SVGReact

``` shell
npm i @svgr/webpack -D
```

``` js
{
    test: /\.svg$/i,
    issuer: /\.[jt]sx?$/,
    use: ['@svgr/webpack'],
}
```

``` tsx
import Star from './star.svg'

const Example = () => (
  <div>
    <Star />
  </div>
)
```



#### esbuild-loader

``` js
{
    test: /\.(t|j)sx?$/,
    loader: 'esbuild-loader',
    options: {
      loader: 'tsx', // Or 'ts' if you don't need tsx
      target: 'es2015',
    },
},
```





### asset modules

*webpack5**asset modules**Webpack4*`raw-loader``url-loader``file-loader`



#### type/resource

> `file-loader`

``` js
module.exports = {
  module: {
   rules: [
     // webpack5
     {
       test: /\.png/,
       type: 'asset/resource',
       generator: {
          filename: 'static/[hash][ext][query]',
       },
     },
     
     // webpack4 file-loader
     {
        test: /\.png$/,
        use: [
          {
            loader: 'file-loader',
          },
        ],
      },
   ]
 },
}
```

``` js
import mainImage from './images/main.png';

img.src = mainImage; // '/dist/151cfcfa1bd74779aadb.png'
```



#### type/inline

>  `url-loader`

``` js
module.exports = {
  module: {
    rules: [
      // webpack5
      {
       	test: /\.svg/,
       	type: 'asset/inline'
     	},
      
      // webpack4 url-loader
      {
        test: /\.svg$/,
        use: [
          {
            loader: 'url-loader',
            options: {
              limit: 8192, // file-loader
            }
          },
        ],
      },
    ]
  }
}
```

``` js
import svg from './images/default.svg';

el.style.background = `url(${svg})`; // url(data:image/svg+xml;base64,xxxxxx)
```



#### type

`type/resource``type/inline``url-loader``file-loader``url-loader`



#### type/source

> `raw-loader`

``` js
module.exports = {
  module: {
    rules: [
      // webpack5
      {
       	test: /\.txt/,
       	type: 'asset/source'
     	},
      
      // webpack4 raw-loader
      {
        test: /\.txt$/,
        use: [
          { loader: 'raw-loader' },
        ],
      },
    ]
  }
}
```

``` markdown
Hello world
```

``` js
import txt from './hello.txt'
console.log(txt) // hello world
```



## Plugins

`webpack`



### 

#### DefinePlugin

********

``` js
module.exports = {
    plugins: [
        new webpack.DefinePlugin({
            PRODUCTION: JSON.stringify(true),
            VERSION: JSON.stringify('5fa3b9'),
            BROWSER_SUPPORTS_HTML5: true,
            TWO: '1+1',
            'typeof window': JSON.stringify('object'),
            'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV),
        });
    ],
};
```



#### ProvidePlugin

> Automatically load modules instead of having to `import` or `require` them everywhere.

- *TSX**React*

``` js
module.exports = {
    plugins: [
        new webpack.ProvidePlugin({
            React: 'react',
        })
    ],
};
```

- **Webpack5NodePoyfill**`process``Buffer`Node*Poyfill*`import buffer from 'buffer'``import stream from 'stream'``resolve.fallback`*Poyfill*

``` js
module.exports = {
		plugins: [
        new webpack.ProvidePlugin({
            process: 'process/browser',
            Buffer: ['buffer/', 'Buffer'], //  require('buffer/').Buffer
        }),
    ]
}
```





### 

#### html-webpack-plugin

HTMLHTMLJS

``` js
const HtmlWebpackPlugin = require('html-webpack-plugin');

const webpackConfig = {
        plugins: [
            new HtmlWebpackPlugin({
            template: path.resolve(__dirname, 'public/index.html'),
        }),
    ],
};
```



## Resolve

### extensions

``` js
module.exports = {
		resolve: {
        extensions: [".js", ".mjs", ".cjs", ".jsx", ".tsx"]
    }
}
```

``` js
import test from './app' // app.mjsapp.cjs
```



### alias



``` js
const path = require('path');

module.exports = {
  	resolve: {
    	alias: {
      		Test: path.join(__dirname, 'src/test/'),
    	},
  	},
};
```

``` js
import Test from 'Test/index.js' // src/test/index.js
```



### fallback

Node

``` js
module.exports = {
    resolve: {
        fallback: {
            stream: require.resolve('stream-browserify'), // npm i stream-browserify
            buffer: require.resolve('buffer/') // npm i buffer
        }
    }
}
```



### mainFields

[Node#package.json](https://messiahhh.github.io/blog/frontend/node.html#browser-module)



## Devtool

`sourceMap`

``` json
module.exports = {
  	devtool: 'source-map'
};
```



### source-map

`index.js``index.js.map``index.js``//# sourceMappingURL=index.js.map`

``` js
function A() {}
//# sourceMappingURL=index.js.map
```



### Inline-source-map

`sourceMap``index.js`

``` js
function A() {}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2Zxxxxxxxxxx
```



### eval-source-map

`index.js``eval``eval``sourceMap``eval``sourceMap``eval`

``` js
// index.js 
var __webpack_modules__ = {
      138: () => {
        eval(
          "const test = __webpack_require__(4)\n\ntest()//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2Zxxxxxxxxxx\n//# sourceURL=webpack-internal:///138\n"
        );
      },
      4: (module) => {
        eval(
          "module.exports = function test(a) {\n    let arr = [];\n    console.log(arr[4].age);\n    return 'test'\n}//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2Zxxxxxxxxxx\n//# sourceURL=webpack-internal:///4\n"
        );
      },
    },
```

`eval-source-map``source``webpack-internal://`









## DevServer

### static

``` js
module.exports = {
		devServer: {
      	open: true,
      	port: 9100,
      	static: {
          	directory: path.join(__dirname, 'dist'),
          	publicPath: "/",
        }
    }
}
```



### Hot Module Replacement

Webpack*Live Reloading*`liveReload`*Hot Module Replacement*`hot`HMRHot Reloading

- Live Reloading
- Hot Module ReplacementWebSocket

HMRLive ReloadingWebpackHMR`hot: true``module.hot.accept`WebpackLive Reloading

ReactHMR*Child.tsx*`xxx.hot-update.json``xxx.hot.js`

``` js
if (module.hot) {
    module.hot.accept('./Child.tsx', function() {
        ReactDOM.render(<App />, document.getElementById('root'));
    })
}
```

React`React-Hot-Loader`**[React Fast Refresh](https://github.com/pmmmwh/react-refresh-webpack-plugin)**



### proxy

``` js
module.exports = {
		devServer: {
      	proxy: {
          '/api': {
            target: 'http://localhost:9100', // 
            changeOrigin: true,
          },
        },
    }
}
```



## Optimization

### runtimeChunk

``` js
module.exports = {
    optimization: {
        runtimeChunk: 'single',
    },
}
```



### splitChunksPlugin

``` js
module.exports = {
    optimization: {
        splitChunks: {
          	chunks: 'all',
            maxInitialRequests: Infinity,
            minSize: 15000,
          	cacheGroups: {
                babel: {
                  test: /[\\/]node_modules[\\/]@babel[\\/]/,
                  minChunks: 1,
                  chunks: 'all',
                  name: 'babel',
                  priority: 20,
                },
            }
        },    
    },
}    
```



## Externals

``` typescript
import _ from 'lodash'
console.log(_)
```

`webpack``lodash`

`HTML``lodash``lodash``lodash``lodash`

`yarn add lodash -P``lodash``peer dependencies``lodash``externals``lodash`

``` js
module.exports = {
  externals: {
    lodash: '_'
  }
}
```

`node_modules``Node``webpack-node-externals`

``` js
const nodeExternals = require('webpack-node-externals');

module.exports = {
  externalsPresets: { node: true }, // webpack5webpack4target: node
  externals: [nodeExternals()]
}
```







## Tree Shaking

*Tree Shaking*JavaScriptDCE(*dead-code elimination*)ES`import``export`Tree Shaking

Tree ShakingRollupWebpackWebpackTree ShakingTree ShakingTree Shaking

`optimization``usedExports``minimize``concatenateModules`Tree Shaking

`usedExports`Webpack`/* unused harmony export <name> */``minimize``terser``concatenateModules`

Tree ShakingTree Shaking`index.tsx`AppTree Shaking`test.tsx``memo`

``` tsx title="index.tsx"
import App, { test } from './test'
console.log(test())
```

``` tsx title="test.tsx"
import React from 'react'

function App() {
    return <div>app</div>
}

export function test() {
    return 'test'
}

export default React.memo(App)
```

****Pure`sideEffects: false`Tree Shaking

`/*#__PURE__*/`

``` tsx title="test.tsx"
export default /*#__PURE__*/React.memo(App)
```

`package.json``sideEffects``ahooks``"sideEffects": false`****`antd`

``` json
{
  "sideEffects": [
    "dist/*",
    "es/**/style/*",
    "lib/**/style/*",
    "*.less"
  ],
}
```

`CSS``import './style.css'`



































## 



1. 
2. `splitChunksPlugin``lodash``Jquery``chunk`
3. `import()`





### 

`webpack`

`entry``thunk``thunkGroup`

`entry``thunkGroup``thunkGroup``thunk`



`thunk``thunkGroup``thunk``import()`

``` js
// webpack.config.js
entry: './src/index.js'

// index.js
import('./test.js').then(() => {
    ReactDOM.render(
        <App />,
        document.querySelector('#root')
    )
})
```

`webpack``dist``js``main.js``[id].js``id`

`/dist/main.js``initial thunk` `/dist/[id].js``non-initial thunk` 

`initial thunk``output.filename``non-initial thunk``output.chunkFileName``Magic comment`

``` js
// index.js
import(
    /* webpackChunkName: "akara" */
    './test.js'
).then(() => {
    ReactDOM.render(
        <App />,
        document.querySelector('#root')
    )
})
```

`non-initial thunk``akara.js`



`index.html``main.js``main.js``akara.js`





## 

`webpack``ES``CommonJS`

`webpack``var module = { exports: {}}``ES`

``` js
// ES a.js
export default function() {
    console.log('111')
}
export function A() {
    console.log('222')
}

// 
var module = {
    exports: {
        default: function() { console.log('111') }, // getter 
        A: function() { console.log('222') }, // 
    }
}
```

`CommonJS`****`default`

``` js
// CommonJS b.js
module.exports.A = function() {
    console.log('111');
}

module.exports.B = function() {
    console.log('222');
}

// 
var module = {
    exports: {
        A: function() { console.log('111') },
        B: function() { console.log('222') },
    }
}
```

`webpack``require``module.exports``import * as xxx from``default`

`module.__esModule``__webpack_require__.r`

