---
sidebar_position: 10
title: Nginx - Web服务器与反向代理
---

# Nginx - 高性能Web服务器

Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP代理服务器。它以高并发、低内存占用著称，是现代Web架构的核心组件。

## 为什么选择Nginx？

### 性能对比

| 特性 | Nginx | Apache | IIS |
|------|-------|--------|-----|
| 并发处理 | 10万+ | 1万+ | 5万+ |
| 内存占用 | 极低 | 中等 | 较高 |
| 配置难度 | 简单 | 复杂 | 中等 |
| 静态文件 | 极快 | 快 | 快 |
| 反向代理 | 优秀 | 一般 | 一般 |

### 应用场景

- **静态资源服务器**：图片、CSS、JS文件
- **反向代理**：负载均衡、API网关
- **HTTPS服务器**：SSL/TLS终止
- **缓存服务器**：减轻后端压力
- **限流限速**：防止恶意攻击

## 安装Nginx

### Ubuntu/Debian

```bash
# 更新软件源
sudo apt update

# 安装Nginx
sudo apt install nginx -y

# 启动Nginx
sudo systemctl start nginx

# 设置开机自启
sudo systemctl enable nginx

# 查看状态
sudo systemctl status nginx

# 测试配置文件
sudo nginx -t

# 重新加载配置（不中断服务）
sudo nginx -s reload
```

### CentOS/RHEL

```bash
# 安装Nginx
sudo yum install nginx -y

# 启动服务
sudo systemctl start nginx
sudo systemctl enable nginx
```

### Docker方式

```bash
# 运行Nginx容器
docker run -d \
  --name nginx \
  -p 80:80 \
  -v /path/to/html:/usr/share/nginx/html \
  -v /path/to/nginx.conf:/etc/nginx/nginx.conf \
  nginx:latest
```

### 验证安装

```bash
# 检查版本
nginx -v

# 访问测试
curl http://localhost

# 或在浏览器打开
# http://你的服务器IP
```

## 核心概念

### 目录结构

```bash
/etc/nginx/
├── nginx.conf              # 主配置文件
├── conf.d/                 # 子配置文件目录
│   └── default.conf
├── sites-available/        # 可用站点配置
├── sites-enabled/          # 启用站点配置（软链接）
├── snippets/               # 配置片段
├── mime.types              # 文件类型映射
└── modules-enabled/        # 启用的模块

/var/log/nginx/
├── access.log              # 访问日志
└── error.log               # 错误日志

/usr/share/nginx/html/      # 默认网站根目录
└── index.html
```

### 配置文件结构

```nginx
# 全局块：影响整个Nginx服务器
user nginx;
worker_processes auto;

# events块：影响Nginx服务器与用户的网络连接
events {
    worker_connections 1024;
}

# http块：配置HTTP服务器
http {
    # http全局块
    include mime.types;
    default_type application/octet-stream;
    
    # server块：配置虚拟主机
    server {
        # server全局块
        listen 80;
        server_name example.com;
        
        # location块：配置请求路由
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }
}
```

## 基础配置

### 1. 静态网站托管

```nginx
server {
    listen 80;
    server_name example.com www.example.com;
    
    # 网站根目录
    root /var/www/example.com;
    index index.html index.htm;
    
    # 日志配置
    access_log /var/log/nginx/example.access.log;
    error_log /var/log/nginx/example.error.log;
    
    # 主页面
    location / {
        try_files $uri $uri/ =404;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }
}
```

### 2. 反向代理

```nginx
# 代理到后端应用
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        # 代理到后端服务
        proxy_pass http://localhost:3000;
        
        # 传递真实IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 3. 负载均衡

```nginx
# 定义后端服务器组
upstream backend {
    # 轮询（默认）
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
    
    # 权重分配
    # server 192.168.1.10:8080 weight=3;
    # server 192.168.1.11:8080 weight=2;
    # server 192.168.1.12:8080 weight=1;
    
    # 健康检查
    # server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name app.example.com;
    
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 负载均衡策略

```nginx
# 1. 轮询（默认）
upstream backend {
    server server1.com;
    server server2.com;
}

# 2. 权重
upstream backend {
    server server1.com weight=3;
    server server2.com weight=1;
}

# 3. IP哈希（同一IP总是访问同一服务器）
upstream backend {
    ip_hash;
    server server1.com;
    server server2.com;
}

# 4. 最少连接
upstream backend {
    least_conn;
    server server1.com;
    server server2.com;
}

# 5. 响应时间最短（需要第三方模块）
upstream backend {
    fair;
    server server1.com;
    server server2.com;
}
```

## HTTPS配置

### 使用Let's Encrypt免费证书

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 自动配置HTTPS
sudo certbot --nginx -d example.com -d www.example.com

# 测试自动续期
sudo certbot renew --dry-run
```

### 手动配置HTTPS

```nginx
server {
    listen 80;
    server_name example.com www.example.com;
    
    # HTTP重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name example.com www.example.com;
    
    # SSL证书
    ssl_certificate /etc/nginx/ssl/example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example.com.key;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # HSTS（强制HTTPS）
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    # 其他安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    location / {
        root /var/www/example.com;
        index index.html;
    }
}
```

## 高级配置

### 1. 缓存配置

```nginx
# 定义缓存路径
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://backend;
        
        # 启用缓存
        proxy_cache my_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_valid 404 10m;
        
        # 缓存键
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        # 添加缓存状态头
        add_header X-Cache-Status $upstream_cache_status;
        
        # 缓存绕过条件
        proxy_cache_bypass $http_pragma $http_authorization;
        proxy_no_cache $http_pragma $http_authorization;
    }
}
```

### 2. Gzip压缩

```nginx
http {
    # 启用Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
    
    # 最小压缩文件大小
    gzip_min_length 1000;
}
```

### 3. 限流限速

```nginx
# 定义限流区域
http {
    # 限制请求频率（每秒10个请求）
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
    
    # 限制连接数
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    
    server {
        listen 80;
        server_name example.com;
        
        location /api/ {
            # 应用限流（允许突发20个请求）
            limit_req zone=req_limit burst=20 nodelay;
            
            # 限制并发连接数
            limit_conn conn_limit 10;
            
            # 限制下载速度（每秒500KB）
            limit_rate 500k;
            
            proxy_pass http://backend;
        }
    }
}
```

### 4. 防盗链

```nginx
location ~* \.(jpg|jpeg|png|gif)$ {
    valid_referers none blocked example.com *.example.com;
    if ($invalid_referer) {
        return 403;
        # 或返回防盗链图片
        # rewrite ^/ /images/forbidden.png break;
    }
}
```

### 5. 跨域配置（CORS）

```nginx
location /api/ {
    # 允许的源
    add_header Access-Control-Allow-Origin *;
    
    # 允许的方法
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
    
    # 允许的头
    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
    
    # 预检请求缓存时间
    add_header Access-Control-Max-Age 1728000;
    
    # 处理OPTIONS请求
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    
    proxy_pass http://backend;
}
```

### 6. WebSocket支持

```nginx
location /ws/ {
    proxy_pass http://backend;
    
    # WebSocket必需配置
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # 超时设置
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
}
```

## 实战项目

### 项目1：前后端分离部署

```nginx
# /etc/nginx/conf.d/myapp.conf

# 前端
server {
    listen 80;
    server_name www.example.com;
    
    root /var/www/frontend/dist;
    index index.html;
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# 后端API
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 项目2：多域名多项目

```nginx
# 项目1
server {
    listen 80;
    server_name project1.com;
    root /var/www/project1;
    index index.html;
}

# 项目2
server {
    listen 80;
    server_name project2.com;
    root /var/www/project2;
    index index.html;
}

# 项目3（Node.js应用）
server {
    listen 80;
    server_name project3.com;
    
    location / {
        proxy_pass http://localhost:3000;
    }
}
```

### 项目3：高可用架构

```nginx
# 主负载均衡器配置
upstream web_backend {
    # 健康检查
    server web1.example.com:80 max_fails=3 fail_timeout=30s;
    server web2.example.com:80 max_fails=3 fail_timeout=30s;
    server web3.example.com:80 backup;  # 备用服务器
}

upstream api_backend {
    least_conn;  # 最少连接
    server api1.example.com:8080 weight=3;
    server api2.example.com:8080 weight=2;
    server api3.example.com:8080 weight=1;
}

# 前端服务
server {
    listen 80;
    server_name www.example.com;
    
    location / {
        proxy_pass http://web_backend;
        proxy_next_upstream error timeout http_500 http_502 http_503;
    }
}

# API服务
server {
    listen 80;
    server_name api.example.com;
    
    # 限流
    limit_req zone=api_limit burst=50 nodelay;
    
    location / {
        proxy_pass http://api_backend;
        
        # 缓存
        proxy_cache api_cache;
        proxy_cache_valid 200 5m;
    }
}
```

### 项目4：Docker + Nginx微服务

```yaml
# docker-compose.yml
version: '3.8'

services:
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
    networks:
      - app-network

  frontend:
    build: ./frontend
    networks:
      - app-network

  backend:
    build: ./backend
    networks:
      - app-network

  database:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: secret
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
```

```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream frontend {
        server frontend:3000;
    }
    
    upstream backend {
        server backend:8000;
    }
    
    server {
        listen 80;
        
        location / {
            proxy_pass http://frontend;
        }
        
        location /api/ {
            proxy_pass http://backend;
        }
    }
}
```

## 性能优化

### 1. Worker进程优化

```nginx
# 自动设置为CPU核心数
worker_processes auto;

# 绑定worker到CPU核心
worker_cpu_affinity auto;

# 每个worker的最大连接数
events {
    worker_connections 10240;
    use epoll;  # Linux高效事件模型
}
```

### 2. 文件优化

```nginx
http {
    # 高效文件传输
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # 连接超时
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # 文件缓存
    open_file_cache max=10000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
}
```

### 3. 缓冲区优化

```nginx
http {
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    output_buffers 1 32k;
    postpone_output 1460;
}
```

## 监控与日志

### 1. 访问日志格式

```nginx
http {
    # 自定义日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';
    
    access_log /var/log/nginx/access.log main;
    
    # JSON格式日志（便于分析）
    log_format json escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time"'
    '}';
}
```

### 2. 状态监控

```nginx
# 启用状态页面
server {
    listen 8080;
    server_name localhost;
    
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}
```

访问 `http://localhost:8080/nginx_status` 查看：

```
Active connections: 291
server accepts handled requests
 16630948 16630948 31070465
Reading: 6 Writing: 179 Waiting: 106
```

### 3. 日志分析

```bash
# 统计访问最多的IP
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -10

# 统计访问最多的URL
awk '{print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -10

# 统计状态码分布
awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -rn

# 统计响应时间
awk '{print $NF}' /var/log/nginx/access.log | sort -n | tail -100

# 实时查看日志
tail -f /var/log/nginx/access.log

# 使用GoAccess分析日志（需安装）
goaccess /var/log/nginx/access.log -o report.html --log-format=COMBINED
```

## 常见问题

### 1. 403 Forbidden

```bash
# 检查文件权限
ls -la /var/www/html

# 修改权限
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html

# 检查SELinux（CentOS）
getenforce
sudo setenforce 0
```

### 2. 502 Bad Gateway

```bash
# 检查后端服务是否运行
netstat -tuln | grep 3000

# 检查防火墙
sudo ufw status

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

### 3. 配置测试失败

```bash
# 测试配置
sudo nginx -t

# 查看详细错误
sudo nginx -t -c /etc/nginx/nginx.conf

# 检查语法
sudo nginx -T
```

### 4. 重启失败

```bash
# 查看Nginx状态
sudo systemctl status nginx

# 查看端口占用
sudo lsof -i :80

# 杀掉占用进程
sudo kill -9 $(lsof -t -i:80)

# 重新启动
sudo systemctl restart nginx
```

## 最佳实践

### 1. 配置文件组织

```bash
/etc/nginx/
├── nginx.conf                    # 主配置
├── conf.d/
│   ├── gzip.conf                # Gzip配置
│   ├── security.conf            # 安全配置
│   └── cache.conf               # 缓存配置
└── sites-available/
    ├── example.com.conf         # 站点配置
    └── api.example.com.conf
```

### 2. 安全加固

```nginx
# 隐藏版本号
http {
    server_tokens off;
}

# 限制请求方法
server {
    if ($request_method !~ ^(GET|POST|HEAD)$) {
        return 405;
    }
}

# 防止点击劫持
add_header X-Frame-Options "SAMEORIGIN" always;

# 防止MIME类型嗅探
add_header X-Content-Type-Options "nosniff" always;

# XSS保护
add_header X-XSS-Protection "1; mode=block" always;

# CSP策略
add_header Content-Security-Policy "default-src 'self'" always;
```

### 3. 备份配置

```bash
# 备份配置文件
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup

# 定期备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d)
tar -czf /backup/nginx-$DATE.tar.gz /etc/nginx/
```

## 学习资源

- **官方文档**：https://nginx.org/en/docs/
- **Nginx配置生成器**：https://www.digitalocean.com/community/tools/nginx
- **测试工具**：https://github.com/yandex/gixy（配置安全检查）

记住：**Nginx配置修改后一定要先测试（nginx -t），再重载（nginx -s reload）！**

