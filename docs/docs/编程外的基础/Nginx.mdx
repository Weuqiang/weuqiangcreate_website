---
sidebar_position: 10
title: Nginx - Web
---

# Nginx - Web

NginxHTTPIMAP/POP3/SMTPWeb

## Nginx

### 

|  | Nginx | Apache | IIS |
|------|-------|--------|-----|
|  | 10+ | 1+ | 5+ |
|  |  |  |  |
|  |  |  |  |
|  |  |  |  |
|  |  |  |  |

### 

- ****CSSJS
- ****API
- **HTTPS**SSL/TLS
- ****
- ****

## Nginx

### Ubuntu/Debian

```bash
# 
sudo apt update

# Nginx
sudo apt install nginx -y

# Nginx
sudo systemctl start nginx

# 
sudo systemctl enable nginx

# 
sudo systemctl status nginx

# 
sudo nginx -t

# 
sudo nginx -s reload
```

### CentOS/RHEL

```bash
# Nginx
sudo yum install nginx -y

# 
sudo systemctl start nginx
sudo systemctl enable nginx
```

### Docker

```bash
# Nginx
docker run -d \
  --name nginx \
  -p 80:80 \
  -v /path/to/html:/usr/share/nginx/html \
  -v /path/to/nginx.conf:/etc/nginx/nginx.conf \
  nginx:latest
```

### 

```bash
# 
nginx -v

# 
curl http://localhost

# 
# http://IP
```

## 

### 

```bash
/etc/nginx/
 nginx.conf              # 
 conf.d/                 # 
    default.conf
 sites-available/        # 
 sites-enabled/          # 
 snippets/               # 
 mime.types              # 
 modules-enabled/        # 

/var/log/nginx/
 access.log              # 
 error.log               # 

/usr/share/nginx/html/      # 
 index.html
```

### 

```nginx
# Nginx
user nginx;
worker_processes auto;

# eventsNginx
events {
    worker_connections 1024;
}

# httpHTTP
http {
    # http
    include mime.types;
    default_type application/octet-stream;
    
    # server
    server {
        # server
        listen 80;
        server_name example.com;
        
        # location
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }
}
```

## 

### 1. 

```nginx
server {
    listen 80;
    server_name example.com www.example.com;
    
    # 
    root /var/www/example.com;
    index index.html index.htm;
    
    # 
    access_log /var/log/nginx/example.access.log;
    error_log /var/log/nginx/example.error.log;
    
    # 
    location / {
        try_files $uri $uri/ =404;
    }
    
    # 
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 
    location ~ /\. {
        deny all;
    }
}
```

### 2. 

```nginx
# 
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        # 
        proxy_pass http://localhost:3000;
        
        # IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 3. 

```nginx
# 
upstream backend {
    # 
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
    
    # 
    # server 192.168.1.10:8080 weight=3;
    # server 192.168.1.11:8080 weight=2;
    # server 192.168.1.12:8080 weight=1;
    
    # 
    # server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name app.example.com;
    
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 

```nginx
# 1. 
upstream backend {
    server server1.com;
    server server2.com;
}

# 2. 
upstream backend {
    server server1.com weight=3;
    server server2.com weight=1;
}

# 3. IPIP
upstream backend {
    ip_hash;
    server server1.com;
    server server2.com;
}

# 4. 
upstream backend {
    least_conn;
    server server1.com;
    server server2.com;
}

# 5. 
upstream backend {
    fair;
    server server1.com;
    server server2.com;
}
```

## HTTPS

### Let's Encrypt

```bash
# Certbot
sudo apt install certbot python3-certbot-nginx -y

# HTTPS
sudo certbot --nginx -d example.com -d www.example.com

# 
sudo certbot renew --dry-run
```

### HTTPS

```nginx
server {
    listen 80;
    server_name example.com www.example.com;
    
    # HTTPHTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name example.com www.example.com;
    
    # SSL
    ssl_certificate /etc/nginx/ssl/example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example.com.key;
    
    # SSL
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # HSTSHTTPS
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    # 
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    location / {
        root /var/www/example.com;
        index index.html;
    }
}
```

## 

### 1. 

```nginx
# 
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://backend;
        
        # 
        proxy_cache my_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_valid 404 10m;
        
        # 
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        # 
        add_header X-Cache-Status $upstream_cache_status;
        
        # 
        proxy_cache_bypass $http_pragma $http_authorization;
        proxy_no_cache $http_pragma $http_authorization;
    }
}
```

### 2. Gzip

```nginx
http {
    # Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
    
    # 
    gzip_min_length 1000;
}
```

### 3. 

```nginx
# 
http {
    # 10
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
    
    # 
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    
    server {
        listen 80;
        server_name example.com;
        
        location /api/ {
            # 20
            limit_req zone=req_limit burst=20 nodelay;
            
            # 
            limit_conn conn_limit 10;
            
            # 500KB
            limit_rate 500k;
            
            proxy_pass http://backend;
        }
    }
}
```

### 4. 

```nginx
location ~* \.(jpg|jpeg|png|gif)$ {
    valid_referers none blocked example.com *.example.com;
    if ($invalid_referer) {
        return 403;
        # 
        # rewrite ^/ /images/forbidden.png break;
    }
}
```

### 5. CORS

```nginx
location /api/ {
    # 
    add_header Access-Control-Allow-Origin *;
    
    # 
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
    
    # 
    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
    
    # 
    add_header Access-Control-Max-Age 1728000;
    
    # OPTIONS
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    
    proxy_pass http://backend;
}
```

### 6. WebSocket

```nginx
location /ws/ {
    proxy_pass http://backend;
    
    # WebSocket
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # 
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
}
```

## 

### 1

```nginx
# /etc/nginx/conf.d/myapp.conf

# 
server {
    listen 80;
    server_name www.example.com;
    
    root /var/www/frontend/dist;
    index index.html;
    
    # SPA
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# API
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 2

```nginx
# 1
server {
    listen 80;
    server_name project1.com;
    root /var/www/project1;
    index index.html;
}

# 2
server {
    listen 80;
    server_name project2.com;
    root /var/www/project2;
    index index.html;
}

# 3Node.js
server {
    listen 80;
    server_name project3.com;
    
    location / {
        proxy_pass http://localhost:3000;
    }
}
```

### 3

```nginx
# 
upstream web_backend {
    # 
    server web1.example.com:80 max_fails=3 fail_timeout=30s;
    server web2.example.com:80 max_fails=3 fail_timeout=30s;
    server web3.example.com:80 backup;  # 
}

upstream api_backend {
    least_conn;  # 
    server api1.example.com:8080 weight=3;
    server api2.example.com:8080 weight=2;
    server api3.example.com:8080 weight=1;
}

# 
server {
    listen 80;
    server_name www.example.com;
    
    location / {
        proxy_pass http://web_backend;
        proxy_next_upstream error timeout http_500 http_502 http_503;
    }
}

# API
server {
    listen 80;
    server_name api.example.com;
    
    # 
    limit_req zone=api_limit burst=50 nodelay;
    
    location / {
        proxy_pass http://api_backend;
        
        # 
        proxy_cache api_cache;
        proxy_cache_valid 200 5m;
    }
}
```

### 4Docker + Nginx

```yaml
# docker-compose.yml
version: '3.8'

services:
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
    networks:
      - app-network

  frontend:
    build: ./frontend
    networks:
      - app-network

  backend:
    build: ./backend
    networks:
      - app-network

  database:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: secret
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
```

```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream frontend {
        server frontend:3000;
    }
    
    upstream backend {
        server backend:8000;
    }
    
    server {
        listen 80;
        
        location / {
            proxy_pass http://frontend;
        }
        
        location /api/ {
            proxy_pass http://backend;
        }
    }
}
```

## 

### 1. Worker

```nginx
# CPU
worker_processes auto;

# workerCPU
worker_cpu_affinity auto;

# worker
events {
    worker_connections 10240;
    use epoll;  # Linux
}
```

### 2. 

```nginx
http {
    # 
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # 
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # 
    open_file_cache max=10000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
}
```

### 3. 

```nginx
http {
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    output_buffers 1 32k;
    postpone_output 1460;
}
```

## 

### 1. 

```nginx
http {
    # 
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';
    
    access_log /var/log/nginx/access.log main;
    
    # JSON
    log_format json escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time"'
    '}';
}
```

### 2. 

```nginx
# 
server {
    listen 8080;
    server_name localhost;
    
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}
```

 `http://localhost:8080/nginx_status` 

```
Active connections: 291
server accepts handled requests
 16630948 16630948 31070465
Reading: 6 Writing: 179 Waiting: 106
```

### 3. 

```bash
# IP
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -10

# URL
awk '{print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -10

# 
awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -rn

# 
awk '{print $NF}' /var/log/nginx/access.log | sort -n | tail -100

# 
tail -f /var/log/nginx/access.log

# GoAccess
goaccess /var/log/nginx/access.log -o report.html --log-format=COMBINED
```

## 

### 1. 403 Forbidden

```bash
# 
ls -la /var/www/html

# 
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html

# SELinuxCentOS
getenforce
sudo setenforce 0
```

### 2. 502 Bad Gateway

```bash
# 
netstat -tuln | grep 3000

# 
sudo ufw status

# 
sudo tail -f /var/log/nginx/error.log
```

### 3. 

```bash
# 
sudo nginx -t

# 
sudo nginx -t -c /etc/nginx/nginx.conf

# 
sudo nginx -T
```

### 4. 

```bash
# Nginx
sudo systemctl status nginx

# 
sudo lsof -i :80

# 
sudo kill -9 $(lsof -t -i:80)

# 
sudo systemctl restart nginx
```

## 

### 1. 

```bash
/etc/nginx/
 nginx.conf                    # 
 conf.d/
    gzip.conf                # Gzip
    security.conf            # 
    cache.conf               # 
 sites-available/
     example.com.conf         # 
     api.example.com.conf
```

### 2. 

```nginx
# 
http {
    server_tokens off;
}

# 
server {
    if ($request_method !~ ^(GET|POST|HEAD)$) {
        return 405;
    }
}

# 
add_header X-Frame-Options "SAMEORIGIN" always;

# MIME
add_header X-Content-Type-Options "nosniff" always;

# XSS
add_header X-XSS-Protection "1; mode=block" always;

# CSP
add_header Content-Security-Policy "default-src 'self'" always;
```

### 3. 

```bash
# 
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup

# 
#!/bin/bash
DATE=$(date +%Y%m%d)
tar -czf /backup/nginx-$DATE.tar.gz /etc/nginx/
```

## 

- ****https://nginx.org/en/docs/
- **Nginx**https://www.digitalocean.com/community/tools/nginx
- ****https://github.com/yandex/gixy

**Nginxnginx -tnginx -s reload**

