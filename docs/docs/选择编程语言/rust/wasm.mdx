# Rust + Web

RustWebAssemblyNode-API

- WebAssemblyWebNode
- Node-APINode`.node`



## WebAssembly

WebAssemblyJavaScriptWASMC++RustWeb



### wasm-pack

`wasm-pack`RustRustWASM[](https://rustwasm.github.io/wasm-pack/)

`wasm-bindgen``js-sys``web-sys``wasm-bindgen-futures`WASMJS`Cargo.toml`

``` toml title="Cargo.toml"
[package]
name = "hello_world"
version = "0.1.0"

[lib]
crate-type = ["cdylib"]

[dependencies]
wasm-bindgen = "0.2.84"
js-sys = "0.3.61"
wasm-bindgen-futures = "0.4.34"

[dependencies.web-sys]
version = "0.3.4"
features = [
  'Document',
  'Element',
  'HtmlElement',
  'Node',
  'Window',
]
```

``` rust title="lib.rs"
use wasm_bindgen::prelude::*;

#[wasm_bindgen]
extern {
    fn alert(s: &str);
}

#[wasm_bindgen]
pub fn greet() {
    alert("Hello, learn-wasm!");
}
```

- Webpack`@wasm-tool/wasm-pack-plugin``experiments.asyncWebAssembly`

  ``` shell
  wasm-pack build # webpack
  ```

- Web

  ``` shell
  wasm-pack build --target web # 
  ```

- Node

  ``` shell
  wasm-pack build --target node # node
  ```

  



### wasm-bindgen

`#[wasm_bindgen]`WASMJSRust`alert``console`



#### js-sys

JavaScript`Object``Function``Reflect`` WebAssembly`

``` rust title="lib.rs"
use js_sys::{Function, Object, Reflect, WebAssembly};
```



#### web-sys

Web API`Window``Document`

``` rust title="lib.rs"
use wasm_bindgen::prelude::*;

// Called by our JS entry point to run the example
#[wasm_bindgen(start)]
pub fn run() -> Result<(), JsValue> {
    // Use `web_sys`'s global `window` function to get a handle on the global
    // window object.
    let window = web_sys::window().expect("no global `window` exists");
    let document = window.document().expect("should have a document on window");
    let body = document.body().expect("document should have a body");

    // Manufacture the element we're gonna append
    let val = document.create_element("p")?;
    val.set_text_content(Some("Hello from Rust!"));

    body.append_child(&val)?;

    Ok(())
}
```





## Node-API

NodeWASMNode-APINodeC++`fs``path``http`C++NodeC++addonsNodeC++ addonsNodeNode-APIRustNode-APINodeRust`neon``napi-rs`



### @napi-rs

`@napi-rs`Node.jsRustNode.js

#### 

```shell
# 
npm init napi
# 
yarn create napi

# 
npm install
```

#### 

```rust
// src/lib.rs
use napi::bindgen_prelude::*;

#[napi]
fn fibonacci(n: u32) -> u32 {
    match n {
        1 | 2 => 1,
        _ => fibonacci(n - 1) + fibonacci(n - 2),
    }
}

#[napi]
fn get_words() -> Vec<String> {
    vec!["hello".to_string(), "world".to_string()]
}

#[napi]
struct User {
    pub name: String,
    pub age: u32,
}

#[napi]
impl User {
    #[napi(constructor)]
    pub fn new(name: String, age: u32) -> Self {
        User { name, age }
    }

    #[napi(getter)]
    pub fn get_name(&self) -> &str {
        &self.name
    }

    #[napi]
    pub fn greet(&self) -> String {
        format!("Hello, I'm {} and I'm {} years old", self.name, self.age)
    }
}
```

#### JavaScript

```javascript
// index.js
const { fibonacci, getWords, User } = require('./index.node');

console.log(fibonacci(10)); // 55
console.log(getWords()); // ['hello', 'world']

const user = new User('Alice', 25);
console.log(user.name); // 'Alice'
console.log(user.greet()); // "Hello, I'm Alice and I'm 25 years old"
```

#### 

```rust
use napi::bindgen_prelude::*;
use tokio::time::{sleep, Duration};

#[napi]
async fn async_task(ms: u32) -> Result<String> {
    sleep(Duration::from_millis(ms as u64)).await;
    Ok(format!("Task completed after {}ms", ms))
}

#[napi]
fn sync_task_with_callback(callback: JsFunction) -> Result<()> {
    let result = "Task completed";
    callback.call(None, &[result.into()])?;
    Ok(())
}
```

#### 

```toml
# Cargo.toml
[package]
name = "my-napi-project"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]

[dependencies]
napi = { version = "2", default-features = false, features = ["napi4"] }
napi-derive = "2"
tokio = { version = "1", features = ["full"] }

[build-dependencies]
napi-build = "2"
```

```json
// package.json
{
  "name": "my-napi-project",
  "version": "1.0.0",
  "main": "index.js",
  "types": "index.d.ts",
  "napi": {
    "name": "my-napi-project",
    "triples": {
      "defaults": true,
      "additional": [
        "x86_64-unknown-linux-musl",
        "aarch64-apple-darwin",
        "aarch64-unknown-linux-gnu",
        "aarch64-pc-windows-msvc"
      ]
    }
  },
  "scripts": {
    "artifacts": "napi artifacts",
    "build": "napi build --platform --release",
    "build:debug": "napi build --platform",
    "prepublishOnly": "napi prepublish -t npm",
    "test": "ava",
    "version": "napi version"
  },
  "devDependencies": {
    "@napi-rs/cli": "^2.0.0"
  }
}
```

#### 

```shell
# 
npm run build:debug

# 
npm run build

# 
napi build --platform --release --strip

# npm
npm run prepublishOnly
npm publish
```

## WebAssembly vs Node-API 

|  | WebAssembly | Node-API |
|------|-------------|----------|
| **** |  + Node.js |  Node.js |
| **** |  |  |
| **** |  |  |
| **** |  |  |
| **** |  | Node.js  |
| **** |  |  |
| **** |  |  |

## 

###  WebAssembly 
- Node.js
- 
- 
- 

###  Node-API 
- Node.js
- 
- Node.js
- 

## 

### WebAssembly 
1. ****
2. **JS-WASM**
3. ****
4. ****`wee_alloc`

### Node-API 
1. ****RustResult
2. ****
3. ****tokio
4. ****Rust



