---
sidebar_position: 3
title: ç§’æ€ç³»ç»Ÿè®¾è®¡
tags: [ç³»ç»Ÿè®¾è®¡, é«˜å¹¶å‘, ç§’æ€]
---

# ç§’æ€ç³»ç»Ÿè®¾è®¡

ç§’æ€ç³»ç»Ÿæ˜¯å…¸å‹çš„é«˜å¹¶å‘åœºæ™¯ï¼Œæœ¬æ–‡å°†è¯¦ç»†è®²è§£å¦‚ä½•è®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿæ‰¿å—ç™¾ä¸‡çº§å¹¶å‘çš„ç§’æ€ç³»ç»Ÿã€‚

## ä¸šåŠ¡åœºæ™¯

### ç§’æ€ç‰¹ç‚¹

```mermaid
graph TB
    A[ç§’æ€ç‰¹ç‚¹] --> B[ç¬æ—¶é«˜å¹¶å‘]
    A --> C[è¯»å¤šå†™å°‘]
    A --> D[åº“å­˜æœ‰é™]
    A --> E[æ—¶é—´é›†ä¸­]
    
    style A fill:#42b883
    style B fill:#ffe1e1
```

**æ ¸å¿ƒæŒ‘æˆ˜**:
- ğŸ”¥ **ç¬æ—¶æµé‡**: å¹³æ—¶QPS 1000ï¼Œç§’æ€æ—¶QPS 100ä¸‡+
- ğŸ“Š **è¯»å†™æ¯”ä¾‹**: è¯»å†™æ¯”å¯è¾¾1000:1
- â° **æ—¶é—´é›†ä¸­**: æµé‡é›†ä¸­åœ¨å¼€å§‹çš„å‡ ç§’å†…
- ğŸ¯ **è¶…å–é—®é¢˜**: å¿…é¡»ä¿è¯åº“å­˜å‡†ç¡®æ€§
- ğŸš« **æ¶æ„è¯·æ±‚**: é˜²æ­¢åˆ·å•ã€é»„ç‰›

## éœ€æ±‚åˆ†æ

### åŠŸèƒ½éœ€æ±‚

```javascript
// æ ¸å¿ƒåŠŸèƒ½
const requirements = {
  // 1. ç§’æ€å‰
  preStart: {
    showCountdown: true,      // æ˜¾ç¤ºå€’è®¡æ—¶
    showProductInfo: true,    // å±•ç¤ºå•†å“ä¿¡æ¯
    allowReminder: true       // å…è®¸è®¾ç½®æé†’
  },
  
  // 2. ç§’æ€ä¸­
  during: {
    placeOrder: true,         // ä¸‹å•
    checkInventory: true,     // æ£€æŸ¥åº“å­˜
    preventOversell: true,    // é˜²æ­¢è¶…å–
    limitPerUser: true        // é™åˆ¶æ¯äººè´­ä¹°æ•°é‡
  },
  
  // 3. ç§’æ€å
  postEnd: {
    showResult: true,         // æ˜¾ç¤ºç»“æœ
    processPayment: true,     // å¤„ç†æ”¯ä»˜
    handleTimeout: true       // å¤„ç†è¶…æ—¶è®¢å•
  }
};
```

### éåŠŸèƒ½éœ€æ±‚

```javascript
const nonFunctionalRequirements = {
  // æ€§èƒ½è¦æ±‚
  performance: {
    qps: 1_000_000,           // 100ä¸‡QPS
    latency: 100,             // 100mså†…å“åº”
    concurrency: 10_000_000   // 1000ä¸‡å¹¶å‘ç”¨æˆ·
  },
  
  // å¯ç”¨æ€§è¦æ±‚
  availability: {
    uptime: 99.99,            // 99.99%å¯ç”¨æ€§
    failover: true,           // æ•…éšœè½¬ç§»
    degradation: true         // æœåŠ¡é™çº§
  },
  
  // ä¸€è‡´æ€§è¦æ±‚
  consistency: {
    inventory: 'strong',      // åº“å­˜å¼ºä¸€è‡´æ€§
    order: 'eventual'         // è®¢å•æœ€ç»ˆä¸€è‡´æ€§
  }
};
```

## å®¹é‡ä¼°ç®—

### æµé‡ä¼°ç®—

```python
# ç§’æ€åœºæ™¯ä¼°ç®—
å‚ä¸ç”¨æˆ·æ•° = 10_000_000      # 1000ä¸‡ç”¨æˆ·
ç§’æ€æ—¶é•¿ = 10                # 10ç§’
å•†å“æ•°é‡ = 10_000            # 1ä¸‡ä»¶å•†å“

# QPSè®¡ç®—
æ€»è¯·æ±‚æ•° = å‚ä¸ç”¨æˆ·æ•° * 3    # æ¯äººå¹³å‡3æ¬¡è¯·æ±‚ï¼ˆåˆ·æ–°+ä¸‹å•+æŸ¥è¯¢ï¼‰
QPS_å³°å€¼ = æ€»è¯·æ±‚æ•° / ç§’æ€æ—¶é•¿

print(f"å³°å€¼QPS: {QPS_å³°å€¼:,}")  # 3,000,000 QPS

# æˆåŠŸç‡
æˆåŠŸè®¢å•æ•° = å•†å“æ•°é‡
æˆåŠŸç‡ = æˆåŠŸè®¢å•æ•° / å‚ä¸ç”¨æˆ·æ•° * 100

print(f"æˆåŠŸç‡: {æˆåŠŸç‡:.2f}%")  # 0.1%

# å¸¦å®½ä¼°ç®—
æ¯æ¬¡è¯·æ±‚å¤§å° = 1024          # 1KB
æ¯æ¬¡å“åº”å¤§å° = 2048          # 2KB

å…¥å¸¦å®½_Gbps = (QPS_å³°å€¼ * æ¯æ¬¡è¯·æ±‚å¤§å° * 8) / (1024 ** 3)
å‡ºå¸¦å®½_Gbps = (QPS_å³°å€¼ * æ¯æ¬¡å“åº”å¤§å° * 8) / (1024 ** 3)

print(f"å…¥å¸¦å®½: {å…¥å¸¦å®½_Gbps:.2f} Gbps")
print(f"å‡ºå¸¦å®½: {å‡ºå¸¦å®½_Gbps:.2f} Gbps")
```

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç”¨æˆ·ç«¯     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚     CDN     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  è´Ÿè½½å‡è¡¡å™¨  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ æ¥å…¥å±‚   â”‚       â”‚ æ¥å…¥å±‚   â”‚       â”‚ æ¥å…¥å±‚   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  ä¸šåŠ¡å±‚      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚  Redis  â”‚       â”‚  MQ     â”‚       â”‚  MySQL  â”‚
   â”‚  ç¼“å­˜   â”‚       â”‚ æ¶ˆæ¯é˜Ÿåˆ— â”‚       â”‚ æ•°æ®åº“  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚è®¾è®¡

```javascript
// 1. æ¥å…¥å±‚ - æµé‡æ§åˆ¶
class AccessLayer {
  async handleRequest(request) {
    // 1.1 é™æµ
    if (!await this.rateLimiter.allow(request.userId)) {
      return { code: 429, message: 'è¯·æ±‚è¿‡äºé¢‘ç¹' };
    }
    
    // 1.2 éªŒè¯
    if (!await this.validator.check(request)) {
      return { code: 400, message: 'è¯·æ±‚å‚æ•°é”™è¯¯' };
    }
    
    // 1.3 é˜²åˆ·
    if (await this.antiBot.isBot(request)) {
      return { code: 403, message: 'æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º' };
    }
    
    // è½¬å‘åˆ°ä¸šåŠ¡å±‚
    return await this.businessLayer.process(request);
  }
}

// 2. ä¸šåŠ¡å±‚ - æ ¸å¿ƒé€»è¾‘
class BusinessLayer {
  async process(request) {
    const { userId, productId, quantity } = request;
    
    // 2.1 æ£€æŸ¥ç§’æ€æ˜¯å¦å¼€å§‹
    if (!await this.checkSeckillTime(productId)) {
      return { code: 400, message: 'ç§’æ€æœªå¼€å§‹æˆ–å·²ç»“æŸ' };
    }
    
    // 2.2 æ£€æŸ¥ç”¨æˆ·èµ„æ ¼
    if (!await this.checkUserEligibility(userId, productId)) {
      return { code: 403, message: 'æ‚¨ä¸ç¬¦åˆå‚ä¸æ¡ä»¶' };
    }
    
    // 2.3 é¢„æ‰£åº“å­˜
    const success = await this.deductInventory(productId, quantity);
    if (!success) {
      return { code: 400, message: 'å•†å“å·²å”®ç½„' };
    }
    
    // 2.4 åˆ›å»ºè®¢å•ï¼ˆå¼‚æ­¥ï¼‰
    await this.createOrderAsync(userId, productId, quantity);
    
    return { code: 200, message: 'æŠ¢è´­æˆåŠŸï¼Œè¯·å°½å¿«æ”¯ä»˜' };
  }
}

// 3. æ•°æ®å±‚ - å­˜å‚¨
class DataLayer {
  // Redisç¼“å­˜åº“å­˜
  async getInventory(productId) {
    return await this.redis.get(`inventory:${productId}`);
  }
  
  // åŸå­æ‰£å‡åº“å­˜
  async deductInventory(productId, quantity) {
    const script = `
      local key = KEYS[1]
      local quantity = tonumber(ARGV[1])
      local inventory = tonumber(redis.call('get', key))
      
      if inventory >= quantity then
        redis.call('decrby', key, quantity)
        return 1
      else
        return 0
      end
    `;
    
    return await this.redis.eval(script, 1, `inventory:${productId}`, quantity);
  }
}
```

## æ ¸å¿ƒä¼˜åŒ–

### 1. å‰ç«¯ä¼˜åŒ–

```javascript
// 1.1 é™æ€èµ„æºCDN
const config = {
  cdn: {
    images: 'https://cdn.example.com/images',
    scripts: 'https://cdn.example.com/js',
    styles: 'https://cdn.example.com/css'
  }
};

// 1.2 é¡µé¢é™æ€åŒ–
// ç§’æ€é¡µé¢æå‰ç”Ÿæˆé™æ€HTMLï¼Œéƒ¨ç½²åˆ°CDN
function generateStaticPage(product) {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <title>${product.name} - ç§’æ€</title>
      <link rel="stylesheet" href="${config.cdn.styles}/seckill.css">
    </head>
    <body>
      <div id="product" data-id="${product.id}">
        <img src="${config.cdn.images}/${product.image}">
        <h1>${product.name}</h1>
        <p class="price">Â¥${product.price}</p>
        <button id="seckill-btn">ç«‹å³æŠ¢è´­</button>
      </div>
      <script src="${config.cdn.scripts}/seckill.js"></script>
    </body>
    </html>
  `;
}

// 1.3 æŒ‰é’®æ§åˆ¶
class SeckillButton {
  constructor(startTime) {
    this.startTime = startTime;
    this.button = document.getElementById('seckill-btn');
    this.init();
  }
  
  init() {
    // å€’è®¡æ—¶
    this.countdown();
    
    // é˜²æ­¢é‡å¤ç‚¹å‡»
    this.button.addEventListener('click', this.debounce(this.handleClick, 1000));
  }
  
  countdown() {
    const now = Date.now();
    const diff = this.startTime - now;
    
    if (diff > 0) {
      this.button.disabled = true;
      this.button.textContent = `${Math.ceil(diff / 1000)}ç§’åå¼€å§‹`;
      setTimeout(() => this.countdown(), 1000);
    } else {
      this.button.disabled = false;
      this.button.textContent = 'ç«‹å³æŠ¢è´­';
    }
  }
  
  debounce(fn, delay) {
    let timer = null;
    return function(...args) {
      if (timer) return;
      timer = setTimeout(() => {
        fn.apply(this, args);
        timer = null;
      }, delay);
    };
  }
  
  async handleClick() {
    this.button.disabled = true;
    this.button.textContent = 'æŠ¢è´­ä¸­...';
    
    try {
      const result = await this.seckill();
      if (result.success) {
        alert('æŠ¢è´­æˆåŠŸï¼');
        window.location.href = '/order/' + result.orderId;
      } else {
        alert(result.message);
        this.button.disabled = false;
        this.button.textContent = 'ç«‹å³æŠ¢è´­';
      }
    } catch (error) {
      alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
      this.button.disabled = false;
      this.button.textContent = 'ç«‹å³æŠ¢è´­';
    }
  }
}
```

### 2. æ¥å…¥å±‚ä¼˜åŒ–

```javascript
// 2.1 å¤šçº§é™æµ
class RateLimiter {
  // IPé™æµ
  async checkIPLimit(ip) {
    const key = `rate:ip:${ip}`;
    const count = await redis.incr(key);
    
    if (count === 1) {
      await redis.expire(key, 1); // 1ç§’çª—å£
    }
    
    return count <= 10; // æ¯ç§’æœ€å¤š10æ¬¡
  }
  
  // ç”¨æˆ·é™æµ
  async checkUserLimit(userId) {
    const key = `rate:user:${userId}`;
    const count = await redis.incr(key);
    
    if (count === 1) {
      await redis.expire(key, 1);
    }
    
    return count <= 5; // æ¯ç§’æœ€å¤š5æ¬¡
  }
  
  // å…¨å±€é™æµï¼ˆä»¤ç‰Œæ¡¶ï¼‰
  async checkGlobalLimit() {
    const script = `
      local key = KEYS[1]
      local capacity = tonumber(ARGV[1])
      local rate = tonumber(ARGV[2])
      local now = tonumber(ARGV[3])
      
      local tokens = tonumber(redis.call('get', key) or capacity)
      local last_time = tonumber(redis.call('get', key .. ':time') or now)
      
      local delta = math.max(0, now - last_time)
      local new_tokens = math.min(capacity, tokens + delta * rate)
      
      if new_tokens >= 1 then
        redis.call('set', key, new_tokens - 1)
        redis.call('set', key .. ':time', now)
        return 1
      else
        return 0
      end
    `;
    
    return await redis.eval(
      script,
      1,
      'rate:global',
      1000000,  // å®¹é‡100ä¸‡
      10000,    // æ¯ç§’è¡¥å……1ä¸‡ä¸ªä»¤ç‰Œ
      Date.now()
    );
  }
}

// 2.2 éªŒè¯ç 
class CaptchaValidator {
  // æ»‘åŠ¨éªŒè¯
  async validateSlide(token, distance) {
    const expected = await redis.get(`captcha:${token}`);
    return Math.abs(distance - expected) < 5;
  }
  
  // ç‚¹å‡»éªŒè¯
  async validateClick(token, positions) {
    const expected = await redis.get(`captcha:${token}`);
    return this.comparePositions(positions, expected);
  }
}

// 2.3 é˜²åˆ·æœºåˆ¶
class AntiBotSystem {
  async isBot(request) {
    const score = await this.calculateRiskScore(request);
    return score > 80; // é£é™©åˆ†æ•°è¶…è¿‡80è®¤ä¸ºæ˜¯æœºå™¨äºº
  }
  
  async calculateRiskScore(request) {
    let score = 0;
    
    // æ£€æŸ¥User-Agent
    if (!request.headers['user-agent']) {
      score += 30;
    }
    
    // æ£€æŸ¥è¯·æ±‚é¢‘ç‡
    const frequency = await this.getRequestFrequency(request.ip);
    if (frequency > 100) {
      score += 40;
    }
    
    // æ£€æŸ¥è¡Œä¸ºæ¨¡å¼
    const pattern = await this.analyzePattern(request.userId);
    if (pattern.suspicious) {
      score += 30;
    }
    
    return score;
  }
}
```

### 3. ä¸šåŠ¡å±‚ä¼˜åŒ–

```javascript
// 3.1 åº“å­˜é¢„çƒ­
class InventoryWarmer {
  async warmup(productId, quantity) {
    // å°†åº“å­˜åŠ è½½åˆ°Redis
    await redis.set(`inventory:${productId}`, quantity);
    
    // è®¾ç½®è¿‡æœŸæ—¶é—´
    await redis.expire(`inventory:${productId}`, 3600);
    
    // é¢„çƒ­åˆ°æœ¬åœ°ç¼“å­˜
    localCache.set(`inventory:${productId}`, quantity);
  }
}

// 3.2 åº“å­˜æ‰£å‡
class InventoryManager {
  // Luaè„šæœ¬ä¿è¯åŸå­æ€§
  async deduct(productId, quantity) {
    const script = `
      local key = KEYS[1]
      local quantity = tonumber(ARGV[1])
      local inventory = tonumber(redis.call('get', key) or 0)
      
      if inventory >= quantity then
        redis.call('decrby', key, quantity)
        return 1
      else
        return 0
      end
    `;
    
    const result = await redis.eval(
      script,
      1,
      `inventory:${productId}`,
      quantity
    );
    
    return result === 1;
  }
  
  // åˆ†æ®µé”å‡å°‘ç«äº‰
  async deductWithSharding(productId, quantity) {
    const shardCount = 10;
    const shard = Math.floor(Math.random() * shardCount);
    const key = `inventory:${productId}:${shard}`;
    
    return await this.deduct(key, quantity);
  }
}

// 3.3 è®¢å•åˆ›å»ºï¼ˆå¼‚æ­¥ï¼‰
class OrderCreator {
  async createAsync(userId, productId, quantity) {
    // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
    await messageQueue.publish('order.create', {
      userId,
      productId,
      quantity,
      timestamp: Date.now()
    });
  }
  
  // æ¶ˆè´¹è€…å¤„ç†
  async processOrder(message) {
    const { userId, productId, quantity } = message;
    
    try {
      // åˆ›å»ºè®¢å•
      const order = await db.orders.create({
        userId,
        productId,
        quantity,
        status: 'PENDING',
        createdAt: new Date()
      });
      
      // è®¾ç½®è¶…æ—¶ä»»åŠ¡
      await this.scheduleTimeout(order.id, 15 * 60 * 1000); // 15åˆ†é’Ÿ
      
      // å‘é€é€šçŸ¥
      await this.notifyUser(userId, order.id);
      
    } catch (error) {
      // å›æ»šåº“å­˜
      await this.rollbackInventory(productId, quantity);
      throw error;
    }
  }
}
```

### 4. æ•°æ®å±‚ä¼˜åŒ–

```javascript
// 4.1 Redisé›†ç¾¤
class RedisCluster {
  constructor(nodes) {
    this.nodes = nodes;
    this.hashSlots = 16384;
  }
  
  getNode(key) {
    const slot = this.crc16(key) % this.hashSlots;
    return this.nodes.find(node => 
      slot >= node.slotStart && slot <= node.slotEnd
    );
  }
  
  async get(key) {
    const node = this.getNode(key);
    return await node.get(key);
  }
  
  async set(key, value) {
    const node = this.getNode(key);
    return await node.set(key, value);
  }
}

// 4.2 æ•°æ®åº“åˆ†åº“åˆ†è¡¨
class DatabaseSharding {
  // æŒ‰ç”¨æˆ·IDåˆ†åº“
  getDatabase(userId) {
    const dbIndex = userId % this.dbCount;
    return this.databases[dbIndex];
  }
  
  // æŒ‰è®¢å•IDåˆ†è¡¨
  getTable(orderId) {
    const tableIndex = orderId % this.tableCount;
    return `orders_${tableIndex}`;
  }
  
  async createOrder(order) {
    const db = this.getDatabase(order.userId);
    const table = this.getTable(order.id);
    
    return await db.query(
      `INSERT INTO ${table} (id, user_id, product_id, quantity, status) 
       VALUES (?, ?, ?, ?, ?)`,
      [order.id, order.userId, order.productId, order.quantity, order.status]
    );
  }
}

// 4.3 è¯»å†™åˆ†ç¦»
class MasterSlaveDB {
  async write(query, params) {
    return await this.master.query(query, params);
  }
  
  async read(query, params) {
    // éšæœºé€‰æ‹©ä¸€ä¸ªä»åº“
    const slave = this.slaves[Math.floor(Math.random() * this.slaves.length)];
    return await slave.query(query, params);
  }
}
```

## é˜²è¶…å–æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

```javascript
// æ–¹æ¡ˆ1ï¼šæ•°æ®åº“æ‚²è§‚é”
async function seckillWithPessimisticLock(productId, quantity) {
  const conn = await db.getConnection();
  
  try {
    await conn.beginTransaction();
    
    // SELECT FOR UPDATE åŠ é”
    const [product] = await conn.query(
      'SELECT inventory FROM products WHERE id = ? FOR UPDATE',
      [productId]
    );
    
    if (product.inventory >= quantity) {
      await conn.query(
        'UPDATE products SET inventory = inventory - ? WHERE id = ?',
        [quantity, productId]
      );
      await conn.commit();
      return true;
    } else {
      await conn.rollback();
      return false;
    }
  } catch (error) {
    await conn.rollback();
    throw error;
  } finally {
    conn.release();
  }
}

// æ–¹æ¡ˆ2ï¼šæ•°æ®åº“ä¹è§‚é”
async function seckillWithOptimisticLock(productId, quantity) {
  const maxRetries = 3;
  
  for (let i = 0; i < maxRetries; i++) {
    const [product] = await db.query(
      'SELECT inventory, version FROM products WHERE id = ?',
      [productId]
    );
    
    if (product.inventory >= quantity) {
      const result = await db.query(
        `UPDATE products 
         SET inventory = inventory - ?, version = version + 1 
         WHERE id = ? AND version = ?`,
        [quantity, productId, product.version]
      );
      
      if (result.affectedRows > 0) {
        return true;
      }
      // ç‰ˆæœ¬å†²çªï¼Œé‡è¯•
    } else {
      return false;
    }
  }
  
  return false;
}

// æ–¹æ¡ˆ3ï¼šRedisåŸå­æ“ä½œï¼ˆæ¨èï¼‰
async function seckillWithRedis(productId, quantity) {
  const script = `
    local key = KEYS[1]
    local quantity = tonumber(ARGV[1])
    local inventory = tonumber(redis.call('get', key) or 0)
    
    if inventory >= quantity then
      redis.call('decrby', key, quantity)
      return 1
    else
      return 0
    end
  `;
  
  const result = await redis.eval(
    script,
    1,
    `inventory:${productId}`,
    quantity
  );
  
  return result === 1;
}
```

## é™çº§æ–¹æ¡ˆ

```javascript
class DegradationManager {
  // æœåŠ¡é™çº§
  async handleOverload() {
    // 1. å…³é—­éæ ¸å¿ƒåŠŸèƒ½
    await this.disableFeature('recommendation');
    await this.disableFeature('analytics');
    
    // 2. è¿”å›é™æ€é¡µé¢
    return this.staticPage;
  }
  
  // ç†”æ–­å™¨
  async callWithCircuitBreaker(fn) {
    if (this.circuitBreaker.isOpen()) {
      return this.fallback();
    }
    
    try {
      const result = await fn();
      this.circuitBreaker.recordSuccess();
      return result;
    } catch (error) {
      this.circuitBreaker.recordFailure();
      return this.fallback();
    }
  }
  
  // é™æµé™çº§
  async handleRateLimit(request) {
    if (await this.rateLimiter.isExceeded(request)) {
      // è¿”å›æ’é˜Ÿé¡µé¢
      return {
        code: 429,
        message: 'å½“å‰äººæ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•',
        queuePosition: await this.getQueuePosition(request.userId)
      };
    }
  }
}
```

## ç›‘æ§å‘Šè­¦

```javascript
class MonitoringSystem {
  // å®æ—¶ç›‘æ§
  async monitor() {
    // 1. QPSç›‘æ§
    const qps = await this.getQPS();
    if (qps > this.threshold.qps) {
      await this.alert('QPSè¿‡é«˜', { qps });
    }
    
    // 2. åº“å­˜ç›‘æ§
    const inventory = await this.getInventory();
    if (inventory < 100) {
      await this.alert('åº“å­˜ä¸è¶³', { inventory });
    }
    
    // 3. é”™è¯¯ç‡ç›‘æ§
    const errorRate = await this.getErrorRate();
    if (errorRate > 0.01) {
      await this.alert('é”™è¯¯ç‡è¿‡é«˜', { errorRate });
    }
    
    // 4. å“åº”æ—¶é—´ç›‘æ§
    const latency = await this.getLatency();
    if (latency > 100) {
      await this.alert('å“åº”æ—¶é—´è¿‡é•¿', { latency });
    }
  }
  
  // å‘Šè­¦
  async alert(message, data) {
    // å‘é€åˆ°å‘Šè­¦ç³»ç»Ÿ
    await alertSystem.send({
      level: 'critical',
      message,
      data,
      timestamp: Date.now()
    });
  }
}
```

## æ€»ç»“

ç§’æ€ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒï¼š
- âš¡ **å‰ç«¯ä¼˜åŒ–**ï¼šé™æ€åŒ–ã€CDNã€é˜²é‡å¤ç‚¹å‡»
- ğŸšª **æ¥å…¥å±‚**ï¼šé™æµã€éªŒè¯ç ã€é˜²åˆ·
- ğŸ’¼ **ä¸šåŠ¡å±‚**ï¼šåº“å­˜é¢„çƒ­ã€å¼‚æ­¥å¤„ç†ã€æ¶ˆæ¯é˜Ÿåˆ—
- ğŸ’¾ **æ•°æ®å±‚**ï¼šRedisç¼“å­˜ã€åˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»
- ğŸ›¡ï¸ **é˜²è¶…å–**ï¼šRedisåŸå­æ“ä½œã€Luaè„šæœ¬
- ğŸ“‰ **é™çº§æ–¹æ¡ˆ**ï¼šæœåŠ¡é™çº§ã€ç†”æ–­ã€é™æµ
- ğŸ“Š **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§ã€åŠæ—¶å‘Šè­¦

è®°ä½ï¼š**ç§’æ€ç³»ç»Ÿçš„æœ¬è´¨æ˜¯å‰Šå³°å¡«è°·ï¼Œå°†ç¬æ—¶æµé‡å¹³æ»‘å¤„ç†ï¼**

