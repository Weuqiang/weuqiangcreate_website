---
sidebar_position: 1
title: Web
---

# Web

Web

## XSS

### 

```html
<!-- XSS -->
<div>
  <script>alert('XSS')</script>
</div>

<!-- XSS -->
<div>
  <?php echo $_GET['keyword']; ?>
</div>

<!-- DOMXSS -->
<script>
  document.write(location.hash.substring(1));
</script>
```

### 

```javascript
// 1. 
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// 2. API
//  
element.innerHTML = userInput;
//  
element.textContent = userInput;

// 3. CSP
// HTTP Header
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'

// 4. HttpOnly Cookie
res.cookie('token', token, {
  httpOnly: true,  // JavaScript
  secure: true,    // HTTPS
  sameSite: 'strict'
});
```

## CSRF

### 

```html
<!--  -->
<img src="https://bank.com/transfer?to=attacker&amount=1000" />

<form action="https://bank.com/transfer" method="POST">
  <input type="hidden" name="to" value="attacker" />
  <input type="hidden" name="amount" value="1000" />
</form>
<script>document.forms[0].submit();</script>
```

### 

```javascript
// 1. CSRF Token
// token
const csrfToken = crypto.randomBytes(32).toString('hex');
req.session.csrfToken = csrfToken;

// token
fetch('/api/transfer', {
  method: 'POST',
  headers: {
    'X-CSRF-Token': csrfToken
  },
  body: JSON.stringify(data)
});

// token
if (req.headers['x-csrf-token'] !== req.session.csrfToken) {
  return res.status(403).json({ error: 'Invalid CSRF token' });
}

// 2. SameSite Cookie
res.cookie('session', sessionId, {
  sameSite: 'strict'  //  'lax'
});

// 3. Referer
if (!req.headers.referer?.startsWith('https://mysite.com')) {
  return res.status(403).json({ error: 'Invalid referer' });
}

// 4. Cookie
res.cookie('csrf', csrfToken);
// CookieHeader
```

## SQL

### 

```javascript
//  SQL
const username = req.body.username;  // "admin' OR '1'='1"
const sql = `SELECT * FROM users WHERE username = '${username}'`;
// SELECT * FROM users WHERE username = 'admin' OR '1'='1'
```

### 

```javascript
// 1. 
//  
const sql = 'SELECT * FROM users WHERE username = ?';
db.query(sql, [username]);

// 2. ORM
// Sequelize
const user = await User.findOne({
  where: { username: username }
});

// 3. 
function validateUsername(username) {
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
    throw new Error('Invalid username');
  }
  return username;
}

// 4. 
// 
GRANT SELECT, INSERT, UPDATE ON mydb.* TO 'app_user'@'localhost';
```

## 

### 

```javascript
// 
// shell.php
<?php system($_GET['cmd']); ?>
```

### 

```javascript
const multer = require('multer');
const path = require('path');

// 1. 
const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];

const upload = multer({
  storage: multer.diskStorage({
    destination: './uploads/',
    filename: (req, file, cb) => {
      // 2. 
      const uniqueName = `${Date.now()}-${Math.random().toString(36)}${path.extname(file.originalname)}`;
      cb(null, uniqueName);
    }
  }),
  fileFilter: (req, file, cb) => {
    // 3. MIME
    if (!allowedTypes.includes(file.mimetype)) {
      return cb(new Error('Invalid file type'));
    }
    cb(null, true);
  },
  limits: {
    fileSize: 5 * 1024 * 1024  // 4. 5MB
  }
});

// 5. 
const fileType = require('file-type');

async function validateFile(filePath) {
  const type = await fileType.fromFile(filePath);
  if (!type || !allowedTypes.includes(type.mime)) {
    throw new Error('Invalid file content');
  }
}

// 6. Web
// OSS
```

## 

### JWT

```javascript
const jwt = require('jsonwebtoken');

// Token
function generateToken(user) {
  return jwt.sign(
    { 
      id: user.id,
      username: user.username,
      role: user.role
    },
    process.env.JWT_SECRET,
    { 
      expiresIn: '1h',
      issuer: 'myapp'
    }
  );
}

// Token
function verifyToken(req, res, next) {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
}

// Token
function refreshToken(oldToken) {
  const decoded = jwt.verify(oldToken, process.env.JWT_SECRET, {
    ignoreExpiration: true
  });
  
  // 
  const now = Math.floor(Date.now() / 1000);
  if (now - decoded.exp > 86400) {  // 24
    throw new Error('Token expired');
  }
  
  return generateToken({ id: decoded.id, username: decoded.username });
}
```

### RBAC

```javascript
// 
const roles = {
  admin: ['read', 'write', 'delete'],
  editor: ['read', 'write'],
  viewer: ['read']
};

// 
function checkPermission(requiredPermission) {
  return (req, res, next) => {
    const userRole = req.user.role;
    const permissions = roles[userRole] || [];
    
    if (!permissions.includes(requiredPermission)) {
      return res.status(403).json({ error: 'Permission denied' });
    }
    
    next();
  };
}

// 
app.delete('/api/users/:id', 
  verifyToken,
  checkPermission('delete'),
  deleteUser
);
```

## 

```javascript
const bcrypt = require('bcrypt');

// 1. 
async function hashPassword(password) {
  const saltRounds = 10;
  return await bcrypt.hash(password, saltRounds);
}

// 2. 
async function verifyPassword(password, hash) {
  return await bcrypt.compare(password, hash);
}

// 3. 
function validatePassword(password) {
  const minLength = 8;
  const hasUpperCase = /[A-Z]/.test(password);
  const hasLowerCase = /[a-z]/.test(password);
  const hasNumbers = /\d/.test(password);
  const hasSpecialChar = /[!@#$%^&*]/.test(password);
  
  if (password.length < minLength) {
    throw new Error('Password too short');
  }
  
  if (!(hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar)) {
    throw new Error('Password must contain uppercase, lowercase, number and special character');
  }
}

// 4. 
const rateLimit = require('express-rate-limit');

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15
  max: 5,  // 5
  message: 'Too many login attempts'
});

app.post('/api/login', loginLimiter, login);
```

## Headers

```javascript
const helmet = require('helmet');

app.use(helmet());

// 
app.use((req, res, next) => {
  // 
  res.setHeader('X-Frame-Options', 'DENY');
  
  // MIME
  res.setHeader('X-Content-Type-Options', 'nosniff');
  
  // XSS
  res.setHeader('X-XSS-Protection', '1; mode=block');
  
  // HTTPS
  res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  
  // CSP
  res.setHeader('Content-Security-Policy', "default-src 'self'");
  
  next();
});
```

## 

1. ****
2. **HTTPS**
3. ****
4. ****
5. ****
6. ****
7. ****
8. ****

## 

Web
-  XSSCSRFSQL
-  
-  JWT
-  RBAC
-  Headers
-  

