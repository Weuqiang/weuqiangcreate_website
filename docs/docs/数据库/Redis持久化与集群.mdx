---
sidebar_position: 5
title: Redis
tags: [, Redis, , , ]
---

# Redis

RedisCluster

## 

### RDB

```bash
# RDB
save 900 1      # 9001key
save 300 10     # 30010key
save 60 10000   # 6010000key

# RDB
dbfilename dump.rdb
dir /var/lib/redis
rdbcompression yes
rdbchecksum yes

# 
SAVE            # 
BGSAVE          # 
```

#### RDB

```javascript
// RDB
const rdbProcess = {
  step1: 'Redis fork',
  step2: 'RDB',
  step3: 'RDB',
  step4: '',
  
  advantages: [
    '',
    '',
    'fork'
  ],
  
  disadvantages: [
    '',
    'fork',
    ''
  ]
};
```

### AOF

```bash
# AOF
appendonly yes
appendfilename "appendonly.aof"

# 
appendfsync always      # 
appendfsync everysec    # 
appendfsync no          # OS

# AOF
auto-aof-rewrite-percentage 100  # 100%
auto-aof-rewrite-min-size 64mb   # 64MB

# 
BGREWRITEAOF
```

#### AOF

```javascript
// AOF
const aofRewrite = {
  problem: 'AOF',
  solution: 'AOF',
  
  example: {
    before: [
      'SET key value1',
      'SET key value2',
      'SET key value3',
      'DEL key',
      'SET key value4'
    ],
    after: [
      'SET key value4'  // 
    ]
  },
  
  process: [
    '1. fork',
    '2. AOF',
    '3. AOF',
    '4. ',
    '5. AOF'
  ]
};
```

### 

```bash
# Redis 4.0+
aof-use-rdb-preamble yes

# AOFRDB + AOF
# RDBAOF
```

## 

### 

```bash
# master
bind 0.0.0.0
port 6379
requirepass master_password

# slave
bind 0.0.0.0
port 6380
replicaof 127.0.0.1 6379
masterauth master_password

# 
replica-read-only yes
```

### 

```javascript
const replicationProcess = {
  // 
  fullSync: {
    step1: 'PSYNC',
    step2: 'BGSAVERDB',
    step3: 'RDB',
    step4: '',
    step5: 'RDB',
    step6: ''
  },
  
  // 
  partialSync: {
    condition: '',
    step1: 'PSYNC runid offset',
    step2: 'offset',
    step3: 'offset',
    step4: ''
  },
  
  // 
  replBacklog: {
    size: '1MB',
    config: 'repl-backlog-size 1mb',
    purpose: ''
  }
};
```

### 

```javascript
class MasterSlaveArchitecture {
  constructor() {
    this.master = { host: '127.0.0.1', port: 6379 };
    this.slaves = [
      { host: '127.0.0.1', port: 6380 },
      { host: '127.0.0.1', port: 6381 }
    ];
  }
  
  // 
  async write(key, value) {
    // 
    return await this.master.set(key, value);
  }
  
  async read(key) {
    // 
    const slave = this.getNextSlave();
    return await slave.get(key);
  }
  
  getNextSlave() {
    const index = this.currentIndex % this.slaves.length;
    this.currentIndex++;
    return this.slaves[index];
  }
}
```

## 

### 

```bash
# sentinel.conf
port 26379
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel auth-pass mymaster master_password
sentinel down-after-milliseconds mymaster 5000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000

# 
redis-sentinel /path/to/sentinel.conf
```

### 

```javascript
const sentinelFeatures = {
  // 1. 
  monitoring: {
    description: '',
    mechanism: 'PING',
    interval: '1'
  },
  
  // 2. 
  notification: {
    description: '',
    methods: ['', 'Pub/Sub']
  },
  
  // 3. 
  failover: {
    trigger: '',
    process: [
      '1. ',
      '2. ',
      '3. Raft',
      '4. runid',
      '5. ',
      '6. '
    ]
  },
  
  // 4. 
  configProvider: {
    description: '',
    command: 'SENTINEL get-master-addr-by-name mymaster'
  }
};
```

### 

```javascript
class SentinelElection {
  selectNewMaster(slaves) {
    // 1. 
    let candidates = slaves.filter(s => s.isOnline && !s.isDisconnected);
    
    // 2. 
    candidates.sort((a, b) => {
      // 
      if (a.priority !== b.priority) {
        return b.priority - a.priority;
      }
      
      // 
      if (a.replOffset !== b.replOffset) {
        return b.replOffset - a.replOffset;
      }
      
      // runid
      return a.runid.localeCompare(b.runid);
    });
    
    return candidates[0];
  }
}
```

## Cluster

### Cluster

```bash
# 
port 7000
cluster-enabled yes
cluster-config-file nodes-7000.conf
cluster-node-timeout 5000
appendonly yes

# 
redis-cli --cluster create \
  127.0.0.1:7000 127.0.0.1:7001 \
  127.0.0.1:7002 127.0.0.1:7003 \
  127.0.0.1:7004 127.0.0.1:7005 \
  --cluster-replicas 1

# 
redis-cli -c -p 7000
CLUSTER INFO
CLUSTER NODES
```

### 

```javascript
class ClusterSlots {
  constructor() {
    this.totalSlots = 16384;  // 16384
  }
  
  // key
  getSlot(key) {
    // CRC16(key) % 16384
    return this.crc16(key) % this.totalSlots;
  }
  
  // 
  allocateSlots() {
    return {
      'node1': '0-5460',      // 5461
      'node2': '5461-10922',  // 5462
      'node3': '10923-16383'  // 5461
    };
  }
  
  // Hash Tagkey
  hashTag(key) {
    // {user:1}:name  {user:1}:age 
    const match = key.match(/\{([^}]+)\}/);
    return match ? match[1] : key;
  }
  
  crc16(str) {
    let crc = 0;
    for (let i = 0; i < str.length; i++) {
      crc = ((crc << 8) ^ this.crc16Table[(crc >> 8) ^ str.charCodeAt(i)]) & 0xFFFF;
    }
    return crc;
  }
}
```

### 

```javascript
class ClusterRedirection {
  async get(key) {
    const slot = this.getSlot(key);
    const node = this.getNodeBySlot(slot);
    
    try {
      return await node.get(key);
    } catch (error) {
      if (error.message.startsWith('MOVED')) {
        // 
        const [_, slot, host, port] = error.message.split(' ');
        const newNode = this.getNode(host, port);
        return await newNode.get(key);
      }
      
      if (error.message.startsWith('ASK')) {
        // 
        const [_, slot, host, port] = error.message.split(' ');
        const newNode = this.getNode(host, port);
        await newNode.asking();  // ASKING
        return await newNode.get(key);
      }
      
      throw error;
    }
  }
}
```

### 

```bash
# 
redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000

# 
redis-cli --cluster reshard 127.0.0.1:7000
# 
# ID
# IDall

# 
redis-cli --cluster add-node 127.0.0.1:7007 127.0.0.1:7000 \
  --cluster-slave --cluster-master-id <master-node-id>
```

### 

```bash
# 
redis-cli --cluster reshard 127.0.0.1:7000 \
  --cluster-from <node-id> \
  --cluster-to <target-node-id> \
  --cluster-slots <slot-count>

# 
redis-cli --cluster del-node 127.0.0.1:7000 <node-id>
```

## 

```javascript
const haComparison = {
  // 
  masterSlave: {
    pros: [
      '',
      '',
      ''
    ],
    cons: [
      '',
      '',
      ''
    ],
    useCase: ''
  },
  
  // 
  sentinel: {
    pros: [
      '',
      '',
      ''
    ],
    cons: [
      '',
      '',
      ''
    ],
    useCase: ''
  },
  
  // Cluster
  cluster: {
    pros: [
      '',
      '',
      '',
      ''
    ],
    cons: [
      '',
      '',
      ''
    ],
    useCase: ''
  }
};
```

## 

```javascript
// Sentinel
class SentinelClient {
  constructor(sentinels, masterName) {
    this.sentinels = sentinels;
    this.masterName = masterName;
    this.master = null;
  }
  
  async connect() {
    // 
    for (const sentinel of this.sentinels) {
      try {
        const [host, port] = await sentinel.sentinelGetMasterAddrByName(
          this.masterName
        );
        this.master = new Redis({ host, port });
        break;
      } catch (error) {
        continue;
      }
    }
    
    // 
    this.subscribeSentinel();
  }
  
  subscribeSentinel() {
    const sentinel = new Redis(this.sentinels[0]);
    sentinel.subscribe('+switch-master', (channel, message) => {
      // 
      const [masterName, oldHost, oldPort, newHost, newPort] = message.split(' ');
      if (masterName === this.masterName) {
        this.master = new Redis({ host: newHost, port: newPort });
      }
    });
  }
}

// Cluster
class ClusterClient {
  constructor(nodes) {
    this.nodes = nodes.map(n => new Redis(n));
    this.slots = new Map();
    this.refreshSlots();
  }
  
  async refreshSlots() {
    const node = this.nodes[0];
    const slots = await node.cluster('SLOTS');
    
    for (const [start, end, master] of slots) {
      for (let i = start; i <= end; i++) {
        this.slots.set(i, master);
      }
    }
  }
  
  async get(key) {
    const slot = this.getSlot(key);
    const node = this.getNodeBySlot(slot);
    
    try {
      return await node.get(key);
    } catch (error) {
      if (error.message.startsWith('MOVED')) {
        await this.refreshSlots();
        return await this.get(key);
      }
      throw error;
    }
  }
}
```

## 

```bash
# 
INFO replication

# 
INFO persistence

# 
CLUSTER INFO
CLUSTER NODES

# 
SLOWLOG GET 10

# 
INFO memory
MEMORY USAGE key

# 
CLIENT LIST

# 
MONITOR
```

## 

Redis
-  ****RDB + AOF + 
-  **** + 
-  **** + 
-  **Cluster** + 
-  ****
-  **** + 

**Redis**

