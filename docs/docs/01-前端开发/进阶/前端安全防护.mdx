---
sidebar_position: 5
title: å‰ç«¯å®‰å…¨é˜²æŠ¤æŒ‡å—
tags: [å‰ç«¯, å®‰å…¨, XSS, CSRF, å®‰å…¨é˜²æŠ¤]
---

# å‰ç«¯å®‰å…¨é˜²æŠ¤æŒ‡å—

å‰ç«¯å®‰å…¨æ˜¯Webåº”ç”¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œæœ¬æ–‡å°†è¯¦ç»†è®²è§£å¸¸è§çš„å‰ç«¯å®‰å…¨é—®é¢˜å’Œé˜²æŠ¤æªæ–½ã€‚

## XSSæ”»å‡»

### XSSç±»å‹

```javascript
const xssTypes = {
  // 1. å­˜å‚¨å‹XSSï¼ˆæœ€å±é™©ï¼‰
  stored: {
    description: 'æ¶æ„è„šæœ¬å­˜å‚¨åœ¨æœåŠ¡å™¨',
    example: 'è¯„è®ºã€ç•™è¨€æ¿',
    flow: [
      '1. æ”»å‡»è€…æäº¤æ¶æ„è„šæœ¬åˆ°æœåŠ¡å™¨',
      '2. æœåŠ¡å™¨å­˜å‚¨æ¶æ„è„šæœ¬',
      '3. å…¶ä»–ç”¨æˆ·è®¿é—®é¡µé¢æ—¶æ‰§è¡Œè„šæœ¬'
    ]
  },
  
  // 2. åå°„å‹XSS
  reflected: {
    description: 'æ¶æ„è„šæœ¬é€šè¿‡URLå‚æ•°ä¼ é€’',
    example: 'æœç´¢ç»“æœé¡µé¢',
    flow: [
      '1. æ”»å‡»è€…æ„é€ æ¶æ„URL',
      '2. ç”¨æˆ·ç‚¹å‡»URL',
      '3. æœåŠ¡å™¨å°†å‚æ•°ç›´æ¥è¾“å‡ºåˆ°é¡µé¢',
      '4. æ¶æ„è„šæœ¬æ‰§è¡Œ'
    ]
  },
  
  // 3. DOMå‹XSS
  dom: {
    description: 'é€šè¿‡ä¿®æ”¹DOMæ‰§è¡Œæ¶æ„è„šæœ¬',
    example: 'å‰ç«¯è·¯ç”±ã€åŠ¨æ€å†…å®¹',
    flow: [
      '1. æ”»å‡»è€…æ„é€ æ¶æ„URL',
      '2. å‰ç«¯JSè¯»å–URLå‚æ•°',
      '3. ç›´æ¥æ’å…¥åˆ°DOM',
      '4. æ¶æ„è„šæœ¬æ‰§è¡Œ'
    ]
  }
};
```

### XSSæ”»å‡»ç¤ºä¾‹

```javascript
// âŒ å­˜å‚¨å‹XSS
// ç”¨æˆ·æäº¤è¯„è®º
const comment = '<script>alert("XSS")</script>';
await api.post('/comments', { content: comment });

// æœåŠ¡å™¨ç›´æ¥å­˜å‚¨
db.comments.insert({ content: comment });

// é¡µé¢æ¸²æŸ“æ—¶ç›´æ¥è¾“å‡º
<div dangerouslySetInnerHTML={{ __html: comment }} />

// âŒ åå°„å‹XSS
// URL: /search?q=<script>alert("XSS")</script>
const query = new URLSearchParams(location.search).get('q');
document.getElementById('result').innerHTML = `æœç´¢ç»“æœï¼š${query}`;

// âŒ DOMå‹XSS
// URL: #<img src=x onerror=alert("XSS")>
const hash = location.hash.slice(1);
document.getElementById('content').innerHTML = hash;
```

### XSSé˜²æŠ¤

```javascript
// 1. è¾“å…¥è¿‡æ»¤
class InputFilter {
  // HTMLå®ä½“ç¼–ç 
  escapeHtml(str) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      '/': '&#x2F;'
    };
    return str.replace(/[&<>"'/]/g, char => map[char]);
  }
  
  // ç§»é™¤å±é™©æ ‡ç­¾
  sanitize(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    
    // ç§»é™¤scriptæ ‡ç­¾
    const scripts = div.querySelectorAll('script');
    scripts.forEach(script => script.remove());
    
    // ç§»é™¤äº‹ä»¶å¤„ç†å™¨
    const elements = div.querySelectorAll('*');
    elements.forEach(el => {
      Array.from(el.attributes).forEach(attr => {
        if (attr.name.startsWith('on')) {
          el.removeAttribute(attr.name);
        }
      });
    });
    
    return div.innerHTML;
  }
}

// 2. ä½¿ç”¨DOMPurifyåº“
import DOMPurify from 'dompurify';

const clean = DOMPurify.sanitize(dirtyHtml, {
  ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a'],
  ALLOWED_ATTR: ['href']
});

// 3. Reactè‡ªåŠ¨è½¬ä¹‰
function SafeComponent({ userInput }) {
  // Reactä¼šè‡ªåŠ¨è½¬ä¹‰
  return <div>{userInput}</div>;
}

// 4. CSPï¼ˆContent Security Policyï¼‰
// HTTPå“åº”å¤´
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://trusted.cdn.com

// HTML metaæ ‡ç­¾
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; script-src 'self' https://trusted.cdn.com">

// 5. HttpOnly Cookie
// é˜²æ­¢JSè®¿é—®Cookie
Set-Cookie: sessionId=xxx; HttpOnly; Secure; SameSite=Strict
```

## CSRFæ”»å‡»

### CSRFåŸç†

```javascript
const csrfConcept = {
  description: 'è·¨ç«™è¯·æ±‚ä¼ªé€ ',
  
  attackFlow: [
    '1. ç”¨æˆ·ç™»å½•ç½‘ç«™Aï¼Œè·å¾—Cookie',
    '2. ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™B',
    '3. ç½‘ç«™Bå‘èµ·å¯¹ç½‘ç«™Açš„è¯·æ±‚',
    '4. æµè§ˆå™¨è‡ªåŠ¨å¸¦ä¸ŠCookie',
    '5. ç½‘ç«™Aè®¤ä¸ºæ˜¯åˆæ³•è¯·æ±‚'
  ],
  
  example: `
    <!-- æ¶æ„ç½‘ç«™Bçš„é¡µé¢ -->
    <img src="https://bank.com/transfer?to=attacker&amount=1000">
    
    <!-- æˆ–è€…è‡ªåŠ¨æäº¤è¡¨å• -->
    <form action="https://bank.com/transfer" method="POST">
      <input type="hidden" name="to" value="attacker">
      <input type="hidden" name="amount" value="1000">
    </form>
    <script>document.forms[0].submit();</script>
  `
};
```

### CSRFé˜²æŠ¤

```javascript
// 1. CSRF Token
class CSRFProtection {
  // ç”ŸæˆToken
  generateToken() {
    return crypto.randomBytes(32).toString('hex');
  }
  
  // æœåŠ¡ç«¯ä¸­é—´ä»¶
  middleware(req, res, next) {
    if (req.method === 'GET') {
      // GETè¯·æ±‚ç”ŸæˆToken
      const token = this.generateToken();
      req.session.csrfToken = token;
      res.locals.csrfToken = token;
      next();
    } else {
      // POSTè¯·æ±‚éªŒè¯Token
      const token = req.body._csrf || req.headers['x-csrf-token'];
      if (token === req.session.csrfToken) {
        next();
      } else {
        res.status(403).json({ error: 'Invalid CSRF token' });
      }
    }
  }
}

// å‰ç«¯ä½¿ç”¨
// åœ¨è¡¨å•ä¸­æ·»åŠ Token
<form action="/transfer" method="POST">
  <input type="hidden" name="_csrf" value="{{ csrfToken }}">
  <input type="text" name="amount">
  <button type="submit">Transfer</button>
</form>

// AJAXè¯·æ±‚ä¸­æ·»åŠ Token
fetch('/api/transfer', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
  },
  body: JSON.stringify({ amount: 1000 })
});

// 2. SameSite Cookie
Set-Cookie: sessionId=xxx; SameSite=Strict

// Strict: å®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹Cookie
// Lax: å…è®¸éƒ¨åˆ†ç¬¬ä¸‰æ–¹Cookieï¼ˆGETè¯·æ±‚ï¼‰
// None: å…è®¸æ‰€æœ‰ç¬¬ä¸‰æ–¹Cookieï¼ˆéœ€è¦Secureï¼‰

// 3. éªŒè¯Referer
app.use((req, res, next) => {
  const referer = req.headers.referer;
  const host = req.headers.host;
  
  if (referer && !referer.includes(host)) {
    return res.status(403).json({ error: 'Invalid referer' });
  }
  
  next();
});

// 4. åŒé‡CookieéªŒè¯
// è®¾ç½®Cookie
res.cookie('csrf-token', token);

// å‰ç«¯è¯»å–Cookieå¹¶å‘é€
const csrfToken = document.cookie
  .split('; ')
  .find(row => row.startsWith('csrf-token='))
  .split('=')[1];

fetch('/api/transfer', {
  headers: {
    'X-CSRF-Token': csrfToken
  }
});
```

## ç‚¹å‡»åŠ«æŒ

### ç‚¹å‡»åŠ«æŒåŸç†

```html
<!-- æ”»å‡»è€…é¡µé¢ -->
<style>
  iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    z-index: 999;
  }
  
  .fake-button {
    position: absolute;
    top: 100px;
    left: 100px;
  }
</style>

<iframe src="https://bank.com/transfer"></iframe>
<button class="fake-button">ç‚¹å‡»é¢†å–å¥–å“</button>

<!-- ç”¨æˆ·ä»¥ä¸ºç‚¹å‡»çš„æ˜¯"é¢†å–å¥–å“"ï¼Œå®é™…ç‚¹å‡»çš„æ˜¯iframeä¸­çš„"è½¬è´¦"æŒ‰é’® -->
```

### ç‚¹å‡»åŠ«æŒé˜²æŠ¤

```javascript
// 1. X-Frame-Options
// HTTPå“åº”å¤´
X-Frame-Options: DENY              // ç¦æ­¢è¢«iframeåµŒå…¥
X-Frame-Options: SAMEORIGIN        // åªå…è®¸åŒæºiframe
X-Frame-Options: ALLOW-FROM https://trusted.com

// 2. CSP frame-ancestors
Content-Security-Policy: frame-ancestors 'self'

// 3. JavaScripté˜²æŠ¤
if (window.top !== window.self) {
  // æ£€æµ‹æ˜¯å¦åœ¨iframeä¸­
  window.top.location = window.self.location;
}

// 4. ä½¿ç”¨sandboxå±æ€§
<iframe src="untrusted.html" sandbox="allow-scripts"></iframe>
```

## SQLæ³¨å…¥

### SQLæ³¨å…¥ç¤ºä¾‹

```javascript
// âŒ ä¸å®‰å…¨çš„æŸ¥è¯¢
app.get('/user', (req, res) => {
  const { id } = req.query;
  const sql = `SELECT * FROM users WHERE id = ${id}`;
  db.query(sql, (err, result) => {
    res.json(result);
  });
});

// æ”»å‡»ï¼š/user?id=1 OR 1=1
// SQL: SELECT * FROM users WHERE id = 1 OR 1=1
// è¿”å›æ‰€æœ‰ç”¨æˆ·

// âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
app.get('/user', (req, res) => {
  const { id } = req.query;
  const sql = 'SELECT * FROM users WHERE id = ?';
  db.query(sql, [id], (err, result) => {
    res.json(result);
  });
});

// âœ… ä½¿ç”¨ORM
const user = await User.findOne({
  where: { id: req.query.id }
});
```

## æ•æ„Ÿä¿¡æ¯æ³„éœ²

### é˜²æŠ¤æªæ–½

```javascript
// 1. ä¸åœ¨å‰ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
// âŒ ä¸è¦è¿™æ ·åš
localStorage.setItem('password', 'secret123');
localStorage.setItem('creditCard', '1234-5678-9012-3456');

// âœ… åªå­˜å‚¨å¿…è¦çš„éæ•æ„Ÿä¿¡æ¯
localStorage.setItem('theme', 'dark');
localStorage.setItem('language', 'zh-CN');

// 2. åŠ å¯†æ•æ„Ÿæ•°æ®
import CryptoJS from 'crypto-js';

class SecureStorage {
  constructor(secretKey) {
    this.secretKey = secretKey;
  }
  
  encrypt(data) {
    return CryptoJS.AES.encrypt(
      JSON.stringify(data),
      this.secretKey
    ).toString();
  }
  
  decrypt(encrypted) {
    const bytes = CryptoJS.AES.decrypt(encrypted, this.secretKey);
    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
  }
  
  setItem(key, value) {
    const encrypted = this.encrypt(value);
    localStorage.setItem(key, encrypted);
  }
  
  getItem(key) {
    const encrypted = localStorage.getItem(key);
    return encrypted ? this.decrypt(encrypted) : null;
  }
}

// 3. HTTPSä¼ è¾“
// ç¡®ä¿æ‰€æœ‰æ•æ„Ÿæ•°æ®é€šè¿‡HTTPSä¼ è¾“

// 4. æ¸…ç†æ—¥å¿—
console.log('User data:', user); // âŒ å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯

// ç”Ÿäº§ç¯å¢ƒç¦ç”¨console
if (process.env.NODE_ENV === 'production') {
  console.log = () => {};
  console.error = () => {};
}

// 5. æºç æ··æ·†
// webpacké…ç½®
const TerserPlugin = require('terser-webpack-plugin');

module.exports = {
  optimization: {
    minimize: true,
    minimizer: [
      new TerserPlugin({
        terserOptions: {
          compress: {
            drop_console: true,
            drop_debugger: true
          },
          mangle: true
        }
      })
    ]
  }
};
```

## ä¾èµ–å®‰å…¨

### ä¾èµ–æ£€æŸ¥

```bash
# æ£€æŸ¥ä¾èµ–æ¼æ´
npm audit

# è‡ªåŠ¨ä¿®å¤
npm audit fix

# å¼ºåˆ¶ä¿®å¤
npm audit fix --force

# ä½¿ç”¨Snyk
npm install -g snyk
snyk test
snyk wizard
```

### ä¾èµ–ç®¡ç†

```javascript
// package.json
{
  "dependencies": {
    // âœ… é”å®šç‰ˆæœ¬
    "react": "18.2.0",
    
    // âŒ ä¸è¦ä½¿ç”¨é€šé…ç¬¦
    "lodash": "*",
    "axios": "^1.0.0"
  },
  
  "scripts": {
    "preinstall": "npx npm-force-resolutions"
  },
  
  // å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬
  "resolutions": {
    "lodash": "4.17.21"
  }
}

// ä½¿ç”¨package-lock.json
// ç¡®ä¿å›¢é˜Ÿä½¿ç”¨ç›¸åŒç‰ˆæœ¬
```

## å®‰å…¨æœ€ä½³å®è·µ

```javascript
const securityBestPractices = {
  // 1. è¾“å…¥éªŒè¯
  input: {
    validate: 'éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥',
    sanitize: 'æ¸…ç†å±é™©å­—ç¬¦',
    whitelist: 'ä½¿ç”¨ç™½åå•è€Œéé»‘åå•'
  },
  
  // 2. è¾“å‡ºç¼–ç 
  output: {
    escape: 'è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦',
    contextAware: 'æ ¹æ®ä¸Šä¸‹æ–‡é€‰æ‹©ç¼–ç æ–¹å¼'
  },
  
  // 3. è®¤è¯æˆæƒ
  auth: {
    https: 'ä½¿ç”¨HTTPS',
    token: 'ä½¿ç”¨JWTæˆ–Session',
    expire: 'è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´',
    refresh: 'å®ç°Tokenåˆ·æ–°æœºåˆ¶'
  },
  
  // 4. æ•æ„Ÿæ“ä½œ
  sensitive: {
    confirm: 'é‡è¦æ“ä½œéœ€è¦äºŒæ¬¡ç¡®è®¤',
    captcha: 'ä½¿ç”¨éªŒè¯ç ',
    rateLimit: 'é™åˆ¶è¯·æ±‚é¢‘ç‡'
  },
  
  // 5. é”™è¯¯å¤„ç†
  error: {
    generic: 'ä¸æš´éœ²è¯¦ç»†é”™è¯¯ä¿¡æ¯',
    log: 'è®°å½•é”™è¯¯æ—¥å¿—',
    monitor: 'ç›‘æ§å¼‚å¸¸'
  },
  
  // 6. ä¾èµ–ç®¡ç†
  dependencies: {
    audit: 'å®šæœŸæ£€æŸ¥ä¾èµ–æ¼æ´',
    update: 'åŠæ—¶æ›´æ–°ä¾èµ–',
    minimal: 'æœ€å°åŒ–ä¾èµ–'
  }
};
```

## å®‰å…¨æ£€æŸ¥æ¸…å•

```javascript
const securityChecklist = {
  // XSSé˜²æŠ¤
  xss: [
    'âœ“ æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡è½¬ä¹‰',
    'âœ“ ä½¿ç”¨CSPç­–ç•¥',
    'âœ“ Cookieè®¾ç½®HttpOnly',
    'âœ“ é¿å…ä½¿ç”¨dangerouslySetInnerHTML',
    'âœ“ ä½¿ç”¨DOMPurifyæ¸…ç†HTML'
  ],
  
  // CSRFé˜²æŠ¤
  csrf: [
    'âœ“ ä½¿ç”¨CSRF Token',
    'âœ“ Cookieè®¾ç½®SameSite',
    'âœ“ éªŒè¯Referer',
    'âœ“ é‡è¦æ“ä½œéœ€è¦äºŒæ¬¡ç¡®è®¤'
  ],
  
  // ç‚¹å‡»åŠ«æŒé˜²æŠ¤
  clickjacking: [
    'âœ“ è®¾ç½®X-Frame-Options',
    'âœ“ ä½¿ç”¨CSP frame-ancestors',
    'âœ“ JavaScriptæ£€æµ‹iframe'
  ],
  
  // æ•°æ®å®‰å…¨
  data: [
    'âœ“ æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨',
    'âœ“ HTTPSä¼ è¾“',
    'âœ“ ä¸åœ¨å‰ç«¯å­˜å‚¨å¯†ç ',
    'âœ“ æ¸…ç†æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯'
  ],
  
  // ä¾èµ–å®‰å…¨
  dependencies: [
    'âœ“ å®šæœŸè¿è¡Œnpm audit',
    'âœ“ é”å®šä¾èµ–ç‰ˆæœ¬',
    'âœ“ ä½¿ç”¨package-lock.json',
    'âœ“ åŠæ—¶æ›´æ–°ä¾èµ–'
  ]
};
```

## æ€»ç»“

å‰ç«¯å®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒï¼š
- ğŸ›¡ï¸ **XSSé˜²æŠ¤**ï¼šè¾“å…¥è¿‡æ»¤ã€è¾“å‡ºç¼–ç ã€CSP
- ğŸ”’ **CSRFé˜²æŠ¤**ï¼šTokenéªŒè¯ã€SameSite Cookie
- ğŸ‘† **ç‚¹å‡»åŠ«æŒ**ï¼šX-Frame-Optionsã€CSP
- ğŸ’¾ **æ•°æ®å®‰å…¨**ï¼šåŠ å¯†å­˜å‚¨ã€HTTPSä¼ è¾“
- ğŸ“¦ **ä¾èµ–å®‰å…¨**ï¼šå®šæœŸå®¡è®¡ã€åŠæ—¶æ›´æ–°
- âœ… **æœ€ä½³å®è·µ**ï¼šè¾“å…¥éªŒè¯ã€è¾“å‡ºç¼–ç ã€æœ€å°æƒé™

è®°ä½ï¼š**å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ä¸æ–­å­¦ä¹ å’Œæ”¹è¿›ï¼**

