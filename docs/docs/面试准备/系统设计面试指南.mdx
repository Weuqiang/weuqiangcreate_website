---
sidebar_position: 3
title: ç³»ç»Ÿè®¾è®¡é¢è¯•æŒ‡å—
tags: [é¢è¯•, ç³»ç»Ÿè®¾è®¡, æ¶æ„]
---

# ç³»ç»Ÿè®¾è®¡é¢è¯•æŒ‡å—

ç³»ç»Ÿè®¾è®¡é¢è¯•è€ƒå¯Ÿæ¶æ„è®¾è®¡èƒ½åŠ›ï¼Œæœ¬æ–‡æä¾›ç³»ç»Ÿè®¾è®¡çš„æ€è·¯å’Œå¸¸è§æ¡ˆä¾‹ã€‚

## è®¾è®¡æ€è·¯

### 1. éœ€æ±‚åˆ†æ

```javascript
/**
 * ç³»ç»Ÿè®¾è®¡å››æ­¥æ³•
 */

const designProcess = {
  step1: {
    name: 'æ˜ç¡®éœ€æ±‚',
    questions: [
      'ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ',
      'é¢„æœŸç”¨æˆ·è§„æ¨¡ï¼Ÿ',
      'è¯»å†™æ¯”ä¾‹ï¼Ÿ',
      'æ•°æ®é‡çº§ï¼Ÿ',
      'æ€§èƒ½è¦æ±‚ï¼Ÿ',
      'å¯ç”¨æ€§è¦æ±‚ï¼Ÿ'
    ]
  },
  
  step2: {
    name: 'ä¼°ç®—è§„æ¨¡',
    calculations: {
      users: 'æ—¥æ´»ç”¨æˆ· * å¹³å‡è¯·æ±‚æ•°',
      qps: 'æ€»è¯·æ±‚æ•° / 86400ç§’',
      storage: 'å•æ¡æ•°æ®å¤§å° * æ•°æ®æ€»é‡',
      bandwidth: 'QPS * å¹³å‡å“åº”å¤§å°'
    }
  },
  
  step3: {
    name: 'è®¾è®¡æ¶æ„',
    components: [
      'å®¢æˆ·ç«¯',
      'è´Ÿè½½å‡è¡¡',
      'åº”ç”¨æœåŠ¡å™¨',
      'ç¼“å­˜',
      'æ•°æ®åº“',
      'æ¶ˆæ¯é˜Ÿåˆ—',
      'CDN'
    ]
  },
  
  step4: {
    name: 'æ·±å…¥ç»†èŠ‚',
    topics: [
      'æ•°æ®æ¨¡å‹',
      'APIè®¾è®¡',
      'ç¼“å­˜ç­–ç•¥',
      'æ•°æ®åº“åˆ†ç‰‡',
      'å®¹é”™å¤„ç†',
      'ç›‘æ§å‘Šè­¦'
    ]
  }
};
```

### 2. å®¹é‡ä¼°ç®—

```javascript
/**
 * å®¹é‡ä¼°ç®—ç¤ºä¾‹
 */

// çŸ­è§†é¢‘ç³»ç»Ÿ
const shortVideoSystem = {
  // å‡è®¾
  assumptions: {
    dailyActiveUsers: 100_000_000,      // 1äº¿DAU
    videosPerUser: 10,                  // æ¯äººæ¯å¤©10ä¸ªè§†é¢‘
    avgVideoSize: 5 * 1024 * 1024,      // 5MB
    avgViewDuration: 30,                // 30ç§’
    peakFactor: 3                       // å³°å€¼æ˜¯å¹³å‡å€¼çš„3å€
  },
  
  // è®¡ç®—
  calculations: {
    // QPS
    dailyVideos: 100_000_000 * 10,                    // 10äº¿
    avgQPS: 1_000_000_000 / 86400,                    // ~11,574
    peakQPS: 11_574 * 3,                              // ~34,722
    
    // å­˜å‚¨
    dailyStorage: 1_000_000_000 * 5 * 1024 * 1024,   // 5PB/å¤©
    yearlyStorage: 5 * 365,                           // 1825PB/å¹´
    
    // å¸¦å®½
    avgBandwidth: 11_574 * 5 * 1024 * 1024,          // ~58TB/s
    peakBandwidth: 58 * 3                             // ~174TB/s
  },
  
  // æ¶æ„å†³ç­–
  decisions: {
    storage: 'CDN + å¯¹è±¡å­˜å‚¨ï¼ˆOSSï¼‰',
    database: 'åˆ†åº“åˆ†è¡¨ + è¯»å†™åˆ†ç¦»',
    cache: 'Redisé›†ç¾¤',
    mq: 'Kafkaå¤„ç†å¼‚æ­¥ä»»åŠ¡'
  }
};
```

## ç»å…¸æ¡ˆä¾‹

### 1. è®¾è®¡çŸ­URLç³»ç»Ÿ

```javascript
/**
 * çŸ­URLç³»ç»Ÿè®¾è®¡
 */

// éœ€æ±‚åˆ†æ
const requirements = {
  functional: [
    'é•¿URLè½¬çŸ­URL',
    'çŸ­URLè·³è½¬åˆ°é•¿URL',
    'è‡ªå®šä¹‰çŸ­URL',
    'ç»Ÿè®¡è®¿é—®æ¬¡æ•°'
  ],
  nonFunctional: [
    'é«˜å¯ç”¨ï¼š99.9%',
    'ä½å»¶è¿Ÿï¼š<100ms',
    'é«˜å¹¶å‘ï¼š10000 QPS'
  ]
};

// APIè®¾è®¡
class URLShortenerAPI {
  // åˆ›å»ºçŸ­URL
  async createShortURL(longURL, customAlias = null) {
    // POST /api/shorten
    // Body: { longURL, customAlias }
    
    // 1. éªŒè¯é•¿URL
    if (!this.isValidURL(longURL)) {
      throw new Error('Invalid URL');
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const existing = await this.db.findByLongURL(longURL);
    if (existing) {
      return existing.shortURL;
    }
    
    // 3. ç”ŸæˆçŸ­ç 
    const shortCode = customAlias || this.generateShortCode();
    
    // 4. æ£€æŸ¥å†²çª
    if (await this.db.exists(shortCode)) {
      throw new Error('Short code already exists');
    }
    
    // 5. ä¿å­˜æ˜ å°„
    await this.db.save({
      shortCode,
      longURL,
      createdAt: new Date(),
      clicks: 0
    });
    
    return `https://short.url/${shortCode}`;
  }
  
  // é‡å®šå‘
  async redirect(shortCode) {
    // GET /:shortCode
    
    // 1. æŸ¥è¯¢ç¼“å­˜
    let longURL = await this.cache.get(shortCode);
    
    if (!longURL) {
      // 2. æŸ¥è¯¢æ•°æ®åº“
      const record = await this.db.findByShortCode(shortCode);
      
      if (!record) {
        throw new Error('URL not found');
      }
      
      longURL = record.longURL;
      
      // 3. å†™å…¥ç¼“å­˜
      await this.cache.set(shortCode, longURL, 3600);
    }
    
    // 4. å¼‚æ­¥æ›´æ–°ç»Ÿè®¡
    this.updateStats(shortCode);
    
    return longURL;
  }
  
  // ç”ŸæˆçŸ­ç 
  generateShortCode() {
    // æ–¹æ¡ˆ1ï¼šBase62ç¼–ç 
    const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const id = this.getNextID(); // åˆ†å¸ƒå¼IDç”Ÿæˆå™¨
    
    let shortCode = '';
    let num = id;
    
    while (num > 0) {
      shortCode = chars[num % 62] + shortCode;
      num = Math.floor(num / 62);
    }
    
    return shortCode.padStart(7, '0'); // 7ä½çŸ­ç 
  }
  
  // æ–¹æ¡ˆ2ï¼šå“ˆå¸Œ + å†²çªæ£€æµ‹
  generateShortCodeHash(longURL) {
    const hash = crypto.createHash('md5').update(longURL).digest('hex');
    return hash.substring(0, 7);
  }
}

// æ•°æ®åº“è®¾è®¡
const schema = {
  urls: {
    id: 'BIGINT PRIMARY KEY',
    short_code: 'VARCHAR(10) UNIQUE INDEX',
    long_url: 'VARCHAR(2048)',
    created_at: 'TIMESTAMP',
    expires_at: 'TIMESTAMP',
    clicks: 'INT DEFAULT 0',
    INDEX: ['short_code', 'long_url']
  }
};

// æ¶æ„è®¾è®¡
const architecture = {
  client: 'Web/Mobile App',
  loadBalancer: 'Nginx',
  appServers: 'Node.jsé›†ç¾¤',
  cache: 'Redisé›†ç¾¤',
  database: 'MySQLä¸»ä» + åˆ†åº“åˆ†è¡¨',
  storage: 'å¯¹è±¡å­˜å‚¨ï¼ˆç»Ÿè®¡æ•°æ®ï¼‰',
  mq: 'Kafkaï¼ˆå¼‚æ­¥ç»Ÿè®¡ï¼‰'
};
```

### 2. è®¾è®¡ç§’æ€ç³»ç»Ÿ

```javascript
/**
 * ç§’æ€ç³»ç»Ÿè®¾è®¡
 */

class SeckillSystem {
  // ç§’æ€æµç¨‹
  async seckill(userId, productId) {
    // 1. å‰ç«¯é™æµï¼šæŒ‰é’®ç½®ç°ã€å€’è®¡æ—¶
    
    // 2. ç½‘å…³é™æµ
    if (!await this.rateLimiter.allow(userId)) {
      throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹');
    }
    
    // 3. æ£€æŸ¥åº“å­˜ï¼ˆRedisï¼‰
    const stock = await this.redis.get(`stock:${productId}`);
    if (stock <= 0) {
      throw new Error('å•†å“å·²å”®ç½„');
    }
    
    // 4. é¢„å‡åº“å­˜
    const newStock = await this.redis.decr(`stock:${productId}`);
    if (newStock < 0) {
      await this.redis.incr(`stock:${productId}`);
      throw new Error('å•†å“å·²å”®ç½„');
    }
    
    // 5. å‘é€æ¶ˆæ¯é˜Ÿåˆ—
    await this.mq.send({
      type: 'CREATE_ORDER',
      userId,
      productId,
      timestamp: Date.now()
    });
    
    return { success: true, message: 'æŠ¢è´­æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆè®¢å•' };
  }
  
  // æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—
  async processOrder(message) {
    const { userId, productId } = message;
    
    try {
      // 1. åˆ›å»ºè®¢å•
      const order = await this.db.transaction(async (trx) => {
        // æ£€æŸ¥æ˜¯å¦å·²è´­ä¹°
        const existing = await trx('orders')
          .where({ userId, productId })
          .first();
        
        if (existing) {
          throw new Error('å·²è´­ä¹°è¿‡è¯¥å•†å“');
        }
        
        // æ‰£å‡æ•°æ®åº“åº“å­˜
        const updated = await trx('products')
          .where('id', productId)
          .where('stock', '>', 0)
          .decrement('stock', 1);
        
        if (updated === 0) {
          throw new Error('åº“å­˜ä¸è¶³');
        }
        
        // åˆ›å»ºè®¢å•
        const [orderId] = await trx('orders').insert({
          userId,
          productId,
          status: 'PENDING',
          createdAt: new Date()
        });
        
        return orderId;
      });
      
      // 2. å‘é€é€šçŸ¥
      await this.notification.send(userId, {
        type: 'ORDER_CREATED',
        orderId: order
      });
      
    } catch (error) {
      // å›æ»šRedisåº“å­˜
      await this.redis.incr(`stock:${productId}`);
      
      // å‘é€å¤±è´¥é€šçŸ¥
      await this.notification.send(userId, {
        type: 'ORDER_FAILED',
        reason: error.message
      });
    }
  }
  
  // åº“å­˜é¢„çƒ­
  async warmupStock(productId) {
    const product = await this.db('products')
      .where('id', productId)
      .first();
    
    await this.redis.set(`stock:${productId}`, product.stock);
  }
}

// ä¼˜åŒ–ç­–ç•¥
const optimizations = {
  frontend: [
    'æŒ‰é’®é˜²æŠ–',
    'éªŒè¯ç ',
    'æ’é˜Ÿé¡µé¢'
  ],
  
  backend: [
    'é™æµï¼šä»¤ç‰Œæ¡¶',
    'ç¼“å­˜ï¼šRedisé¢„çƒ­',
    'å¼‚æ­¥ï¼šæ¶ˆæ¯é˜Ÿåˆ—',
    'é™çº§ï¼šè¿”å›æ’é˜Ÿä¸­'
  ],
  
  database: [
    'è¯»å†™åˆ†ç¦»',
    'åˆ†åº“åˆ†è¡¨',
    'ä¹è§‚é”',
    'æ‰¹é‡æ“ä½œ'
  ],
  
  infrastructure: [
    'CDNåŠ é€Ÿ',
    'è´Ÿè½½å‡è¡¡',
    'å¼¹æ€§æ‰©å®¹',
    'ç†”æ–­é™çº§'
  ]
};
```

### 3. è®¾è®¡åˆ†å¸ƒå¼IDç”Ÿæˆå™¨

```javascript
/**
 * åˆ†å¸ƒå¼IDç”Ÿæˆå™¨
 */

// æ–¹æ¡ˆ1ï¼šSnowflakeç®—æ³•
class SnowflakeIDGenerator {
  constructor(workerId, datacenterId) {
    this.workerId = workerId;           // 10ä½
    this.datacenterId = datacenterId;   // 10ä½
    this.sequence = 0;                  // 12ä½
    this.lastTimestamp = -1;
    
    // æ—¶é—´æˆ³å 41ä½ï¼Œä»2020-01-01å¼€å§‹
    this.epoch = 1577836800000;
  }
  
  generate() {
    let timestamp = Date.now();
    
    // æ—¶é’Ÿå›æ‹¨
    if (timestamp < this.lastTimestamp) {
      throw new Error('Clock moved backwards');
    }
    
    // åŒä¸€æ¯«ç§’å†…
    if (timestamp === this.lastTimestamp) {
      this.sequence = (this.sequence + 1) & 0xfff; // 12ä½
      
      // åºåˆ—å·ç”¨å®Œï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’
      if (this.sequence === 0) {
        timestamp = this.waitNextMillis(timestamp);
      }
    } else {
      this.sequence = 0;
    }
    
    this.lastTimestamp = timestamp;
    
    // ç»„è£…ID
    const id = 
      ((timestamp - this.epoch) << 22) |  // 41ä½æ—¶é—´æˆ³
      (this.datacenterId << 17) |         // 5ä½æ•°æ®ä¸­å¿ƒ
      (this.workerId << 12) |             // 5ä½æœºå™¨ID
      this.sequence;                      // 12ä½åºåˆ—å·
    
    return id;
  }
  
  waitNextMillis(timestamp) {
    while (timestamp <= this.lastTimestamp) {
      timestamp = Date.now();
    }
    return timestamp;
  }
}

// æ–¹æ¡ˆ2ï¼šæ•°æ®åº“è‡ªå¢ID
class DatabaseIDGenerator {
  async generate() {
    const result = await this.db.query(`
      REPLACE INTO id_generator (stub) VALUES ('a');
      SELECT LAST_INSERT_ID() as id;
    `);
    
    return result[0].id;
  }
}

// æ–¹æ¡ˆ3ï¼šRedisè‡ªå¢
class RedisIDGenerator {
  async generate(key) {
    return await this.redis.incr(key);
  }
  
  // æ‰¹é‡è·å–
  async generateBatch(key, count) {
    const max = await this.redis.incrby(key, count);
    const min = max - count + 1;
    
    return { min, max };
  }
}

// æ–¹æ¡ˆ4ï¼šUUID
class UUIDGenerator {
  generate() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
}

// å¯¹æ¯”
const comparison = {
  snowflake: {
    pros: ['è¶‹åŠ¿é€’å¢', 'é«˜æ€§èƒ½', 'æ— ä¾èµ–'],
    cons: ['æ—¶é’Ÿä¾èµ–', 'éœ€è¦æœºå™¨ID']
  },
  
  database: {
    pros: ['ç®€å•', 'å…¨å±€å”¯ä¸€'],
    cons: ['æ€§èƒ½ç“¶é¢ˆ', 'å•ç‚¹æ•…éšœ']
  },
  
  redis: {
    pros: ['é«˜æ€§èƒ½', 'ç®€å•'],
    cons: ['ä¾èµ–Redis', 'éœ€è¦æŒä¹…åŒ–']
  },
  
  uuid: {
    pros: ['æ— ä¾èµ–', 'å…¨å±€å”¯ä¸€'],
    cons: ['æ— åº', 'å­˜å‚¨ç©ºé—´å¤§']
  }
};
```

### 4. è®¾è®¡æ¶ˆæ¯é˜Ÿåˆ—

```javascript
/**
 * æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡
 */

class MessageQueue {
  constructor() {
    this.queues = new Map();
    this.consumers = new Map();
  }
  
  // å‘é€æ¶ˆæ¯
  async send(topic, message) {
    if (!this.queues.has(topic)) {
      this.queues.set(topic, []);
    }
    
    const msg = {
      id: this.generateID(),
      topic,
      body: message,
      timestamp: Date.now(),
      retryCount: 0
    };
    
    // æŒä¹…åŒ–
    await this.persist(msg);
    
    // æ¨é€åˆ°é˜Ÿåˆ—
    this.queues.get(topic).push(msg);
    
    // é€šçŸ¥æ¶ˆè´¹è€…
    this.notifyConsumers(topic);
    
    return msg.id;
  }
  
  // è®¢é˜…æ¶ˆæ¯
  subscribe(topic, handler) {
    if (!this.consumers.has(topic)) {
      this.consumers.set(topic, []);
    }
    
    this.consumers.get(topic).push(handler);
  }
  
  // æ¶ˆè´¹æ¶ˆæ¯
  async consume(topic) {
    const queue = this.queues.get(topic);
    if (!queue || queue.length === 0) return;
    
    const message = queue.shift();
    const handlers = this.consumers.get(topic) || [];
    
    for (const handler of handlers) {
      try {
        await handler(message);
        
        // ç¡®è®¤æ¶ˆè´¹
        await this.ack(message.id);
      } catch (error) {
        // é‡è¯•
        await this.retry(message);
      }
    }
  }
  
  // é‡è¯•æœºåˆ¶
  async retry(message) {
    message.retryCount++;
    
    if (message.retryCount > 3) {
      // è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
      await this.sendToDeadLetter(message);
      return;
    }
    
    // å»¶è¿Ÿé‡è¯•
    const delay = Math.pow(2, message.retryCount) * 1000;
    setTimeout(() => {
      this.queues.get(message.topic).push(message);
    }, delay);
  }
  
  // æŒä¹…åŒ–
  async persist(message) {
    await this.db.insert('messages', message);
  }
  
  // ç¡®è®¤æ¶ˆè´¹
  async ack(messageId) {
    await this.db.delete('messages', { id: messageId });
  }
}

// ç‰¹æ€§
const features = {
  reliability: [
    'æ¶ˆæ¯æŒä¹…åŒ–',
    'ACKç¡®è®¤æœºåˆ¶',
    'é‡è¯•æœºåˆ¶',
    'æ­»ä¿¡é˜Ÿåˆ—'
  ],
  
  performance: [
    'æ‰¹é‡å‘é€',
    'å¼‚æ­¥å¤„ç†',
    'æ¶ˆæ¯å‹ç¼©',
    'é›¶æ‹·è´'
  ],
  
  scalability: [
    'åˆ†åŒº',
    'å‰¯æœ¬',
    'é›†ç¾¤',
    'è´Ÿè½½å‡è¡¡'
  ],
  
  ordering: [
    'å…¨å±€æœ‰åº',
    'åˆ†åŒºæœ‰åº',
    'æ¶ˆè´¹è€…æœ‰åº'
  ]
};
```

## æ€»ç»“

ç³»ç»Ÿè®¾è®¡è¦ç‚¹ï¼š
- ğŸ“‹ **éœ€æ±‚åˆ†æ**ï¼šåŠŸèƒ½ã€æ€§èƒ½ã€è§„æ¨¡
- ğŸ“Š **å®¹é‡ä¼°ç®—**ï¼šQPSã€å­˜å‚¨ã€å¸¦å®½
- ğŸ—ï¸ **æ¶æ„è®¾è®¡**ï¼šåˆ†å±‚ã€åˆ†å¸ƒå¼ã€é«˜å¯ç”¨
- ğŸ’¾ **æ•°æ®è®¾è®¡**ï¼šæ•°æ®æ¨¡å‹ã€åˆ†åº“åˆ†è¡¨
- ğŸ”§ **æŠ€æœ¯é€‰å‹**ï¼šç¼“å­˜ã€é˜Ÿåˆ—ã€å­˜å‚¨
- ğŸ¯ **ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šæ€§èƒ½ã€å¯ç”¨æ€§ã€æ‰©å±•æ€§

è®°ä½ï¼š**æ²¡æœ‰å®Œç¾çš„è®¾è®¡ï¼Œåªæœ‰åˆé€‚çš„æƒè¡¡ï¼**

