---
sidebar_position: 3
title: Redis - 
---

# Redis - 

Redis**Redis**

## Redis

### Redis

****

```python
#  - 
def get_user(user_id):
    return db.query("SELECT * FROM users WHERE id = ?", user_id)
# 50ms
```

****Redis

```python
# 
def get_user(user_id):
    # 1. Redis
    user = redis.get(f"user:{user_id}")
    if user:
        return json.loads(user)  # 1ms
    
    # 2. 
    user = db.query("SELECT * FROM users WHERE id = ?", user_id)
    
    # 3. 
    redis.setex(f"user:{user_id}", 3600, json.dumps(user))
    
    return user
```

### 

**Docker**
```bash
# Redis
docker run -d --name redis \
  -p 6379:6379 \
  redis:latest

# Redis CLI
docker exec -it redis redis-cli
```

**Python**
```python
import redis

# Redis
r = redis.Redis(host='localhost', port=6379, db=0, decode_responses=True)

# 
r.ping()  # True
```

## 

### 1. String

```python
import redis

r = redis.Redis(host='localhost', port=6379, decode_responses=True)

# 
r.set('name', 'Alice')

# 
name = r.get('name')
print(name)  # Alice

# 
r.setex('session:123', 3600, 'user_data')

# 
r.psetex('token:456', 60000, 'auth_token')

# key
r.setnx('lock:order', 'locked')

# 
r.mset({'key1': 'value1', 'key2': 'value2'})

# 
values = r.mget(['key1', 'key2'])

# 
r.append('name', ' Smith')

# 
length = r.strlen('name')

# 
r.set('counter', 0)
r.incr('counter')  # 1
r.incrby('counter', 10)  # 10
r.decr('counter')  # 1
r.decrby('counter', 5)  # 5

# 
old_value = r.getset('name', 'Bob')
```

****
- 
- 
- 
- Session

### 2. Hash

```python
# hash
r.hset('user:1', 'name', 'Alice')
r.hset('user:1', 'age', 25)

# 
r.hmset('user:1', {'email': 'alice@example.com', 'city': 'Beijing'})

# 
name = r.hget('user:1', 'name')

# 
user = r.hmget('user:1', ['name', 'age', 'email'])

# 
user_data = r.hgetall('user:1')
print(user_data)
# {'name': 'Alice', 'age': '25', 'email': 'alice@example.com', 'city': 'Beijing'}

# 
keys = r.hkeys('user:1')

# 
values = r.hvals('user:1')

# 
exists = r.hexists('user:1', 'name')

# 
r.hdel('user:1', 'city')

# 
count = r.hlen('user:1')

# 
r.hincrby('user:1', 'age', 1)  # age1
```

****
- 
- IDkeyIDfield

### 3. List

```python
# 
r.lpush('queue', 'task1')
r.lpush('queue', 'task2', 'task3')

# 
r.rpush('queue', 'task4')

# 
task = r.lpop('queue')

# 
task = r.rpop('queue')

# 
task = r.blpop('queue', timeout=10)

# 
length = r.llen('queue')

# 
tasks = r.lrange('queue', 0, -1)  # 

# 
task = r.lindex('queue', 0)

# 
r.lset('queue', 0, 'new_task')

# 
r.lrem('queue', 1, 'task1')  # 1task1

# 
r.ltrim('queue', 0, 99)  # 100
```

****
- 
- 
- 

### 4. Set

```python
# 
r.sadd('tags', 'python', 'redis', 'database')

# 
tags = r.smembers('tags')

# 
exists = r.sismember('tags', 'python')

# 
r.srem('tags', 'database')

# 
tag = r.srandmember('tags')

# 
tag = r.spop('tags')

# 
count = r.scard('tags')

# 
r.sadd('set1', 'a', 'b', 'c')
r.sadd('set2', 'b', 'c', 'd')

# 
inter = r.sinter('set1', 'set2')  # {'b', 'c'}

# 
union = r.sunion('set1', 'set2')  # {'a', 'b', 'c', 'd'}

# 
diff = r.sdiff('set1', 'set2')  # {'a'}

# 
r.sinterstore('result', 'set1', 'set2')
```

****
- 
- 
- 
- 

### 5. Sorted Set

```python
# 
r.zadd('rank', {'alice': 100, 'bob': 90, 'charlie': 95})

# 
score = r.zscore('rank', 'alice')

# 
r.zincrby('rank', 10, 'bob')  # bob10

# 0
rank = r.zrank('rank', 'alice')  # 
rank = r.zrevrank('rank', 'alice')  # 

# 
# 
top3 = r.zrange('rank', 0, 2, withscores=True)  # 
top3 = r.zrevrange('rank', 0, 2, withscores=True)  # 

# 
users = r.zrangebyscore('rank', 90, 100, withscores=True)

# 
r.zrem('rank', 'charlie')

# 
r.zremrangebyrank('rank', 0, 2)  # 0-2
r.zremrangebyscore('rank', 0, 60)  # 0-60

# 
count = r.zcard('rank')

# 
count = r.zcount('rank', 90, 100)
```

****
- 
- 
- 

## 

### 1. 

```python
import redis
import threading

r = redis.Redis(host='localhost', port=6379)

# 
def subscriber():
    pubsub = r.pubsub()
    pubsub.subscribe('news')
    
    print("...")
    for message in pubsub.listen():
        if message['type'] == 'message':
            print(f": {message['data'].decode()}")

# 
def publisher():
    import time
    time.sleep(1)
    
    for i in range(5):
        r.publish('news', f'{i}')
        time.sleep(1)

# 
t = threading.Thread(target=subscriber, daemon=True)
t.start()

# 
publisher()
```

### 2. 

```python
# 
pipe = r.pipeline()

# 
pipe.set('key1', 'value1')
pipe.set('key2', 'value2')
pipe.incr('counter')

# 
results = pipe.execute()

# key
with r.pipeline() as pipe:
    while True:
        try:
            # key
            pipe.watch('balance')
            
            # 
            balance = int(pipe.get('balance') or 0)
            
            # 
            if balance < 100:
                pipe.unwatch()
                break
            
            # 
            pipe.multi()
            pipe.decrby('balance', 100)
            
            # 
            pipe.execute()
            break
        except redis.WatchError:
            # key
            continue
```

### 3. Lua

```python
# 
lua_script = """
local value = redis.call('GET', KEYS[1])
if value then
    redis.call('DEL', KEYS[1])
    return value
else
    return nil
end
"""

# 
get_and_delete = r.register_script(lua_script)

# 
result = get_and_delete(keys=['mykey'])

# 
rate_limit_script = """
local key = KEYS[1]
local limit = tonumber(ARGV[1])
local window = tonumber(ARGV[2])

local current = redis.call('INCR', key)
if current == 1 then
    redis.call('EXPIRE', key, window)
end

if current > limit then
    return 0
else
    return 1
end
"""

rate_limiter = r.register_script(rate_limit_script)

# 10
allowed = rate_limiter(keys=['rate:user:123'], args=[10, 1])
if allowed:
    print("")
else:
    print("")
```

## 

### 1. 

```python
import redis
import json
import time
from functools import wraps

class RedisCache:
    """Redis"""
    
    def __init__(self, host='localhost', port=6379):
        self.redis = redis.Redis(host=host, port=port, decode_responses=True)
    
    def cache(self, expire=3600, key_prefix=''):
        """"""
        def decorator(func):
            @wraps(func)
            def wrapper(*args, **kwargs):
                # key
                cache_key = f"{key_prefix}:{func.__name__}:{args}:{kwargs}"
                
                # 
                cached = self.redis.get(cache_key)
                if cached:
                    print(f": {cache_key}")
                    return json.loads(cached)
                
                # 
                print(f": {cache_key}")
                result = func(*args, **kwargs)
                
                # 
                self.redis.setex(cache_key, expire, json.dumps(result))
                
                return result
            return wrapper
        return decorator

# 
cache = RedisCache()

@cache.cache(expire=60, key_prefix='user')
def get_user_info(user_id):
    """"""
    time.sleep(1)  # 
    return {
        'id': user_id,
        'name': f'User{user_id}',
        'email': f'user{user_id}@example.com'
    }

# 
user = get_user_info(123)  # 1

# 
user = get_user_info(123)  # <1ms
```

### 2. 

```python
import redis
import time
import uuid

class RedisLock:
    """Redis"""
    
    def __init__(self, redis_client, lock_name, timeout=10):
        self.redis = redis_client
        self.lock_name = f"lock:{lock_name}"
        self.timeout = timeout
        self.identifier = str(uuid.uuid4())
    
    def acquire(self):
        """"""
        end_time = time.time() + self.timeout
        
        while time.time() < end_time:
            # 
            if self.redis.set(self.lock_name, self.identifier, nx=True, ex=self.timeout):
                return True
            
            # 
            time.sleep(0.001)
        
        return False
    
    def release(self):
        """"""
        # Lua
        lua_script = """
        if redis.call('GET', KEYS[1]) == ARGV[1] then
            return redis.call('DEL', KEYS[1])
        else
            return 0
        end
        """
        
        script = self.redis.register_script(lua_script)
        return script(keys=[self.lock_name], args=[self.identifier])
    
    def __enter__(self):
        if not self.acquire():
            raise Exception("")
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        self.release()

# 
r = redis.Redis(host='localhost', port=6379)

# 1
lock = RedisLock(r, 'order:123')
if lock.acquire():
    try:
        # 
        print("...")
        time.sleep(2)
    finally:
        lock.release()

# 2
with RedisLock(r, 'order:456'):
    print("...")
    time.sleep(2)
```

### 3. 

```python
import redis
import time

class Leaderboard:
    """"""
    
    def __init__(self, redis_client, name):
        self.redis = redis_client
        self.key = f"leaderboard:{name}"
    
    def add_score(self, user_id, score):
        """"""
        self.redis.zincrby(self.key, score, user_id)
    
    def get_rank(self, user_id):
        """1"""
        rank = self.redis.zrevrank(self.key, user_id)
        return rank + 1 if rank is not None else None
    
    def get_score(self, user_id):
        """"""
        return self.redis.zscore(self.key, user_id)
    
    def get_top(self, n=10):
        """TOP N"""
        return self.redis.zrevrange(self.key, 0, n-1, withscores=True)
    
    def get_around(self, user_id, n=5):
        """"""
        rank = self.redis.zrevrank(self.key, user_id)
        if rank is None:
            return []
        
        start = max(0, rank - n)
        end = rank + n
        
        return self.redis.zrevrange(self.key, start, end, withscores=True)
    
    def get_range(self, start_rank, end_rank):
        """"""
        return self.redis.zrevrange(self.key, start_rank-1, end_rank-1, withscores=True)

# 
r = redis.Redis(host='localhost', port=6379, decode_responses=True)
leaderboard = Leaderboard(r, 'game:2024')

# 
leaderboard.add_score('user1', 100)
leaderboard.add_score('user2', 200)
leaderboard.add_score('user3', 150)

# TOP 10
top10 = leaderboard.get_top(10)
print("TOP 10:")
for i, (user, score) in enumerate(top10, 1):
    print(f"{i}. {user}: {score}")

# 
rank = leaderboard.get_rank('user1')
print(f"user1: {rank}")

# 
around = leaderboard.get_around('user1', 2)
print(":", around)
```

### 4. 

```python
import redis
import time

class RateLimiter:
    """"""
    
    def __init__(self, redis_client):
        self.redis = redis_client
    
    def is_allowed(self, key, limit, window):
        """
        
        key: key
        limit: 
        window: 
        """
        current = self.redis.incr(key)
        
        if current == 1:
            self.redis.expire(key, window)
        
        return current <= limit
    
    def is_allowed_sliding(self, key, limit, window):
        """
        
        """
        now = time.time()
        window_start = now - window
        
        # 
        self.redis.zremrangebyscore(key, 0, window_start)
        
        # 
        count = self.redis.zcard(key)
        
        if count < limit:
            # 
            self.redis.zadd(key, {str(now): now})
            self.redis.expire(key, window)
            return True
        
        return False

# 
r = redis.Redis(host='localhost', port=6379)
limiter = RateLimiter(r)

# 10
for i in range(15):
    if limiter.is_allowed('api:user:123', 10, 1):
        print(f"{i+1}: ")
    else:
        print(f"{i+1}: ")
    time.sleep(0.05)

# 10100
for i in range(105):
    if limiter.is_allowed_sliding('api:user:456', 100, 10):
        print(f"{i+1}: ")
    else:
        print(f"{i+1}: ")
```

## 

Redis

1. ****StringHashListSetSorted Set
2. ****
3. ****
4. ****RDBAOF

**Redis**

## 

1. 
2. 
3. 
4. Redis

[MongoDB](./mongodb.mdx)

