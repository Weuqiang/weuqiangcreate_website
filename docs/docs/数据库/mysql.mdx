---
sidebar_position: 1
title: MySQL - 
---

# MySQL - 

MySQL**MySQL**

## MySQL

### 

**Docker**
```bash
# MySQL
docker run -d --name mysql \
  -e MYSQL_ROOT_PASSWORD=password \
  -p 3306:3306 \
  mysql:8.0

# MySQL
docker exec -it mysql mysql -uroot -ppassword
```

**MySQL**
```bash
# 
mysql -h localhost -u root -p

# 
SELECT VERSION();

# 
SELECT USER();
```

### 

```sql
-- 
CREATE DATABASE ecommerce CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 
SHOW DATABASES;

-- 
USE ecommerce;

-- 
DROP DATABASE IF EXISTS test_db;
```

### 

```sql
-- 
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    age INT,
    gender ENUM('M', 'F', 'Other'),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 
DESC users;
SHOW CREATE TABLE users;

-- 
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
ALTER TABLE users MODIFY COLUMN age TINYINT;
ALTER TABLE users DROP COLUMN phone;
ALTER TABLE users ADD INDEX idx_age (age);

-- 
DROP TABLE IF EXISTS temp_table;
```

## CRUD

### 

```sql
-- 
INSERT INTO users (username, email, password, age, gender)
VALUES ('alice', 'alice@example.com', 'hashed_password', 25, 'F');

-- 
INSERT INTO users (username, email, password, age, gender) VALUES
('bob', 'bob@example.com', 'hashed_password', 30, 'M'),
('charlie', 'charlie@example.com', 'hashed_password', 28, 'M'),
('diana', 'diana@example.com', 'hashed_password', 26, 'F');

-- ID
INSERT INTO users (username, email, password) 
VALUES ('eve', 'eve@example.com', 'hashed_password');
SELECT LAST_INSERT_ID();

-- ON DUPLICATE KEY
INSERT INTO users (id, username, email, password)
VALUES (1, 'alice', 'alice@example.com', 'new_password')
ON DUPLICATE KEY UPDATE password = VALUES(password);
```

### 

```sql
-- 
SELECT * FROM users;
SELECT username, email FROM users;

-- 
SELECT * FROM users WHERE age > 25;
SELECT * FROM users WHERE gender = 'F' AND age BETWEEN 20 AND 30;
SELECT * FROM users WHERE username LIKE 'a%';
SELECT * FROM users WHERE email IN ('alice@example.com', 'bob@example.com');

-- 
SELECT * FROM users ORDER BY age DESC;
SELECT * FROM users ORDER BY age DESC, created_at ASC;

-- 
SELECT * FROM users LIMIT 10;
SELECT * FROM users LIMIT 10 OFFSET 20;  -- 

-- 
SELECT DISTINCT gender FROM users;

-- 
SELECT COUNT(*) FROM users;
SELECT AVG(age) FROM users;
SELECT MAX(age), MIN(age) FROM users;
SELECT SUM(age) FROM users;

-- 
SELECT gender, COUNT(*) as count, AVG(age) as avg_age
FROM users
GROUP BY gender;

-- HAVING
SELECT gender, COUNT(*) as count
FROM users
GROUP BY gender
HAVING count > 10;
```

### 

```sql
-- 
UPDATE users SET age = 26 WHERE username = 'alice';

-- 
UPDATE users SET age = age + 1 WHERE gender = 'M';

-- 
UPDATE users 
SET email = 'newemail@example.com', updated_at = NOW()
WHERE id = 1;
```

### 

```sql
-- 
DELETE FROM users WHERE id = 1;

-- 
DELETE FROM users WHERE age < 18;

-- 
TRUNCATE TABLE users;
```

## 

### 

```sql
-- 
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status ENUM('pending', 'paid', 'shipped', 'completed') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 
SELECT u.username, o.id as order_id, o.total_amount
FROM users u
INNER JOIN orders o ON u.id = o.user_id;

-- 
SELECT u.username, COUNT(o.id) as order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.username;

-- 
SELECT u.username, o.id as order_id
FROM users u
RIGHT JOIN orders o ON u.id = o.user_id;

-- 
SELECT u1.username as user1, u2.username as user2, u1.age
FROM users u1
JOIN users u2 ON u1.age = u2.age AND u1.id < u2.id;
```

### 

```sql
-- WHERE
SELECT username FROM users
WHERE id IN (
    SELECT user_id FROM orders WHERE total_amount > 1000
);

-- FROM
SELECT avg_age FROM (
    SELECT AVG(age) as avg_age FROM users GROUP BY gender
) t;

-- EXISTS
SELECT username FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o WHERE o.user_id = u.id
);

-- 
SELECT username, age,
    (SELECT AVG(age) FROM users) as avg_age
FROM users;
```

### MySQL 8.0+

```sql
-- ROW_NUMBER
SELECT 
    username,
    age,
    ROW_NUMBER() OVER (ORDER BY age DESC) as rank
FROM users;

-- RANK
SELECT 
    username,
    age,
    RANK() OVER (ORDER BY age DESC) as rank
FROM users;

-- 
SELECT 
    username,
    gender,
    age,
    ROW_NUMBER() OVER (PARTITION BY gender ORDER BY age DESC) as rank_in_gender
FROM users;

-- LAG/LEAD
SELECT 
    username,
    age,
    LAG(age, 1) OVER (ORDER BY age) as prev_age,
    LEAD(age, 1) OVER (ORDER BY age) as next_age
FROM users;

-- 
SELECT 
    username,
    age,
    SUM(age) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as cumsum
FROM users;
```

### CTE

```sql
-- CTE
WITH high_value_users AS (
    SELECT user_id, SUM(total_amount) as total
    FROM orders
    GROUP BY user_id
    HAVING total > 10000
)
SELECT u.username, h.total
FROM users u
JOIN high_value_users h ON u.id = h.user_id;

-- CTE
WITH RECURSIVE org_tree AS (
    -- 
    SELECT id, name, manager_id, 1 as level
    FROM employees
    WHERE manager_id IS NULL
    
    UNION ALL
    
    -- 
    SELECT e.id, e.name, e.manager_id, o.level + 1
    FROM employees e
    JOIN org_tree o ON e.manager_id = o.id
)
SELECT * FROM org_tree;
```

## 

### 

```sql
-- 
CREATE INDEX idx_username ON users(username);

-- 
CREATE UNIQUE INDEX idx_email ON users(email);

-- 
CREATE INDEX idx_age_gender ON users(age, gender);

-- 
CREATE FULLTEXT INDEX idx_content ON articles(content);

-- 
SHOW INDEX FROM users;

-- 
DROP INDEX idx_username ON users;
```

### 

```sql
-- B+
-- 
-- 

-- 
EXPLAIN SELECT * FROM users WHERE username = 'alice';

-- 
SELECT * FROM users FORCE INDEX (idx_username) WHERE username = 'alice';

-- 
SELECT * FROM users IGNORE INDEX (idx_username) WHERE username = 'alice';
```

### 

```sql
--  
SELECT * FROM users WHERE age = 25;

--  
SELECT * FROM users WHERE age + 1 = 26;  -- 
SELECT * FROM users WHERE age != 25;     -- 
SELECT * FROM users WHERE age IS NULL;   -- NULL
SELECT * FROM users WHERE username LIKE '%alice';  -- 

-- 
CREATE INDEX idx_abc ON table(a, b, c);
--  WHERE a=1, WHERE a=1 AND b=2, WHERE a=1 AND b=2 AND c=3
--  WHERE b=2, WHERE c=3, WHERE b=2 AND c=3

-- 
CREATE INDEX idx_username_email ON users(username, email);
SELECT username, email FROM users WHERE username = 'alice';  -- 
```

## 

### 

```sql
-- 
START TRANSACTION;

-- 
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

-- 
COMMIT;

-- 
ROLLBACK;

-- 
SAVEPOINT sp1;
-- 
ROLLBACK TO sp1;
```

### 

```sql
-- 
SELECT @@transaction_isolation;

-- 
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;

-- 
-- 1. READ UNCOMMITTED
-- 2. READ COMMITTED
-- 3. REPEATABLE READ- MySQL
-- 4. SERIALIZABLE
```

### 

```sql
-- S
SELECT * FROM users WHERE id = 1 LOCK IN SHARE MODE;

-- X
SELECT * FROM users WHERE id = 1 FOR UPDATE;

-- 
LOCK TABLES users READ;
UNLOCK TABLES;

-- 
SHOW OPEN TABLES WHERE In_use > 0;
SELECT * FROM information_schema.innodb_locks;
```

## 

### 

```sql
-- 
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;  -- 2

-- 
SHOW VARIABLES LIKE 'slow_query%';

-- 
-- mysqldumpslow
```

### 

```python
import mysql.connector
import time

class QueryOptimizer:
    """"""
    
    def __init__(self):
        self.conn = mysql.connector.connect(
            host='localhost',
            user='root',
            password='password',
            database='ecommerce'
        )
        self.cursor = self.conn.cursor()
    
    def bad_query(self):
        """ N+1"""
        start = time.time()
        
        # 
        self.cursor.execute("SELECT id, username FROM users LIMIT 100")
        users = self.cursor.fetchall()
        
        # N+1
        for user_id, username in users:
            self.cursor.execute(
                "SELECT COUNT(*) FROM orders WHERE user_id = %s",
                (user_id,)
            )
            count = self.cursor.fetchone()[0]
            print(f"{username}: {count} orders")
        
        print(f": {time.time() - start:.2f}")
    
    def good_query(self):
        """ JOIN"""
        start = time.time()
        
        self.cursor.execute("""
            SELECT u.username, COUNT(o.id) as order_count
            FROM users u
            LEFT JOIN orders o ON u.id = o.user_id
            WHERE u.id <= 100
            GROUP BY u.id, u.username
        """)
        
        for username, count in self.cursor.fetchall():
            print(f"{username}: {count} orders")
        
        print(f": {time.time() - start:.2f}")
    
    def use_index(self):
        """"""
        #  
        self.cursor.execute("SELECT * FROM users WHERE age > 25")
        
        #  
        self.cursor.execute("SELECT * FROM users WHERE age = 25")
    
    def batch_insert(self):
        """"""
        #  
        start = time.time()
        for i in range(1000):
            self.cursor.execute(
                "INSERT INTO users (username, email, password) VALUES (%s, %s, %s)",
                (f'user{i}', f'user{i}@example.com', 'password')
            )
        self.conn.commit()
        print(f": {time.time() - start:.2f}")
        
        #  
        start = time.time()
        values = [(f'user{i}', f'user{i}@example.com', 'password') for i in range(1000)]
        self.cursor.executemany(
            "INSERT INTO users (username, email, password) VALUES (%s, %s, %s)",
            values
        )
        self.conn.commit()
        print(f": {time.time() - start:.2f}")
```

### 

```sql
-- 1. 
--  
CREATE TABLE bad_table (
    id VARCHAR(255),  -- BIGINT
    age VARCHAR(10),  -- TINYINT
    price VARCHAR(20) -- DECIMAL
);

--  
CREATE TABLE good_table (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    age TINYINT UNSIGNED,
    price DECIMAL(10,2)
);

-- 2. NULL
CREATE TABLE products (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100) NOT NULL DEFAULT '',
    stock INT NOT NULL DEFAULT 0
);

-- 3. ENUM
CREATE TABLE orders (
    id BIGINT PRIMARY KEY,
    status ENUM('pending', 'paid', 'shipped', 'completed') NOT NULL
);
```

## 

### 

```sql
-- 
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_email (email)
) ENGINE=InnoDB;

-- 
CREATE TABLE products (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    category_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_category (category_id),
    INDEX idx_price (price)
) ENGINE=InnoDB;

-- 
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status ENUM('pending', 'paid', 'shipped', 'completed', 'cancelled') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user (user_id),
    INDEX idx_status (status),
    INDEX idx_created (created_at)
) ENGINE=InnoDB;

-- 
CREATE TABLE order_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    INDEX idx_order (order_id),
    INDEX idx_product (product_id)
) ENGINE=InnoDB;

-- 
CREATE TABLE cart (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_product (user_id, product_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
) ENGINE=InnoDB;

-- 

-- 1. 
SELECT 
    u.username,
    COUNT(o.id) as order_count,
    SUM(o.total_amount) as total_spent
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.username
ORDER BY total_spent DESC
LIMIT 10;

-- 2. 
SELECT 
    p.name,
    SUM(oi.quantity) as total_sold,
    SUM(oi.quantity * oi.price) as revenue
FROM products p
JOIN order_items oi ON p.id = oi.product_id
JOIN orders o ON oi.order_id = o.id
WHERE o.status = 'completed'
GROUP BY p.id, p.name
ORDER BY total_sold DESC
LIMIT 20;

-- 3. 
WITH user_orders AS (
    SELECT 
        user_id,
        COUNT(*) as order_count,
        SUM(total_amount) as total_amount,
        MAX(created_at) as last_order_date
    FROM orders
    WHERE status = 'completed'
    GROUP BY user_id
)
SELECT 
    u.username,
    uo.order_count,
    uo.total_amount,
    uo.last_order_date,
    DATEDIFF(NOW(), uo.last_order_date) as days_since_last_order
FROM users u
JOIN user_orders uo ON u.id = uo.user_id
ORDER BY uo.total_amount DESC;
```

## 

MySQL

1. **ACID**
2. ****B+
3. ****
4. ****SQL

****

## 

1. 
2. 
3. 
4. 

[MongoDB](./mongodb.mdx)

