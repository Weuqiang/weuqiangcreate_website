---
sidebar_position: 3
title: Redisæ ¸å¿ƒåŸç†ä¸å®æˆ˜
tags: [æ•°æ®åº“, Redis, ç¼“å­˜, æ•°æ®ç»“æ„]
---

# Redisæ ¸å¿ƒåŸç†ä¸å®æˆ˜

Redisæ˜¯é«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œæœ¬æ–‡å°†æ·±å…¥è®²è§£Redisçš„æ•°æ®ç»“æ„ã€æŒä¹…åŒ–ã€é›†ç¾¤ç­‰æ ¸å¿ƒåŸç†ã€‚

## æ•°æ®ç»“æ„

### 1. Stringï¼ˆå­—ç¬¦ä¸²ï¼‰

```bash
# åŸºæœ¬æ“ä½œ
SET key value
GET key
DEL key

# æ•°å€¼æ“ä½œ
SET counter 0
INCR counter        # 1
INCRBY counter 10   # 11
DECR counter        # 10

# æ‰¹é‡æ“ä½œ
MSET key1 value1 key2 value2
MGET key1 key2

# è¿‡æœŸæ—¶é—´
SETEX key 3600 value  # è®¾ç½®å¹¶æŒ‡å®šè¿‡æœŸæ—¶é—´
EXPIRE key 3600       # è®¾ç½®è¿‡æœŸæ—¶é—´
TTL key              # æŸ¥çœ‹å‰©ä½™æ—¶é—´

# åº”ç”¨åœºæ™¯
# 1. ç¼“å­˜
SET user:1:info '{"name":"John","age":30}'

# 2. è®¡æ•°å™¨
INCR page:views
INCR user:1:followers

# 3. åˆ†å¸ƒå¼é”
SET lock:order:123 uuid NX EX 30
```

### 2. Hashï¼ˆå“ˆå¸Œï¼‰

```bash
# åŸºæœ¬æ“ä½œ
HSET user:1 name John
HSET user:1 age 30
HGET user:1 name
HGETALL user:1

# æ‰¹é‡æ“ä½œ
HMSET user:1 name John age 30 email john@example.com
HMGET user:1 name age

# æ•°å€¼æ“ä½œ
HINCRBY user:1 age 1

# åº”ç”¨åœºæ™¯
# 1. å¯¹è±¡å­˜å‚¨
HMSET product:1 name iPhone price 999 stock 100

# 2. è´­ç‰©è½¦
HSET cart:user:1 product:1 2
HSET cart:user:1 product:2 1
HGETALL cart:user:1
```

### 3. Listï¼ˆåˆ—è¡¨ï¼‰

```bash
# åŸºæœ¬æ“ä½œ
LPUSH list value1    # å·¦ä¾§æ’å…¥
RPUSH list value2    # å³ä¾§æ’å…¥
LPOP list           # å·¦ä¾§å¼¹å‡º
RPOP list           # å³ä¾§å¼¹å‡º
LRANGE list 0 -1    # æŸ¥çœ‹æ‰€æœ‰å…ƒç´ 

# é˜»å¡æ“ä½œ
BLPOP list 30       # é˜»å¡å¼¹å‡ºï¼Œè¶…æ—¶30ç§’

# åº”ç”¨åœºæ™¯
# 1. æ¶ˆæ¯é˜Ÿåˆ—
LPUSH queue:tasks task1
BRPOP queue:tasks 0

# 2. æœ€æ–°åˆ—è¡¨
LPUSH news:latest article1
LRANGE news:latest 0 9  # æœ€æ–°10æ¡

# 3. æ—¶é—´çº¿
LPUSH timeline:user:1 post1
LRANGE timeline:user:1 0 19  # æœ€æ–°20æ¡
```

### 4. Setï¼ˆé›†åˆï¼‰

```bash
# åŸºæœ¬æ“ä½œ
SADD set member1
SREM set member1
SMEMBERS set
SISMEMBER set member1

# é›†åˆè¿ç®—
SINTER set1 set2     # äº¤é›†
SUNION set1 set2     # å¹¶é›†
SDIFF set1 set2      # å·®é›†

# åº”ç”¨åœºæ™¯
# 1. æ ‡ç­¾ç³»ç»Ÿ
SADD user:1:tags tech music
SADD user:2:tags tech sports
SINTER user:1:tags user:2:tags  # å…±åŒå…´è¶£

# 2. å¥½å‹å…³ç³»
SADD user:1:friends user:2 user:3
SADD user:2:friends user:1 user:4
SINTER user:1:friends user:2:friends  # å…±åŒå¥½å‹

# 3. å»é‡
SADD unique:visitors user:1
SCARD unique:visitors  # ç‹¬ç«‹è®¿å®¢æ•°
```

### 5. Sorted Setï¼ˆæœ‰åºé›†åˆï¼‰

```bash
# åŸºæœ¬æ“ä½œ
ZADD zset 100 member1
ZADD zset 200 member2
ZRANGE zset 0 -1 WITHSCORES
ZREVRANGE zset 0 -1  # å€’åº

# èŒƒå›´æŸ¥è¯¢
ZRANGEBYSCORE zset 100 200
ZCOUNT zset 100 200

# æ’å
ZRANK zset member1
ZREVRANK zset member1

# åº”ç”¨åœºæ™¯
# 1. æ’è¡Œæ¦œ
ZADD leaderboard 1000 user:1
ZADD leaderboard 2000 user:2
ZREVRANGE leaderboard 0 9 WITHSCORES  # Top 10

# 2. å»¶è¿Ÿé˜Ÿåˆ—
ZADD delay:queue 1704067200 task1  # æ—¶é—´æˆ³ä½œä¸ºåˆ†æ•°
ZRANGEBYSCORE delay:queue 0 [å½“å‰æ—¶é—´æˆ³]  # è·å–åˆ°æœŸä»»åŠ¡

# 3. çƒ­é—¨æ–‡ç« 
ZINCRBY hot:articles 1 article:1
ZREVRANGE hot:articles 0 9  # çƒ­é—¨Top 10
```

## æŒä¹…åŒ–æœºåˆ¶

### RDBï¼ˆå¿«ç…§ï¼‰

```bash
# é…ç½®
save 900 1      # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–
save 300 10     # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–
save 60 10000   # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–

# æ‰‹åŠ¨è§¦å‘
SAVE            # é˜»å¡ä¿å­˜
BGSAVE          # åå°ä¿å­˜

# RDBæ–‡ä»¶
dbfilename dump.rdb
dir /var/lib/redis

# ä¼˜ç‚¹
# 1. æ–‡ä»¶ç´§å‡‘ï¼Œé€‚åˆå¤‡ä»½
# 2. æ¢å¤é€Ÿåº¦å¿«
# 3. æ€§èƒ½å½±å“å°ï¼ˆforkå­è¿›ç¨‹ï¼‰

# ç¼ºç‚¹
# 1. å¯èƒ½ä¸¢å¤±æœ€åä¸€æ¬¡å¿«ç…§åçš„æ•°æ®
# 2. forkå­è¿›ç¨‹è€—æ—¶
```

### AOFï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰

```bash
# é…ç½®
appendonly yes
appendfilename "appendonly.aof"

# åŒæ­¥ç­–ç•¥
appendfsync always      # æ¯æ¬¡å†™å…¥éƒ½åŒæ­¥ï¼ˆæœ€å®‰å…¨ï¼Œæœ€æ…¢ï¼‰
appendfsync everysec    # æ¯ç§’åŒæ­¥ï¼ˆæ¨èï¼‰
appendfsync no          # ç”±OSå†³å®šï¼ˆæœ€å¿«ï¼Œæœ€ä¸å®‰å…¨ï¼‰

# AOFé‡å†™
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# æ‰‹åŠ¨é‡å†™
BGREWRITEAOF

# ä¼˜ç‚¹
# 1. æ•°æ®æ›´å®‰å…¨
# 2. å¯è¯»æ€§å¥½
# 3. å¯ä¿®å¤

# ç¼ºç‚¹
# 1. æ–‡ä»¶å¤§
# 2. æ¢å¤æ…¢
# 3. æ€§èƒ½å½±å“å¤§
```

### æ··åˆæŒä¹…åŒ–

```bash
# Redis 4.0+
aof-use-rdb-preamble yes

# AOFæ–‡ä»¶ = RDBå¿«ç…§ + AOFå¢é‡
# ç»“åˆä¸¤è€…ä¼˜ç‚¹ï¼šæ¢å¤å¿« + æ•°æ®å®‰å…¨
```

## ç¼“å­˜ç­–ç•¥

### 1. Cache-Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰

```javascript
class CacheAside {
  async get(key) {
    // 1. æŸ¥ç¼“å­˜
    let value = await redis.get(key);
    
    if (value) {
      return JSON.parse(value);
    }
    
    // 2. æŸ¥æ•°æ®åº“
    value = await db.query(`SELECT * FROM users WHERE id = ?`, [key]);
    
    if (value) {
      // 3. å†™ç¼“å­˜
      await redis.setex(key, 3600, JSON.stringify(value));
    }
    
    return value;
  }
  
  async update(key, value) {
    // 1. æ›´æ–°æ•°æ®åº“
    await db.query(`UPDATE users SET ... WHERE id = ?`, [key]);
    
    // 2. åˆ é™¤ç¼“å­˜
    await redis.del(key);
  }
}
```

### 2. Read-Through

```javascript
class ReadThrough {
  async get(key) {
    // ç¼“å­˜å±‚è‡ªåŠ¨åŠ è½½æ•°æ®
    return await cache.get(key, async () => {
      return await db.query(`SELECT * FROM users WHERE id = ?`, [key]);
    });
  }
}
```

### 3. Write-Through

```javascript
class WriteThrough {
  async update(key, value) {
    // åŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
    await Promise.all([
      redis.set(key, JSON.stringify(value)),
      db.query(`UPDATE users SET ... WHERE id = ?`, [key])
    ]);
  }
}
```

### 4. Write-Behind

```javascript
class WriteBehind {
  constructor() {
    this.writeQueue = [];
  }
  
  async update(key, value) {
    // 1. ç«‹å³æ›´æ–°ç¼“å­˜
    await redis.set(key, JSON.stringify(value));
    
    // 2. å¼‚æ­¥æ›´æ–°æ•°æ®åº“
    this.writeQueue.push({ key, value });
    
    if (this.writeQueue.length >= 100) {
      await this.flush();
    }
  }
  
  async flush() {
    const batch = this.writeQueue.splice(0, 100);
    
    // æ‰¹é‡å†™å…¥æ•°æ®åº“
    await db.batchUpdate(batch);
  }
}
```

## ç¼“å­˜é—®é¢˜

### 1. ç¼“å­˜ç©¿é€

```javascript
// é—®é¢˜ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜å’Œæ•°æ®åº“éƒ½æ²¡æœ‰
// è§£å†³æ–¹æ¡ˆ1ï¼šç¼“å­˜ç©ºå€¼
class CachePenetration {
  async get(key) {
    let value = await redis.get(key);
    
    if (value === 'NULL') {
      return null;
    }
    
    if (value) {
      return JSON.parse(value);
    }
    
    value = await db.query(`SELECT * FROM users WHERE id = ?`, [key]);
    
    if (value) {
      await redis.setex(key, 3600, JSON.stringify(value));
    } else {
      // ç¼“å­˜ç©ºå€¼ï¼Œè¿‡æœŸæ—¶é—´çŸ­
      await redis.setex(key, 60, 'NULL');
    }
    
    return value;
  }
}

// è§£å†³æ–¹æ¡ˆ2ï¼šå¸ƒéš†è¿‡æ»¤å™¨
class BloomFilter {
  constructor(size = 10000000, hashCount = 7) {
    this.size = size;
    this.hashCount = hashCount;
  }
  
  async add(key) {
    for (let i = 0; i < this.hashCount; i++) {
      const hash = this.hash(key, i) % this.size;
      await redis.setbit('bloom:filter', hash, 1);
    }
  }
  
  async contains(key) {
    for (let i = 0; i < this.hashCount; i++) {
      const hash = this.hash(key, i) % this.size;
      const bit = await redis.getbit('bloom:filter', hash);
      if (bit === 0) {
        return false;
      }
    }
    return true;
  }
  
  hash(key, seed) {
    let hash = seed;
    for (let i = 0; i < key.length; i++) {
      hash = ((hash << 5) - hash) + key.charCodeAt(i);
      hash = hash & hash;
    }
    return Math.abs(hash);
  }
}
```

### 2. ç¼“å­˜å‡»ç©¿

```javascript
// é—®é¢˜ï¼šçƒ­ç‚¹keyè¿‡æœŸï¼Œå¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“
// è§£å†³æ–¹æ¡ˆï¼šäº’æ–¥é”
class CacheBreakdown {
  async get(key) {
    let value = await redis.get(key);
    
    if (value) {
      return JSON.parse(value);
    }
    
    // è·å–é”
    const lockKey = `lock:${key}`;
    const locked = await redis.set(lockKey, '1', 'NX', 'EX', 10);
    
    if (locked) {
      try {
        // å†æ¬¡æ£€æŸ¥ç¼“å­˜
        value = await redis.get(key);
        if (value) {
          return JSON.parse(value);
        }
        
        // æŸ¥è¯¢æ•°æ®åº“
        value = await db.query(`SELECT * FROM users WHERE id = ?`, [key]);
        
        if (value) {
          await redis.setex(key, 3600, JSON.stringify(value));
        }
        
        return value;
      } finally {
        await redis.del(lockKey);
      }
    } else {
      // ç­‰å¾…å¹¶é‡è¯•
      await new Promise(resolve => setTimeout(resolve, 50));
      return await this.get(key);
    }
  }
}
```

### 3. ç¼“å­˜é›ªå´©

```javascript
// é—®é¢˜ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ
// è§£å†³æ–¹æ¡ˆ1ï¼šéšæœºè¿‡æœŸæ—¶é—´
class CacheAvalanche {
  async set(key, value, ttl = 3600) {
    // æ·»åŠ éšæœºæ—¶é—´ï¼ˆÂ±10%ï¼‰
    const randomTTL = ttl + Math.floor(Math.random() * ttl * 0.2 - ttl * 0.1);
    await redis.setex(key, randomTTL, JSON.stringify(value));
  }
}

// è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜
class MultiLevelCache {
  async get(key) {
    // L1: æœ¬åœ°ç¼“å­˜
    let value = localCache.get(key);
    if (value) return value;
    
    // L2: Redisç¼“å­˜
    value = await redis.get(key);
    if (value) {
      localCache.set(key, value, 60);
      return JSON.parse(value);
    }
    
    // L3: æ•°æ®åº“
    value = await db.query(`SELECT * FROM users WHERE id = ?`, [key]);
    if (value) {
      await redis.setex(key, 3600, JSON.stringify(value));
      localCache.set(key, value, 60);
    }
    
    return value;
  }
}
```

## åˆ†å¸ƒå¼é”

```javascript
class RedisLock {
  async acquire(key, ttl = 30) {
    const value = this.generateUUID();
    
    // SET key value NX EX ttl
    const result = await redis.set(
      `lock:${key}`,
      value,
      'NX',
      'EX',
      ttl
    );
    
    if (result === 'OK') {
      return value;
    }
    
    return null;
  }
  
  async release(key, value) {
    // Luaè„šæœ¬ä¿è¯åŸå­æ€§
    const script = `
      if redis.call("get", KEYS[1]) == ARGV[1] then
        return redis.call("del", KEYS[1])
      else
        return 0
      end
    `;
    
    return await redis.eval(script, 1, `lock:${key}`, value);
  }
  
  async withLock(key, callback, ttl = 30) {
    const lockValue = await this.acquire(key, ttl);
    
    if (!lockValue) {
      throw new Error('Failed to acquire lock');
    }
    
    try {
      return await callback();
    } finally {
      await this.release(key, lockValue);
    }
  }
  
  generateUUID() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const lock = new RedisLock();

await lock.withLock('order:123', async () => {
  // å¤„ç†è®¢å•
  const order = await getOrder(123);
  order.status = 'paid';
  await saveOrder(order);
});
```

## Redisé›†ç¾¤

### ä¸»ä»å¤åˆ¶

```bash
# ä»èŠ‚ç‚¹é…ç½®
replicaof 127.0.0.1 6379
masterauth password

# æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
INFO replication

# ç‰¹ç‚¹
# 1. è¯»å†™åˆ†ç¦»
# 2. æ•°æ®å¤‡ä»½
# 3. é«˜å¯ç”¨

# å¤åˆ¶æµç¨‹
# 1. ä»èŠ‚ç‚¹å‘é€SYNCå‘½ä»¤
# 2. ä¸»èŠ‚ç‚¹æ‰§è¡ŒBGSAVE
# 3. ä¸»èŠ‚ç‚¹å‘é€RDBæ–‡ä»¶
# 4. ä¸»èŠ‚ç‚¹å‘é€ç¼“å†²åŒºå‘½ä»¤
# 5. ä»èŠ‚ç‚¹åŠ è½½RDBå¹¶æ‰§è¡Œå‘½ä»¤
```

### å“¨å…µæ¨¡å¼

```bash
# å“¨å…µé…ç½®
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000

# åŠŸèƒ½
# 1. ç›‘æ§ï¼šæ£€æŸ¥ä¸»ä»èŠ‚ç‚¹çŠ¶æ€
# 2. é€šçŸ¥ï¼šæ•…éšœé€šçŸ¥
# 3. è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šé€‰ä¸¾æ–°ä¸»èŠ‚ç‚¹
# 4. é…ç½®æä¾›ï¼šå®¢æˆ·ç«¯è·å–ä¸»èŠ‚ç‚¹åœ°å€
```

### Clusteré›†ç¾¤

```bash
# åˆ›å»ºé›†ç¾¤
redis-cli --cluster create \
  127.0.0.1:7000 127.0.0.1:7001 \
  127.0.0.1:7002 127.0.0.1:7003 \
  127.0.0.1:7004 127.0.0.1:7005 \
  --cluster-replicas 1

# ç‰¹ç‚¹
# 1. æ•°æ®åˆ†ç‰‡ï¼š16384ä¸ªæ§½ä½
# 2. é«˜å¯ç”¨ï¼šä¸»ä»è‡ªåŠ¨åˆ‡æ¢
# 3. æ°´å¹³æ‰©å±•ï¼šåŠ¨æ€æ·»åŠ èŠ‚ç‚¹

# æ§½ä½åˆ†é…
# CRC16(key) % 16384

# é‡å®šå‘
# MOVEDï¼šæ§½ä½å·²è¿ç§»
# ASKï¼šæ§½ä½æ­£åœ¨è¿ç§»
```

## æ€§èƒ½ä¼˜åŒ–

```javascript
const optimizationTips = {
  // 1. ä½¿ç”¨Pipeline
  pipeline: async () => {
    const pipeline = redis.pipeline();
    for (let i = 0; i < 1000; i++) {
      pipeline.set(`key:${i}`, `value:${i}`);
    }
    await pipeline.exec();
  },
  
  // 2. ä½¿ç”¨æ‰¹é‡æ“ä½œ
  batch: async () => {
    await redis.mset('key1', 'value1', 'key2', 'value2');
    const values = await redis.mget('key1', 'key2');
  },
  
  // 3. é¿å…å¤§key
  avoidBigKey: {
    problem: 'String > 10KB, List/Set/Hash > 5000å…ƒç´ ',
    solution: 'æ‹†åˆ†æˆå¤šä¸ªå°key'
  },
  
  // 4. è®¾ç½®è¿‡æœŸæ—¶é—´
  expiration: async () => {
    await redis.setex('key', 3600, 'value');
  },
  
  // 5. ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„
  dataStructure: {
    counter: 'String + INCR',
    ranking: 'Sorted Set',
    uniqueCount: 'HyperLogLog',
    bitmap: 'Bitmap'
  }
};
```

## æ€»ç»“

Redisæ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼š
- ğŸ“¦ **æ•°æ®ç»“æ„**ï¼šStringã€Hashã€Listã€Setã€Sorted Set
- ğŸ’¾ **æŒä¹…åŒ–**ï¼šRDBå¿«ç…§ + AOFæ—¥å¿—
- ğŸ”„ **ç¼“å­˜ç­–ç•¥**ï¼šCache-Asideã€Read/Write-Through
- âš ï¸ **ç¼“å­˜é—®é¢˜**ï¼šç©¿é€ã€å‡»ç©¿ã€é›ªå´©
- ğŸ”’ **åˆ†å¸ƒå¼é”**ï¼šSET NX EX + Luaè„šæœ¬
- ğŸŒ **é›†ç¾¤æ–¹æ¡ˆ**ï¼šä¸»ä»å¤åˆ¶ã€å“¨å…µã€Cluster

è®°ä½ï¼š**Redisæ˜¯é«˜æ€§èƒ½ç¼“å­˜çš„é¦–é€‰æ–¹æ¡ˆï¼**

