---
sidebar_position: 13
title: JavaScript
tags: [JavaScript, , , , Event Loop]
---

# JavaScript

## 

JavaScriptJavaScript

## Closure

### 1. 



```javascript
// 
function createCounter() {
  let count = 0;
  
  return {
    increment() {
      return ++count;
    },
    decrement() {
      return --count;
    },
    getCount() {
      return count;
    }
  };
}

const counter = createCounter();
console.log(counter.increment()); // 1
console.log(counter.increment()); // 2
console.log(counter.getCount());  // 2
// count 

// 
for (var i = 0; i < 5; i++) {
  setTimeout(function() {
    console.log(i); //  5 5 5 5 5
  }, 100);
}

// 1 let
for (let i = 0; i < 5; i++) {
  setTimeout(function() {
    console.log(i); //  0 1 2 3 4
  }, 100);
}

// 2
for (var i = 0; i < 5; i++) {
  (function(j) {
    setTimeout(function() {
      console.log(j); //  0 1 2 3 4
    }, 100);
  })(i);
}
```

### 2. 

```javascript
// 
function createPerson(name) {
  let _age = 0; // 
  
  return {
    getName() {
      return name;
    },
    getAge() {
      return _age;
    },
    setAge(age) {
      if (age >= 0 && age <= 150) {
        _age = age;
      }
    }
  };
}

const person = createPerson('John');
person.setAge(30);
console.log(person.getAge()); // 30
// console.log(person._age); // undefined

// 
function curry(fn) {
  return function curried(...args) {
    if (args.length >= fn.length) {
      return fn.apply(this, args);
    } else {
      return function(...nextArgs) {
        return curried.apply(this, args.concat(nextArgs));
      };
    }
  };
}

function add(a, b, c) {
  return a + b + c;
}

const curriedAdd = curry(add);
console.log(curriedAdd(1)(2)(3)); // 6
console.log(curriedAdd(1, 2)(3)); // 6
console.log(curriedAdd(1)(2, 3)); // 6

// 
function partial(fn, ...presetArgs) {
  return function(...laterArgs) {
    return fn(...presetArgs, ...laterArgs);
  };
}

function multiply(a, b, c) {
  return a * b * c;
}

const double = partial(multiply, 2);
console.log(double(3, 4)); // 24

// Memoization
function memoize(fn) {
  const cache = new Map();
  
  return function(...args) {
    const key = JSON.stringify(args);
    
    if (cache.has(key)) {
      console.log('');
      return cache.get(key);
    }
    
    const result = fn.apply(this, args);
    cache.set(key, result);
    return result;
  };
}

function fibonacci(n) {
  if (n <= 1) return n;
  return fibonacci(n - 1) + fibonacci(n - 2);
}

const memoizedFib = memoize(fibonacci);
console.log(memoizedFib(40)); // 
console.log(memoizedFib(40)); // 

// Debounce
function debounce(fn, delay) {
  let timeoutId;
  
  return function(...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      fn.apply(this, args);
    }, delay);
  };
}

// 
const handleSearch = debounce((query) => {
  console.log(':', query);
}, 300);

// Throttle
function throttle(fn, delay) {
  let lastTime = 0;
  
  return function(...args) {
    const now = Date.now();
    
    if (now - lastTime >= delay) {
      fn.apply(this, args);
      lastTime = now;
    }
  };
}

// 
const handleScroll = throttle(() => {
  console.log(':', window.scrollY);
}, 200);
```

## 

### 1. 

```javascript
// 
function Person(name) {
  this.name = name;
}

Person.prototype.sayHello = function() {
  console.log(`Hello, I'm ${this.name}`);
};

const person1 = new Person('Alice');
const person2 = new Person('Bob');

person1.sayHello(); // Hello, I'm Alice
person2.sayHello(); // Hello, I'm Bob

// 
console.log(person1.__proto__ === Person.prototype); // true
console.log(Person.prototype.__proto__ === Object.prototype); // true
console.log(Object.prototype.__proto__ === null); // true

// 
console.log(person1 instanceof Person); // true
console.log(Person.prototype.isPrototypeOf(person1)); // true
console.log(Object.getPrototypeOf(person1) === Person.prototype); // true

// 
function Student(name, grade) {
  Person.call(this, name);
  this.grade = grade;
}

// 
Student.prototype = Object.create(Person.prototype);
Student.prototype.constructor = Student;

Student.prototype.study = function() {
  console.log(`${this.name} is studying in grade ${this.grade}`);
};

const student = new Student('Charlie', 10);
student.sayHello(); // Hello, I'm Charlie
student.study();    // Charlie is studying in grade 10
```

### 2. 

```javascript
// ES6 
class Animal {
  constructor(name) {
    this.name = name;
  }
  
  speak() {
    console.log(`${this.name} makes a sound`);
  }
  
  // 
  static create(name) {
    return new Animal(name);
  }
  
  // Getter
  get displayName() {
    return this.name.toUpperCase();
  }
  
  // Setter
  set displayName(name) {
    this.name = name;
  }
}

// 
class Dog extends Animal {
  constructor(name, breed) {
    super(name);
    this.breed = breed;
  }
  
  speak() {
    console.log(`${this.name} barks`);
  }
  
  fetch() {
    console.log(`${this.name} fetches the ball`);
  }
}

const dog = new Dog('Max', 'Golden Retriever');
dog.speak(); // Max barks
dog.fetch(); // Max fetches the ball

// ES2022
class BankAccount {
  #balance = 0; // 
  
  constructor(initialBalance) {
    this.#balance = initialBalance;
  }
  
  deposit(amount) {
    if (amount > 0) {
      this.#balance += amount;
    }
  }
  
  withdraw(amount) {
    if (amount > 0 && amount <= this.#balance) {
      this.#balance -= amount;
      return amount;
    }
    return 0;
  }
  
  getBalance() {
    return this.#balance;
  }
}

const account = new BankAccount(1000);
account.deposit(500);
console.log(account.getBalance()); // 1500
// console.log(account.#balance); // SyntaxError

// Mixin 
const canEat = {
  eat(food) {
    console.log(`${this.name} is eating ${food}`);
  }
};

const canWalk = {
  walk() {
    console.log(`${this.name} is walking`);
  }
};

const canSwim = {
  swim() {
    console.log(`${this.name} is swimming`);
  }
};

class Duck {
  constructor(name) {
    this.name = name;
  }
}

// 
Object.assign(Duck.prototype, canEat, canWalk, canSwim);

const duck = new Duck('Donald');
duck.eat('bread');
duck.walk();
duck.swim();
```

## this 

### 1. this 

```javascript
// 1. 
function foo() {
  console.log(this); // : undefined, : window
}
foo();

// 2. 
const obj = {
  name: 'Object',
  sayName() {
    console.log(this.name);
  }
};
obj.sayName(); // Object

// 
const sayName = obj.sayName;
sayName(); // undefined ()

// 3. 
function greet(greeting) {
  console.log(`${greeting}, ${this.name}`);
}

const person = { name: 'John' };
greet.call(person, 'Hello');    // Hello, John
greet.apply(person, ['Hi']);    // Hi, John

const boundGreet = greet.bind(person, 'Hey');
boundGreet(); // Hey, John

// 4. new 
function Person(name) {
  this.name = name;
}

const p = new Person('Alice');
console.log(p.name); // Alice

//  this
const obj2 = {
  name: 'Object2',
  regularFunc() {
    console.log(this.name); // Object2
  },
  arrowFunc: () => {
    console.log(this.name); // undefined ()
  },
  nested() {
    const arrow = () => {
      console.log(this.name); // Object2 ( nested  this)
    };
    arrow();
  }
};

obj2.regularFunc();
obj2.arrowFunc();
obj2.nested();
```

### 2.  callapplybind

```javascript
//  call
Function.prototype.myCall = function(context, ...args) {
  context = context || window;
  const fnSymbol = Symbol();
  context[fnSymbol] = this;
  const result = context[fnSymbol](...args);
  delete context[fnSymbol];
  return result;
};

//  apply
Function.prototype.myApply = function(context, args) {
  context = context || window;
  const fnSymbol = Symbol();
  context[fnSymbol] = this;
  const result = context[fnSymbol](...args);
  delete context[fnSymbol];
  return result;
};

//  bind
Function.prototype.myBind = function(context, ...args) {
  const fn = this;
  return function(...newArgs) {
    return fn.apply(context, [...args, ...newArgs]);
  };
};

// 
function greet(greeting, punctuation) {
  console.log(`${greeting}, ${this.name}${punctuation}`);
}

const person = { name: 'John' };

greet.myCall(person, 'Hello', '!');
greet.myApply(person, ['Hi', '?']);
const boundGreet = greet.myBind(person, 'Hey');
boundGreet('!!!');
```

## Event Loop

### 1. 

```javascript
// 
console.log('1'); // 

setTimeout(() => {
  console.log('2'); // 
}, 0);

Promise.resolve().then(() => {
  console.log('3'); // 
});

console.log('4'); // 

// : 1 4 3 2

// 
console.log('start');

setTimeout(() => {
  console.log('setTimeout 1');
  Promise.resolve().then(() => {
    console.log('promise 1');
  });
}, 0);

Promise.resolve().then(() => {
  console.log('promise 2');
  setTimeout(() => {
    console.log('setTimeout 2');
  }, 0);
});

console.log('end');

// :
// start
// end
// promise 2
// setTimeout 1
// promise 1
// setTimeout 2
```

### 2. 

```javascript
// Promise
function fetchData(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (url) {
        resolve({ data: 'success' });
      } else {
        reject(new Error('URL is required'));
      }
    }, 1000);
  });
}

fetchData('/api/users')
  .then(result => console.log(result))
  .catch(error => console.error(error));

// async/await
async function getData() {
  try {
    const result = await fetchData('/api/users');
    console.log(result);
  } catch (error) {
    console.error(error);
  }
}

// 
async function fetchMultiple() {
  const [users, posts, comments] = await Promise.all([
    fetchData('/api/users'),
    fetchData('/api/posts'),
    fetchData('/api/comments')
  ]);
  
  return { users, posts, comments };
}

// 
async function fetchSequential() {
  const users = await fetchData('/api/users');
  const posts = await fetchData('/api/posts');
  const comments = await fetchData('/api/comments');
  
  return { users, posts, comments };
}

// Promise 
class PromiseUtils {
  // 
  static delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  // 
  static timeout(promise, ms) {
    return Promise.race([
      promise,
      new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout')), ms)
      )
    ]);
  }
  
  // 
  static async retry(fn, maxRetries = 3, delay = 1000) {
    for (let i = 0; i < maxRetries; i++) {
      try {
        return await fn();
      } catch (error) {
        if (i === maxRetries - 1) throw error;
        await this.delay(delay * (i + 1));
      }
    }
  }
  
  // 
  static async limit(tasks, concurrency) {
    const results = [];
    const executing = [];
    
    for (const task of tasks) {
      const p = Promise.resolve().then(() => task());
      results.push(p);
      
      if (concurrency <= tasks.length) {
        const e = p.then(() => executing.splice(executing.indexOf(e), 1));
        executing.push(e);
        
        if (executing.length >= concurrency) {
          await Promise.race(executing);
        }
      }
    }
    
    return Promise.all(results);
  }
}

// 
await PromiseUtils.delay(1000);

const result = await PromiseUtils.timeout(
  fetchData('/api/users'),
  5000
);

const data = await PromiseUtils.retry(
  () => fetchData('/api/users'),
  3,
  1000
);
```

## 

### 1. ES6 

```javascript
// math.js
export function add(a, b) {
  return a + b;
}

export function subtract(a, b) {
  return a - b;
}

export const PI = 3.14159;

export default class Calculator {
  add(a, b) {
    return a + b;
  }
}

// main.js
import Calculator, { add, subtract, PI } from './math.js';
import * as math from './math.js';

console.log(add(1, 2));
console.log(math.PI);

const calc = new Calculator();
console.log(calc.add(3, 4));

// 
async function loadModule() {
  const module = await import('./math.js');
  console.log(module.add(5, 6));
}
```

### 2. CommonJS 

```javascript
// math.js
function add(a, b) {
  return a + b;
}

function subtract(a, b) {
  return a - b;
}

module.exports = {
  add,
  subtract,
  PI: 3.14159
};

// main.js
const math = require('./math');
console.log(math.add(1, 2));
console.log(math.PI);
```

## 

### 1. 

```javascript
// 
function optimized() {
  const doc = document; // 
  const element = doc.getElementById('myElement');
}

// 
document.getElementById('parent').addEventListener('click', (e) => {
  if (e.target.matches('.child')) {
    console.log('Child clicked');
  }
});

//  DocumentFragment
function addMultipleElements(items) {
  const fragment = document.createDocumentFragment();
  
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    fragment.appendChild(li);
  });
  
  document.getElementById('list').appendChild(fragment);
}

//  requestAnimationFrame
function animate() {
  // 
  requestAnimationFrame(animate);
}

//  Web Workers
const worker = new Worker('worker.js');
worker.postMessage({ data: 'heavy computation' });
worker.onmessage = (e) => {
  console.log('Result:', e.data);
};
```

### 2. 

```javascript
// 
class Component {
  constructor() {
    this.listeners = [];
  }
  
  addEventListener(element, event, handler) {
    element.addEventListener(event, handler);
    this.listeners.push({ element, event, handler });
  }
  
  destroy() {
    // 
    this.listeners.forEach(({ element, event, handler }) => {
      element.removeEventListener(event, handler);
    });
    this.listeners = [];
  }
}

//  WeakMap 
const cache = new WeakMap();

function process(obj) {
  if (cache.has(obj)) {
    return cache.get(obj);
  }
  
  const result = heavyComputation(obj);
  cache.set(obj, result);
  return result;
}
```

## 

JavaScript

1. ****thisEvent Loop
2. ****Promiseasync/await
3. ****ES6 CommonJS
4. ****

## 

- [You Don't Know JS](https://github.com/getify/You-Dont-Know-JS)
- [JavaScript](https://www.ituring.com.cn/book/2472)
- [ES6](https://www.ituring.com.cn/book/1986)

