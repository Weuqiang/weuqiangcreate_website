---
sidebar_position: 2
title: Reactæ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—
tags: [å‰ç«¯, React, æ€§èƒ½ä¼˜åŒ–, Hooks, è™šæ‹ŸDOM]
---

# Reactæ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—

æœ¬æ–‡å°†æ·±å…¥è®²è§£Reactæ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•å’ŒæŠ€å·§ï¼Œä»åŸç†åˆ°å®æˆ˜å…¨é¢è¦†ç›–ã€‚

## æ€§èƒ½åˆ†æå·¥å…·

### React DevTools Profiler

```javascript
// ä½¿ç”¨Profilerç»„ä»¶
import { Profiler } from 'react';

function App() {
  const onRenderCallback = (
    id,                   // ç»„ä»¶æ ‡è¯†
    phase,                // "mount" æˆ– "update"
    actualDuration,       // æœ¬æ¬¡æ¸²æŸ“è€—æ—¶
    baseDuration,         // ä¼°è®¡ä¸ä½¿ç”¨memoizationçš„æ¸²æŸ“è€—æ—¶
    startTime,            // å¼€å§‹æ¸²æŸ“æ—¶é—´
    commitTime,           // æäº¤æ¸²æŸ“æ—¶é—´
    interactions          // æœ¬æ¬¡æ›´æ–°çš„interactionsé›†åˆ
  ) => {
    console.log(`${id} ${phase} phase:`);
    console.log(`Actual duration: ${actualDuration}ms`);
    console.log(`Base duration: ${baseDuration}ms`);
  };
  
  return (
    <Profiler id="App" onRender={onRenderCallback}>
      <div>
        <Header />
        <Main />
        <Footer />
      </div>
    </Profiler>
  );
}
```

### Chrome Performance

```javascript
// æ€§èƒ½æ ‡è®°
function expensiveOperation() {
  performance.mark('expensive-start');
  
  // æ‰§è¡Œè€—æ—¶æ“ä½œ
  for (let i = 0; i < 1000000; i++) {
    // ...
  }
  
  performance.mark('expensive-end');
  performance.measure('expensive', 'expensive-start', 'expensive-end');
  
  const measure = performance.getEntriesByName('expensive')[0];
  console.log(`è€—æ—¶: ${measure.duration}ms`);
}
```

## ç»„ä»¶ä¼˜åŒ–

### React.memo

```javascript
// âŒ æ¯æ¬¡çˆ¶ç»„ä»¶æ›´æ–°éƒ½ä¼šé‡æ–°æ¸²æŸ“
function Child({ name }) {
  console.log('Child render');
  return <div>{name}</div>;
}

// âœ… ä½¿ç”¨React.memoï¼Œpropsä¸å˜æ—¶ä¸é‡æ–°æ¸²æŸ“
const Child = React.memo(function Child({ name }) {
  console.log('Child render');
  return <div>{name}</div>;
});

// è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°
const Child = React.memo(
  function Child({ user }) {
    return <div>{user.name}</div>;
  },
  (prevProps, nextProps) => {
    // è¿”å›trueè¡¨ç¤ºä¸éœ€è¦é‡æ–°æ¸²æŸ“
    return prevProps.user.id === nextProps.user.id;
  }
);

// ä½¿ç”¨ç¤ºä¾‹
function Parent() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState('John');
  
  return (
    <div>
      <button onClick={() => setCount(count + 1)}>
        Count: {count}
      </button>
      <Child name={name} />
      {/* countå˜åŒ–æ—¶ï¼ŒChildä¸ä¼šé‡æ–°æ¸²æŸ“ */}
    </div>
  );
}
```

### useMemo

```javascript
// âŒ æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šé‡æ–°è®¡ç®—
function Component({ items }) {
  const expensiveValue = computeExpensiveValue(items);
  return <div>{expensiveValue}</div>;
}

// âœ… ä½¿ç”¨useMemoï¼Œåªåœ¨itemså˜åŒ–æ—¶é‡æ–°è®¡ç®—
function Component({ items }) {
  const expensiveValue = useMemo(() => {
    console.log('è®¡ç®—expensiveValue');
    return computeExpensiveValue(items);
  }, [items]);
  
  return <div>{expensiveValue}</div>;
}

// å®æˆ˜ç¤ºä¾‹ï¼šè¿‡æ»¤å’Œæ’åº
function TodoList({ todos, filter, sortBy }) {
  const filteredAndSortedTodos = useMemo(() => {
    console.log('è¿‡æ»¤å’Œæ’åº');
    
    let result = todos;
    
    // è¿‡æ»¤
    if (filter) {
      result = result.filter(todo => 
        todo.title.includes(filter)
      );
    }
    
    // æ’åº
    if (sortBy === 'date') {
      result = result.sort((a, b) => 
        new Date(b.createdAt) - new Date(a.createdAt)
      );
    } else if (sortBy === 'priority') {
      result = result.sort((a, b) => 
        b.priority - a.priority
      );
    }
    
    return result;
  }, [todos, filter, sortBy]);
  
  return (
    <ul>
      {filteredAndSortedTodos.map(todo => (
        <li key={todo.id}>{todo.title}</li>
      ))}
    </ul>
  );
}
```

### useCallback

```javascript
// âŒ æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šåˆ›å»ºæ–°å‡½æ•°
function Parent() {
  const [count, setCount] = useState(0);
  
  const handleClick = () => {
    console.log('clicked');
  };
  
  return (
    <div>
      <button onClick={() => setCount(count + 1)}>
        Count: {count}
      </button>
      <Child onClick={handleClick} />
      {/* handleClickæ¯æ¬¡éƒ½æ˜¯æ–°å‡½æ•°ï¼ŒChildä¼šé‡æ–°æ¸²æŸ“ */}
    </div>
  );
}

// âœ… ä½¿ç”¨useCallbackï¼Œå‡½æ•°å¼•ç”¨ä¿æŒä¸å˜
function Parent() {
  const [count, setCount] = useState(0);
  
  const handleClick = useCallback(() => {
    console.log('clicked');
  }, []); // ä¾èµ–ä¸ºç©ºï¼Œå‡½æ•°æ°¸è¿œä¸å˜
  
  return (
    <div>
      <button onClick={() => setCount(count + 1)}>
        Count: {count}
      </button>
      <Child onClick={handleClick} />
      {/* handleClickå¼•ç”¨ä¸å˜ï¼ŒChildä¸ä¼šé‡æ–°æ¸²æŸ“ */}
    </div>
  );
}

// å¸¦ä¾èµ–çš„useCallback
function SearchBox({ onSearch }) {
  const [query, setQuery] = useState('');
  
  const handleSearch = useCallback(() => {
    onSearch(query);
  }, [query, onSearch]); // queryæˆ–onSearchå˜åŒ–æ—¶ï¼Œå‡½æ•°æ‰æ›´æ–°
  
  return (
    <div>
      <input 
        value={query} 
        onChange={e => setQuery(e.target.value)} 
      />
      <button onClick={handleSearch}>Search</button>
    </div>
  );
}
```

## åˆ—è¡¨ä¼˜åŒ–

### è™šæ‹Ÿåˆ—è¡¨

```javascript
import { useState, useRef, useEffect } from 'react';

function VirtualList({ items, itemHeight, containerHeight }) {
  const [scrollTop, setScrollTop] = useState(0);
  const containerRef = useRef(null);
  
  // è®¡ç®—å¯è§èŒƒå›´
  const visibleCount = Math.ceil(containerHeight / itemHeight);
  const startIndex = Math.floor(scrollTop / itemHeight);
  const endIndex = Math.min(startIndex + visibleCount + 1, items.length);
  
  // å¯è§é¡¹
  const visibleItems = items.slice(startIndex, endIndex);
  
  // æ€»é«˜åº¦
  const totalHeight = items.length * itemHeight;
  
  // åç§»é‡
  const offsetY = startIndex * itemHeight;
  
  const handleScroll = (e) => {
    setScrollTop(e.target.scrollTop);
  };
  
  return (
    <div
      ref={containerRef}
      style={{
        height: containerHeight,
        overflow: 'auto'
      }}
      onScroll={handleScroll}
    >
      <div style={{ height: totalHeight, position: 'relative' }}>
        <div style={{ transform: `translateY(${offsetY}px)` }}>
          {visibleItems.map((item, index) => (
            <div
              key={startIndex + index}
              style={{ height: itemHeight }}
            >
              {item.content}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// ä½¿ç”¨ç¤ºä¾‹
function App() {
  const items = Array.from({ length: 10000 }, (_, i) => ({
    id: i,
    content: `Item ${i}`
  }));
  
  return (
    <VirtualList
      items={items}
      itemHeight={50}
      containerHeight={600}
    />
  );
}
```

### keyä¼˜åŒ–

```javascript
// âŒ ä½¿ç”¨ç´¢å¼•ä½œä¸ºkey
function BadList({ items }) {
  return (
    <ul>
      {items.map((item, index) => (
        <li key={index}>{item.name}</li>
      ))}
    </ul>
  );
}

// âœ… ä½¿ç”¨å”¯ä¸€IDä½œä¸ºkey
function GoodList({ items }) {
  return (
    <ul>
      {items.map(item => (
        <li key={item.id}>{item.name}</li>
      ))}
    </ul>
  );
}

// keyçš„é‡è¦æ€§
const items1 = [
  { id: 1, name: 'A' },
  { id: 2, name: 'B' },
  { id: 3, name: 'C' }
];

const items2 = [
  { id: 1, name: 'A' },
  { id: 4, name: 'D' }, // æ–°æ’å…¥
  { id: 2, name: 'B' },
  { id: 3, name: 'C' }
];

// ä½¿ç”¨indexä½œä¸ºkeyï¼šReactä¼šè®¤ä¸ºæ‰€æœ‰é¡¹éƒ½å˜äº†
// ä½¿ç”¨idä½œä¸ºkeyï¼šReactåªä¼šæ’å…¥æ–°é¡¹
```

## çŠ¶æ€ç®¡ç†ä¼˜åŒ–

### çŠ¶æ€æ‹†åˆ†

```javascript
// âŒ æ‰€æœ‰çŠ¶æ€æ”¾åœ¨ä¸€èµ·
function BadComponent() {
  const [state, setState] = useState({
    user: { name: 'John', age: 30 },
    posts: [],
    comments: [],
    loading: false
  });
  
  // æ›´æ–°userä¼šå¯¼è‡´æ•´ä¸ªç»„ä»¶é‡æ–°æ¸²æŸ“
  const updateUser = (name) => {
    setState(prev => ({
      ...prev,
      user: { ...prev.user, name }
    }));
  };
  
  return <div>...</div>;
}

// âœ… çŠ¶æ€æ‹†åˆ†
function GoodComponent() {
  const [user, setUser] = useState({ name: 'John', age: 30 });
  const [posts, setPosts] = useState([]);
  const [comments, setComments] = useState([]);
  const [loading, setLoading] = useState(false);
  
  // åªæ›´æ–°userï¼Œä¸å½±å“å…¶ä»–çŠ¶æ€
  const updateUser = (name) => {
    setUser(prev => ({ ...prev, name }));
  };
  
  return <div>...</div>;
}
```

### Contextä¼˜åŒ–

```javascript
// âŒ å•ä¸€Contextï¼Œæ‰€æœ‰æ¶ˆè´¹è€…éƒ½ä¼šé‡æ–°æ¸²æŸ“
const AppContext = createContext();

function AppProvider({ children }) {
  const [user, setUser] = useState(null);
  const [theme, setTheme] = useState('light');
  const [language, setLanguage] = useState('en');
  
  return (
    <AppContext.Provider value={{ user, setUser, theme, setTheme, language, setLanguage }}>
      {children}
    </AppContext.Provider>
  );
}

// âœ… æ‹†åˆ†Context
const UserContext = createContext();
const ThemeContext = createContext();
const LanguageContext = createContext();

function AppProvider({ children }) {
  const [user, setUser] = useState(null);
  const [theme, setTheme] = useState('light');
  const [language, setLanguage] = useState('en');
  
  return (
    <UserContext.Provider value={{ user, setUser }}>
      <ThemeContext.Provider value={{ theme, setTheme }}>
        <LanguageContext.Provider value={{ language, setLanguage }}>
          {children}
        </LanguageContext.Provider>
      </ThemeContext.Provider>
    </UserContext.Provider>
  );
}

// ä½¿ç”¨useMemoä¼˜åŒ–Context value
function UserProvider({ children }) {
  const [user, setUser] = useState(null);
  
  const value = useMemo(() => ({ user, setUser }), [user]);
  
  return (
    <UserContext.Provider value={value}>
      {children}
    </UserContext.Provider>
  );
}
```

## æ‡’åŠ è½½

### React.lazy

```javascript
import { lazy, Suspense } from 'react';

// æ‡’åŠ è½½ç»„ä»¶
const Dashboard = lazy(() => import('./Dashboard'));
const Profile = lazy(() => import('./Profile'));
const Settings = lazy(() => import('./Settings'));

function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <Routes>
        <Route path="/dashboard" element={<Dashboard />} />
        <Route path="/profile" element={<Profile />} />
        <Route path="/settings" element={<Settings />} />
      </Routes>
    </Suspense>
  );
}

// é¢„åŠ è½½
const Dashboard = lazy(() => import('./Dashboard'));

function App() {
  const preloadDashboard = () => {
    // é¼ æ ‡æ‚¬åœæ—¶é¢„åŠ è½½
    import('./Dashboard');
  };
  
  return (
    <nav>
      <Link 
        to="/dashboard" 
        onMouseEnter={preloadDashboard}
      >
        Dashboard
      </Link>
    </nav>
  );
}
```

### å›¾ç‰‡æ‡’åŠ è½½

```javascript
function LazyImage({ src, alt, placeholder }) {
  const [imageSrc, setImageSrc] = useState(placeholder);
  const [isLoaded, setIsLoaded] = useState(false);
  const imgRef = useRef(null);
  
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            setImageSrc(src);
            observer.disconnect();
          }
        });
      },
      { threshold: 0.1 }
    );
    
    if (imgRef.current) {
      observer.observe(imgRef.current);
    }
    
    return () => observer.disconnect();
  }, [src]);
  
  return (
    <img
      ref={imgRef}
      src={imageSrc}
      alt={alt}
      onLoad={() => setIsLoaded(true)}
      style={{
        opacity: isLoaded ? 1 : 0,
        transition: 'opacity 0.3s'
      }}
    />
  );
}
```

## äº‹ä»¶å¤„ç†ä¼˜åŒ–

### é˜²æŠ–å’ŒèŠ‚æµ

```javascript
import { useCallback, useRef } from 'react';

// é˜²æŠ–Hook
function useDebounce(callback, delay) {
  const timeoutRef = useRef(null);
  
  return useCallback((...args) => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
    
    timeoutRef.current = setTimeout(() => {
      callback(...args);
    }, delay);
  }, [callback, delay]);
}

// èŠ‚æµHook
function useThrottle(callback, delay) {
  const lastRunRef = useRef(Date.now());
  
  return useCallback((...args) => {
    const now = Date.now();
    
    if (now - lastRunRef.current >= delay) {
      callback(...args);
      lastRunRef.current = now;
    }
  }, [callback, delay]);
}

// ä½¿ç”¨ç¤ºä¾‹
function SearchBox() {
  const [query, setQuery] = useState('');
  
  const handleSearch = useCallback((value) => {
    console.log('æœç´¢:', value);
    // è°ƒç”¨API
  }, []);
  
  const debouncedSearch = useDebounce(handleSearch, 500);
  
  const handleChange = (e) => {
    const value = e.target.value;
    setQuery(value);
    debouncedSearch(value);
  };
  
  return (
    <input
      value={query}
      onChange={handleChange}
      placeholder="æœç´¢..."
    />
  );
}

// æ»šåŠ¨èŠ‚æµ
function ScrollComponent() {
  const handleScroll = useCallback(() => {
    console.log('æ»šåŠ¨ä½ç½®:', window.scrollY);
  }, []);
  
  const throttledScroll = useThrottle(handleScroll, 200);
  
  useEffect(() => {
    window.addEventListener('scroll', throttledScroll);
    return () => window.removeEventListener('scroll', throttledScroll);
  }, [throttledScroll]);
  
  return <div>...</div>;
}
```

## æ¸²æŸ“ä¼˜åŒ–

### æ¡ä»¶æ¸²æŸ“

```javascript
// âŒ ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦ï¼Œä¸¤ä¸ªåˆ†æ”¯éƒ½ä¼šåˆ›å»º
function Component({ isLoading, data }) {
  return (
    <div>
      {isLoading ? <Loading /> : <DataView data={data} />}
    </div>
  );
}

// âœ… ä½¿ç”¨&&è¿ç®—ç¬¦ï¼Œåªåˆ›å»ºéœ€è¦çš„åˆ†æ”¯
function Component({ isLoading, data }) {
  return (
    <div>
      {isLoading && <Loading />}
      {!isLoading && <DataView data={data} />}
    </div>
  );
}

// âœ… æå‰è¿”å›
function Component({ isLoading, data }) {
  if (isLoading) {
    return <Loading />;
  }
  
  return <DataView data={data} />;
}
```

### Fragmentä¼˜åŒ–

```javascript
// âŒ é¢å¤–çš„divåŒ…è£¹
function Component() {
  return (
    <div>
      <Header />
      <Main />
      <Footer />
    </div>
  );
}

// âœ… ä½¿ç”¨Fragment
function Component() {
  return (
    <>
      <Header />
      <Main />
      <Footer />
    </>
  );
}

// å¸¦keyçš„Fragment
function List({ items }) {
  return (
    <>
      {items.map(item => (
        <Fragment key={item.id}>
          <dt>{item.term}</dt>
          <dd>{item.description}</dd>
        </Fragment>
      ))}
    </>
  );
}
```

## å¹¶å‘ç‰¹æ€§

### useTransition

```javascript
import { useState, useTransition } from 'react';

function SearchResults() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  const [isPending, startTransition] = useTransition();
  
  const handleChange = (e) => {
    const value = e.target.value;
    setQuery(value);
    
    // æ ‡è®°ä¸ºä½ä¼˜å…ˆçº§æ›´æ–°
    startTransition(() => {
      const filtered = largeDataset.filter(item =>
        item.name.includes(value)
      );
      setResults(filtered);
    });
  };
  
  return (
    <div>
      <input value={query} onChange={handleChange} />
      {isPending && <div>æœç´¢ä¸­...</div>}
      <ul>
        {results.map(item => (
          <li key={item.id}>{item.name}</li>
        ))}
      </ul>
    </div>
  );
}
```

### useDeferredValue

```javascript
import { useState, useDeferredValue, useMemo } from 'react';

function SearchResults() {
  const [query, setQuery] = useState('');
  const deferredQuery = useDeferredValue(query);
  
  const results = useMemo(() => {
    return largeDataset.filter(item =>
      item.name.includes(deferredQuery)
    );
  }, [deferredQuery]);
  
  return (
    <div>
      <input 
        value={query} 
        onChange={e => setQuery(e.target.value)} 
      />
      <ul>
        {results.map(item => (
          <li key={item.id}>{item.name}</li>
        ))}
      </ul>
    </div>
  );
}
```

## æ€§èƒ½ç›‘æ§

```javascript
// è‡ªå®šä¹‰æ€§èƒ½ç›‘æ§Hook
function usePerformance(componentName) {
  useEffect(() => {
    const startTime = performance.now();
    
    return () => {
      const endTime = performance.now();
      const duration = endTime - startTime;
      
      console.log(`${componentName} æ¸²æŸ“è€—æ—¶: ${duration}ms`);
      
      // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ
      reportPerformance({
        component: componentName,
        duration,
        timestamp: Date.now()
      });
    };
  });
}

// ä½¿ç”¨
function ExpensiveComponent() {
  usePerformance('ExpensiveComponent');
  
  return <div>...</div>;
}
```

## æ€»ç»“

Reactæ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒï¼š
- ğŸ¯ **é¿å…ä¸å¿…è¦çš„æ¸²æŸ“**ï¼šReact.memoã€useMemoã€useCallback
- ğŸ“¦ **ä¼˜åŒ–åˆ—è¡¨æ¸²æŸ“**ï¼šè™šæ‹Ÿåˆ—è¡¨ã€æ­£ç¡®çš„key
- ğŸ”„ **çŠ¶æ€ç®¡ç†**ï¼šçŠ¶æ€æ‹†åˆ†ã€Contextä¼˜åŒ–
- ğŸš€ **æ‡’åŠ è½½**ï¼šä»£ç åˆ†å‰²ã€å›¾ç‰‡æ‡’åŠ è½½
- âš¡ **äº‹ä»¶ä¼˜åŒ–**ï¼šé˜²æŠ–ã€èŠ‚æµ
- ğŸ¨ **å¹¶å‘ç‰¹æ€§**ï¼šuseTransitionã€useDeferredValue

è®°ä½ï¼š**æ€§èƒ½ä¼˜åŒ–è¦åŸºäºå®é™…æµ‹é‡ï¼Œä¸è¦è¿‡æ—©ä¼˜åŒ–ï¼**

