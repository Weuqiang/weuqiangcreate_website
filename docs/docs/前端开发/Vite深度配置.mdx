---
sidebar_position: 5
title: Viteæ·±åº¦é…ç½®ä¸ä¼˜åŒ–
tags: [Vite, å‰ç«¯å·¥ç¨‹åŒ–, æ„å»ºå·¥å…·]
---

# Viteæ·±åº¦é…ç½®ä¸ä¼˜åŒ–

Viteæ˜¯æ–°ä¸€ä»£å‰ç«¯æ„å»ºå·¥å…·ï¼ŒåŸºäºESæ¨¡å—æä¾›æé€Ÿçš„å¼€å‘ä½“éªŒã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Viteçš„é…ç½®å’Œä¼˜åŒ–æŠ€å·§ã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹©Viteï¼Ÿ

### ä¼˜åŠ¿å¯¹æ¯”

```mermaid
graph LR
    A[ä¼ ç»Ÿæ„å»ºå·¥å…·] --> B[æ‰“åŒ…æ‰€æœ‰ä»£ç ]
    B --> C[å¯åŠ¨æ…¢]
    
    D[Vite] --> E[æŒ‰éœ€ç¼–è¯‘]
    E --> F[ç§’çº§å¯åŠ¨]
    
    style D fill:#42b883
    style F fill:#42b883
```

**Vite vs Webpack**:
- âš¡ **å¼€å‘å¯åŠ¨**: Viteç§’çº§ vs Webpackåˆ†é’Ÿçº§
- ğŸ”¥ **çƒ­æ›´æ–°**: Viteæ¯«ç§’çº§ vs Webpackç§’çº§
- ğŸ“¦ **ç”Ÿäº§æ„å»º**: éƒ½ä½¿ç”¨Rollupï¼Œæ€§èƒ½ç›¸è¿‘
- ğŸ¯ **é…ç½®å¤æ‚åº¦**: Viteç®€å• vs Webpackå¤æ‚

## åŸºç¡€é…ç½®

### vite.config.ts

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  // æ’ä»¶é…ç½®
  plugins: [
    react({
      // å¯ç”¨React Fast Refresh
      fastRefresh: true,
      // Babelé…ç½®
      babel: {
        plugins: [
          ['@babel/plugin-proposal-decorators', { legacy: true }]
        ]
      }
    })
  ],
  
  // è·¯å¾„è§£æ
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@components': path.resolve(__dirname, 'src/components'),
      '@utils': path.resolve(__dirname, 'src/utils'),
      '@assets': path.resolve(__dirname, 'src/assets')
    },
    // çœç•¥çš„æ‰©å±•å
    extensions: ['.js', '.ts', '.jsx', '.tsx', '.json']
  },
  
  // å¼€å‘æœåŠ¡å™¨é…ç½®
  server: {
    port: 3000,
    host: true, // ç›‘å¬æ‰€æœ‰åœ°å€
    open: true, // è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    cors: true, // å…è®¸è·¨åŸŸ
    
    // ä»£ç†é…ç½®
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      },
      '/ws': {
        target: 'ws://localhost:8080',
        ws: true
      }
    },
    
    // HMRé…ç½®
    hmr: {
      overlay: true // æ˜¾ç¤ºé”™è¯¯è¦†ç›–å±‚
    }
  },
  
  // æ„å»ºé…ç½®
  build: {
    // è¾“å‡ºç›®å½•
    outDir: 'dist',
    // é™æ€èµ„æºç›®å½•
    assetsDir: 'assets',
    // å°äºæ­¤é˜ˆå€¼çš„èµ„æºå°†å†…è”ä¸ºbase64
    assetsInlineLimit: 4096,
    // å¯ç”¨CSSä»£ç æ‹†åˆ†
    cssCodeSplit: true,
    // ç”Ÿæˆsourcemap
    sourcemap: false,
    
    // Rollupé…ç½®
    rollupOptions: {
      output: {
        // åˆ†åŒ…ç­–ç•¥
        manualChunks: {
          'react-vendor': ['react', 'react-dom'],
          'router': ['react-router-dom'],
          'ui': ['antd', '@ant-design/icons']
        },
        // è¾“å‡ºæ–‡ä»¶å
        chunkFileNames: 'js/[name]-[hash].js',
        entryFileNames: 'js/[name]-[hash].js',
        assetFileNames: '[ext]/[name]-[hash].[ext]'
      }
    },
    
    // å‹ç¼©é…ç½®
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true, // åˆ é™¤console
        drop_debugger: true // åˆ é™¤debugger
      }
    },
    
    // å—å¤§å°è­¦å‘Šé™åˆ¶
    chunkSizeWarningLimit: 1000
  },
  
  // CSSé…ç½®
  css: {
    // CSSé¢„å¤„ç†å™¨é…ç½®
    preprocessorOptions: {
      scss: {
        additionalData: `@import "@/styles/variables.scss";`
      },
      less: {
        javascriptEnabled: true,
        modifyVars: {
          '@primary-color': '#1890ff'
        }
      }
    },
    // CSSæ¨¡å—åŒ–
    modules: {
      localsConvention: 'camelCase',
      scopeBehaviour: 'local'
    }
  },
  
  // ç¯å¢ƒå˜é‡
  envPrefix: 'VITE_',
  
  // ä¾èµ–ä¼˜åŒ–
  optimizeDeps: {
    include: ['react', 'react-dom', 'react-router-dom'],
    exclude: ['your-local-package']
  }
});
```

## ç¯å¢ƒå˜é‡

### é…ç½®æ–‡ä»¶

```bash
# .env - æ‰€æœ‰ç¯å¢ƒ
VITE_APP_TITLE=My App

# .env.development - å¼€å‘ç¯å¢ƒ
VITE_API_URL=http://localhost:8080
VITE_DEBUG=true

# .env.production - ç”Ÿäº§ç¯å¢ƒ
VITE_API_URL=https://api.example.com
VITE_DEBUG=false

# .env.local - æœ¬åœ°ç¯å¢ƒï¼ˆä¸æäº¤åˆ°gitï¼‰
VITE_SECRET_KEY=your-secret-key
```

### ä½¿ç”¨ç¯å¢ƒå˜é‡

```typescript
// åœ¨ä»£ç ä¸­ä½¿ç”¨
const apiUrl = import.meta.env.VITE_API_URL;
const isDebug = import.meta.env.VITE_DEBUG === 'true';
const mode = import.meta.env.MODE; // 'development' | 'production'
const isDev = import.meta.env.DEV; // boolean
const isProd = import.meta.env.PROD; // boolean

// TypeScriptç±»å‹å®šä¹‰
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_API_URL: string;
  readonly VITE_DEBUG: string;
  readonly VITE_APP_TITLE: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

## æ’ä»¶ç”Ÿæ€

### å¸¸ç”¨æ’ä»¶

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import vue from '@vitejs/plugin-vue';
import legacy from '@vitejs/plugin-legacy';
import { visualizer } from 'rollup-plugin-visualizer';
import viteCompression from 'vite-plugin-compression';
import { createHtmlPlugin } from 'vite-plugin-html';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    // Reactæ”¯æŒ
    react(),
    
    // Vueæ”¯æŒ
    vue(),
    
    // ä¼ ç»Ÿæµè§ˆå™¨æ”¯æŒ
    legacy({
      targets: ['defaults', 'not IE 11']
    }),
    
    // æ‰“åŒ…åˆ†æ
    visualizer({
      open: true,
      gzipSize: true,
      brotliSize: true
    }),
    
    // Gzipå‹ç¼©
    viteCompression({
      algorithm: 'gzip',
      ext: '.gz'
    }),
    
    // HTMLæ¨¡æ¿
    createHtmlPlugin({
      minify: true,
      inject: {
        data: {
          title: 'My App',
          injectScript: '<script src="./inject.js"></script>'
        }
      }
    }),
    
    // PWAæ”¯æŒ
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'My App',
        short_name: 'App',
        theme_color: '#ffffff',
        icons: [
          {
            src: '/icon-192.png',
            sizes: '192x192',
            type: 'image/png'
          }
        ]
      }
    })
  ]
});
```

### è‡ªå®šä¹‰æ’ä»¶

```typescript
// è‡ªå®šä¹‰æ’ä»¶ï¼šè‡ªåŠ¨å¯¼å…¥ç»„ä»¶
import type { Plugin } from 'vite';

function autoImportComponents(): Plugin {
  return {
    name: 'auto-import-components',
    
    // è½¬æ¢ä»£ç 
    transform(code, id) {
      if (!id.endsWith('.tsx') && !id.endsWith('.jsx')) {
        return null;
      }
      
      // è‡ªåŠ¨æ·»åŠ importè¯­å¥
      const imports = `
        import Button from '@/components/Button';
        import Input from '@/components/Input';
      `;
      
      return {
        code: imports + code,
        map: null
      };
    }
  };
}

// ä½¿ç”¨æ’ä»¶
export default defineConfig({
  plugins: [autoImportComponents()]
});
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ä¾èµ–é¢„æ„å»º

```typescript
export default defineConfig({
  optimizeDeps: {
    // å¼ºåˆ¶é¢„æ„å»º
    include: [
      'react',
      'react-dom',
      'react-router-dom',
      'axios',
      'lodash-es'
    ],
    
    // æ’é™¤é¢„æ„å»º
    exclude: ['your-local-package'],
    
    // è‡ªå®šä¹‰esbuildé…ç½®
    esbuildOptions: {
      target: 'es2020',
      supported: {
        bigint: true
      }
    }
  }
});
```

### 2. ä»£ç åˆ†å‰²

```typescript
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks(id) {
          // node_modulesåˆ†åŒ…
          if (id.includes('node_modules')) {
            // Reactç›¸å…³
            if (id.includes('react') || id.includes('react-dom')) {
              return 'react-vendor';
            }
            // UIåº“
            if (id.includes('antd') || id.includes('@ant-design')) {
              return 'ui-vendor';
            }
            // å·¥å…·åº“
            if (id.includes('lodash') || id.includes('dayjs')) {
              return 'utils-vendor';
            }
            // å…¶ä»–ç¬¬ä¸‰æ–¹åº“
            return 'vendor';
          }
          
          // æŒ‰è·¯ç”±åˆ†åŒ…
          if (id.includes('src/pages/')) {
            const match = id.match(/src\/pages\/([^/]+)/);
            if (match) {
              return `page-${match[1]}`;
            }
          }
        }
      }
    }
  }
});
```

### 3. å›¾ç‰‡ä¼˜åŒ–

```typescript
import viteImagemin from 'vite-plugin-imagemin';

export default defineConfig({
  plugins: [
    viteImagemin({
      gifsicle: {
        optimizationLevel: 7,
        interlaced: false
      },
      optipng: {
        optimizationLevel: 7
      },
      mozjpeg: {
        quality: 80
      },
      pngquant: {
        quality: [0.8, 0.9],
        speed: 4
      },
      svgo: {
        plugins: [
          {
            name: 'removeViewBox'
          },
          {
            name: 'removeEmptyAttrs',
            active: false
          }
        ]
      }
    })
  ]
});
```

### 4. CDNåŠ é€Ÿ

```typescript
export default defineConfig({
  build: {
    rollupOptions: {
      external: ['react', 'react-dom'],
      output: {
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM'
        }
      }
    }
  },
  
  // åœ¨HTMLä¸­å¼•å…¥CDN
  plugins: [
    createHtmlPlugin({
      inject: {
        data: {
          injectScript: `
            <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
          `
        }
      }
    })
  ]
});
```

## å¤šé¡µé¢åº”ç”¨

```typescript
import { resolve } from 'path';

export default defineConfig({
  build: {
    rollupOptions: {
      input: {
        main: resolve(__dirname, 'index.html'),
        admin: resolve(__dirname, 'admin/index.html'),
        mobile: resolve(__dirname, 'mobile/index.html')
      }
    }
  }
});
```

## SSRé…ç½®

```typescript
// vite.config.ts
export default defineConfig({
  ssr: {
    // SSRå¤–éƒ¨åŒ–ä¾èµ–
    external: ['react', 'react-dom'],
    // ä¸å¤–éƒ¨åŒ–çš„ä¾èµ–
    noExternal: ['@your/package']
  }
});

// server.js
import express from 'express';
import { createServer as createViteServer } from 'vite';

async function createServer() {
  const app = express();
  
  // åˆ›å»ºViteæœåŠ¡å™¨
  const vite = await createViteServer({
    server: { middlewareMode: true },
    appType: 'custom'
  });
  
  app.use(vite.middlewares);
  
  app.use('*', async (req, res) => {
    const url = req.originalUrl;
    
    try {
      // åŠ è½½HTMLæ¨¡æ¿
      let template = await vite.transformIndexHtml(
        url,
        fs.readFileSync('index.html', 'utf-8')
      );
      
      // åŠ è½½æœåŠ¡ç«¯å…¥å£
      const { render } = await vite.ssrLoadModule('/src/entry-server.tsx');
      
      // æ¸²æŸ“åº”ç”¨
      const appHtml = await render(url);
      
      // æ³¨å…¥HTML
      const html = template.replace('<!--ssr-outlet-->', appHtml);
      
      res.status(200).set({ 'Content-Type': 'text/html' }).end(html);
    } catch (e) {
      vite.ssrFixStacktrace(e);
      console.error(e);
      res.status(500).end(e.message);
    }
  });
  
  app.listen(3000);
}

createServer();
```

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ä¾èµ–é¢„æ„å»º

```bash
# æ¸…é™¤ç¼“å­˜
rm -rf node_modules/.vite

# æŸ¥çœ‹é¢„æ„å»ºæ—¥å¿—
vite --debug
```

### 2. åˆ†ææ‰“åŒ…ç»“æœ

```typescript
import { visualizer } from 'rollup-plugin-visualizer';

export default defineConfig({
  plugins: [
    visualizer({
      open: true,
      filename: 'dist/stats.html',
      gzipSize: true,
      brotliSize: true
    })
  ]
});
```

### 3. æ€§èƒ½åˆ†æ

```typescript
export default defineConfig({
  build: {
    // ç”ŸæˆæŠ¥å‘Š
    reportCompressedSize: true,
    
    rollupOptions: {
      // è¾“å‡ºè¯¦ç»†ä¿¡æ¯
      output: {
        // æŸ¥çœ‹æ¯ä¸ªchunkçš„å¤§å°
        experimentalMinChunkSize: 1000
      }
    }
  }
});
```

## æœ€ä½³å®è·µ

### 1. é¡¹ç›®ç»“æ„

```
project/
â”œâ”€â”€ public/              # é™æ€èµ„æº
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â””â”€â”€ robots.txt
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ assets/         # éœ€è¦å¤„ç†çš„èµ„æº
â”‚   â”œâ”€â”€ components/     # ç»„ä»¶
â”‚   â”œâ”€â”€ pages/          # é¡µé¢
â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ styles/         # æ ·å¼
â”‚   â”œâ”€â”€ App.tsx
â”‚   â””â”€â”€ main.tsx
â”œâ”€â”€ .env                # ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.development
â”œâ”€â”€ .env.production
â”œâ”€â”€ index.html
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ vite.config.ts
```

### 2. å¯¼å…¥ä¼˜åŒ–

```typescript
// âŒ é”™è¯¯ï¼šå¯¼å…¥æ•´ä¸ªåº“
import _ from 'lodash';

// âœ… æ­£ç¡®ï¼šæŒ‰éœ€å¯¼å…¥
import debounce from 'lodash-es/debounce';

// âŒ é”™è¯¯ï¼šå¯¼å…¥æ‰€æœ‰å›¾æ ‡
import * as Icons from '@ant-design/icons';

// âœ… æ­£ç¡®ï¼šæŒ‰éœ€å¯¼å…¥
import { UserOutlined, SettingOutlined } from '@ant-design/icons';
```

### 3. åŠ¨æ€å¯¼å…¥

```typescript
// è·¯ç”±æ‡’åŠ è½½
const Home = lazy(() => import('./pages/Home'));
const About = lazy(() => import('./pages/About'));

// æ¡ä»¶å¯¼å…¥
if (import.meta.env.DEV) {
  import('./debug-tools').then(module => {
    module.init();
  });
}
```

### 4. èµ„æºå¤„ç†

```typescript
// å¯¼å…¥å›¾ç‰‡
import logo from './logo.png'; // è¿”å›URL

// å¯¼å…¥ä¸ºå­—ç¬¦ä¸²
import styles from './style.css?inline';

// å¯¼å…¥ä¸ºURL
import workerUrl from './worker.js?url';

// å¯¼å…¥ä¸ºåŸå§‹å†…å®¹
import raw from './data.txt?raw';
```

## å¸¸è§é—®é¢˜

### 1. ä¾èµ–é¢„æ„å»ºå¤±è´¥

```typescript
// è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨æŒ‡å®šéœ€è¦é¢„æ„å»ºçš„ä¾èµ–
export default defineConfig({
  optimizeDeps: {
    include: ['problematic-package']
  }
});
```

### 2. HMRä¸å·¥ä½œ

```typescript
// æ£€æŸ¥HMRé…ç½®
export default defineConfig({
  server: {
    hmr: {
      overlay: true,
      // å¦‚æœä½¿ç”¨Dockerï¼Œéœ€è¦é…ç½®
      host: '0.0.0.0',
      port: 3000
    }
  }
});
```

### 3. æ„å»ºåè·¯å¾„é”™è¯¯

```typescript
// é…ç½®baseè·¯å¾„
export default defineConfig({
  base: '/my-app/', // éƒ¨ç½²åˆ°å­è·¯å¾„
  // æˆ–
  base: './', // ç›¸å¯¹è·¯å¾„
});
```

## æ€»ç»“

Viteçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š
- âš¡ **æé€Ÿå¯åŠ¨**ï¼šåŸºäºESæ¨¡å—çš„æŒ‰éœ€ç¼–è¯‘
- ğŸ”¥ **å¿«é€ŸHMR**ï¼šæ¯«ç§’çº§çš„çƒ­æ›´æ–°
- ğŸ“¦ **ä¼˜åŒ–æ„å»º**ï¼šåŸºäºRollupçš„ç”Ÿäº§æ„å»º
- ğŸ¯ **ç®€å•é…ç½®**ï¼šå¼€ç®±å³ç”¨ï¼Œé…ç½®ç®€å•
- ğŸ”Œ **ä¸°å¯Œæ’ä»¶**ï¼šå¼ºå¤§çš„æ’ä»¶ç”Ÿæ€

æŒæ¡Viteæ˜¯ç°ä»£å‰ç«¯å¼€å‘çš„å¿…å¤‡æŠ€èƒ½ï¼

