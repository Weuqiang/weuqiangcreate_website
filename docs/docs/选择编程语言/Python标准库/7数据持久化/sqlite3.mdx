---
sidebar_position: 4
title: sqlite3
---

:::info
SQLite Python  `sqlite3`  SQLite 

- [SQLite ](https://www.sqlite.org/) 
- [Python sqlite3 ](https://docs.python.org/zh-cn/3/library/sqlite3.html)
:::

## 

### 

`connect()`  SQLite 

`sqlite3.connect(database, timeout=5.0, **kwargs) -> Connection`


- `database` `:memory:` 
- `timeout` 5.0
- `check_same_thread` True
- `isolation_level` "DEFERRED"


-  Connection 

```python showLineNumbers
import sqlite3

# 
conn = sqlite3.connect('example.db')

# 
memory_conn = sqlite3.connect(':memory:')

# 
conn.close()

# 
with sqlite3.connect('example.db') as conn:
    # 
    pass
# 
```

:::tip
****
1. 
2. 
3. 


:::

### SQL

Cursor SQL 

#### execute() 

`cursor.execute(sql, parameters=()) -> Cursor`


- `sql` SQL 
- `parameters`SQL  SQL 


-  Cursor 

```python showLineNumbers
import sqlite3

# 
conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# 
cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        age INTEGER,
        email TEXT UNIQUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
''')

#  - 
cursor.execute(
    "INSERT INTO users (name, age, email) VALUES (?, ?, ?)",
    ('', 25, 'zhangsan@example.com')
)

#  - 
cursor.execute(
    "INSERT INTO users (name, age, email) VALUES (:name, :age, :email)",
    {'name': '', 'age': 30, 'email': 'lisi@example.com'}
)

# 
conn.commit()

# 
cursor.execute("SELECT * FROM users WHERE age > ?", (20,))
results = cursor.fetchall()
print(results)

# 
conn.close()
```

:::warning
** SQL **

```python
#   -  SQL 
user_input = "admin' OR '1'='1"
cursor.execute(f"SELECT * FROM users WHERE name = '{user_input}'")

#   - 
cursor.execute("SELECT * FROM users WHERE name = ?", (user_input,))
```
:::

#### executemany() 

 SQL 

`cursor.executemany(sql, parameters) -> Cursor`

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# 
users = [
    ('', 28, 'wangwu@example.com'),
    ('', 35, 'zhaoliu@example.com'),
    ('', 22, 'sunqi@example.com')
]

cursor.executemany(
    "INSERT INTO users (name, age, email) VALUES (?, ?, ?)",
    users
)
conn.commit()

print(f" {cursor.rowcount} ")

conn.close()
```

#### executescript() 

 SQL 

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

#  SQL 
cursor.executescript('''
    DROP TABLE IF EXISTS products;
    
    CREATE TABLE products (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        price REAL,
        stock INTEGER DEFAULT 0
    );
    
    INSERT INTO products (name, price, stock) VALUES 
        ('', 5999.99, 10),
        ('', 399.99, 50),
        ('', 99.99, 100);
''')

conn.commit()
conn.close()
```

### 

#### fetchone() 



`cursor.fetchone() -> tuple | None`


-  None

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

cursor.execute("SELECT * FROM users WHERE age > ?", (25,))

# 
row = cursor.fetchone()
if row:
    print(f": {row}")  # (1, '', 25, 'zhangsan@example.com', ...)

# 
next_row = cursor.fetchone()
if next_row:
    print(f": {next_row}")

conn.close()
```

#### fetchmany() 



`cursor.fetchmany(size=cursor.arraysize) -> list[tuple]`


- `size` cursor.arraysize 1

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

cursor.execute("SELECT * FROM users")

#  2 
while True:
    rows = cursor.fetchmany(2)
    if not rows:
        break
    for row in rows:
        print(row)

conn.close()
```

#### fetchall() 



`cursor.fetchall() -> list[tuple]`


- 

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

cursor.execute("SELECT name, age FROM users ORDER BY age DESC")
all_users = cursor.fetchall()

for name, age in all_users:
    print(f"{name}: {age}")

conn.close()
```

:::tip
****
-  `fetchmany()` 
-  `fetchone()`
-  `fetchall()` 
:::

###  Row 

 `row_factory` 

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')

#  Row 
conn.row_factory = sqlite3.Row

cursor = conn.cursor()
cursor.execute("SELECT * FROM users WHERE id = ?", (1,))
row = cursor.fetchone()

if row:
    # 
    print(row[0])
    
    # 
    print(row['name'])
    print(row['email'])
    
    # 
    user_dict = dict(row)
    print(user_dict)  # {'id': 1, 'name': '', ...}
    
    # 
    print(row.keys())  # ['id', 'name', 'age', 'email', ...]

conn.close()
```

## 

SQLite 

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

try:
    # 
    cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('1', 20))
    cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('2', 21))
    
    # 
    conn.commit()
    print("")
    
except sqlite3.Error as e:
    # 
    conn.rollback()
    print(f": {e}")
    
finally:
    conn.close()

# 
with sqlite3.connect('example.db') as conn:
    cursor = conn.cursor()
    cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('3', 22))
    # 
```

:::info
****
- `None`
- `"DEFERRED"`
- `"IMMEDIATE"`
- `"EXCLUSIVE"`

```python
conn = sqlite3.connect('example.db', isolation_level='IMMEDIATE')
```
:::

## 

SQLite  5 Python  sqlite3 

| Python  | SQLite  |  |
|------------|------------|------|
| `None` | `NULL` |  |
| `int` | `INTEGER` |  |
| `float` | `REAL` |  |
| `str` | `TEXT` |  |
| `bytes` | `BLOB` |  |

```python showLineNumbers
import sqlite3
import datetime

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# 
cursor.execute('''
    CREATE TABLE IF NOT EXISTS data_types (
        id INTEGER PRIMARY KEY,
        integer_col INTEGER,
        real_col REAL,
        text_col TEXT,
        blob_col BLOB,
        null_col TEXT
    )
''')

# 
cursor.execute('''
    INSERT INTO data_types (integer_col, real_col, text_col, blob_col, null_col)
    VALUES (?, ?, ?, ?, ?)
''', (42, 3.14, 'Hello', b'binary data', None))

conn.commit()

# 
cursor.execute("SELECT * FROM data_types")
row = cursor.fetchone()
print(row)
# (1, 42, 3.14, 'Hello', b'binary data', None)

conn.close()
```

### 

SQLite  TEXTREAL  INTEGER 

```python showLineNumbers
import sqlite3
from datetime import datetime, date

# 
sqlite3.register_adapter(datetime, lambda val: val.isoformat())
sqlite3.register_adapter(date, lambda val: val.isoformat())

sqlite3.register_converter("timestamp", lambda val: datetime.fromisoformat(val.decode()))
sqlite3.register_converter("date", lambda val: date.fromisoformat(val.decode()))

# 
conn = sqlite3.connect('example.db', detect_types=sqlite3.PARSE_DECLTYPES)
cursor = conn.cursor()

cursor.execute('''
    CREATE TABLE IF NOT EXISTS events (
        id INTEGER PRIMARY KEY,
        title TEXT,
        event_date date,
        created_at timestamp
    )
''')

# 
now = datetime.now()
today = date.today()

cursor.execute(
    "INSERT INTO events (title, event_date, created_at) VALUES (?, ?, ?)",
    ('', today, now)
)
conn.commit()

#  Python 
cursor.execute("SELECT * FROM events")
row = cursor.fetchone()
print(f": {row[1]}, : {row[2]}, : {row[3]}")
print(f": {type(row[2])}, {type(row[3])}")

conn.close()
```

## 

###  ID

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('', 25))
conn.commit()

#  ID
last_id = cursor.lastrowid
print(f" ID: {last_id}")

conn.close()
```

### 

```python showLineNumbers
import sqlite3

def table_exists(conn, table_name):
    """"""
    cursor = conn.cursor()
    cursor.execute("""
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name=?
    """, (table_name,))
    return cursor.fetchone() is not None

conn = sqlite3.connect('example.db')

if table_exists(conn, 'users'):
    print("users ")
else:
    print("users ")

conn.close()
```

### 

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# 
cursor.execute("PRAGMA table_info(users)")
columns = cursor.fetchall()

print(":")
for col in columns:
    cid, name, col_type, notnull, default, pk = col
    print(f"  {name}: {col_type}", end='')
    if pk:
        print(" [PRIMARY KEY]", end='')
    if notnull:
        print(" [NOT NULL]", end='')
    print()

# 
cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
tables = cursor.fetchall()
print("\n:")
for table in tables:
    print(f"  - {table[0]}")

conn.close()
```

### 

```python showLineNumbers
import sqlite3

def backup_database(source_db, target_db):
    """"""
    source = sqlite3.connect(source_db)
    target = sqlite3.connect(target_db)
    
    #  backup API
    source.backup(target)
    
    source.close()
    target.close()
    print(f" {target_db}")

# 
backup_database('example.db', 'example_backup.db')

# 
import shutil
shutil.copy2('example.db', 'example_backup2.db')
```

### 

```python showLineNumbers
import sqlite3
from functools import wraps

def with_database(db_path):
    """"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            conn = sqlite3.connect(db_path)
            conn.row_factory = sqlite3.Row
            try:
                result = func(conn, *args, **kwargs)
                conn.commit()
                return result
            except Exception as e:
                conn.rollback()
                raise e
            finally:
                conn.close()
        return wrapper
    return decorator

@with_database('example.db')
def get_user_by_id(conn, user_id):
    """ ID """
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    return cursor.fetchone()

@with_database('example.db')
def create_user(conn, name, age, email):
    """"""
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO users (name, age, email) VALUES (?, ?, ?)",
        (name, age, email)
    )
    return cursor.lastrowid

# 
user = get_user_by_id(1)
if user:
    print(dict(user))

new_id = create_user('', 30, 'new@example.com')
print(f"ID: {new_id}")
```

## 

###  1

```python showLineNumbers
import sqlite3
import threading

#  
conn = sqlite3.connect('example.db')

def worker():
    cursor = conn.cursor()  # 
    cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('', 20))
    conn.commit()

threads = [threading.Thread(target=worker) for _ in range(5)]
for t in threads:
    t.start()

#  
def worker_correct():
    conn = sqlite3.connect('example.db')
    cursor = conn.cursor()
    cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('', 20))
    conn.commit()
    conn.close()

#  check_same_thread=False
conn = sqlite3.connect('example.db', check_same_thread=False)
```

###  2

```python showLineNumbers
import sqlite3

#  
conn = sqlite3.connect('example.db')
cursor = conn.cursor()
cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('', 25))
conn.close()  # 

#  
conn = sqlite3.connect('example.db')
cursor = conn.cursor()
cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('', 25))
conn.commit()  # 
conn.close()

#  
with sqlite3.connect('example.db') as conn:
    cursor = conn.cursor()
    cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('', 25))
    # 
```

###  3

```python showLineNumbers
import sqlite3
import time

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

#  
start = time.time()
for i in range(1000):
    cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", (f'{i}', 20))
    conn.commit()  # 
print(f": {time.time() - start:.2f}")

#  
start = time.time()
for i in range(1000):
    cursor.execute("INSERT INTO users (name, age) VALUES (?, ?)", (f'{i}', 20))
conn.commit()  # 
print(f": {time.time() - start:.2f}")

#   executemany
start = time.time()
data = [(f'{i}', 20) for i in range(1000)]
cursor.executemany("INSERT INTO users (name, age) VALUES (?, ?)", data)
conn.commit()
print(f": {time.time() - start:.2f}")

conn.close()
```

###  4

```python showLineNumbers
import sqlite3

# SQLite 

#  
conn1 = sqlite3.connect('example.db')
conn2 = sqlite3.connect('example.db')

cursor1 = conn1.cursor()
cursor2 = conn2.cursor()

cursor1.execute("BEGIN")
cursor1.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('1', 20))

# conn2  conn1 
try:
    cursor2.execute("INSERT INTO users (name, age) VALUES (?, ?)", ('2', 21))
    conn2.commit()
except sqlite3.OperationalError as e:
    print(f": {e}")

conn1.commit()
conn1.close()
conn2.close()

#  
conn = sqlite3.connect('example.db', timeout=30.0)
```

## 

### 

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# 
cursor.execute("CREATE INDEX IF NOT EXISTS idx_users_email ON users(email)")
cursor.execute("CREATE INDEX IF NOT EXISTS idx_users_age ON users(age)")

# 
cursor.execute("EXPLAIN QUERY PLAN SELECT * FROM users WHERE email = ?", ('test@example.com',))
print(cursor.fetchall())

conn.close()
```

###  WAL 

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')

#  WALWrite-Ahead Logging
# 
conn.execute("PRAGMA journal_mode=WAL")

# 
conn.execute("PRAGMA synchronous = NORMAL")  # 
conn.execute("PRAGMA cache_size = -64000")   # KB
conn.execute("PRAGMA temp_store = MEMORY")   # 

conn.close()
```

### 

```python showLineNumbers
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# 
cursor.execute("PRAGMA synchronous = OFF")
cursor.execute("PRAGMA journal_mode = MEMORY")

# 
cursor.execute("BEGIN TRANSACTION")

# 
data = [(f'{i}', i % 100) for i in range(10000)]
cursor.executemany("INSERT INTO users (name, age) VALUES (?, ?)", data)

cursor.execute("COMMIT")

# 
cursor.execute("PRAGMA synchronous = FULL")

conn.close()
```

## 

```python showLineNumbers
import sqlite3
from datetime import datetime
from typing import List, Optional

class TaskManager:
    """"""
    
    def __init__(self, db_path: str = 'tasks.db'):
        self.db_path = db_path
        self._init_database()
    
    def _init_database(self):
        """"""
        with sqlite3.connect(self.db_path) as conn:
            conn.execute('''
                CREATE TABLE IF NOT EXISTS tasks (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    title TEXT NOT NULL,
                    description TEXT,
                    status TEXT DEFAULT 'pending',
                    priority INTEGER DEFAULT 0,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    completed_at TIMESTAMP
                )
            ''')
            conn.execute('CREATE INDEX IF NOT EXISTS idx_status ON tasks(status)')
    
    def add_task(self, title: str, description: str = '', priority: int = 0) -> int:
        """"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute(
                'INSERT INTO tasks (title, description, priority) VALUES (?, ?, ?)',
                (title, description, priority)
            )
            return cursor.lastrowid
    
    def get_task(self, task_id: int) -> Optional[dict]:
        """"""
        with sqlite3.connect(self.db_path) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute('SELECT * FROM tasks WHERE id = ?', (task_id,))
            row = cursor.fetchone()
            return dict(row) if row else None
    
    def list_tasks(self, status: Optional[str] = None) -> List[dict]:
        """"""
        with sqlite3.connect(self.db_path) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            if status:
                cursor.execute(
                    'SELECT * FROM tasks WHERE status = ? ORDER BY priority DESC, created_at',
                    (status,)
                )
            else:
                cursor.execute('SELECT * FROM tasks ORDER BY priority DESC, created_at')
            
            return [dict(row) for row in cursor.fetchall()]
    
    def complete_task(self, task_id: int) -> bool:
        """"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute(
                'UPDATE tasks SET status = ?, completed_at = ? WHERE id = ?',
                ('completed', datetime.now().isoformat(), task_id)
            )
            return cursor.rowcount > 0
    
    def delete_task(self, task_id: int) -> bool:
        """"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('DELETE FROM tasks WHERE id = ?', (task_id,))
            return cursor.rowcount > 0

# 
if __name__ == '__main__':
    tm = TaskManager()
    
    # 
    task1_id = tm.add_task(' SQLite', ' SQLite ', priority=1)
    task2_id = tm.add_task('', '', priority=2)
    task3_id = tm.add_task('', '', priority=1)
    
    # 
    print(":")
    for task in tm.list_tasks():
        print(f"  [{task['id']}] {task['title']} (: {task['priority']}, : {task['status']})")
    
    # 
    tm.complete_task(task1_id)
    
    # 
    print("\n:")
    for task in tm.list_tasks(status='pending'):
        print(f"  [{task['id']}] {task['title']}")
    
    # 
    task = tm.get_task(task2_id)
    if task:
        print(f"\n: {task}")
```

## 

- <Highlight color="g">[SQLite ](https://www.sqlite.org/docs.html) - </Highlight>
- <Highlight color="g">[Python sqlite3 ](https://docs.python.org/zh-cn/3/library/sqlite3.html) - Python </Highlight>
- <Highlight color="g">[DB Browser for SQLite](https://sqlitebrowser.org/) - </Highlight>
- [SQLite Tutorial](https://www.sqlitetutorial.net/) -  SQLite 
- [w3schools SQL](https://www.w3schools.com/sql/) - SQL 
-  Python 
  - `sqlalchemy` -  ORM 
  - `peewee` -  ORM
  - `dataset` - 

:::tip
 SQLite  PostgreSQL  MySQL
:::
