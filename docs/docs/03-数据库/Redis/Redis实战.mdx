---
sidebar_position: 2
title: Redis
---

# Redis

Redis

## 

### String

```python
import redis

r = redis.Redis(host='localhost', port=6379, db=0)

# 
r.set('key', 'value')
r.get('key')
r.incr('counter')  # 
r.expire('key', 3600)  # 

# 
r.mset({'key1': 'value1', 'key2': 'value2'})
r.mget(['key1', 'key2'])
```

### Hash

```python
# 
r.hset('user:1', 'name', 'John')
r.hset('user:1', 'age', 30)
r.hget('user:1', 'name')
r.hgetall('user:1')

# 
r.hmset('user:2', {'name': 'Alice', 'age': 25})
```

### List

```python
# 
r.lpush('queue', 'task1')  # 
r.rpush('queue', 'task2')  # 
r.lpop('queue')  # 
r.rpop('queue')  # 

# 
r.blpop('queue', timeout=5)
```

### Set

```python
# 
r.sadd('tags', 'python', 'redis', 'database')
r.smembers('tags')
r.sismember('tags', 'python')

# 
r.sinter('set1', 'set2')  # 
r.sunion('set1', 'set2')  # 
r.sdiff('set1', 'set2')   # 
```

### Sorted Set

```python
# 
r.zadd('leaderboard', {'player1': 100, 'player2': 200})
r.zrange('leaderboard', 0, 9, withscores=True)  # 10
r.zrevrange('leaderboard', 0, 9, withscores=True)  # 
r.zrank('leaderboard', 'player1')  # 
```

## 

### 1. 

```python
def get_user(user_id):
    # 
    cache_key = f'user:{user_id}'
    user = r.get(cache_key)
    
    if user:
        return json.loads(user)
    
    # 
    user = db.query(f'SELECT * FROM users WHERE id = {user_id}')
    
    # 
    r.setex(cache_key, 3600, json.dumps(user))
    
    return user
```

### 2. 

```python
import uuid
import time

class RedisLock:
    def __init__(self, redis_client, lock_name, timeout=10):
        self.redis = redis_client
        self.lock_name = f'lock:{lock_name}'
        self.timeout = timeout
        self.identifier = str(uuid.uuid4())
    
    def acquire(self):
        """"""
        end_time = time.time() + self.timeout
        
        while time.time() < end_time:
            if self.redis.set(
                self.lock_name,
                self.identifier,
                nx=True,
                ex=self.timeout
            ):
                return True
            time.sleep(0.001)
        
        return False
    
    def release(self):
        """"""
        lua_script = """
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("del", KEYS[1])
        else
            return 0
        end
        """
        self.redis.eval(lua_script, 1, self.lock_name, self.identifier)
```

### 3. 

```python
def rate_limiter(user_id, max_requests=100, window=60):
    """"""
    key = f'rate_limit:{user_id}'
    now = time.time()
    
    # 
    r.zremrangebyscore(key, 0, now - window)
    
    # 
    count = r.zcard(key)
    
    if count < max_requests:
        # 
        r.zadd(key, {str(uuid.uuid4()): now})
        r.expire(key, window)
        return True
    
    return False
```

### 4. 

```python
# 
def publish_message(channel, message):
    r.publish(channel, json.dumps(message))

# 
def consume_messages(channel):
    pubsub = r.pubsub()
    pubsub.subscribe(channel)
    
    for message in pubsub.listen():
        if message['type'] == 'message':
            data = json.loads(message['data'])
            process_message(data)
```

### 5. 

```python
def update_score(user_id, score):
    """"""
    r.zadd('leaderboard', {user_id: score})

def get_top_users(n=10):
    """N"""
    return r.zrevrange('leaderboard', 0, n-1, withscores=True)

def get_user_rank(user_id):
    """"""
    rank = r.zrevrank('leaderboard', user_id)
    return rank + 1 if rank is not None else None
```

## Redis

### Redis Sentinel

```python
from redis.sentinel import Sentinel

sentinel = Sentinel([
    ('localhost', 26379),
    ('localhost', 26380),
    ('localhost', 26381)
], socket_timeout=0.1)

# 
master = sentinel.master_for('mymaster', socket_timeout=0.1)
master.set('key', 'value')

# 
slave = sentinel.slave_for('mymaster', socket_timeout=0.1)
value = slave.get('key')
```

### Redis Cluster

```python
from rediscluster import RedisCluster

startup_nodes = [
    {"host": "127.0.0.1", "port": "7000"},
    {"host": "127.0.0.1", "port": "7001"},
    {"host": "127.0.0.1", "port": "7002"}
]

rc = RedisCluster(startup_nodes=startup_nodes, decode_responses=True)
rc.set('key', 'value')
```

## 

### RDB

```conf
# redis.conf
save 900 1      # 9001key
save 300 10     # 30010key
save 60 10000   # 6010000key
```

### AOF

```conf
# redis.conf
appendonly yes
appendfsync everysec  # 
```

## 

### 1. Pipeline

```python
#  
for i in range(1000):
    r.set(f'key:{i}', i)

#  Pipeline
pipe = r.pipeline()
for i in range(1000):
    pipe.set(f'key:{i}', i)
pipe.execute()
```

### 2. key

```python
#  key
r.hset('user:all', mapping={f'user:{i}': data for i in range(100000)})

#  key
for i in range(100000):
    r.hset(f'user:{i}', mapping=data)
```

### 3. 

```python
# 
r.setex('cache:key', 3600, value)  # 1
```

## 

1. ****
2. ****
3. **Pipeline**
4. **key**
5. ****
6. ****
7. ****
8. ****

## 

Redis
-  
-  
-  
-  
-  

