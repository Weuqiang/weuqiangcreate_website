---
sidebar_position: 1
title: Vue3å“åº”å¼åŸç†æ·±åº¦è§£æ
tags: [å‰ç«¯, Vue3, å“åº”å¼, Proxy, æºç ]
---

# Vue3å“åº”å¼åŸç†æ·±åº¦è§£æ

Vue3é‡‡ç”¨Proxyé‡å†™äº†å“åº”å¼ç³»ç»Ÿï¼Œæœ¬æ–‡å°†æ·±å…¥è®²è§£Vue3å“åº”å¼åŸç†å’Œæºç å®ç°ã€‚

## å“åº”å¼åŸºç¡€

### Proxy vs Object.defineProperty

```javascript
// Vue2: Object.defineProperty
const vue2Reactive = (obj) => {
  Object.keys(obj).forEach(key => {
    let value = obj[key];
    Object.defineProperty(obj, key, {
      get() {
        console.log(`è¯»å– ${key}`);
        return value;
      },
      set(newValue) {
        console.log(`è®¾ç½® ${key} = ${newValue}`);
        value = newValue;
      }
    });
  });
  return obj;
};

// ç¼ºç‚¹
const vue2Limitations = {
  issues: [
    'æ— æ³•æ£€æµ‹å±æ€§çš„æ·»åŠ å’Œåˆ é™¤',
    'æ— æ³•æ£€æµ‹æ•°ç»„ç´¢å¼•å’Œlengthçš„å˜åŒ–',
    'éœ€è¦é€’å½’éå†æ‰€æœ‰å±æ€§',
    'æ€§èƒ½å¼€é”€å¤§'
  ],
  
  examples: {
    addProperty: () => {
      const obj = vue2Reactive({ name: 'Vue' });
      obj.age = 3; // ä¸ä¼šè§¦å‘å“åº”å¼
    },
    
    arrayIndex: () => {
      const arr = vue2Reactive([1, 2, 3]);
      arr[0] = 10; // ä¸ä¼šè§¦å‘å“åº”å¼
    }
  }
};

// Vue3: Proxy
const vue3Reactive = (obj) => {
  return new Proxy(obj, {
    get(target, key, receiver) {
      console.log(`è¯»å– ${key}`);
      return Reflect.get(target, key, receiver);
    },
    set(target, key, value, receiver) {
      console.log(`è®¾ç½® ${key} = ${value}`);
      return Reflect.set(target, key, value, receiver);
    },
    deleteProperty(target, key) {
      console.log(`åˆ é™¤ ${key}`);
      return Reflect.deleteProperty(target, key);
    }
  });
};

// ä¼˜ç‚¹
const vue3Advantages = {
  benefits: [
    'å¯ä»¥æ£€æµ‹å±æ€§çš„æ·»åŠ å’Œåˆ é™¤',
    'å¯ä»¥æ£€æµ‹æ•°ç»„ç´¢å¼•å’Œlengthçš„å˜åŒ–',
    'ä¸éœ€è¦é€’å½’éå†',
    'æ€§èƒ½æ›´å¥½'
  ],
  
  examples: {
    addProperty: () => {
      const obj = vue3Reactive({ name: 'Vue' });
      obj.age = 3; // âœ… å¯ä»¥æ£€æµ‹åˆ°
    },
    
    arrayIndex: () => {
      const arr = vue3Reactive([1, 2, 3]);
      arr[0] = 10; // âœ… å¯ä»¥æ£€æµ‹åˆ°
    }
  }
};
```

## å“åº”å¼æ ¸å¿ƒå®ç°

### reactiveå®ç°

```javascript
// å­˜å‚¨åŸå§‹å¯¹è±¡åˆ°ä»£ç†å¯¹è±¡çš„æ˜ å°„
const reactiveMap = new WeakMap();

// åˆ¤æ–­æ˜¯å¦ä¸ºå¯¹è±¡
const isObject = (val) => val !== null && typeof val === 'object';

// reactiveå‡½æ•°
function reactive(target) {
  // å¦‚æœä¸æ˜¯å¯¹è±¡ï¼Œç›´æ¥è¿”å›
  if (!isObject(target)) {
    return target;
  }
  
  // å¦‚æœå·²ç»æ˜¯ä»£ç†å¯¹è±¡ï¼Œç›´æ¥è¿”å›
  if (reactiveMap.has(target)) {
    return reactiveMap.get(target);
  }
  
  // åˆ›å»ºä»£ç†å¯¹è±¡
  const proxy = new Proxy(target, {
    get(target, key, receiver) {
      // ç‰¹æ®Škeyå¤„ç†
      if (key === '__v_isReactive') {
        return true;
      }
      
      // æ”¶é›†ä¾èµ–
      track(target, key);
      
      const result = Reflect.get(target, key, receiver);
      
      // å¦‚æœæ˜¯å¯¹è±¡ï¼Œé€’å½’ä»£ç†
      if (isObject(result)) {
        return reactive(result);
      }
      
      return result;
    },
    
    set(target, key, value, receiver) {
      const oldValue = target[key];
      const result = Reflect.set(target, key, value, receiver);
      
      // å€¼å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘æ›´æ–°
      if (oldValue !== value) {
        trigger(target, key);
      }
      
      return result;
    },
    
    deleteProperty(target, key) {
      const hadKey = Object.prototype.hasOwnProperty.call(target, key);
      const result = Reflect.deleteProperty(target, key);
      
      if (hadKey && result) {
        trigger(target, key);
      }
      
      return result;
    }
  });
  
  // ç¼“å­˜ä»£ç†å¯¹è±¡
  reactiveMap.set(target, proxy);
  
  return proxy;
}

// ä½¿ç”¨ç¤ºä¾‹
const state = reactive({
  count: 0,
  user: {
    name: 'Vue',
    age: 3
  }
});

console.log(state.count); // è§¦å‘getï¼Œæ”¶é›†ä¾èµ–
state.count++; // è§¦å‘setï¼Œè§¦å‘æ›´æ–°
```

### refå®ç°

```javascript
class RefImpl {
  constructor(value) {
    this._value = convert(value);
    this.__v_isRef = true;
  }
  
  get value() {
    // æ”¶é›†ä¾èµ–
    track(this, 'value');
    return this._value;
  }
  
  set value(newValue) {
    if (newValue !== this._value) {
      this._value = convert(newValue);
      // è§¦å‘æ›´æ–°
      trigger(this, 'value');
    }
  }
}

// è½¬æ¢å€¼
function convert(value) {
  return isObject(value) ? reactive(value) : value;
}

// refå‡½æ•°
function ref(value) {
  return new RefImpl(value);
}

// ä½¿ç”¨ç¤ºä¾‹
const count = ref(0);
console.log(count.value); // 0
count.value++; // è§¦å‘æ›´æ–°

const user = ref({ name: 'Vue' });
console.log(user.value.name); // 'Vue'
user.value.name = 'React'; // è§¦å‘æ›´æ–°
```

## ä¾èµ–æ”¶é›†ä¸è§¦å‘

### effectå®ç°

```javascript
// å½“å‰æ´»è·ƒçš„effect
let activeEffect = null;

// effectæ ˆ
const effectStack = [];

// ä¾èµ–æ˜ å°„ï¼štarget -> key -> effects
const targetMap = new WeakMap();

// effectå‡½æ•°
function effect(fn, options = {}) {
  const effectFn = () => {
    try {
      // å…¥æ ˆ
      effectStack.push(effectFn);
      activeEffect = effectFn;
      
      // æ‰§è¡Œå‡½æ•°ï¼Œè§¦å‘ä¾èµ–æ”¶é›†
      return fn();
    } finally {
      // å‡ºæ ˆ
      effectStack.pop();
      activeEffect = effectStack[effectStack.length - 1];
    }
  };
  
  // ä¿å­˜é€‰é¡¹
  effectFn.options = options;
  
  // ç«‹å³æ‰§è¡Œ
  if (!options.lazy) {
    effectFn();
  }
  
  return effectFn;
}

// ä¾èµ–æ”¶é›†
function track(target, key) {
  if (!activeEffect) {
    return;
  }
  
  // è·å–targetçš„ä¾èµ–æ˜ å°„
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()));
  }
  
  // è·å–keyçš„ä¾èµ–é›†åˆ
  let deps = depsMap.get(key);
  if (!deps) {
    depsMap.set(key, (deps = new Set()));
  }
  
  // æ·»åŠ å½“å‰effect
  deps.add(activeEffect);
}

// è§¦å‘æ›´æ–°
function trigger(target, key) {
  const depsMap = targetMap.get(target);
  if (!depsMap) {
    return;
  }
  
  const deps = depsMap.get(key);
  if (!deps) {
    return;
  }
  
  // æ‰§è¡Œæ‰€æœ‰effect
  deps.forEach(effect => {
    if (effect.options.scheduler) {
      effect.options.scheduler(effect);
    } else {
      effect();
    }
  });
}

// ä½¿ç”¨ç¤ºä¾‹
const state = reactive({ count: 0 });

effect(() => {
  console.log('count:', state.count);
});
// è¾“å‡º: count: 0

state.count++; // è§¦å‘effectï¼Œè¾“å‡º: count: 1
```

### computedå®ç°

```javascript
function computed(getter) {
  let value;
  let dirty = true; // æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—
  
  const effectFn = effect(getter, {
    lazy: true,
    scheduler: () => {
      // ä¾èµ–å˜åŒ–æ—¶ï¼Œæ ‡è®°ä¸ºè„
      dirty = true;
      // è§¦å‘computedçš„ä¾èµ–
      trigger(computed, 'value');
    }
  });
  
  const computed = {
    get value() {
      if (dirty) {
        value = effectFn();
        dirty = false;
      }
      // æ”¶é›†computedçš„ä¾èµ–
      track(computed, 'value');
      return value;
    }
  };
  
  return computed;
}

// ä½¿ç”¨ç¤ºä¾‹
const state = reactive({ count: 0 });

const double = computed(() => {
  console.log('è®¡ç®—double');
  return state.count * 2;
});

console.log(double.value); // è®¡ç®—double, è¾“å‡º: 0
console.log(double.value); // ä¸ä¼šé‡æ–°è®¡ç®—ï¼Œè¾“å‡º: 0

state.count++; // æ ‡è®°dirty
console.log(double.value); // è®¡ç®—double, è¾“å‡º: 2
```

### watchå®ç°

```javascript
function watch(source, cb, options = {}) {
  let getter;
  
  // å¤„ç†source
  if (typeof source === 'function') {
    getter = source;
  } else {
    getter = () => traverse(source);
  }
  
  let oldValue;
  let cleanup;
  
  // æ¸…ç†å‡½æ•°
  const onCleanup = (fn) => {
    cleanup = fn;
  };
  
  const job = () => {
    // æ‰§è¡Œæ¸…ç†
    if (cleanup) {
      cleanup();
    }
    
    const newValue = effectFn();
    cb(newValue, oldValue, onCleanup);
    oldValue = newValue;
  };
  
  const effectFn = effect(getter, {
    lazy: true,
    scheduler: () => {
      if (options.flush === 'post') {
        // åœ¨DOMæ›´æ–°åæ‰§è¡Œ
        Promise.resolve().then(job);
      } else {
        job();
      }
    }
  });
  
  if (options.immediate) {
    job();
  } else {
    oldValue = effectFn();
  }
}

// é€’å½’éå†å¯¹è±¡
function traverse(value, seen = new Set()) {
  if (!isObject(value) || seen.has(value)) {
    return value;
  }
  
  seen.add(value);
  
  for (const key in value) {
    traverse(value[key], seen);
  }
  
  return value;
}

// ä½¿ç”¨ç¤ºä¾‹
const state = reactive({ count: 0 });

watch(
  () => state.count,
  (newValue, oldValue) => {
    console.log(`count changed: ${oldValue} -> ${newValue}`);
  }
);

state.count++; // è¾“å‡º: count changed: 0 -> 1
```

## ç»„ä»¶æ›´æ–°æœºåˆ¶

### ç»„ä»¶æ¸²æŸ“

```javascript
class Component {
  constructor(options) {
    this.$options = options;
    this.$data = reactive(options.data());
    this.$el = null;
    
    // åˆ›å»ºæ¸²æŸ“effect
    this.update = effect(() => {
      this.render();
    }, {
      scheduler: () => {
        // å¼‚æ­¥æ›´æ–°
        queueJob(this.update);
      }
    });
  }
  
  render() {
    const vnode = this.$options.render.call(this.$data);
    
    if (!this.$el) {
      // é¦–æ¬¡æ¸²æŸ“
      this.$el = this.mount(vnode);
    } else {
      // æ›´æ–°æ¸²æŸ“
      this.patch(this.$el, vnode);
    }
  }
  
  mount(vnode) {
    // åˆ›å»ºçœŸå®DOM
    const el = document.createElement(vnode.tag);
    
    // è®¾ç½®å±æ€§
    if (vnode.props) {
      for (const key in vnode.props) {
        el.setAttribute(key, vnode.props[key]);
      }
    }
    
    // å¤„ç†å­èŠ‚ç‚¹
    if (typeof vnode.children === 'string') {
      el.textContent = vnode.children;
    } else if (Array.isArray(vnode.children)) {
      vnode.children.forEach(child => {
        el.appendChild(this.mount(child));
      });
    }
    
    return el;
  }
  
  patch(el, vnode) {
    // ç®€åŒ–çš„diffç®—æ³•
    // å®é™…Vue3ä½¿ç”¨æ›´å¤æ‚çš„diffç®—æ³•
    el.textContent = vnode.children;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const app = new Component({
  data() {
    return {
      count: 0
    };
  },
  render() {
    return {
      tag: 'div',
      children: `Count: ${this.count}`
    };
  }
});

document.body.appendChild(app.$el);

// æ›´æ–°æ•°æ®ï¼Œè‡ªåŠ¨è§¦å‘é‡æ–°æ¸²æŸ“
app.$data.count++;
```

### å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—

```javascript
const queue = [];
let isFlushing = false;
let isFlushPending = false;

function queueJob(job) {
  if (!queue.includes(job)) {
    queue.push(job);
    queueFlush();
  }
}

function queueFlush() {
  if (!isFlushing && !isFlushPending) {
    isFlushPending = true;
    Promise.resolve().then(flushJobs);
  }
}

function flushJobs() {
  isFlushPending = false;
  isFlushing = true;
  
  // æ’åºï¼šçˆ¶ç»„ä»¶å…ˆäºå­ç»„ä»¶æ›´æ–°
  queue.sort((a, b) => a.id - b.id);
  
  try {
    for (let i = 0; i < queue.length; i++) {
      const job = queue[i];
      job();
    }
  } finally {
    queue.length = 0;
    isFlushing = false;
  }
}

// nextTickå®ç°
function nextTick(fn) {
  return fn ? Promise.resolve().then(fn) : Promise.resolve();
}

// ä½¿ç”¨ç¤ºä¾‹
const state = reactive({ count: 0 });

effect(() => {
  console.log('effect:', state.count);
});

state.count++;
state.count++;
state.count++;

// åªä¼šæ‰§è¡Œä¸€æ¬¡effect
// è¾“å‡º: effect: 3

nextTick(() => {
  console.log('nextTick:', state.count);
});
```

## æ€§èƒ½ä¼˜åŒ–

### shallowReactive

```javascript
function shallowReactive(target) {
  return new Proxy(target, {
    get(target, key, receiver) {
      track(target, key);
      return Reflect.get(target, key, receiver);
    },
    
    set(target, key, value, receiver) {
      const result = Reflect.set(target, key, value, receiver);
      trigger(target, key);
      return result;
    }
  });
}

// ä½¿ç”¨åœºæ™¯ï¼šå¤§å‹æ•°æ®ç»“æ„ï¼Œåªéœ€è¦ç›‘å¬ç¬¬ä¸€å±‚
const state = shallowReactive({
  user: {
    name: 'Vue',
    profile: {
      age: 3
    }
  }
});

// âœ… è§¦å‘æ›´æ–°
state.user = { name: 'React' };

// âŒ ä¸ä¼šè§¦å‘æ›´æ–°
state.user.name = 'Angular';
```

### readonly

```javascript
function readonly(target) {
  return new Proxy(target, {
    get(target, key, receiver) {
      track(target, key);
      const result = Reflect.get(target, key, receiver);
      return isObject(result) ? readonly(result) : result;
    },
    
    set() {
      console.warn('readonlyå¯¹è±¡ä¸èƒ½ä¿®æ”¹');
      return true;
    },
    
    deleteProperty() {
      console.warn('readonlyå¯¹è±¡ä¸èƒ½åˆ é™¤å±æ€§');
      return true;
    }
  });
}

// ä½¿ç”¨åœºæ™¯ï¼špropsã€store state
const props = readonly({ msg: 'Hello' });
props.msg = 'World'; // è­¦å‘Šï¼šreadonlyå¯¹è±¡ä¸èƒ½ä¿®æ”¹
```

### markRaw

```javascript
const rawMap = new WeakMap();

function markRaw(value) {
  rawMap.set(value, true);
  return value;
}

function isRaw(value) {
  return rawMap.has(value);
}

// åœ¨reactiveä¸­æ£€æŸ¥
function reactive(target) {
  if (isRaw(target)) {
    return target;
  }
  // ... å…¶ä»–é€»è¾‘
}

// ä½¿ç”¨åœºæ™¯ï¼šç¬¬ä¸‰æ–¹åº“å®ä¾‹ã€å¤§å‹ä¸å¯å˜æ•°æ®
const map = markRaw(new Map());
const state = reactive({ map });

// mapä¸ä¼šè¢«ä»£ç†
console.log(state.map === map); // true
```

## å®æˆ˜åº”ç”¨

### è‡ªå®šä¹‰å“åº”å¼Hook

```javascript
// useCounter
function useCounter(initialValue = 0) {
  const count = ref(initialValue);
  
  const increment = () => count.value++;
  const decrement = () => count.value--;
  const reset = () => count.value = initialValue;
  
  return {
    count,
    increment,
    decrement,
    reset
  };
}

// useMouse
function useMouse() {
  const x = ref(0);
  const y = ref(0);
  
  const update = (e) => {
    x.value = e.pageX;
    y.value = e.pageY;
  };
  
  onMounted(() => {
    window.addEventListener('mousemove', update);
  });
  
  onUnmounted(() => {
    window.removeEventListener('mousemove', update);
  });
  
  return { x, y };
}

// useLocalStorage
function useLocalStorage(key, initialValue) {
  const data = ref(initialValue);
  
  // ä»localStorageè¯»å–
  const stored = localStorage.getItem(key);
  if (stored) {
    data.value = JSON.parse(stored);
  }
  
  // ç›‘å¬å˜åŒ–ï¼ŒåŒæ­¥åˆ°localStorage
  watch(data, (newValue) => {
    localStorage.setItem(key, JSON.stringify(newValue));
  }, { deep: true });
  
  return data;
}
```

## æ€»ç»“

Vue3å“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒï¼š
- ğŸ¯ **Proxyä»£ç†**ï¼šå®Œç¾çš„å“åº”å¼æ‹¦æˆª
- ğŸ“¦ **ä¾èµ–æ”¶é›†**ï¼štrackæ”¶é›†ï¼Œtriggerè§¦å‘
- ğŸ”„ **effectç³»ç»Ÿ**ï¼šå“åº”å¼å‰¯ä½œç”¨
- ğŸ’¡ **computed**ï¼šæ‡’è®¡ç®—ï¼Œç¼“å­˜ç»“æœ
- ğŸ‘€ **watch**ï¼šç›‘å¬æ•°æ®å˜åŒ–
- ğŸš€ **å¼‚æ­¥æ›´æ–°**ï¼šæ‰¹é‡æ›´æ–°ï¼Œæ€§èƒ½ä¼˜åŒ–

è®°ä½ï¼š**ç†è§£å“åº”å¼åŸç†æ˜¯æŒæ¡Vue3çš„å…³é”®ï¼**

