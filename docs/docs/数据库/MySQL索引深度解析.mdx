---
sidebar_position: 1
title: MySQLç´¢å¼•æ·±åº¦è§£æ
tags: [æ•°æ®åº“, MySQL, ç´¢å¼•, B+æ ‘]
---

# MySQLç´¢å¼•æ·±åº¦è§£æ

ç´¢å¼•æ˜¯æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒï¼Œæœ¬æ–‡å°†æ·±å…¥è®²è§£MySQLç´¢å¼•çš„åŸç†ã€ç±»å‹å’Œä¼˜åŒ–æŠ€å·§ã€‚

## ç´¢å¼•æ•°æ®ç»“æ„

### B+æ ‘åŸç†

```javascript
// B+æ ‘èŠ‚ç‚¹ç»“æ„
class BPlusTreeNode {
  constructor(isLeaf = false) {
    this.isLeaf = isLeaf;
    this.keys = [];           // é”®å€¼
    this.children = [];       // å­èŠ‚ç‚¹æŒ‡é’ˆ
    this.next = null;         // å¶å­èŠ‚ç‚¹é“¾è¡¨æŒ‡é’ˆ
    this.parent = null;       // çˆ¶èŠ‚ç‚¹æŒ‡é’ˆ
  }
}

class BPlusTree {
  constructor(order = 4) {
    this.root = new BPlusTreeNode(true);
    this.order = order;       // é˜¶æ•°
    this.minKeys = Math.ceil(order / 2) - 1;
  }
  
  // æŸ¥æ‰¾
  search(key) {
    let node = this.root;
    
    // ä»æ ¹èŠ‚ç‚¹å‘ä¸‹æŸ¥æ‰¾
    while (!node.isLeaf) {
      let i = 0;
      while (i < node.keys.length && key >= node.keys[i]) {
        i++;
      }
      node = node.children[i];
    }
    
    // åœ¨å¶å­èŠ‚ç‚¹ä¸­æŸ¥æ‰¾
    const index = node.keys.indexOf(key);
    return index !== -1 ? node.children[index] : null;
  }
  
  // æ’å…¥
  insert(key, value) {
    const leaf = this.findLeaf(key);
    
    // æ’å…¥åˆ°å¶å­èŠ‚ç‚¹
    this.insertIntoLeaf(leaf, key, value);
    
    // å¦‚æœèŠ‚ç‚¹æº¢å‡ºï¼Œåˆ†è£‚
    if (leaf.keys.length >= this.order) {
      this.splitLeaf(leaf);
    }
  }
  
  findLeaf(key) {
    let node = this.root;
    
    while (!node.isLeaf) {
      let i = 0;
      while (i < node.keys.length && key >= node.keys[i]) {
        i++;
      }
      node = node.children[i];
    }
    
    return node;
  }
  
  insertIntoLeaf(leaf, key, value) {
    let i = 0;
    while (i < leaf.keys.length && key > leaf.keys[i]) {
      i++;
    }
    
    leaf.keys.splice(i, 0, key);
    leaf.children.splice(i, 0, value);
  }
  
  splitLeaf(leaf) {
    const mid = Math.floor(this.order / 2);
    
    // åˆ›å»ºæ–°èŠ‚ç‚¹
    const newLeaf = new BPlusTreeNode(true);
    newLeaf.keys = leaf.keys.splice(mid);
    newLeaf.children = leaf.children.splice(mid);
    
    // ç»´æŠ¤é“¾è¡¨
    newLeaf.next = leaf.next;
    leaf.next = newLeaf;
    
    // å‘çˆ¶èŠ‚ç‚¹æ’å…¥
    const promoteKey = newLeaf.keys[0];
    this.insertIntoParent(leaf, promoteKey, newLeaf);
  }
  
  insertIntoParent(left, key, right) {
    if (left === this.root) {
      // åˆ›å»ºæ–°æ ¹èŠ‚ç‚¹
      const newRoot = new BPlusTreeNode(false);
      newRoot.keys = [key];
      newRoot.children = [left, right];
      left.parent = newRoot;
      right.parent = newRoot;
      this.root = newRoot;
      return;
    }
    
    const parent = left.parent;
    let i = 0;
    while (i < parent.keys.length && key > parent.keys[i]) {
      i++;
    }
    
    parent.keys.splice(i, 0, key);
    parent.children.splice(i + 1, 0, right);
    right.parent = parent;
    
    // å¦‚æœçˆ¶èŠ‚ç‚¹æº¢å‡ºï¼Œç»§ç»­åˆ†è£‚
    if (parent.keys.length >= this.order) {
      this.splitInternal(parent);
    }
  }
}

// B+æ ‘ç‰¹ç‚¹
const bPlusTreeFeatures = {
  advantages: [
    'æ‰€æœ‰æ•°æ®éƒ½åœ¨å¶å­èŠ‚ç‚¹',
    'å¶å­èŠ‚ç‚¹å½¢æˆæœ‰åºé“¾è¡¨',
    'éå¶å­èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•',
    'æŸ¥è¯¢æ€§èƒ½ç¨³å®šï¼ˆO(logN)ï¼‰',
    'èŒƒå›´æŸ¥è¯¢æ•ˆç‡é«˜'
  ],
  
  vsHashIndex: {
    bPlusTree: 'æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€æ’åº',
    hash: 'åªæ”¯æŒç­‰å€¼æŸ¥è¯¢'
  },
  
  vsBTree: {
    bPlusTree: 'å¶å­èŠ‚ç‚¹é“¾è¡¨ï¼ŒèŒƒå›´æŸ¥è¯¢å¿«',
    bTree: 'æ‰€æœ‰èŠ‚ç‚¹å­˜æ•°æ®ï¼Œå•ç‚¹æŸ¥è¯¢å¿«'
  }
};
```

### èšç°‡ç´¢å¼•ä¸éèšç°‡ç´¢å¼•

```sql
-- èšç°‡ç´¢å¼•ï¼ˆä¸»é”®ç´¢å¼•ï¼‰
-- InnoDBä¸­ï¼Œæ•°æ®æŒ‰ä¸»é”®é¡ºåºå­˜å‚¨
CREATE TABLE users (
    id INT PRIMARY KEY,        -- èšç°‡ç´¢å¼•
    name VARCHAR(100),
    email VARCHAR(100),
    age INT
);

-- èšç°‡ç´¢å¼•çš„B+æ ‘å¶å­èŠ‚ç‚¹å­˜å‚¨å®Œæ•´è¡Œæ•°æ®
/*
èšç°‡ç´¢å¼•ç»“æ„ï¼š
         [10, 20, 30]
        /      |      \
   [1-9]   [10-19]   [20-29]
     |        |         |
  å®Œæ•´è¡Œ   å®Œæ•´è¡Œ     å®Œæ•´è¡Œ
*/

-- éèšç°‡ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰
CREATE INDEX idx_email ON users(email);

-- éèšç°‡ç´¢å¼•çš„B+æ ‘å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼
/*
éèšç°‡ç´¢å¼•ç»“æ„ï¼š
         [email_b, email_m, email_z]
        /           |              \
   [email_a]    [email_l]      [email_y]
      |            |               |
    ä¸»é”®id       ä¸»é”®id          ä¸»é”®id
*/

-- å›è¡¨æŸ¥è¯¢
-- 1. å…ˆåœ¨éèšç°‡ç´¢å¼•ä¸­æ‰¾åˆ°ä¸»é”®
-- 2. å†ç”¨ä¸»é”®åœ¨èšç°‡ç´¢å¼•ä¸­æŸ¥æ‰¾å®Œæ•´æ•°æ®
SELECT * FROM users WHERE email = 'john@example.com';

-- è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_email_name ON users(email, name);

-- æŸ¥è¯¢åªéœ€è¦ç´¢å¼•ä¸­çš„åˆ—ï¼Œä¸éœ€è¦å›è¡¨
SELECT name FROM users WHERE email = 'john@example.com';
```

## ç´¢å¼•ç±»å‹è¯¦è§£

### 1. ä¸»é”®ç´¢å¼•

```sql
-- è‡ªå¢ä¸»é”®
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT,
    amount DECIMAL(10,2),
    created_at TIMESTAMP
);

-- ä¼˜ç‚¹ï¼š
-- 1. é¡ºåºæ’å…¥ï¼Œé¡µåˆ†è£‚å°‘
-- 2. ç©ºé—´åˆ©ç”¨ç‡é«˜
-- 3. æŸ¥è¯¢æ•ˆç‡é«˜

-- UUIDä¸»é”®ï¼ˆä¸æ¨èï¼‰
CREATE TABLE orders_uuid (
    id CHAR(36) PRIMARY KEY,  -- UUID
    user_id BIGINT,
    amount DECIMAL(10,2)
);

-- ç¼ºç‚¹ï¼š
-- 1. éšæœºæ’å…¥ï¼Œé¡µåˆ†è£‚å¤š
-- 2. ç´¢å¼•å ç”¨ç©ºé—´å¤§
-- 3. æŸ¥è¯¢æ•ˆç‡ä½

-- å¤åˆä¸»é”®
CREATE TABLE order_items (
    order_id BIGINT,
    product_id BIGINT,
    quantity INT,
    PRIMARY KEY (order_id, product_id)
);
```

### 2. å”¯ä¸€ç´¢å¼•

```sql
-- å”¯ä¸€ç´¢å¼•
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20)
);

-- æˆ–è€…
CREATE UNIQUE INDEX idx_email ON users(email);

-- å”¯ä¸€ç´¢å¼• vs ä¸»é”®ç´¢å¼•
/*
ç›¸åŒç‚¹ï¼š
- éƒ½ä¿è¯å”¯ä¸€æ€§
- éƒ½ä¼šåˆ›å»ºç´¢å¼•

ä¸åŒç‚¹ï¼š
- ä¸»é”®ä¸èƒ½ä¸ºNULLï¼Œå”¯ä¸€ç´¢å¼•å¯ä»¥
- ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œå¯ä»¥æœ‰å¤šä¸ªå”¯ä¸€ç´¢å¼•
- ä¸»é”®æ˜¯èšç°‡ç´¢å¼•ï¼Œå”¯ä¸€ç´¢å¼•æ˜¯éèšç°‡ç´¢å¼•
*/

-- å¤„ç†NULLå€¼
INSERT INTO users (id, email) VALUES (1, NULL);  -- å…è®¸
INSERT INTO users (id, email) VALUES (2, NULL);  -- å…è®¸ï¼ˆå¤šä¸ªNULLï¼‰
```

### 3. ç»„åˆç´¢å¼•

```sql
-- åˆ›å»ºç»„åˆç´¢å¼•
CREATE INDEX idx_user_time ON orders(user_id, created_at);

-- æœ€å·¦å‰ç¼€åŸåˆ™
-- âœ… å¯ä»¥ä½¿ç”¨ç´¢å¼•
SELECT * FROM orders WHERE user_id = 1;
SELECT * FROM orders WHERE user_id = 1 AND created_at > '2024-01-01';

-- âŒ ä¸èƒ½ä½¿ç”¨ç´¢å¼•
SELECT * FROM orders WHERE created_at > '2024-01-01';

-- ç´¢å¼•åˆ—é¡ºåºçš„é€‰æ‹©
-- 1. åŒºåˆ†åº¦é«˜çš„åˆ—æ”¾å‰é¢
-- 2. ç»å¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶çš„åˆ—æ”¾å‰é¢
-- 3. ç»å¸¸éœ€è¦æ’åºçš„åˆ—æ”¾åé¢

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„è®¢å•ï¼ŒæŒ‰æ—¶é—´æ’åº
CREATE INDEX idx_user_time ON orders(user_id, created_at);

SELECT * FROM orders 
WHERE user_id = 1 
ORDER BY created_at DESC;  -- å¯ä»¥ä½¿ç”¨ç´¢å¼•æ’åº

-- ç´¢å¼•ä¸‹æ¨ï¼ˆIndex Condition Pushdownï¼‰
CREATE INDEX idx_name_age ON users(name, age);

SELECT * FROM users 
WHERE name LIKE 'John%' AND age > 20;

-- MySQL 5.6+ä¼šå°†age > 20çš„æ¡ä»¶ä¸‹æ¨åˆ°å­˜å‚¨å¼•æ“å±‚è¿‡æ»¤
-- å‡å°‘å›è¡¨æ¬¡æ•°
```

### 4. å‰ç¼€ç´¢å¼•

```sql
-- å¯¹é•¿å­—ç¬¦ä¸²å»ºç«‹å‰ç¼€ç´¢å¼•
CREATE INDEX idx_email_prefix ON users(email(10));

-- é€‰æ‹©åˆé€‚çš„å‰ç¼€é•¿åº¦
SELECT 
    COUNT(DISTINCT LEFT(email, 5)) / COUNT(*) AS sel_5,
    COUNT(DISTINCT LEFT(email, 10)) / COUNT(*) AS sel_10,
    COUNT(DISTINCT LEFT(email, 15)) / COUNT(*) AS sel_15,
    COUNT(DISTINCT email) / COUNT(*) AS sel_full
FROM users;

-- é€‰æ‹©åŒºåˆ†åº¦æ¥è¿‘å®Œæ•´åˆ—çš„æœ€çŸ­å‰ç¼€

-- å‰ç¼€ç´¢å¼•çš„é™åˆ¶
-- 1. ä¸èƒ½ç”¨äºORDER BY
-- 2. ä¸èƒ½ç”¨äºGROUP BY
-- 3. ä¸èƒ½ä½œä¸ºè¦†ç›–ç´¢å¼•
```

### 5. å…¨æ–‡ç´¢å¼•

```sql
-- åˆ›å»ºå…¨æ–‡ç´¢å¼•
CREATE TABLE articles (
    id BIGINT PRIMARY KEY,
    title VARCHAR(200),
    content TEXT,
    FULLTEXT INDEX idx_fulltext (title, content)
) ENGINE=InnoDB;

-- å…¨æ–‡æœç´¢
-- è‡ªç„¶è¯­è¨€æ¨¡å¼
SELECT * FROM articles
WHERE MATCH(title, content) AGAINST('MySQLç´¢å¼•' IN NATURAL LANGUAGE MODE);

-- å¸ƒå°”æ¨¡å¼
SELECT * FROM articles
WHERE MATCH(title, content) AGAINST('+MySQL -Oracle' IN BOOLEAN MODE);

-- æŸ¥è¯¢æ‰©å±•æ¨¡å¼
SELECT * FROM articles
WHERE MATCH(title, content) AGAINST('æ•°æ®åº“' WITH QUERY EXPANSION);

-- å…¨æ–‡ç´¢å¼•é…ç½®
-- æœ€å°è¯é•¿åº¦
SET GLOBAL innodb_ft_min_token_size = 2;

-- åœç”¨è¯
CREATE TABLE my_stopwords (value VARCHAR(30));
INSERT INTO my_stopwords VALUES ('çš„'), ('æ˜¯'), ('åœ¨');
SET GLOBAL innodb_ft_server_stopword_table = 'mydb/my_stopwords';
```

## ç´¢å¼•ä¼˜åŒ–æŠ€å·§

### 1. ç´¢å¼•é€‰æ‹©æ€§

```sql
-- è®¡ç®—ç´¢å¼•é€‰æ‹©æ€§
SELECT 
    COUNT(DISTINCT column_name) / COUNT(*) AS selectivity
FROM table_name;

-- é€‰æ‹©æ€§è¶Šé«˜ï¼Œç´¢å¼•æ•ˆæœè¶Šå¥½
-- é€‰æ‹©æ€§ = 1ï¼šå®Œå…¨å”¯ä¸€ï¼ˆå¦‚ä¸»é”®ï¼‰
-- é€‰æ‹©æ€§ < 0.1ï¼šä¸é€‚åˆå»ºç´¢å¼•ï¼ˆå¦‚æ€§åˆ«ï¼‰

-- ç¤ºä¾‹
SELECT 
    COUNT(DISTINCT gender) / COUNT(*) AS gender_sel,  -- 0.5
    COUNT(DISTINCT email) / COUNT(*) AS email_sel,    -- 1.0
    COUNT(DISTINCT age) / COUNT(*) AS age_sel         -- 0.05
FROM users;

-- ç»“è®ºï¼šemailé€‚åˆå»ºç´¢å¼•ï¼Œgenderå’Œageä¸é€‚åˆ
```

### 2. é¿å…ç´¢å¼•å¤±æ•ˆ

```sql
-- âŒ åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°
SELECT * FROM users WHERE YEAR(created_at) = 2024;

-- âœ… æ”¹å†™æŸ¥è¯¢
SELECT * FROM users 
WHERE created_at >= '2024-01-01' 
  AND created_at < '2025-01-01';

-- âŒ éšå¼ç±»å‹è½¬æ¢
SELECT * FROM users WHERE phone = 12345678;  -- phoneæ˜¯VARCHAR

-- âœ… ä½¿ç”¨æ­£ç¡®ç±»å‹
SELECT * FROM users WHERE phone = '12345678';

-- âŒ ä½¿ç”¨NOTã€!=ã€<>
SELECT * FROM users WHERE status != 'deleted';

-- âœ… ä½¿ç”¨IN
SELECT * FROM users WHERE status IN ('active', 'pending');

-- âŒ ä½¿ç”¨ORè¿æ¥ä¸åŒåˆ—
SELECT * FROM users WHERE name = 'John' OR email = 'john@example.com';

-- âœ… ä½¿ç”¨UNION
SELECT * FROM users WHERE name = 'John'
UNION
SELECT * FROM users WHERE email = 'john@example.com';

-- âŒ LIKEä»¥é€šé…ç¬¦å¼€å¤´
SELECT * FROM users WHERE name LIKE '%John';

-- âœ… LIKEä»¥å¸¸é‡å¼€å¤´
SELECT * FROM users WHERE name LIKE 'John%';

-- âŒ åœ¨ç´¢å¼•åˆ—ä¸Šè¿›è¡Œè®¡ç®—
SELECT * FROM orders WHERE amount * 0.9 > 100;

-- âœ… ç§»åŠ¨è®¡ç®—åˆ°å³è¾¹
SELECT * FROM orders WHERE amount > 100 / 0.9;
```

### 3. è¦†ç›–ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºè¦†ç›–ç´¢å¼•
CREATE INDEX idx_covering ON users(name, email, age);

-- âœ… æŸ¥è¯¢åªéœ€è¦ç´¢å¼•ä¸­çš„åˆ—
SELECT name, email, age FROM users WHERE name = 'John';
-- Extra: Using index

-- âŒ æŸ¥è¯¢éœ€è¦å…¶ä»–åˆ—ï¼Œéœ€è¦å›è¡¨
SELECT name, email, age, address FROM users WHERE name = 'John';
-- Extra: Using index condition

-- ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢
-- âŒ æ·±åˆ†é¡µæ€§èƒ½å·®
SELECT * FROM users ORDER BY id LIMIT 1000000, 10;

-- âœ… ä½¿ç”¨è¦†ç›–ç´¢å¼• + å»¶è¿Ÿå…³è”
SELECT * FROM users
INNER JOIN (
    SELECT id FROM users ORDER BY id LIMIT 1000000, 10
) AS t USING(id);
```

### 4. ç´¢å¼•åˆå¹¶

```sql
-- åˆ›å»ºå•åˆ—ç´¢å¼•
CREATE INDEX idx_name ON users(name);
CREATE INDEX idx_age ON users(age);

-- MySQLå¯èƒ½ä½¿ç”¨ç´¢å¼•åˆå¹¶
SELECT * FROM users WHERE name = 'John' AND age > 20;

-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM users WHERE name = 'John' AND age > 20;
-- Extra: Using intersect(idx_name, idx_age)

-- ä½†é€šå¸¸ç»„åˆç´¢å¼•æ›´å¥½
CREATE INDEX idx_name_age ON users(name, age);
```

## ç´¢å¼•ç›‘æ§

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    TABLE_NAME,
    INDEX_NAME,
    SEQ_IN_INDEX,
    COLUMN_NAME,
    CARDINALITY,
    INDEX_TYPE
FROM INFORMATION_SCHEMA.STATISTICS
WHERE TABLE_SCHEMA = 'your_database'
ORDER BY TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;

-- æŸ¥çœ‹æœªä½¿ç”¨çš„ç´¢å¼•
SELECT 
    s.TABLE_NAME,
    s.INDEX_NAME,
    s.CARDINALITY
FROM INFORMATION_SCHEMA.STATISTICS s
LEFT JOIN INFORMATION_SCHEMA.INDEX_STATISTICS i
    ON s.TABLE_SCHEMA = i.TABLE_SCHEMA
    AND s.TABLE_NAME = i.TABLE_NAME
    AND s.INDEX_NAME = i.INDEX_NAME
WHERE s.TABLE_SCHEMA = 'your_database'
    AND s.INDEX_NAME != 'PRIMARY'
    AND i.INDEX_NAME IS NULL;

-- æŸ¥çœ‹ç´¢å¼•å¤§å°
SELECT 
    TABLE_NAME,
    INDEX_NAME,
    ROUND(STAT_VALUE * @@innodb_page_size / 1024 / 1024, 2) AS size_mb
FROM mysql.innodb_index_stats
WHERE DATABASE_NAME = 'your_database'
    AND STAT_NAME = 'size';

-- åˆ†æè¡¨
ANALYZE TABLE users;

-- ä¼˜åŒ–è¡¨
OPTIMIZE TABLE users;
```

## æ€»ç»“

MySQLç´¢å¼•ä¼˜åŒ–çš„æ ¸å¿ƒï¼š
- ğŸŒ³ **B+æ ‘ç»“æ„**ï¼šç†è§£åŸç†æ‰èƒ½ç”¨å¥½ç´¢å¼•
- ğŸ”‘ **ç´¢å¼•ç±»å‹**ï¼šä¸»é”®ã€å”¯ä¸€ã€ç»„åˆã€å‰ç¼€ã€å…¨æ–‡
- ğŸ“Š **é€‰æ‹©æ€§**ï¼šé«˜é€‰æ‹©æ€§çš„åˆ—é€‚åˆå»ºç´¢å¼•
- ğŸš« **é¿å…å¤±æ•ˆ**ï¼šä¸åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°ã€ç±»å‹è½¬æ¢
- ğŸ“¦ **è¦†ç›–ç´¢å¼•**ï¼šå‡å°‘å›è¡¨ï¼Œæå‡æ€§èƒ½
- ğŸ“ˆ **ç›‘æ§ç»´æŠ¤**ï¼šå®šæœŸæ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ

è®°ä½ï¼š**ç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®æŸ¥è¯¢æ¨¡å¼åˆç†è®¾è®¡ï¼**

