---
sidebarDepth: 4
---
# 

XSSCSRF

## XSS

XSSJavaScriptCookie

### XSS 

**1.  XSS**

URL

```javascript
// 
app.get('/', (req, res) => {
  const { content } = req.query;
  res.send(`<div>${content}</div>`);  // 
});

// 
// http://example.com/?content=<script>alert(document.cookie)</script>
```

**2.  XSS**



```javascript
// 
app.post('/comment', async (req, res) => {
  const { content } = req.body;
  await db.insert({ content });  // 
});

app.get('/comments', async (req, res) => {
  const comments = await db.find();
  res.render('comments', { comments });  // 
});
```

**3. DOM  XSS**

JavaScriptDOM

```javascript
// 
const hash = location.hash.slice(1);
document.getElementById('content').innerHTML = hash;

// 
// http://example.com/#<img src=x onerror=alert(1)>
```

### XSS

**1. **



```javascript
// 
function validateInput(input) {
  const allowedPattern = /^[a-zA-Z0-9\s]+$/;
  return allowedPattern.test(input);
}

// 
function filterInput(input) {
  return input.replace(/<script>/gi, '');
}
```

**2. **

`<script>``&lt;script&gt;`

```javascript
// HTML 
function escapeHtml(str) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;',
    '/': '&#x2F;'
  };
  return str.replace(/[&<>"'/]/g, char => map[char]);
}

// 
const userInput = '<script>alert(1)</script>';
const safe = escapeHtml(userInput);
// &lt;script&gt;alert(1)&lt;/script&gt;
```

**3. API**

`textContent``innerHTML`HTML

```javascript
// 
element.innerHTML = userInput;

// 
element.textContent = userInput;
element.innerText = userInput;
```

**4. CSP**



```html
<!--  meta  -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://trusted.com">

<!--  HTTP  -->
```

```javascript
// Node.js  CSP
app.use((req, res, next) => {
  res.setHeader(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
  );
  next();
});
```

**CSP **
- `default-src`
- `script-src`
- `style-src`
- `img-src`
- `connect-src`AJAXWebSocket 
- `font-src`
- `frame-src`iframe 

**5. HttpOnly Cookie**

CookieHttpOnlyJavaScriptXSSCookie

```javascript
//  HttpOnly JavaScript  Cookie
res.cookie('sessionId', 'xxx', {
  httpOnly: true,
  secure: true,      //  HTTPS
  sameSite: 'strict' //  CSRF
});
```

## CSRF

CSRFCookie


1. `bank.com`Cookie
2. `evil.com`
3. `evil.com``bank.com`
4. Cookie
5. 

```html
<!--  evil.com -->
<img src="https://bank.com/transfer?to=hacker&amount=10000">

<!--  -->
<form action="https://bank.com/transfer" method="POST">
  <input type="hidden" name="to" value="hacker">
  <input type="hidden" name="amount" value="10000">
</form>
<script>document.forms[0].submit();</script>
```

### CSRF

**1. CSRF Token**

tokentokentoken

```javascript
//  token
app.get('/form', (req, res) => {
  const csrfToken = generateToken();
  req.session.csrfToken = csrfToken;
  res.render('form', { csrfToken });
});

//  token
app.post('/submit', (req, res) => {
  const { csrfToken } = req.body;
  if (csrfToken !== req.session.csrfToken) {
    return res.status(403).send('Invalid CSRF token');
  }
  // 
});
```

```html
<!--  token -->
<form method="POST" action="/submit">
  <input type="hidden" name="csrfToken" value="<%= csrfToken %>">
  <button type="submit"></button>
</form>
```

**2. SameSite Cookie**

CookieSameSiteCookie

```javascript
res.cookie('sessionId', 'xxx', {
  sameSite: 'strict'  //  'lax'
});
```

- `Strict`Cookie
- `Lax`GETCookie
- `None`HTTPSSecure

**3. Referer**

Referer

```javascript
app.post('/api', (req, res) => {
  const referer = req.headers.referer;
  if (!referer || !referer.startsWith('https://example.com')) {
    return res.status(403).send('Invalid referer');
  }
  // 
});
```

**4.  Cookie **

```javascript
//  Cookie
res.cookie('csrfToken', token);

//  token
fetch('/api', {
  headers: {
    'X-CSRF-Token': getCookie('csrfToken')
  }
});

// 
app.post('/api', (req, res) => {
  const cookieToken = req.cookies.csrfToken;
  const headerToken = req.headers['x-csrf-token'];
  if (cookieToken !== headerToken) {
    return res.status(403).send('Invalid token');
  }
});
```

## 

iframe""

### 

**1. X-Frame-Options**

iframe

```javascript
//  iframe 
res.setHeader('X-Frame-Options', 'DENY');

// 
res.setHeader('X-Frame-Options', 'SAMEORIGIN');

// 
res.setHeader('X-Frame-Options', 'ALLOW-FROM https://example.com');
```

**2. CSP frame-ancestors**

```javascript
res.setHeader(
  'Content-Security-Policy',
  "frame-ancestors 'self' https://trusted.com"
);
```

**3. JavaScript **

```javascript
// 
if (top !== self) {
  top.location = self.location;
}
```

## SQL 



### 

```javascript
//  SQL
const username = req.body.username;
const sql = `SELECT * FROM users WHERE username = '${username}'`;

// 
// username = "admin' OR '1'='1"
//  SQL: SELECT * FROM users WHERE username = 'admin' OR '1'='1'
```

### 

**1. **

```javascript
// 
const sql = 'SELECT * FROM users WHERE username = ?';
db.query(sql, [username]);

//  ORM
const user = await User.findOne({ where: { username } });
```

**2. **

```javascript
function validateUsername(username) {
  const pattern = /^[a-zA-Z0-9_]{3,20}$/;
  return pattern.test(username);
}
```

## 

### 

```javascript
const bcrypt = require('bcrypt');

// 
async function hashPassword(password) {
  const salt = await bcrypt.genSalt(10);
  return await bcrypt.hash(password, salt);
}

// 
async function verifyPassword(password, hash) {
  return await bcrypt.compare(password, hash);
}

// 
const hashedPassword = await hashPassword('user123');
// $2b$10$xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

const isValid = await verifyPassword('user123', hashedPassword);
```

### 

```javascript
function validatePassword(password) {
  // 8
  const pattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
  return pattern.test(password);
}
```

## HTTPS

HTTPS  TLS/SSL 

### 

1. ****
2. ****
3. ****
4. ****
5. ****
6. ****

### 


- 
- 
-  CA 
- 

## 

### 1. 

```javascript
// 
<input type="text" maxlength="100">

// 
if (input.length > 100) {
  return res.status(400).send('Input too long');
}
```

### 2. 

```javascript
const multer = require('multer');

const upload = multer({
  limits: {
    fileSize: 5 * 1024 * 1024  // 5MB
  },
  fileFilter: (req, file, cb) => {
    // 
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('Invalid file type'));
    }
  }
});
```

### 3. 

```javascript
// 
// 
localStorage.setItem('password', 'xxx');
localStorage.setItem('creditCard', 'xxx');

// 
localStorage.setItem('theme', 'dark');
localStorage.setItem('language', 'zh-CN');
```

### 4. 

```javascript
// 
Math.random();

// 
crypto.getRandomValues(new Uint32Array(1))[0];

// Node.js
const crypto = require('crypto');
crypto.randomBytes(32).toString('hex');
```

### 5. 

```bash
# 
npm audit

# 
npm audit fix

#  Snyk 
npx snyk test
```

## 

****
- [ ] 
- [ ]  `textContent`  `innerHTML`
- [ ]  CSP 
- [ ] Cookie  HttpOnly  Secure
- [ ]  CSRF 
- [ ] 
- [ ]  HTTPS

****
- [ ]  SQL 
- [ ]  bcrypt 
- [ ] 
- [ ] 
- [ ] 
- [ ] 
- [ ] 

## 

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [MDN Web Security](https://developer.mozilla.org/en-US/docs/Web/Security)
- [Content Security Policy](https://content-security-policy.com/)
